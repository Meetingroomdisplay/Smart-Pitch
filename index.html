<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartPitch</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(255,255,255,0.05);
      --panel2: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.12);
      --border2: rgba(255,255,255,0.18);
      --text:#eaf0ff;
      --muted:#9fb0d7;
      --shadow: 0 18px 40px rgba(0,0,0,0.38);
      --radius: 18px;

      --accent: #2ee59d;
      --accentSoft: rgba(46,229,157,0.14);

      --warn: #ffd166;
      --blue: #7aa7ff;
      --danger: rgba(255,120,120,0.35);
    }

    *{box-sizing:border-box}
    
    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #070b14;
      background-image:
        radial-gradient(1200px 700px at 50% 40%, rgba(46,229,157,0.15), transparent 60%),
        radial-gradient(800px 500px at 30% 60%, rgba(122,167,255,0.12), transparent 50%),
        radial-gradient(600px 400px at 70% 30%, rgba(255,209,102,0.08), transparent 50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease-out;
    }
    .splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .splash-logo {
      width: 200px;
      height: auto;
      animation: logoEntry 1.5s ease-out forwards, logoPulse 2s ease-in-out 1.5s infinite;
      filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
    }
    @keyframes logoEntry {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(30px);
        filter: drop-shadow(0 0 0 rgba(46,229,157,0)) drop-shadow(0 0 0 rgba(0,0,0,0));
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
      }
    }
    @keyframes logoPulse {
      0%, 100% {
        filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
        transform: scale(1);
      }
      50% {
        filter: drop-shadow(0 0 50px rgba(46,229,157,0.6)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
        transform: scale(1.02);
      }
    }
    .splash-text {
      margin-top: 30px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      opacity: 0;
      animation: textFadeIn 1s ease-out 0.8s forwards;
    }
    @keyframes textFadeIn {
      to { opacity: 0.8; }
    }
    .splash-loader {
      margin-top: 40px;
      display: flex;
      gap: 8px;
      opacity: 0;
      animation: textFadeIn 1s ease-out 1.2s forwards;
    }
    .splash-dot {
      width: 10px;
      height: 10px;
      background: #2ee59d;
      border-radius: 50%;
      animation: dotBounce 1.4s ease-in-out infinite;
    }
    .splash-dot:nth-child(2) { animation-delay: 0.2s; }
    .splash-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes toastIn {
      from { opacity:0; transform:translateX(-50%) translateY(20px); }
      to { opacity:1; transform:translateX(-50%) translateY(0); }
    }
    @keyframes toastOut {
      from { opacity:1; transform:translateX(-50%) translateY(0); }
      to { opacity:0; transform:translateX(-50%) translateY(20px); }
    }
    @keyframes dotBounce {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.4;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .splash-version {
      position: absolute;
      bottom: 30px;
      color: rgba(255,255,255,0.3);
      font-size: 11px;
      letter-spacing: 1px;
      opacity: 0;
      animation: textFadeIn 1s ease-out 1.5s forwards;
    }
    body{
      margin:0;
      color:var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(122,167,255,0.18), transparent 62%),
        radial-gradient(900px 600px at 90% 0%, rgba(46,229,157,0.14), transparent 55%),
        radial-gradient(900px 600px at 70% 110%, rgba(255,209,102,0.07), transparent 55%),
        var(--bg);
    }

    .wrap{max-width:1280px;margin:0 auto;padding:18px}

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border:1px solid var(--border2);
      border-radius: calc(var(--radius) + 8px);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      min-height: 92px;
    }
    .brand{
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .brand img{
      height: 84px;
      width: auto;
      display:block;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,0.55)) drop-shadow(0 0 22px rgba(46,229,157,0.20));
    }

    .chip{
      justify-self:end;
      grid-column:3;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(0,0,0,0.22);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    #serverTime{
      color:#fff;
      font-weight: 950;
      letter-spacing:0.2px;
    }

    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .tabbtn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:11px 14px;
      border-radius: 16px;
      font-weight: 950;
      font-size: 14px;
      position:relative;
    }
    .tabbtn:hover{
      background: rgba(122,167,255,0.10);
      border-color: rgba(122,167,255,0.32);
    }
    .tabbtn.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }

    .panel{
      margin-top:14px;
      border:1px solid var(--border2);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding:14px;
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.20);
      padding:14px;
    text-align:center;}

    .card h3{
      margin:0 0 10px;
      font-size: 16px;
      color: #ffffff;
      font-weight: 980;
      letter-spacing: 0.15px;
    text-align:center;}

    .subtleTitle{
      color: var(--accent);
      font-weight: 980;
      font-size: 13px;
      margin-bottom: 10px;
      letter-spacing: 0.3px;
    }

    .small{ color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .kpi{
      padding:10px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
    text-align:center;}
    .kpi .label{ color:var(--muted); font-size:12px; font-weight:900; }
    .kpi .value{ font-size:18px; font-weight:980; margin-top:4px; }

    .statusBar{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:14px;
    }

    .dashGrid{
      display:grid;
      grid-template-columns: 1.65fr 1fr;
      gap:14px;
      align-items:start;
    }

    .rightCol{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .chartWrap{ height: 360px; }
    .chartWrapSmall{ height: 340px; }
    canvas{ width:100% !important; height:100% !important; }

    select, input{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight:900;
      outline:none;
    }
    button{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight:980;
    }
    button:hover{ background: rgba(122,167,255,0.10); border-color: rgba(122,167,255,0.32); }
    button.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }

    .btnPill{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:980;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .led{
      display:inline-block;
      width:10px; height:10px;
      border-radius:999px;
      margin-right:8px;
      background: rgba(255,255,255,0.20);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    .led.on{
      background: rgba(46,229,157,0.95);
      box-shadow:
        0 0 0 2px rgba(46,229,157,0.16),
        0 0 18px rgba(46,229,157,0.45);
    }

    .ghost{
      border:1px dashed rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.10);
      border-radius: 16px;
      padding:12px;
      color: var(--muted);
    }

    .errorBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,120,120,0.35);
      background: rgba(255,120,120,0.10);
      color: #ffd6d6;
      display:none;
      font-weight: 900;
    }

    .warnBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,209,102,0.35);
      background: rgba(255,209,102,0.10);
      color: #ffe9b3;
      display:none;
      font-weight: 900;
    }

    /* ===== Calendar grid ===== */
    .calTop{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .calHeader{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .monthTitle{
      font-size: 20px;
      font-weight: 990;
      letter-spacing: 0.2px;
    }
    .monthNav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .calControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .dow{
      text-align:center;
      font-weight:980;
      color: var(--muted);
      font-size:12px;
      padding:6px 0;
    }
    .dayCell{
      border:1px solid var(--border);
      border-radius: 18px;
      background: rgba(0,0,0,0.16);
      padding:12px;
      min-height: 120px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform 0.05s ease;
    }
    .dayCell:hover{
      border-color: rgba(122,167,255,0.35);
      background: rgba(122,167,255,0.08);
    }
    .dayCell:active{ transform: scale(0.995); }

    .dayNum{
      font-weight:980;
      font-size:13px;
      color:#fff;
      opacity:0.92;
    }
    .dayMuted{ opacity:0.35; }

    .dayItems{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .pill{
      border:1px solid rgba(46,229,157,0.35);
      background: rgba(46,229,157,0.10);
      border-radius: 16px;
      padding:8px 10px;
      font-weight:950;
      font-size:12px;
      color: var(--text);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .pill .meta{ color: var(--muted); font-weight:900; }
    .pillX{
      border:none;
      background: rgba(255,255,255,0.10);
      color:#fff;
      border-radius: 999px;
      padding:2px 10px;
      font-weight:990;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .pillX:hover{ background: rgba(255,255,255,0.16); }

    @media (max-width: 1080px){
      .dashGrid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
      .statusBar{ grid-template-columns: 1fr; }
      .chartWrap{ height: 300px; }
      .chartWrapSmall{ height: 290px; }
      .topbar{ min-height: 88px; }
      .brand img{ height: 74px; }
      .dayCell{ min-height: 110px; }
    }
  
    /* ===== Data tables (Data tab only) ===== */
    .subtabs{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .subtabbtn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight: 980;
    }
    .subtabbtn:hover{ background: rgba(122,167,255,0.10); border-color: rgba(122,167,255,0.32); }
    .subtabbtn.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }
    .dataControls .field{ min-width: 160px; }
    .dataControls .label{ color:var(--muted); font-size:12px; font-weight:900; margin:0 0 6px 2px; }
    .tableWrap{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:auto;
      max-height: 560px;
      background: rgba(0,0,0,0.16);
    }
    table.dbTable{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      font-size: 12px;
    }
    table.dbTable thead th{
      position: sticky;
      top: 0;
      background: rgba(7,11,20,0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border2);
      padding:10px 10px;
      text-align:left;
      white-space:nowrap;
      font-weight: 980;
      color:#ffffff;
    }
    table.dbTable tbody td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding:9px 10px;
      white-space:nowrap;
      color: var(--text);
    }
    table.dbTable tbody tr:hover td{
      background: rgba(122,167,255,0.07);
    }
    .pillTiny{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      font-weight: 950;
      font-size: 11px;
    }
    .pillTiny.ok{ border-color: rgba(46,229,157,0.40); background: rgba(46,229,157,0.08); }
    .pillTiny.bad{ border-color: rgba(255,120,120,0.40); background: rgba(255,120,120,0.08); }

    /* PLC Monitor styles */
    .plc-io-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 6px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 11px;
    }
    .plc-label {
      color: #9fb0d7;
      font-weight: 900;
      min-width: 32px;
    }
    .plc-desc {
      color: #7a8a9a;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .plc-value {
      color: #2ee59d;
      font-weight: 900;
      font-family: monospace;
      min-width: 50px;
      text-align: right;
    }
    .plc-led {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #3a4a5a;
      border: 1px solid #5a6a7a;
      flex-shrink: 0;
    }
    .plc-led.on {
      background: #2ee59d;
      box-shadow: 0 0 6px #2ee59d;
    }
    .plc-led.fault.on {
      background: #ff6b6b;
      box-shadow: 0 0 6px #ff6b6b;
    }

  
    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch.small {
      width: 40px;
      height: 22px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #3a4a5a;
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: #7a8a9a;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch.small .toggle-slider:before {
      height: 16px;
      width: 16px;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #2ee59d;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
      background-color: white;
    }
    .toggle-switch.small input:checked + .toggle-slider:before {
      transform: translateX(18px);
    }
    
    /* Manual Control Row Styles */
    .manual-io-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .manual-label {
      color: #7aa7ff;
      font-weight: 900;
      font-size: 11px;
      min-width: 30px;
    }
    .manual-desc {
      color: #9fb0d7;
      font-size: 11px;
      flex: 1;
    }
    
    /* Analog Output Slider Styles */
    .manual-ao-row {
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .manual-ao-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .manual-ao-value {
      color: #2ee59d;
      font-weight: 900;
      font-size: 14px;
      margin-left: auto;
      min-width: 45px;
      text-align: right;
    }
    .manual-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #3a4a5a;
      outline: none;
      -webkit-appearance: none;
    }
    .manual-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #7aa7ff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .manual-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #7aa7ff;
      cursor: pointer;
      border: none;
    }
    
    /* Tuning Parameter Styles */
    .tuning-param {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
    }
    .tuning-param label {
      display: block;
      color: #f5a623;
      font-weight: 700;
      font-size: 11px;
      margin-bottom: 6px;
    }
    .tuning-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tuning-param input[type="number"] {
      flex: 1;
      padding: 8px 10px;
      background: #0d1117;
      border: 1px solid #3a4a5a;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 700;
    }
    .tuning-param input[type="number"]:focus {
      outline: none;
      border-color: #f5a623;
    }
    .tuning-unit {
      color: #7a8a9a;
      font-size: 11px;
      min-width: 35px;
    }
    .tuning-hint {
      color: #5a6a7a;
      font-size: 10px;
      margin-top: 4px;
    }

    /* Mode Card Styles */
    .mode-card{background:linear-gradient(135deg,rgba(255,255,255,0.08) 0%,rgba(255,255,255,0.03) 100%);border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:40px;text-align:center;max-width:600px;width:100%;transition:all 0.5s ease;}
    .mode-card.smartpitch-active{border-color:rgba(46,229,157,0.5);box-shadow:0 0 60px rgba(46,229,157,0.2);}
    .mode-header{margin-bottom:30px;}
    .mode-icon{font-size:48px;margin-bottom:10px;transition:all 0.5s ease;}
    .mode-card.smartpitch-active .mode-icon{font-size:64px;animation:modeFloat 3s ease-in-out infinite;}
    @keyframes modeFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
    .mode-title{color:#eaf0ff;font-size:24px;font-weight:700;margin:0 0 8px 0;transition:all 0.5s ease;}
    .mode-card.smartpitch-active .mode-title{background:linear-gradient(90deg,#2ee59d,#7aa7ff,#2ee59d);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:modeGradient 3s linear infinite;}
    @keyframes modeGradient{0%{background-position:0% center;}100%{background-position:200% center;}}
    .mode-subtitle{color:#9fb0d7;font-size:14px;}
    .mode-buttons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:24px;}
    .mode-btn{background:linear-gradient(135deg,rgba(255,255,255,0.06) 0%,rgba(255,255,255,0.02) 100%);border:2px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px 24px;min-width:140px;cursor:pointer;transition:all 0.3s ease;position:relative;}
    .mode-btn:hover{border-color:rgba(255,255,255,0.3);transform:translateY(-2px);}
    .mode-btn.smartpitch{border-color:rgba(255,255,255,0.15);background:linear-gradient(135deg,rgba(255,255,255,0.06) 0%,rgba(255,255,255,0.02) 100%);}
    .mode-btn.smartpitch.selected{border-color:rgba(46,229,157,0.4);background:linear-gradient(135deg,rgba(46,229,157,0.1) 0%,rgba(122,167,255,0.05) 100%);}
    .mode-btn.smartpitch:hover{border-color:rgba(46,229,157,0.6);box-shadow:0 0 30px rgba(46,229,157,0.2);}
    .mode-btn-icon{font-size:28px;margin-bottom:8px;}
    .mode-btn-label{color:#eaf0ff;font-size:16px;font-weight:700;margin-bottom:4px;}
    .mode-btn-desc{color:#7a8a9a;font-size:11px;}
    .mode-btn .led{position:absolute;top:10px;right:10px;}
    .mode-status{color:#9fb0d7;font-size:14px;}
    .ai-status-panel{display:none;margin-top:24px;padding:20px;background:linear-gradient(135deg,rgba(46,229,157,0.1) 0%,rgba(122,167,255,0.05) 100%);border:1px solid rgba(46,229,157,0.3);border-radius:16px;}
    .mode-card.smartpitch-active .ai-status-panel{display:block;animation:aiFadeIn 0.5s ease;}
    @keyframes aiFadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .ai-status-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;color:#2ee59d;font-weight:900;font-size:12px;letter-spacing:2px;}
    .ai-pulse{width:10px;height:10px;background:#2ee59d;border-radius:50%;animation:aiPulse 2s ease-in-out infinite;}
    @keyframes aiPulse{0%,100%{box-shadow:0 0 0 0 rgba(46,229,157,0.7);}50%{box-shadow:0 0 0 10px rgba(46,229,157,0);}}
    .ai-status-grid{display:flex;gap:20px;justify-content:center;}
    .ai-stat{text-align:center;}
    .ai-stat-label{color:#7a8a9a;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
    .ai-stat-value{color:#2ee59d;font-size:14px;font-weight:700;}
    .smartpitch-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 1s ease;z-index:-1;background:radial-gradient(circle at 20% 80%,rgba(46,229,157,0.08) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(122,167,255,0.08) 0%,transparent 50%);}
    .smartpitch-bg.active{opacity:1;}
    .ai-submode-display{text-align:center;margin-bottom:20px;padding:16px;background:rgba(0,0,0,0.2);border-radius:12px;}
    .ai-submode-label{font-size:10px;color:#7a8a9a;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;}
    .ai-submode-value{font-size:24px;font-weight:900;letter-spacing:3px;margin-bottom:6px;transition:all 0.3s ease;}
    .ai-submode-value.monitor{color:#7aa7ff;}
    .ai-submode-value.preheat{color:#ffd166;}
    .ai-submode-value.heating{color:#2ee59d;}
    .ai-submode-desc{font-size:11px;color:#9fb0d7;}
    

    /* Schematic Styles */
    .sch-wrapper{position:relative;padding:20px;min-height:480px;}
    .sch-mode-legend{position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 14px;font-size:12px;}
    .sch-mode-item{display:flex;align-items:center;gap:8px;color:#9fb0d7;margin-bottom:5px;}
    .sch-mode-item:last-child{margin-bottom:0;}
    .sch-radio{width:14px;height:14px;border:2px solid #5a6a7a;border-radius:50%;background:transparent;}
    .sch-radio.active{background:#2ee59d;border-color:#2ee59d;box-shadow:0 0 6px rgba(46,229,157,0.5);}
    .sch-building{position:absolute;top:10px;right:10px;text-align:center;}
    .sch-building-icon{font-size:32px;margin-bottom:4px;}
    .sch-temp-box{background:rgba(0,0,0,0.4);border:1px solid rgba(122,167,255,0.3);border-radius:4px;padding:3px 8px;font-size:11px;color:#7aa7ff;font-weight:600;display:inline-block;}
    .sch-grid{display:flex;gap:10px;margin-top:70px;}
    .sch-plant-section{width:140px;display:flex;flex-direction:column;align-items:center;position:relative;}
    .sch-pipe-temps-upper{display:flex;flex-direction:column;gap:4px;position:absolute;top:0;right:-10px;}
    .sch-vert-pipe{position:relative;height:60px;display:flex;justify-content:center;}
    .sch-pipe-v{width:6px;height:100%;background:linear-gradient(180deg,#5a6a7a,#4a5a6a);border-radius:3px;}
    .sch-temp-vert{position:absolute;left:15px;top:20px;}
    .sch-plant-unit{background:linear-gradient(135deg,#2a3a4a,#1a2530);border:2px solid #4a5a6a;border-radius:8px;padding:10px;position:relative;width:100px;}
    .sch-temp-left{position:absolute;left:-60px;top:10px;}
    .sch-hex-icon{font-size:24px;text-align:center;color:#6a7a8a;margin-bottom:6px;}
    .sch-valve-row{display:flex;align-items:center;gap:6px;justify-content:center;}
    .sch-valve-box{background:rgba(46,229,157,0.2);border:1px solid rgba(46,229,157,0.4);border-radius:3px;padding:2px 6px;font-size:10px;color:#2ee59d;}
    .sch-valve-icon{color:#7a8a9a;font-size:14px;}
    .sch-return-temp{margin-top:10px;}
    .sch-status-indicators{margin-top:15px;font-size:10px;color:#7a8a9a;}
    .sch-status-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
    .sch-status-led{width:12px;height:8px;background:#3a4a3a;border-radius:2px;}
    .sch-status-led.on{background:#2ee59d;box-shadow:0 0 6px rgba(46,229,157,0.6);}
    .sch-main-section{flex:1;position:relative;}
    .sch-pipes-svg{position:absolute;top:0;left:0;width:100%;height:100%;z-index:0;}
    .sch-pipe{fill:none;stroke:#6a7a8a;stroke-width:5;stroke-linecap:round;}
    .sch-pipe.active{stroke:#2ee59d;filter:drop-shadow(0 0 3px rgba(46,229,157,0.5));}
    .sch-pipe-ret{stroke:#5a6a7a;}
    .sch-pitch-labels{display:flex;justify-content:space-around;padding:0 40px;margin-bottom:5px;position:relative;z-index:1;}
    .sch-pitch-label-box{text-align:center;}
    .sch-selected-label{color:#9fb0d7;font-size:12px;font-weight:600;}
    .sch-pumps-row{display:flex;justify-content:space-around;padding:0 60px;margin-bottom:8px;position:relative;z-index:1;}
    .sch-pump-pair{display:flex;gap:12px;}
    .sch-pump-circle{width:24px;height:24px;border:3px solid #5a6a7a;border-radius:50%;background:rgba(0,0,0,0.3);position:relative;}
    .sch-pump-circle::after{content:'';position:absolute;top:50%;left:50%;width:10px;height:10px;border:2px solid #5a6a7a;border-radius:50%;transform:translate(-50%,-50%);}
    .sch-pump-circle.on{border-color:#2ee59d;box-shadow:0 0 10px rgba(46,229,157,0.5);}
    .sch-pump-circle.on::after{border-color:#2ee59d;}
    .sch-pitches-row{display:flex;gap:30px;justify-content:center;position:relative;z-index:1;}
    .sch-pitch-box{position:relative;}
    .sch-pitch-inner{width:200px;height:160px;background:linear-gradient(180deg,#2d8a3e 0%,#3da652 50%,#2d8a3e 100%);border-radius:6px;position:relative;border:2px solid rgba(255,255,255,0.2);}
    .sch-field-marking{position:absolute;top:8px;left:8px;right:8px;bottom:8px;border:2px solid rgba(255,255,255,0.3);border-radius:2px;}
    .sch-center-circle{position:absolute;top:50%;left:50%;width:36px;height:36px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;transform:translate(-50%,-50%);}
    .sch-center-line{position:absolute;top:8px;bottom:8px;left:50%;width:2px;background:rgba(255,255,255,0.3);transform:translateX(-50%);}
    .sch-sens{position:absolute;background:rgba(255,255,255,0.9);border-radius:3px;padding:2px 5px;font-size:9px;color:#333;font-weight:600;z-index:2;}
    .sch-sens-tl{top:12px;left:12px;}
    .sch-sens-tr{top:12px;right:12px;}
    .sch-sens-center{top:50%;left:50%;transform:translate(-50%,-50%);}
    .sch-sens-bl{bottom:12px;left:12px;}
    .sch-sens-br{bottom:12px;right:12px;}
    .sch-pitch-name{text-align:center;color:#9fb0d7;font-size:13px;font-weight:600;margin-top:6px;}
    .sch-side-sensors{position:absolute;right:-55px;top:30px;display:flex;flex-direction:column;gap:50px;}

    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a4a5a; transition: .3s; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #fff; transition: .3s; }
    .slider.round { border-radius: 24px; }
    .slider.round:before { border-radius: 50%; }
    input:checked + .slider { background-color: #2ee59d; }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Settings Page Styles */
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:24px;margin-top:16px;}
    .settings-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px;transition:border-color 0.3s;}
    .settings-card:hover{border-color:var(--border2);}
    .settings-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border);}
    .settings-card-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .settings-card-title{margin:0;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;}
    .settings-card-desc{color:var(--muted);font-size:12px;margin-bottom:18px;line-height:1.5;}
    .settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
    .settings-row:last-child{border-bottom:none;padding-bottom:0;}
    .settings-row:first-child{padding-top:0;}
    .settings-label{display:flex;flex-direction:column;gap:4px;flex:1;min-width:0;padding-right:20px;}
    .settings-label-text{color:var(--text);font-weight:500;font-size:13px;}
    .settings-label-hint{color:var(--muted);font-size:11px;line-height:1.4;}
    .settings-input{display:flex;align-items:center;gap:8px;flex-shrink:0;}
    .settings-input input[type="number"]{width:70px;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,0.3);color:var(--text);font-size:14px;text-align:center;transition:border-color 0.2s,box-shadow 0.2s;}
    .settings-input input[type="number"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(46,229,157,0.15);}
    .settings-input-unit{color:var(--muted);font-size:12px;min-width:28px;}
    .settings-section-title{color:var(--muted);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;margin:20px 0 12px 0;padding-top:12px;border-top:1px solid var(--border);}
    .settings-section-title:first-child{margin-top:0;padding-top:0;border-top:none;}
    .card-standard{border-color:rgba(122,167,255,0.25);}
    .card-standard .settings-card-dot{background:#7aa7ff;}
    .card-standard .settings-card-title{color:#7aa7ff;}
    .card-frost{border-color:rgba(100,180,255,0.25);}
    .card-frost .settings-card-dot{background:#64b4ff;}
    .card-frost .settings-card-title{color:#64b4ff;}
    .card-smartpitch{border-color:rgba(46,229,157,0.25);}
    .card-smartpitch .settings-card-dot{background:#2ee59d;}
    .card-smartpitch .settings-card-title{color:#2ee59d;}

    
    /* ========================================
       SMARTPITCH MODE TRANSITION ANIMATIONS
       ======================================== */
    
    /* Neural Network Canvas */
    #neuralCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.8s ease;
      z-index: 1;
    }
    
    #neuralCanvas.active {
      opacity: 1;
    }
    
    /* Mode Panel Container */
    .mode-panel {
      position: relative;
      overflow: hidden;
    }
    
    /* AI Activation Overlay */
    .ai-activation-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, rgba(100, 180, 255, 0.3) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 5;
      transition: opacity 0.5s ease;
    }
    
    .ai-activation-overlay.pulse {
      animation: aiPulse 2s ease-out;
    }
    
    @keyframes aiPulse {
      0% { opacity: 0; transform: scale(0.5); }
      30% { opacity: 1; }
      100% { opacity: 0; transform: scale(2); }
    }
    
    /* Scanning Line Effect */
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #64b4ff, #00ffff, #64b4ff, transparent);
      opacity: 0;
      z-index: 10;
      box-shadow: 0 0 20px #64b4ff, 0 0 40px #00ffff;
    }
    
    .scan-line.active {
      animation: scanDown 1.5s ease-in-out;
    }
    
    @keyframes scanDown {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
    
    /* Mode Card Enhancements */
    .mode-card {
      position: relative;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .mode-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(100, 180, 255, 0.1), transparent 30%);
      opacity: 0;
      transition: opacity 0.5s ease;
      animation: rotate 4s linear infinite paused;
    }
    
    .mode-card.smartpitch-active::before {
      opacity: 1;
      animation-play-state: running;
    }
    
    @keyframes rotate {
      100% { transform: rotate(360deg); }
    }
    
    /* SmartPitch Active Glow */
    .mode-card.smartpitch-active {
      border-color: #64b4ff !important;
      box-shadow: 0 0 30px rgba(100, 180, 255, 0.4), 
                  0 0 60px rgba(100, 180, 255, 0.2),
                  inset 0 0 30px rgba(100, 180, 255, 0.1) !important;
    }
    
    /* AI Status Indicator */
    .ai-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(100, 180, 255, 0.2), rgba(0, 255, 255, 0.1));
      border: 1px solid rgba(100, 180, 255, 0.5);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #64b4ff;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.5s ease;
    }
    
    .ai-status-badge.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .ai-status-badge .pulse-dot {
      width: 8px;
      height: 8px;
      background: #00ffff;
      border-radius: 50%;
      animation: pulseDot 2s ease-in-out infinite;
    }
    
    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 10px #00ffff; }
      50% { opacity: 0.5; transform: scale(0.8); box-shadow: 0 0 5px #00ffff; }
    }
    
    /* Data Stream Effect */
    .data-stream {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .data-stream.active {
      opacity: 1;
    }
    
    .data-stream span {
      position: absolute;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      color: rgba(100, 180, 255, 0.3);
      white-space: nowrap;
      animation: dataFall linear infinite;
    }
    
    @keyframes dataFall {
      0% { transform: translateY(-100%); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(calc(100vh)); opacity: 0; }
    }
    
    /* Learning Stats Animation */
    .learning-stat {
      opacity: 0;
      transform: translateX(-20px);
      transition: all 0.4s ease;
    }
    
    .learning-stat.animate-in {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Circular Progress Ring */
    .confidence-ring {
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .confidence-ring svg {
      transform: rotate(-90deg);
    }
    
    .confidence-ring circle {
      fill: none;
      stroke-width: 6;
    }
    
    .confidence-ring .bg {
      stroke: rgba(100, 180, 255, 0.1);
    }
    
    .confidence-ring .progress {
      stroke: url(#confidenceGradient);
      stroke-linecap: round;
      stroke-dasharray: 226;
      stroke-dashoffset: 226;
      transition: stroke-dashoffset 1.5s ease;
    }
    
    .confidence-ring .value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
      color: #64b4ff;
    }
    
    /* Hexagon Grid Background */
    .hex-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2364b4ff' fill-opacity='0.03'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
    }
    
    .hex-grid.active {
      opacity: 1;
    }
    
    /* Typing Text Effect */
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #64b4ff;
      animation: typing 2s steps(40) forwards, blink 0.8s step-end infinite;
    }
    
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    
    @keyframes blink {
      50% { border-color: transparent; }
    }
    
    /* Particle Float */
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #64b4ff;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0;
    }
    
    .particle.float {
      animation: particleFloat 3s ease-in-out infinite;
    }
    
    @keyframes particleFloat {
      0%, 100% { opacity: 0; transform: translateY(0) scale(0); }
      20% { opacity: 1; transform: scale(1); }
      80% { opacity: 1; }
      100% { transform: translateY(-100px) scale(0); }
    }
    
    /* Mode Button Enhanced */
    .mode-btn {
      position: relative;
      overflow: hidden;
    }
    
    .mode-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(100, 180, 255, 0.4), transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    
    .mode-btn.ripple::after {
      width: 300px;
      height: 300px;
    }
    
    /* Glitch Text Effect */
    .glitch {
      position: relative;
    }
    
    .glitch::before,
    .glitch::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
    }
    
    .glitch.active::before {
      animation: glitch1 0.3s linear;
      color: #ff0040;
      z-index: -1;
    }
    
    .glitch.active::after {
      animation: glitch2 0.3s linear;
      color: #00ffff;
      z-index: -2;
    }
    
    @keyframes glitch1 {
      0%, 100% { opacity: 0; transform: translate(0); }
      20% { opacity: 0.8; transform: translate(-3px, 2px); }
      40% { opacity: 0.8; transform: translate(3px, -2px); }
      60% { opacity: 0.8; transform: translate(-2px, 1px); }
      80% { opacity: 0.8; transform: translate(2px, -1px); }
    }
    
    @keyframes glitch2 {
      0%, 100% { opacity: 0; transform: translate(0); }
      20% { opacity: 0.8; transform: translate(3px, -2px); }
      40% { opacity: 0.8; transform: translate(-3px, 2px); }
      60% { opacity: 0.8; transform: translate(2px, -1px); }
      80% { opacity: 0.8; transform: translate(-2px, 1px); }
    }

    
    
  
    /* Slope Intervention Indicator */
    @keyframes slopePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    .slope-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,209,102,0.1);
      border: 1px solid rgba(255,209,102,0.3);
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .slope-indicator.active {
      background: rgba(255,209,102,0.15);
      border-color: rgba(255,209,102,0.5);
    }
    .slope-indicator .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }
    .slope-indicator.active .dot {
      background: #ffd166;
      box-shadow: 0 0 8px rgba(255,209,102,0.6);
      animation: slopePulse 1.5s infinite;
    }
    .slope-indicator.on-track .dot {
      background: #4CAF50;
      box-shadow: 0 0 8px rgba(76,175,80,0.4);
      animation: none;
    }

  
    /* Building Protect Mode */
    .building-protect-active {
      border-color: rgba(255,159,67,0.5) !important;
      background: linear-gradient(180deg, rgba(255,159,67,0.15), rgba(255,159,67,0.05)) !important;
    }
    .building-protect-active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 30px rgba(255,159,67,0.2);
      pointer-events: none;
    }
  </style>

<script>
/* ==========================================================
   SmartPitch DEMO / Simulation Adapter (static-site friendly)
   - Intercepts fetch('/api/...') calls and serves mock data
   - Generates realistic, smoothly changing values + scenarios
   ========================================================== */
(function(){
  const DEMO_MODE = true; // set false if you later wire a real backend
  if (!DEMO_MODE) return;

  // --- Helpers ---
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const lerp = (a,b,t) => a + (b-a)*t;
  const rnd = (a,b) => a + Math.random()*(b-a);
  const nowISO = () => new Date().toISOString();

  // For GitHub Pages etc, absolute "/api" would otherwise 404.
  // We'll intercept anything that looks like an API call.
  const isApi = (u) => {
    try {
      const s = (typeof u === "string") ? u : (u && u.url ? u.url : "");
      return s.startsWith("/api/") || s.includes("/api/") || s === "./logoforhtml.svg";
    } catch(e){ return false; }
  };

  // --- Scenario model (best for demos) ---
  const SCENARIOS = [
    {
      key: "frost",
      name: "Frost risk (cold + calm)",
      baseOutside: -1.2,
      wind: 1.2,
      cloud: 20,
      humidity: 92,
      precip: 0.0
    },
    {
      key: "windy",
      name: "Windy night (high heat loss)",
      baseOutside: 1.5,
      wind: 9.0,
      cloud: 65,
      humidity: 86,
      precip: 0.2
    },
    {
      key: "mild",
      name: "Mild & cloudy (low demand)",
      baseOutside: 6.0,
      wind: 3.2,
      cloud: 90,
      humidity: 80,
      precip: 0.0
    }
  ];

  const Demo = {
    scenarioKey: "frost",
    heatEnabled: true,
    mode: "AUTO",
    _t0: Date.now(),
    _lastToggle: Date.now(),
    _energyKwh: 0,
    _sessionId: 21
  };

  function scenario(){ return SCENARIOS.find(s=>s.key===Demo.scenarioKey) || SCENARIOS[0]; }

  function timeMinutes(){
    return (Date.now() - Demo._t0) / 60000;
  }

  // Smooth outside temp variation over time
  function outsideTemp(){
    const s = scenario();
    const t = timeMinutes();
    const diurnal = Math.sin((t/60)*Math.PI*2) * 0.7; // gentle swing
    const noise = Math.sin(t*0.35) * 0.15 + (Math.random()-0.5)*0.05;
    return s.baseOutside + diurnal + noise;
  }

  function feelsLike(tempC, wind){
    // rough wind chill-ish feel for demo (NOT meteorologically strict)
    return tempC - clamp(wind*0.12, 0, 2.5);
  }

  // Field temps respond slowly to heating / weather
  function fieldTemps(){
    const t = timeMinutes();
    const out = outsideTemp();
    const heat = Demo.heatEnabled ? 1 : 0;
    // target soil temps: heat drives upward, outside drags down slowly
    const target8 = lerp(out + 2.0, 12.5, heat) + (scenario().cloud>70?0.2:-0.2);
    const target25 = lerp(out + 3.0, 11.0, heat);

    // "inertia" via exponential approach
    // create deterministic-ish smooth values using sin waves instead of storing state
    const a8  = 1 - Math.exp(-t/40);   // 8cm responds faster
    const a25 = 1 - Math.exp(-t/85);   // 25cm slower
    const base8  = lerp(out + 3.5, target8, a8)  + Math.sin(t*0.12)*0.12;
    const base25 = lerp(out + 4.2, target25, a25) + Math.sin(t*0.09)*0.08;

    return {
      avg_field_8cm_c: Number((base8).toFixed(2)),
      avg_field_25cm_c: Number((base25).toFixed(2))
    };
  }

  function flowReturn(){
    // If heating on, sec flow rises with "wish" temp; otherwise near ambient
    const out = outsideTemp();
    const heat = Demo.heatEnabled;
    const wish = wishTemp();
    const secFlow = heat ? clamp(wish + rnd(-0.6,0.6), 15, 40) : clamp(out + 6 + rnd(-0.4,0.4), 8, 18);
    const secReturn = heat ? secFlow - clamp(3.0 + scenario().wind*0.18 + rnd(-0.4,0.4), 2.0, 10.0) : secFlow - rnd(0.3,1.2);
    const priFlow = heat ? secFlow + rnd(2.5,4.0) : secFlow + rnd(0.5,1.5);
    const priReturn = heat ? priFlow - rnd(2.0,4.5) : priFlow - rnd(0.5,1.5);
    return {
      sec_flow_c: Number(secFlow.toFixed(2)),
      sec_return_c: Number(secReturn.toFixed(2)),
      pri_flow_c: Number(priFlow.toFixed(2)),
      pri_return_c: Number(priReturn.toFixed(2))
    };
  }

  function wishTemp(){
    // simple curve: colder outside => higher desired flow
    const out = outsideTemp();
    // map out temp roughly (-10..6) => wish (34..16)
    const w = lerp(34, 16, clamp((out + 10) / 16, 0, 1));
    return Number(w.toFixed(1));
  }

  function leafFrost(){
    // More likely when cold and clear, and heating off
    const out = outsideTemp();
    const s = scenario();
    const risk = (out < 1.0 && s.cloud < 40 && s.humidity > 85 && !Demo.heatEnabled);
    // add a little stochastic behaviour
    if (!risk) return false;
    return (Math.random() < 0.65);
  }

  function updateEnergy(){
    // Pretend energy increases when heating is enabled
    // 3.7MW at full is huge; for demo, accumulate kWh at ~800-1600 kW equivalent
    const dtMin = 1; // we update roughly each minute in charts; safe enough
    if (Demo.heatEnabled){
      const kw = clamp(900 + scenario().wind*60 + rnd(-60,60), 700, 1700);
      Demo._energyKwh += (kw * dtMin) / 60.0;
    }
  }

  // --- API payload builders (match your NR API shapes) ---
  function api_status(){
    const s = scenario();
    const ft = fieldTemps();
    const fr = flowReturn();
    const out = outsideTemp();
    const wind = s.wind + Math.sin(timeMinutes()*0.25)*0.6;
    const cloud = clamp(s.cloud + Math.sin(timeMinutes()*0.18)*8, 0, 100);
    const humidity = clamp(s.humidity + Math.sin(timeMinutes()*0.14)*4, 40, 100);

    updateEnergy();

    const latest_trend = {
      ts: nowISO(),
      leaf_frost: leafFrost(),
      outside_temp_c: Number(out.toFixed(2)),
      humidity_pct: Number(humidity.toFixed(0)),
      wind_speed: Number(wind.toFixed(1)),
      cloud_cover_pct: Number(cloud.toFixed(0)),
      avg_field_8cm_c: ft.avg_field_8cm_c,
      avg_field_25cm_c: ft.avg_field_25cm_c,
      sec_flow_c: fr.sec_flow_c,
      sec_return_c: fr.sec_return_c,
      pri_flow_c: fr.pri_flow_c,
      pri_return_c: fr.pri_return_c,
      heat_enabled: Demo.heatEnabled,
      mode: Demo.mode,
      energy_kw: Demo.heatEnabled ? Number(clamp(1100 + wind*70, 700, 1800).toFixed(0)) : 0
    };

    const counts = {
      trend_log: 81241,
      weather_open_meteo: 168,
      decisions: 317,
      weather_last_fetch: nowISO()
    };

    const latest_decision = {
      id: 317,
      ts: nowISO(),
      pitch_id: "P1",
      mode: Demo.mode,
      frost_risk: (out < 1.5 && cloud < 45),
      confidence: Number(clamp(0.55 + (cloud<40?0.1:-0.05) + (wind>7?-0.05:0), 0.2, 0.9).toFixed(2)),
      reason: (out < 1.5 && cloud < 45) ? "Clear skies + low temp â‡’ leaf frost risk" : "Risk low under current conditions"
    };

    const duration = 72;
    const forecast_avg = Number((out + 1.8).toFixed(1));
    const wish = wishTemp();

    return {
      server_time: new Date().toISOString().replace("T"," ").replace("Z","+00"),
      latest_trend,
      counts,
      latest_decision,
      forecast_avg,
      wish_temp: wish,
      forecast_settings: { duration, temp_type: "real" },
      smartpitch_submode: "LEARNING",
      slope_intervened: false,
      slope_adjustment_total: 0,
      session_active: true,
      building_protect_active: false,
      forecast_override_active: false
    };
  }

  function api_timeseries(hours){
    hours = clamp(parseInt(hours||24,10)||24, 1, 8760);
    // build one point per 10 minutes for the chosen hours
    const points = Math.min(720, Math.max(24, Math.floor((hours*60)/10)));
    const series = [];
    const now = Date.now();
    for (let i = points-1; i >= 0; i--){
      const ts = new Date(now - i*10*60*1000).toISOString();
      // rewind outside temp slightly
      const tMin = timeMinutes() - i*10;
      const s = scenario();
      const diurnal = Math.sin((tMin/60)*Math.PI*2) * 0.7;
      const out = s.baseOutside + diurnal + Math.sin(tMin*0.35)*0.15;
      const heat = Demo.heatEnabled ? 1 : 0;
      const a8  = 1 - Math.exp(-(timeMinutes())/40);
      const field8 = lerp(out + 3.5, 12.5, heat) * (0.9 + 0.1*a8) + Math.sin(tMin*0.12)*0.12;

      series.push({
        ts,
        outside_temp_c: Number(out.toFixed(2)),
        avg_field_8cm_c: Number(field8.toFixed(2)),
        heat_enabled: Demo.heatEnabled,
        mode: Demo.mode
      });
    }
    return { hours, series };
  }

  function api_forecast(hours){
    hours = clamp(parseInt(hours||168,10)||168, 1, 336);
    const series = [];
    const s = scenario();
    const start = Date.now();
    for (let h=0; h<=hours; h++){
      const ts = new Date(start + h*3600*1000).toISOString();
      const diurnal = Math.sin((h/24)*Math.PI*2) * 0.9;
      const temp = s.baseOutside + 1.2 + diurnal + Math.sin(h*0.3)*0.2;
      const wind = clamp(s.wind + Math.sin(h*0.22)*0.8, 0, 14);
      const cloud = clamp(s.cloud + Math.sin(h*0.17)*10, 0, 100);
      const hum = clamp(s.humidity + Math.sin(h*0.15)*6, 40, 100);
      const precip = (cloud > 80 && hum > 85) ? Number(clamp(s.precip + Math.random()*0.4, 0, 2.5).toFixed(2)) : 0;
      series.push({
        ts,
        temp_c: Number(temp.toFixed(1)),
        humidity_pct: Number(hum.toFixed(0)),
        wind_speed: Number(wind.toFixed(1)),
        cloud_cover_pct: Number(cloud.toFixed(0)),
        precip_mm: precip,
        feels_like_c: Number(feelsLike(temp, wind).toFixed(1))
      });
    }
    return {
      hours,
      now_ts: new Date().toISOString(),
      max_ts: new Date(start + hours*3600*1000).toISOString(),
      hours_behind: 0,
      stale: false,
      series
    };
  }

  function api_learning_sessions(days){
    days = clamp(parseInt(days||365,10)||365, 1, 3650);
    // Provide a plausible set of recent sessions
    const rows = [];
    const now = Date.now();
    const n = 26;
    for (let i=0; i<n; i++){
      const start = new Date(now - (i*3 + 1)*24*3600*1000 - rnd(0,8)*3600*1000);
      const durH = rnd(2.5, 6.5);
      const end = new Date(start.getTime() + durH*3600*1000);
      const playableBy = new Date(end.getTime() + rnd(0.5,2.0)*3600*1000);
      const pass = Math.random() > (scenario().key==="frost" ? 0.35 : 0.25);
      const margin = pass ? Math.round(rnd(10, 120)) : -Math.round(rnd(10, 240));
      rows.push({
        session_id: Demo._sessionId - i,
        pitch_id: (i%2===0) ? "P1" : "P2",
        start_ts: start.toISOString(),
        end_ts: end.toISOString(),
        playable_by_ts: playableBy.toISOString(),
        result: pass ? "PASS" : "FAIL",
        margin_minutes: margin,
        energy_kwh: Number((rnd(1200, 5400)).toFixed(0)),
        notes: pass ? "Cleared in time" : "Late clearance under adverse conditions"
      });
    }
    return { days, rows };
  }

  function api_learning_recommendation(){
    // Next training 10:00 tomorrow with 60 min buffer
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 24*3600*1000);
    tomorrow.setUTCHours(10,0,0,0);
    const buffer_minutes = 60;
    const playable_by_ts = new Date(tomorrow.getTime() - buffer_minutes*60*1000);

    const out = outsideTemp();
    const s = scenario();
    const temp_band = (out <= -2) ? "T<=-2" : (out<=0) ? "T-2..0" : (out<=2) ? "T0..2" : (out<=5) ? "T2..5" : "T>5";
    const wind_band = (s.wind < 2) ? "W0..2" : (s.wind < 5) ? "W2..5" : (s.wind < 8) ? "W5..8" : "W>8";
    const cloud_band = (s.cloud < 25) ? "C0..25" : (s.cloud < 75) ? "C25..75" : "C75..100";

    // suggest start offset based on scenario
    const base = (s.key==="frost") ? 420 : (s.key==="windy") ? 360 : 240;
    const buffer = (s.key==="windy") ? 60 : 45;
    const start_offset_minutes = base + buffer;
    const suggested_start_ts = new Date(playable_by_ts.getTime() - start_offset_minutes*60*1000);

    const used_level = (s.key==="mild") ? 3 : 2;
    const nMatches = (s.key==="mild") ? 14 : 6;
    const nPass = Math.round(nMatches * (s.key==="frost" ? 0.55 : 0.65));
    const confidence = (used_level===3 && nMatches>=10) ? 0.8 : (used_level===3) ? 0.6 : 0.5;

    return {
      next_training: {
        training_start: tomorrow.toISOString(),
        buffer_minutes,
        playable_by_ts: playable_by_ts.toISOString()
      },
      current_bands: {
        playable_by_ts: playable_by_ts.toISOString(),
        temp_band,
        wind_band,
        cloud_band
      },
      matches: {
        n: nMatches,
        pass: nPass,
        pass_rate: Number((100*nPass/nMatches).toFixed(1)),
        used_level,
        worst_fail_late_min: (s.key==="frost") ? 180 : 90
      },
      recommendation: {
        start_offset_minutes,
        suggested_start_ts: suggested_start_ts.toISOString(),
        confidence: Number(confidence.toFixed(2)),
        reason: (s.key==="frost")
          ? "Historically needs longer lead time under clear/cold conditions"
          : (s.key==="windy")
            ? "High wind increases heat loss â€” add buffer"
            : "Mild conditions â€” shorter lead time generally sufficient"
      }
    };
  }

  function api_mode_get(){ return { mode: Demo.mode, heat_enabled: Demo.heatEnabled, demo: true }; }
  function api_mode_post(body){
    try{
      if (body && typeof body === "object"){
        if (typeof body.mode === "string") Demo.mode = body.mode.toUpperCase();
        if (typeof body.heat_enabled === "boolean") Demo.heatEnabled = body.heat_enabled;
      }
    }catch(e){}
    return api_mode_get();
  }

  function api_rate_get(){ return { gas_p_per_kwh: 7.5, electricity_p_per_kwh: 28.0, demo:true }; }
  function api_rate_post(body){ return api_rate_get(); }
  function api_cost_get(){ return { session_energy_kwh: Number(Demo._energyKwh.toFixed(1)), est_cost_gbp: Number((Demo._energyKwh*0.075).toFixed(2)), demo:true }; }

  function api_schedule_get(month){
    // simple training schedule blocks
    const items = [];
    const base = new Date(month ? (month+"-01T10:00:00Z") : new Date().toISOString());
    const y = base.getUTCFullYear();
    const m = base.getUTCMonth();
    for (let d=1; d<=28; d+=4){
      const dt = new Date(Date.UTC(y,m,d,10,0,0));
      items.push({ id: `${y}${m+1}${d}`, training_start: dt.toISOString(), buffer_minutes: 60, pitch_id: "P1", title: "First Team Training" });
    }
    return { month: `${y}-${String(m+1).padStart(2,"0")}`, items };
  }
  function api_schedule_post(body){ return { ok:true, demo:true }; }

  // --- Response factory ---
  function jsonResponse(obj, status=200){
    return new Response(JSON.stringify(obj), {
      status,
      headers: { "content-type": "application/json; charset=utf-8", "cache-control": "no-store" }
    });
  }

  async function readBody(req){
    try{
      if (!req) return null;
      if (req.bodyUsed) return null;
      const ct = req.headers && req.headers.get ? (req.headers.get("content-type")||"") : "";
      if (ct.includes("application/json")){
        return await req.json();
      }
      const txt = await req.text();
      try { return JSON.parse(txt); } catch(e){ return txt; }
    }catch(e){ return null; }
  }

  // --- fetch interception ---
  const _fetch = window.fetch.bind(window);
  window.fetch = async function(input, init){
    const url = (typeof input === "string") ? input : (input && input.url ? input.url : "");
    const method = (init && init.method) ? String(init.method).toUpperCase() : (input && input.method ? String(input.method).toUpperCase() : "GET");

    if (!isApi(url)) return _fetch(input, init);

    // Provide a built-in logo fallback (so ./logoforhtml.svg doesn't break on static hosting)
    if (url === "./logoforhtml.svg"){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="420" height="140" viewBox="0 0 420 140">
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="#2ee59d"/><stop offset="1" stop-color="#7aa7ff"/>
          </linearGradient>
          <filter id="f" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="#000" flood-opacity="0.55"/>
          </filter>
        </defs>
        <rect x="10" y="14" rx="26" ry="26" width="400" height="112" fill="rgba(0,0,0,0.22)" stroke="rgba(255,255,255,0.22)"/>
        <text x="210" y="78" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="40" font-weight="900" fill="url(#g)" filter="url(#f)">SmartPitch</text>
        <text x="210" y="104" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="12" font-weight="700" fill="rgba(255,255,255,0.55)">DEMO Â· SIMULATION MODE</text>
      </svg>`;
      return new Response(svg, { status:200, headers:{ "content-type":"image/svg+xml" }});
    }

    // route
    const u = new URL(url, window.location.origin);
    const path = u.pathname;

    // GETs
    if (method === "GET"){
      if (path === "/api/ping") return jsonResponse({ ok:true, ts: nowISO(), demo:true });
      if (path === "/api/status") return jsonResponse(api_status());
      if (path === "/api/timeseries") return jsonResponse(api_timeseries(u.searchParams.get("hours")));
      if (path === "/api/forecast") return jsonResponse(api_forecast(u.searchParams.get("hours")));
      if (path === "/api/learning/sessions") return jsonResponse(api_learning_sessions(u.searchParams.get("days")));
      if (path === "/api/learning/recommendation") return jsonResponse(api_learning_recommendation());
      if (path === "/api/mode") return jsonResponse(api_mode_get());
      if (path === "/api/rate") return jsonResponse(api_rate_get());
      if (path === "/api/cost") return jsonResponse(api_cost_get());
      if (path === "/api/schedule") return jsonResponse(api_schedule_get(u.searchParams.get("month")));
      if (path === "/api/gui") return jsonResponse({ ok:true, demo:true }); // not used in static mode
    }

    // POSTs
    if (method === "POST"){
      if (path === "/api/mode"){
        const body = await (async()=>{ 
          if (input && typeof input !== "string") return await readBody(input);
          if (init && init.body){
            try { return JSON.parse(init.body); } catch(e){ return init.body; }
          }
          return null;
        })();
        return jsonResponse(api_mode_post(body));
      }
      if (path === "/api/rate") return jsonResponse(api_rate_post(null));
      if (path === "/api/schedule") return jsonResponse(api_schedule_post(null));
    }

    // default
    return jsonResponse({ error:"Demo API: endpoint not implemented", path, method }, 404);
  };

  // --- Tiny demo control dock (scenario buttons) ---
  function mountDock(){
    const dock = document.createElement("div");
    dock.id = "demoDock";
    dock.style.position = "fixed";
    dock.style.right = "14px";
    dock.style.bottom = "14px";
    dock.style.zIndex = "9998";
    dock.style.border = "1px solid rgba(255,255,255,0.18)";
    dock.style.background = "rgba(0,0,0,0.30)";
    dock.style.backdropFilter = "blur(10px)";
    dock.style.borderRadius = "18px";
    dock.style.padding = "10px";
    dock.style.boxShadow = "0 18px 40px rgba(0,0,0,0.38)";
    dock.style.maxWidth = "320px";

    dock.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px;">
        <div style="font-weight:950;letter-spacing:0.2px;">DEMO Â· Simulation</div>
        <button id="demoMinBtn" style="padding:6px 10px;border-radius:999px;">â€“</button>
      </div>
      <div id="demoBody">
        <div style="color:rgba(255,255,255,0.70);font-size:12px;font-weight:800;margin:0 0 6px 0;">Scenario</div>
        <div id="demoScenarioBtns" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
          <button id="demoHeatBtn" class="active" style="flex:1;min-width:130px;">Heating: ON</button>
          <button id="demoModeBtn" style="flex:1;min-width:130px;">Mode: AUTO</button>
        </div>
        <div style="margin-top:8px;color:rgba(255,255,255,0.55);font-size:11px;font-weight:800;">
          Tip: use scenarios to show how wind/cloud/temp affect efficiency.
        </div>
      </div>
    `;
    document.body.appendChild(dock);

    const btnWrap = dock.querySelector("#demoScenarioBtns");
    SCENARIOS.forEach(sc=>{
      const b = document.createElement("button");
      b.textContent = sc.name;
      b.style.padding = "8px 10px";
      b.style.borderRadius = "14px";
      b.style.fontWeight = "950";
      b.style.fontSize = "12px";
      if (sc.key === Demo.scenarioKey) b.classList.add("active");
      b.addEventListener("click", ()=>{
        Demo.scenarioKey = sc.key;
        [...btnWrap.querySelectorAll("button")].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
      });
      btnWrap.appendChild(b);
    });

    const heatBtn = dock.querySelector("#demoHeatBtn");
    const modeBtn = dock.querySelector("#demoModeBtn");

    function syncBtns(){
      heatBtn.textContent = `Heating: ${Demo.heatEnabled ? "ON" : "OFF"}`;
      heatBtn.classList.toggle("active", Demo.heatEnabled);
      modeBtn.textContent = `Mode: ${Demo.mode}`;
      modeBtn.classList.toggle("active", Demo.mode === "AUTO");
    }
    syncBtns();

    heatBtn.addEventListener("click", ()=>{
      Demo.heatEnabled = !Demo.heatEnabled;
      syncBtns();
    });
    modeBtn.addEventListener("click", ()=>{
      Demo.mode = (Demo.mode === "AUTO") ? "MANUAL" : "AUTO";
      syncBtns();
    });

    // minimize
    const minBtn = dock.querySelector("#demoMinBtn");
    const body = dock.querySelector("#demoBody");
    let minimized = false;
    minBtn.addEventListener("click", ()=>{
      minimized = !minimized;
      body.style.display = minimized ? "none" : "block";
      minBtn.textContent = minimized ? "+" : "â€“";
    });
  }

  // Mount after DOM
  window.addEventListener("DOMContentLoaded", ()=>{
    try { mountDock(); } catch(e){}
  });

})();
</script>

</head>

<body>

<!-- Splash Screen -->
<div class="splash-screen" id="splashScreen">
  <img src="./logoforhtml.svg" alt="SmartPitch" class="splash-logo">
  <div class="splash-text">Pitch Heating Intelligence</div>
  <div class="splash-loader">
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
  </div>
  <div class="splash-version">THFC Training Ground</div>
</div>

  <div class="wrap">
    <div class="topbar">
      <div></div>
      <div class="brand">
        <img src="./logoforhtml.svg?v=20260122-7" alt="SmartPitch" />
      </div>
      <div class="chip small">
        <span class="mono" id="serverTime"></span>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabDashboard" onclick="showTab('Dashboard')">Dashboard</button>
      <button class="tabbtn" id="tabForecast" onclick="showTab('Forecast')">Forecast</button>
      <button class="tabbtn" id="tabSchedule" onclick="showTab('Schedule')">Schedule</button>
      <button class="tabbtn" id="tabHeating" onclick="showTab('Heating')">Heating Control</button>
      <button class="tabbtn" id="tabData" onclick="showTab('Data')">Data</button>
      <button class="tabbtn" id="tabAdvanced" onclick="showTab('Advanced')">Advanced</button>
    </div>

    <!-- DASHBOARD -->
    <div class="panel" id="panelDashboard">
      <div id="forecastOverrideIndicator" style="display:none; background:rgba(255,159,67,0.15); border:1px solid rgba(255,159,67,0.4); border-radius:8px; padding:8px 12px; margin-bottom:10px; align-items:center; gap:8px;">
        <span style="color:#ff9f43; font-size:18px;">??</span>
        <span style="color:#ff9f43; font-size:12px; font-weight:600;">FORECAST OVERRIDE ACTIVE</span>
        <span style="color:var(--muted); font-size:11px;">Actual temp significantly colder than forecast - using actual readings</span>
      </div>
      <div class="statusBar">
        <div class="card">
          <h3>Live status</h3>
          <div class="kpi">
            <div class="label">Leaf condition</div>
            <div class="value" id="leafFrost"></div>
            <div class="small mono" id="trendTs"></div>
          </div>
        </div>

        <div class="card">
          <h3>Field Temperature</h3>
          <div class="kpi">
            <div class="label">Average field temp -8cm</div>
            <div class="value"><span class="mono" id="field8" style="color:#2ee59d;"></span></div>
          </div>
        </div>

        <div style="display:flex; gap:15px;">
          <div class="card" style="flex:1;">
            <h3>Live energy</h3>
            <div style="display:flex; gap:15px; align-items:stretch;">
              <div class="kpi" style="flex:1; margin:0; text-align:center;">
                <div class="label">Heating</div>
                <div class="value" style="justify-content:center;"><span class="mono" id="liveKw" style="color:#2ee59d;"></span></div>
              </div>
              <div style="display:flex; flex-direction:column; justify-content:center; padding:8px 12px; background:rgba(0,0,0,0.2); border-radius:8px; border:1px solid #3a4a5a;">
                <label style="color:#9fb0d7; font-size:10px; margin-bottom:4px;">Flow Rate</label>
                <div style="display:flex; align-items:center; gap:6px;">
                  <input type="number" id="flowRateInput" step="0.1" min="0" max="50" placeholder="0.0" 
                    style="width:60px; padding:5px 6px; background:#1a2530; border:1px solid #3a4a5a; border-radius:4px; color:#2ee59d; font-size:14px; font-weight:bold; text-align:center;"
                    onchange="saveFlowRate(this.value)">
                  <span style="color:#9fb0d7; font-size:11px;">L/s</span>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="flex:0 0 120px; display:flex; flex-direction:column; align-items:center;">
            <h3 style="text-align:center; width:100%;">Heat Status</h3>
            <div style="flex:1; display:flex; align-items:center; justify-content:center;">
              <div id="heatStatusIndicator" style="display:flex; align-items:center; gap:10px; padding:12px 18px; border-radius:25px; background:linear-gradient(145deg, #1a1a1a, #252525); border:1px solid #333; box-shadow:0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.4s ease;">
                <div id="heatStatusIcon" style="font-size:20px; filter:grayscale(1) opacity(0.4); transition: all 0.4s ease;">?</div>
                <div id="heatStatusText" style="font-size:13px; font-weight:700; letter-spacing:1px; color:#555; text-transform:uppercase; transition: all 0.4s ease;">OFF</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Mode</h3>
          <div class="kpi">
            <div class="label">Current mode</div>
            <div class="value"><span class="led on" id="modeLed"></span><span class="mono" id="modeNow"></span></div>
            <div class="small" id="modeDesc"></div>
          </div>
        </div>
      </div>

      <div class="dashGrid">
        <div class="card">
          <div class="row">
            <div>
              <div class="subtleTitle">Pitch Temperature</div>
            </div>
            <div class="row" style="gap:8px;">
              <div class="small">Range</div>
              <select id="hoursSel">
                <option value="24">24 hours</option>
                <option value="168">7 days</option>
                <option value="720" selected>1 month</option>
                <option value="8760">1 year</option>
              </select>
            </div>
          </div>

          <div class="chartWrap" style="margin-top:10px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <div class="rightCol">
          <div class="card">
            <div class="subtleTitle">SmartPitch Lookahead</div>
            <div class="kpis">
              <div class="kpi">
                <div class="label">Playable by</div>
                <div class="value" id="playableBy"></div>
                <div class="small mono" id="trainingStart"></div>
              </div>
              <div class="kpi">
                <div class="label">Suggested start</div>
                <div class="value" id="suggestedStart"></div>
                <div class="small mono" id="startOffset"></div>
              </div>
              <div class="kpi">
                <div class="label">Confidence</div>
                <div class="value" id="confidence"></div>
                <div class="small mono" id="passRate"></div>
              </div>
            </div>
            <div class="small" style="margin-top:10px;">
              Reason: <span id="reason"></span>
            </div>
          </div>

          <div class="card">
            <div class="subtleTitle">Heating costs</div>

            <div class="kpi" style="margin-bottom:10px;">
              <div class="label">Season-to-date</div>
              <div class="value" id="seasonCost"></div>
              <div class="small">kWh: <span class="mono" id="seasonKwh"></span></div>
            </div>

            <div class="kpi">
              <div class="label">Energy rate (p/kWh)</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                <input id="rateInput" type="number" step="0.01" min="0" style="width:160px;" />
                <button onclick="saveRate()">Save</button>
                <div class="small">Current: <span class="mono" id="rateNow"></span></div>
              </div>
              <div class="small" style="margin-top:8px;">
                Season window: <span class="mono" id="seasonWindow"></span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- FORECAST -->
    <div class="panel" id="panelForecast" style="display:none;">
      <div class="card">
        <div class="row">
          <div>
            <h3 style="margin:0 0 6px;">Forecast (Fixed 7 days)</h3>
            <div class="small">Temp (green)  Feels Like (green dashed)  Cloud (yellow)  Wind (blue)</div>
          </div>
          <div class="row" style="gap:10px; align-items:center;">
            <div style="background: rgba(46,229,157,0.15); border: 2px solid var(--accent); border-radius: 12px; padding: 8px 16px; text-align:center;">
              <div class="small" style="color: var(--accent); font-weight:900;" id="coldestLabel">Coldest Feels Like</div>
              <div style="font-size: 24px; font-weight: 990; color: #fff;" id="coldestValue"></div>
              <div class="small mono" id="coldestTime"></div>
            </div>
            <button id="btnShowTemp" onclick="selectTempType('temp')">Temp</button>
            <button id="btnShowFeels" class="active" onclick="selectTempType('feels')">Feels Like</button>
            <button onclick="loadForecast(true)">Refresh</button>
          </div>
        </div>

        <div class="chartWrapSmall" style="margin-top:10px;">
          <canvas id="forecastChart"></canvas>
        </div>

        <div class="warnBox" id="forecastWarn"></div>
        <div class="errorBox" id="forecastErr"></div>

        <div class="small" style="margin-top:10px;">
          Rows: <span class="mono" id="fcRows"></span>  DB max_ts: <span class="mono" id="fcMaxTs"></span>
           Behind: <span class="mono" id="fcBehind"></span>
        </div>
      </div>
    </div>

    <!-- SCHEDULE -->
    <div class="panel" id="panelSchedule" style="display:none;">
      <div class="card">
        <div class="calTop">
          <div class="calHeader">
            <div class="monthNav">
              <button onclick="prevMonth()" title="Previous month">?</button>
              <button onclick="nextMonth()" title="Next month">+</button>
            </div>
            <div>
              <div class="monthTitle" id="calTitle"></div>
              <div class="small">Click a day to add entry. It shows inside the day cell. X deletes. Save writes to DB.</div>
            </div>
          </div>

          <div class="calControls">
            <span class="btnPill"><span class="small">Start</span>&nbsp;
              <select id="schedStart">
                <option value="06:00">06:00</option><option value="07:00">07:00</option><option value="08:00">08:00</option>
                <option value="09:00" selected>09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option>
                <option value="12:00">12:00</option><option value="13:00">13:00</option><option value="14:00">14:00</option>
                <option value="15:00">15:00</option><option value="16:00">16:00</option><option value="17:00">17:00</option>
                <option value="18:00">18:00</option><option value="19:00">19:00</option><option value="20:00">20:00</option>
              </select>
            </span>

            <span class="btnPill"><span class="small">Finish</span>&nbsp;
              <select id="schedStop">
                <option value="07:00">07:00</option><option value="08:00">08:00</option><option value="09:00">09:00</option>
                <option value="10:00">10:00</option><option value="11:00" selected>11:00</option><option value="12:00">12:00</option>
                <option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option>
                <option value="16:00">16:00</option><option value="17:00">17:00</option><option value="18:00">18:00</option>
                <option value="19:00">19:00</option><option value="20:00">20:00</option><option value="21:00">21:00</option>
              </select>
            </span>

            <span class="btnPill"><span class="small">Buffer</span>&nbsp;
              <select id="schedBuf">
                <option value="0">0</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                <option value="60" selected>60</option><option value="75">75</option><option value="90">90</option>
                <option value="105">105</option><option value="120">120</option><option value="150">150</option><option value="180">180</option>
              </select>&nbsp;<span class="small">min</span>
            </span>

            <button onclick="saveSchedule()">Save</button>
          </div>
        </div>

        <div class="calGrid" id="calDow">
          <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
        </div>

        <div class="calGrid" id="calGrid"></div>

        <div class="errorBox" id="scheduleErr"></div>

        <div class="small" style="margin-top:10px;">
          Stored fields: <span class="mono">training_start</span> (Start), <span class="mono">buffer_minutes</span> (Buffer),
          Finish is stored inside <span class="mono">session_name</span> for display.
        </div>
      </div>
    </div>

    <!-- HEATING CONTROL -->
    <div class="panel" id="panelHeating" style="display:none; position:relative; overflow:hidden;">
      
      <!-- Heating Sub-tabs -->
      <div class="subtabs" style="margin-bottom:14px;">
        <button class="subtabbtn active" id="subHeatingMode" onclick="showHeatingSub('mode')">Mode</button>
        <button class="subtabbtn" id="subHeatingCurve" onclick="showHeatingSub('curve')">Heat Curve</button>
        <button class="subtabbtn" id="subHeatingSchematic" onclick="showHeatingSub('schematic')">Schematic</button>
        <button class="subtabbtn" id="subHeatingSettings" onclick="showHeatingSub('settings')">Settings</button>
        <button class="subtabbtn" id="subHeatingFrostCam" onclick="showHeatingSub('frostcam')">Frost Camera</button>
        <button class="subtabbtn" id="subHeatingAdvisory" onclick="showHeatingSub('advisory')">Advisory</button>
      </div>

      <!-- MODE SUB-TAB -->
      <div id="heatingSubMode" class="mode-panel">
        <div id="smartpitchBg" class="smartpitch-bg"></div>
        <div style="display:flex; justify-content:center; align-items:center; min-height:400px;">
          <div id="modeCard" class="mode-card">
            <div class="mode-header">
              <h2 id="modeTitle" class="mode-title">Select Operating Mode</h2>
              <div id="modeSubtitle" class="mode-subtitle">Choose how the system controls pitch heating</div>
            </div>
            <div class="mode-buttons">
              <button id="btnSTANDARD" class="mode-btn" onclick="setModeEnhanced('STANDARD')">
                <div class="mode-btn-icon">?</div>
                <div class="mode-btn-label">Standard</div>
                <div class="mode-btn-desc">Manual control</div>
                <span class="led" id="ledSTANDARD"></span>
              </button>
              
              <button id="btnSMARTPITCH" class="mode-btn smartpitch" onclick="setModeEnhanced('SMARTPITCH')">
                <div class="mode-btn-icon">?</div>
                <div class="mode-btn-label">SmartPitch AI</div>
                <div class="mode-btn-desc">Intelligent automation</div>
                <span class="led" id="ledSMARTPITCH"></span>
              </button>
            </div>
            <div class="mode-status">Current mode: <span class="mono" id="modeNow2"></span></div>
            <div id="aiStatusPanel" class="ai-status-panel">
              <div class="ai-status-header"><div class="ai-pulse"></div><span>AI ENGINE ACTIVE</span></div>
              <div class="ai-submode-display">
                <div class="ai-submode-label">Current Phase</div>
                <div class="ai-submode-value" id="aiSubmode">MONITOR</div>
                <div class="ai-submode-desc" id="aiSubmodeDesc">Monitoring conditions</div>
              </div>
              <div class="ai-status-grid">
                <div class="ai-stat"><div class="ai-stat-label">Frost Analysis</div><div class="ai-stat-value" id="aiFrostStatus">Monitoring</div></div>
                <div class="ai-stat"><div class="ai-stat-label">Learning</div><div class="ai-stat-value">Active</div></div>
                <div class="ai-stat"><div class="ai-stat-label">Slope Tracking</div><div class="ai-stat-value" id="aiSlopeStatus">Ready</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HEAT CURVE SUB-TAB -->
      <div id="heatingSubCurve" style="display:none; visibility:hidden;">
      <div class="card">
        <h3>Heat Curve with Knee</h3>
        <div class="small" style="margin-bottom:10px;">
          Defines secondary flow temperature based on outside temperature. The knee point allows aggressive heating in cold conditions, gentler heating for minor frosts.
        </div>

        <div class="dashGrid" style="grid-template-columns: 1fr 1fr;">
          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Heat Curve Chart</div>
            <div style="height:300px; position:relative;">
              <canvas id="heatCurveChart"></canvas>
            </div>
          </div>

          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Curve Parameters</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X1 (Coldest Outside C)</div>
                <input type="number" id="hcX1" step="0.5" value="-10" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y1 (Flow at X1 C)</div>
                <input type="number" id="hcY1" step="0.5" value="35" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">XK (Knee Outside C)</div>
                <input type="number" id="hcXK" step="0.5" value="-2" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">YK (Flow at Knee C)</div>
                <input type="number" id="hcYK" step="0.5" value="20" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X2 (Warmest Outside C)</div>
                <input type="number" id="hcX2" step="0.5" value="4" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y2 (Flow at X2 C)</div>
                <input type="number" id="hcY2" step="0.5" value="15" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button onclick="saveHeatCurve()" style="flex:1;">Save Curve</button>
              <button onclick="loadHeatCurve()" style="flex:1;">Reset</button>
            </div>

            <div class="small" style="margin-top:4px;">
              Current wish temp: <span class="mono" id="hcCurrentFlow"></span>
            </div>
          </div>
          </div>
        </div>

        <div class="errorBox" id="heatCurveErr"></div>

      <!-- FORECAST MONITOR CONTROL -->
      <div class="card" style="margin-top:20px;">
        <h3>Forecast Monitor Control</h3>
        <div class="small" style="margin-bottom:14px;">
          View average forecast temperature over selected duration for heating decisions
        </div>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
          
          <!-- Controls -->
          <div style="flex:1; min-width:200px;">
            <div class="kpi" style="margin-bottom:12px;">
              <div class="label">Forecast Duration</div>
              <select id="forecastDuration" onchange="updateForecastAverage(); saveForecastSettings()" style="width:100%; margin-top:6px; padding:8px; background:#1a2530; color:#eaf0ff; border:1px solid #3a4a5a; border-radius:6px;">
                <option value="24">24 Hours</option>
                <option value="36">36 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72">72 Hours</option>
              </select>
            </div>
            
            <div class="kpi">
              <div class="label">Temperature Type</div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="real" checked onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Real</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="feels" onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Feels Like</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Result Display -->
          <div style="flex:1; min-width:250px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%); border:2px solid #3a4a5a; border-radius:12px; padding:20px; text-align:center;">
              <div style="color:#9fb0d7; font-size:11px; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Average Forecast Temperature</div>
              <div id="forecastAvgTemp" style="font-size:42px; font-weight:900; color:#2ee59d; font-family:monospace;">--</div>
              <div style="color:#9fb0d7; font-size:12px; margin-top:4px;">
                <span id="forecastTempLabel">Real</span> temp over next <span id="forecastDurationLabel">24</span>h
              </div>
              <div style="color:#7aa7ff; font-size:11px; margin-top:8px;">
                Min: <span id="forecastMinTemp" style="font-weight:700;">--</span>&deg;C &nbsp;|&nbsp; Max: <span id="forecastMaxTemp" style="font-weight:700;">--</span>&deg;C
              </div>
            </div>
          </div>
          
        </div>
        
        <button onclick="updateForecastAverage()" style="margin-top:14px;">
          Refresh Forecast
        </button>
      </div>

      </div>
      </div>

      <!-- SCHEMATIC SUB-TAB -->
      <div id="heatingSubSchematic" style="display:none; visibility:hidden;">
        <div style="position:relative;width:1100px;height:550px;margin:0 auto;">

          <!-- Ambient temperature - top right -->
          <div style="position:absolute;top:10px;right:10px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%);border:2px solid #7aa7ff;padding:12px 20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(122,167,255,0.3);">
              <div style="color:#9fb0d7;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Ambient</div>
              <div style="color:#7aa7ff;font-size:28px;font-weight:900;font-family:monospace;"><span id="schAmbientTemp">6.5</span>&deg;C</div>
            </div>
          </div>

          <!-- PRIMARY CIRCUIT -->
          <div style="position:absolute;top:35px;left:5px;color:#bbb;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">Primary</div>

          <!-- Primary IN vertical -->
          <div style="position:absolute;top:60px;left:46px;width:8px;height:180px;background:linear-gradient(to right,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- Bypass horizontal -->
          <div style="position:absolute;top:170px;left:46px;height:8px;width:60px;background:linear-gradient(to bottom,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- 3-port valve -->
          <div style="position:absolute;top:159px;left:93px;width:24px;height:24px;z-index:25;background:radial-gradient(circle at 40% 40%,#777,#444);border:2px solid #555;border-radius:50%;"></div>
          <div style="position:absolute;top:140px;left:85px;z-index:30;background:rgba(76,175,80,0.9);border:1px solid #4CAF50;padding:3px 8px;border-radius:4px;color:#fff;font-size:10px;">S <span id="schValvePos">0</span>%</div>

          <!-- Primary OUT vertical -->
          <div style="position:absolute;top:60px;left:98px;width:8px;height:180px;background:linear-gradient(to right,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- Primary sensors -->
          <div style="position:absolute;top:48px;left:5px;color:#aaa;font-size:10px;font-weight:bold;">Pri Flow</div>
          <div style="position:absolute;top:65px;left:5px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schPriFlow">72.0</span>&deg;C</div>
          <div style="position:absolute;top:48px;left:115px;color:#aaa;font-size:10px;font-weight:bold;">Pri Return</div>
          <div style="position:absolute;top:65px;left:115px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schPriReturn">62.0</span>&deg;C</div>

          <!-- HEAT EXCHANGER -->
          <div style="position:absolute;top:240px;left:46px;width:60px;height:80px;background:linear-gradient(145deg,#3a3a4a,#2a2a3a);border:2px solid #555;border-radius:5px;display:flex;align-items:center;justify-content:center;">
            <div style="width:45px;height:60px;background:repeating-linear-gradient(90deg,#555,#555 3px,#3a3a4a 3px,#3a3a4a 6px);border-radius:3px;"></div>
          </div>
          <div style="position:absolute;top:345px;left:25px;color:#bbb;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">Heat Exchanger</div>

          <!-- SECONDARY CIRCUIT -->
          <!-- Secondary flow from HX -->
          <div style="position:absolute;top:275px;left:106px;height:8px;width:82px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:70px;left:180px;width:8px;height:213px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary horizontal header -->
          <div style="position:absolute;top:70px;left:180px;height:8px;width:680px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary sensors on vertical -->
          <div style="position:absolute;top:138px;left:195px;color:#aaa;font-size:10px;font-weight:bold;">Sec Flow</div>
          <div style="position:absolute;top:155px;left:195px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schSecFlow">18.0</span>&deg;C</div>
          <div style="position:absolute;top:180px;left:195px;background:rgba(80,60,100,0.95);border:1px solid #a080cc;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">W <span id="schWishTemp">--</span>&deg;C</div>

          <!-- Vertical drops to pitches -->
          <div style="position:absolute;top:70px;left:465px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:70px;left:855px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>

          <!-- RETURN PIPEWORK -->
          <div style="position:absolute;top:420px;left:465px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:420px;left:855px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:475px;left:180px;height:8px;width:683px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:295px;left:180px;width:8px;height:185px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:295px;left:106px;height:8px;width:82px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary return sensor -->
          <div style="position:absolute;top:373px;left:195px;color:#aaa;font-size:10px;font-weight:bold;">Sec Return</div>
          <div style="position:absolute;top:390px;left:195px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schSecReturn">8.0</span>&deg;C</div>

          <!-- PITCH 1 -->
          <div style="position:absolute;left:300px;top:130px;">
            <!-- Pumps -->
            <div style="position:absolute;left:50%;transform:translateX(-50%);top:-30px;display:flex;gap:6px;">
              <div id="schPump1A" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
              <div id="schPump1B" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
            </div>
            <!-- Pitch -->
            <div style="width:340px;height:240px;background:linear-gradient(90deg,#1e6b1e 0%,#2a8a2a 50%,#1e6b1e 50%,#2a8a2a 100%);border:2px solid rgba(255,255,255,0.7);border-radius:3px;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;">
              <div style="position:absolute;left:50%;top:0;width:2px;height:100%;background:rgba(255,255,255,0.6);transform:translateX(-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid rgba(255,255,255,0.6);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:6px;height:6px;background:rgba(255,255,255,0.7);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <!-- 5 Sensors -->
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:-22px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1C">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1TL">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1BL">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1TR">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1BR">--</span>&deg;C</div>
            </div>
            <div style="position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);color:#fff;font-size:14px;font-weight:bold;">Pitch 1</div>
          </div>

          <!-- PITCH 2 -->
          <div style="position:absolute;left:690px;top:130px;">
            <!-- Pumps -->
            <div style="position:absolute;left:50%;transform:translateX(-50%);top:-30px;display:flex;gap:6px;">
              <div id="schPump2A" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
              <div id="schPump2B" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
            </div>
            <!-- Pitch -->
            <div style="width:340px;height:240px;background:linear-gradient(90deg,#1e6b1e 0%,#2a8a2a 50%,#1e6b1e 50%,#2a8a2a 100%);border:2px solid rgba(255,255,255,0.7);border-radius:3px;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;">
              <div style="position:absolute;left:50%;top:0;width:2px;height:100%;background:rgba(255,255,255,0.6);transform:translateX(-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid rgba(255,255,255,0.6);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:6px;height:6px;background:rgba(255,255,255,0.7);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <!-- 5 Sensors -->
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:-22px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2C">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2TL">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2BL">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2TR">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2BR">--</span>&deg;C</div>
            </div>
            <div style="position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);color:#fff;font-size:14px;font-weight:bold;">Pitch 2</div>
          </div>

          <!-- Legend -->
          <div style="position:absolute;bottom:10px;left:0;display:flex;gap:20px;font-size:11px;color:#aaa;">
            <div style="display:flex;align-items:center;gap:5px;"><div id="schBmsLed" style="width:15px;height:15px;background:#555;border-radius:3px;"></div><span>Heat demand to BMS</span></div>
          </div>

        </div>
      </div>

      <!-- HEAT CURVE SUB-TAB -->
      <div id="heatingSubCurve" style="display:none; visibility:hidden;">
      <div class="card">
        <h3>Heat Curve with Knee</h3>
        <div class="small" style="margin-bottom:10px;">
          Defines secondary flow temperature based on outside temperature. The knee point allows aggressive heating in cold conditions, gentler heating for minor frosts.
        </div>

        <div class="dashGrid" style="grid-template-columns: 1fr 1fr;">
          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Heat Curve Chart</div>
            <div style="height:300px; position:relative;">
              <canvas id="heatCurveChart"></canvas>
            </div>
          </div>

          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Curve Parameters</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X1 (Coldest Outside C)</div>
                <input type="number" id="hcX1" step="0.5" value="-10" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y1 (Flow at X1 C)</div>
                <input type="number" id="hcY1" step="0.5" value="35" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">XK (Knee Outside C)</div>
                <input type="number" id="hcXK" step="0.5" value="-2" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">YK (Flow at Knee C)</div>
                <input type="number" id="hcYK" step="0.5" value="20" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X2 (Warmest Outside C)</div>
                <input type="number" id="hcX2" step="0.5" value="4" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y2 (Flow at X2 C)</div>
                <input type="number" id="hcY2" step="0.5" value="15" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button onclick="saveHeatCurve()" style="flex:1;">Save Curve</button>
              <button onclick="loadHeatCurve()" style="flex:1;">Reset</button>
            </div>

            <div class="small" style="margin-top:4px;">
              Current wish temp: <span class="mono" id="hcCurrentFlow"></span>
            </div>
          </div>
          </div>
        </div>

        <div class="errorBox" id="heatCurveErr"></div>

      <!-- FORECAST MONITOR CONTROL -->
      <div class="card" style="margin-top:20px;">
        <h3>Forecast Monitor Control</h3>
        <div class="small" style="margin-bottom:14px;">
          View average forecast temperature over selected duration for heating decisions
        </div>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
          
          <!-- Controls -->
          <div style="flex:1; min-width:200px;">
            <div class="kpi" style="margin-bottom:12px;">
              <div class="label">Forecast Duration</div>
              <select id="forecastDuration" onchange="updateForecastAverage(); saveForecastSettings()" style="width:100%; margin-top:6px; padding:8px; background:#1a2530; color:#eaf0ff; border:1px solid #3a4a5a; border-radius:6px;">
                <option value="24">24 Hours</option>
                <option value="36">36 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72">72 Hours</option>
              </select>
            </div>
            
            <div class="kpi">
              <div class="label">Temperature Type</div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="real" checked onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Real</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="feels" onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Feels Like</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Result Display -->
          <div style="flex:1; min-width:250px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%); border:2px solid #3a4a5a; border-radius:12px; padding:20px; text-align:center;">
              <div style="color:#9fb0d7; font-size:11px; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Average Forecast Temperature</div>
              <div id="forecastAvgTemp" style="font-size:42px; font-weight:900; color:#2ee59d; font-family:monospace;">--</div>
              <div style="color:#9fb0d7; font-size:12px; margin-top:4px;">
                <span id="forecastTempLabel">Real</span> temp over next <span id="forecastDurationLabel">24</span>h
              </div>
              <div style="color:#7aa7ff; font-size:11px; margin-top:8px;">
                Min: <span id="forecastMinTemp" style="font-weight:700;">--</span>&deg;C &nbsp;|&nbsp; Max: <span id="forecastMaxTemp" style="font-weight:700;">--</span>&deg;C
              </div>
            </div>
          </div>
          
        </div>
        
        <button onclick="updateForecastAverage()" style="margin-top:14px;">
          Refresh Forecast
        </button>
      </div>

      </div>
      </div>

      <!-- SCHEMATIC SUB-TAB -->
      <div id="heatingSubSchematic" style="display:none; visibility:hidden;">
        <div class="schematic-container">
          
          <!-- Mode Legend (Top Left) -->
          <div class="sch-legend">
            <div class="sch-legend-item"><span class="sch-led" id="schLedAutoFrost"></span>Auto Frost</div>
            <div class="sch-legend-item"><span class="sch-led" id="schLedHeating"></span>Heating</div>
            <div class="sch-legend-item"><span class="sch-led" id="schLedDefrost"></span>Defrost</div>
          </div>
          
          <!-- Weather (Top Right) -->
          <div class="sch-weather">
            <div class="sch-weather-temp" id="schWeatherTemp">--C</div>
            <div class="sch-weather-label">Outside</div>
          </div>
          
          <!-- Main Schematic Area -->
          <div class="sch-main">
            
            <!-- Plant Room (Left) -->
            <div class="sch-plant">
              <div class="sch-plant-box">
                <div class="sch-plant-icon">?</div>
                <div class="sch-plant-label">Heat Source</div>
                <div class="sch-temp-badge sch-plant-temp" id="schPlantTemp">M --C</div>
              </div>
              
              <!-- Valves and Pipes from Plant -->
              <div class="sch-plant-pipes">
                <div class="sch-valve-group">
                  <div class="sch-valve" id="schValve1"><div class="sch-valve-icon"></div></div>
                  <div class="sch-temp-badge" id="schFlowTemp">M --C</div>
                </div>
                <div class="sch-valve-group">
                  <div class="sch-valve" id="schValve2"><div class="sch-valve-icon"></div></div>
                  <div class="sch-temp-badge" id="schReturnTemp">M --C</div>
                </div>
              </div>
              
              <!-- Status Indicators -->
              <div class="sch-status-box">
                <div class="sch-status-item"><span class="sch-led small" id="schHeatDemand"></span>Heat demand to BMS</div>
                <div class="sch-status-item"><span class="sch-led small" id="schTempSwitch"></span>Temperature switch active</div>
              </div>
            </div>
            
            <!-- Pipe Network -->
            <div class="sch-pipes">
              <svg class="sch-pipe-svg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                <!-- Main horizontal pipe from plant -->
                <path class="sch-pipe-line" d="M 0,200 L 100,200 L 100,50 L 700,50 L 700,200" />
                <!-- Return pipe -->
                <path class="sch-pipe-line sch-pipe-return" d="M 0,220 L 80,220 L 80,350 L 700,350 L 700,200" />
                <!-- Branch to Pitch 1 -->
                <path class="sch-pipe-line" d="M 280,50 L 280,80" />
                <path class="sch-pipe-line sch-pipe-return" d="M 300,350 L 300,320" />
                <!-- Branch to Pitch 2 -->
                <path class="sch-pipe-line" d="M 520,50 L 520,80" />
                <path class="sch-pipe-line sch-pipe-return" d="M 540,350 L 540,320" />
                <!-- Flow indicators -->
                <circle class="sch-flow-dot" id="schFlowDot1" cx="200" cy="50" r="4" />
                <circle class="sch-flow-dot" id="schFlowDot2" cx="400" cy="50" r="4" />
              </svg>
              
              <!-- Manifold Temps on pipes -->
              <div class="sch-pipe-temp" style="left:120px;top:30px;" id="schPipeTemp1">M --C</div>
              <div class="sch-pipe-temp" style="right:120px;top:30px;" id="schPipeTemp2">M --C</div>
            </div>
            
            <!-- Pitches -->
            <div class="sch-pitches">
              
              <!-- Pitch 1 -->
              <div class="sch-pitch" id="schPitch1">
                <div class="sch-pitch-status" id="schPitch1Status">Selected</div>
                <div class="sch-pitch-header">
                  <div class="sch-pump" id="schPump1"><div class="sch-pump-icon"></div></div>
                  <div class="sch-temp-badge" id="schP1FlowIn">M --C</div>
                </div>
                <div class="sch-pitch-field">
                  <div class="sch-field-grass">
                    <div class="sch-field-lines"></div>
                    <div class="sch-field-center"></div>
                  </div>
                  <!-- Pitch 1 Sensors -->
                  <div class="sch-sensor sch-sensor-tl" id="schP1SensorTL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-tr" id="schP1SensorTR"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-c" id="schP1SensorC"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-bl" id="schP1SensorBL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-br" id="schP1SensorBR"><span class="sch-sensor-led"></span>--C</div>
                </div>
                <div class="sch-pitch-footer">
                  <div class="sch-temp-badge" id="schP1Return">M --C</div>
                </div>
                <div class="sch-pitch-label">Pitch 1</div>
              </div>
              
              <!-- Pitch 2 -->
              <div class="sch-pitch" id="schPitch2">
                <div class="sch-pitch-status" id="schPitch2Status">Selected</div>
                <div class="sch-pitch-header">
                  <div class="sch-pump" id="schPump2"><div class="sch-pump-icon"></div></div>
                  <div class="sch-temp-badge" id="schP2FlowIn">M --C</div>
                </div>
                <div class="sch-pitch-field">
                  <div class="sch-field-grass">
                    <div class="sch-field-lines"></div>
                    <div class="sch-field-center"></div>
                  </div>
                  <!-- Pitch 2 Sensors -->
                  <div class="sch-sensor sch-sensor-tl" id="schP2SensorTL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-tr" id="schP2SensorTR"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-c" id="schP2SensorC"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-bl" id="schP2SensorBL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-br" id="schP2SensorBR"><span class="sch-sensor-led"></span>--C</div>
                </div>
                <div class="sch-pitch-footer">
                  <div class="sch-temp-badge" id="schP2Return">M --C</div>
                </div>
                <div class="sch-pitch-label">Pitch 2</div>
              </div>
              
            </div>
          </div>
          
        </div>
      </div>

      <!-- SETTINGS SUB-TAB -->
      <div id="heatingSubSettings" style="display:none; overflow:hidden; visibility:hidden;">
        <div class="card">
          <h3>Heating Control Settings</h3>
          <p class="small" style="margin-bottom:8px;">Configure parameters for each operating mode</p>
          
          <div class="settings-grid">
            
            <!-- STANDARD MODE -->
            <div class="settings-card card-standard">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">Standard Mode</h4>
              </div>
              <p class="settings-card-desc">Basic frost protection - choose trigger method below</p>
              
              <!-- Trigger Type Toggle -->
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Trigger Method</span>
                  <span class="settings-label-hint">How to determine when heating should start</span>
                </div>
                <div class="settings-input">
                  <select id="stdTriggerMethod" onchange="toggleStandardTrigger(); saveStandardSettings();" style="padding:8px 12px; border-radius:6px; border:1px solid #3a3f4b; background:#2a2f3a; color:#e0e0e0; font-size:13px; min-width:180px;">
                    <option value="time">Time-based (fixed hours)</option>
                    <option value="forecast">Forecast Temperature</option>
                  </select>
                </div>
              </div>
              
              <!-- TIME-BASED SETTINGS -->
              <div id="stdTimeBasedSettings">
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Pre-Training Window</span>
                    <span class="settings-label-hint">Hours before training when heating can start if frost risk detected</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="stdPreTrainingHours" value="72" min="1" max="168" step="1" onchange="saveStandardSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
              </div>
              
              <!-- FORECAST TEMPERATURE SETTINGS -->
              <div id="stdForecastSettings" style="display:none;">
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Forecast Duration</span>
                    <span class="settings-label-hint">Number of days to average the temperature over</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="stdForecastDays" value="3" min="1" max="7" step="1" onchange="saveStandardSettings()">
                    <span class="settings-input-unit">days</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Temperature Type</span>
                    <span class="settings-label-hint">Use actual or feels-like temperature for the average</span>
                  </div>
                  <div class="settings-input">
                    <select id="stdForecastTempType" onchange="saveStandardSettings();" style="padding:8px 12px; border-radius:6px; border:1px solid #3a3f4b; background:#2a2f3a; color:#e0e0e0; font-size:13px; min-width:140px;">
                      <option value="real">Actual Temperature</option>
                      <option value="feels">Feels Like</option>
                    </select>
                  </div>
                </div>
                
                <div class="settings-row" style="background:#1a1f2a; border-radius:6px; padding:12px; margin-top:8px;">
                  <div style="font-size:12px; color:#8a9bae;">
                    <strong style="color:#64b4ff;">How it works:</strong> Heating will start when the average <span id="stdTempTypeDesc">actual</span> temperature over the next <span id="stdDaysDesc">3</span> days falls below the Frost Threshold (<span id="stdThresholdDesc">0</span>C).
                  </div>
                </div>
              </div>
            </div>
            
            <!-- FROST PROTECTION -->
            <div class="settings-card card-frost">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">Frost Protection</h4>
              </div>
              <p class="settings-card-desc">Applies to all modes - triggers heating when frost risk is detected in forecast</p>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Frost Threshold</span>
                  <span class="settings-label-hint">Heating activates when forecast minimum falls below this</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="frostThreshold" value="2" min="-10" max="10" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Deadband</span>
                  <span class="settings-label-hint">Hysteresis to prevent rapid cycling (off when min > threshold + deadband)</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="frostDeadband" value="1.5" min="0.5" max="5" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Minimum Run Time</span>
                  <span class="settings-label-hint">Heating stays on for at least this long once activated</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="minHeatMinutes" value="30" min="10" max="120" step="10" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">min</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Soil Frozen Threshold</span>
                  <span class="settings-label-hint">Soil is considered frozen below this temperature (for pass/fail)</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="soilFrozenThreshold" value="0" min="-5" max="5" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Temperature Type</span>
                  <span class="settings-label-hint">Use actual or feels-like temperature for frost detection</span>
                </div>
                <div class="settings-input">
                  <select id="frostTempType" onchange="saveFrostSettings()" style="padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,0.3);color:var(--text);font-size:14px;">
                    <option value="real">Actual</option>
                    <option value="feels">Feels Like</option>
                  </select>
                </div>
              </div>
              
              <div class="settings-section-title" style="margin-top:16px; font-size:12px; color:var(--muted); border-top:1px solid var(--border); padding-top:12px;">Forecast Override (applies to all modes)</div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Enable Forecast Override</span>
                  <span class="settings-label-hint">Use actual temp when significantly colder than forecast</span>
                </div>
                <div class="settings-input">
                  <label class="switch">
                    <input type="checkbox" id="forecastOverrideEnabled" checked onchange="saveFrostSettings()">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Override Threshold</span>
                  <span class="settings-label-hint">Trigger when actual is this much colder than forecast</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="forecastOverrideThreshold" value="5" min="2" max="10" step="1" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
            </div>
            
            <!-- SMARTPITCH MODE -->
            <div class="settings-card card-smartpitch">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">SmartPitch Mode</h4>
              </div>
              <p class="settings-card-desc">AI-driven heating with slope-based safety net and learning optimization</p>
              
              <!-- SmartPitch Sub-tabs -->
              <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                <button class="subtabbtn active" id="spSubSafetyNet" onclick="showSpTab('safetynet')">Safety Net</button>
                <button class="subtabbtn" id="spSubHeatCurve" onclick="showSpTab('heatcurve')">Heat Curve</button>
                <button class="subtabbtn" id="spSubTiming" onclick="showSpTab('timing')">Timing</button>
              </div>
              
              <!-- Safety Net Sub-tab -->
              <div id="spTabSafetyNet">
                <div class="settings-section-title">Safety Net</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">The safety net is <strong>dormant by default</strong>. It monitors pitch temperature and only intervenes when the system is off-track or in emergency. Normal control comes from the heat curve and learning system.</p>
                
                <div style="background:rgba(255,159,67,0.1); border:1px solid rgba(255,159,67,0.3); border-radius:8px; padding:12px; margin-bottom:16px;">
                  <div style="color:#ff9f43; font-weight:600; font-size:12px; margin-bottom:8px;">WHEN SAFETY NET INTERVENES:</div>
                  <ul style="margin:0; padding-left:20px; font-size:12px; color:var(--muted); line-height:1.6;">
                    <li><strong>EMERGENCY</strong>  Pitch drops below emergency threshold</li>
                    <li><strong>OFF-TRACK</strong>  Pitch falling too fast with deadline approaching</li>
                    <li><strong>STALLED</strong>  No progress being made near deadline</li>
                    <li><strong>SUCCESS</strong>  Can reduce heat once frost risk cleared (if safe)</li>
                  </ul>
                </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Enable Safety Net</span>
                  <span class="settings-label-hint">Allow safety net to intervene when system is off-track</span>
                </div>
                <div class="settings-input">
                  <label class="switch">
                    <input type="checkbox" id="safetyNetEnabled" checked onchange="saveSmartPitchSettings()">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Emergency Threshold</span>
                  <span class="settings-label-hint">Pitch temp below which emergency intervention triggers</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="emergencyThreshold" value="1.0" min="0" max="3.0" step="0.5" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Off-Track Slope</span>
                  <span class="settings-label-hint">Falling rate (C/hr) that triggers off-track intervention</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="offTrackSlope" value="-0.5" min="-2.0" max="0" step="0.1" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">C/hr</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Evaluation Window</span>
                  <span class="settings-label-hint">Time window for calculating pitch temperature slope</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="slopeWindow" value="60" min="30" max="120" step="10" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">min</span>
                </div>
              </div>
              </div><!-- End Safety Net Sub-tab -->
              
              <!-- Heat Curve Sub-tab -->
              <div id="spTabHeatCurve" style="display:none;">
                <div class="settings-section-title">Heat Curve Fallback</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">The heat curve provides baseline flow temperatures when learning data is insufficient. As the system learns, it relies less on this curve.</p>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Use Heat Curve</span>
                    <span class="settings-label-hint">Enable heat curve as fallback when no learning data</span>
                  </div>
                  <div class="settings-input">
                    <label class="switch">
                      <input type="checkbox" id="useHeatCurve" checked onchange="saveSmartPitchSettings()">
                      <span class="slider round"></span>
                    </label>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Learning Confidence Threshold</span>
                    <span class="settings-label-hint">Minimum confidence before using learned data over heat curve</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="learningConfidence" value="70" min="50" max="95" step="5" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">%</span>
                  </div>
                </div>
              </div><!-- End Heat Curve Sub-tab -->
              
              <!-- Timing Sub-tab -->
              <div id="spTabTiming" style="display:none;">
                <div class="settings-section-title">Timing & Deadlines</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">Configure how far ahead the system looks and when it considers sessions complete.</p>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Forecast Lookahead</span>
                    <span class="settings-label-hint">Hours of forecast data to consider for decisions</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="forecastLookahead" value="24" min="12" max="72" step="6" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Success Temperature</span>
                    <span class="settings-label-hint">Target pitch temperature to achieve before deadline</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="successTemp" value="5.0" min="3.0" max="10.0" step="0.5" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">C</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Cool Buffer Hours</span>
                    <span class="settings-label-hint">Hours before reducing heat after success (if no cold night ahead)</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="coolBufferHours" value="2" min="1" max="6" step="1" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
              </div><!-- End Timing Sub-tab -->
              
            </div>
            
          </div>
        </div>
      </div>

      <!-- FROST CAMERA SUB-TAB -->
      <div id="heatingSubFrostcam" style="display:none; overflow:hidden; visibility:hidden; position:relative;">
        <div class="card">
          <h3>Frost Camera</h3>
          <div class="small" style="margin-bottom:15px;">Live camera feed with frost detection</div>
          
          <div id="frostCamFeed" style="background:#111; border-radius:12px; overflow:hidden; min-height:350px; display:none; align-items:center; justify-content:center; border:2px solid #2ee59d; box-shadow:0 0 15px rgba(46,229,157,0.3); position:relative;">
            <!-- Camera image inserted dynamically -->
            <div id="frostCamError" style="display:none; color:#666; flex-direction:column; align-items:center; text-align:center;">
              <div style="font-size:36px; margin-bottom:8px;">&#128247;</div>
              <div style="font-size:12px;">Camera unavailable</div>
            </div>
            <div id="frostRoiContainer"></div>
            <div style="position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.7); padding:3px 6px; border-radius:4px; font-size:10px; color:#2ee59d;">LIVE</div>
            <div id="frostBadge" style="position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.8); padding:6px 10px; border-radius:5px; font-weight:600; font-size:12px; color:#2ee59d;">--</div>
          </div>
          
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Status</div>
              <div id="fdStatus" style="font-size:16px; font-weight:700; margin-top:4px; color:#2ee59d;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Confidence</div>
              <div id="fdConf" style="font-size:16px; font-weight:700; margin-top:4px;">--%</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Saturation</div>
              <div id="fdSat" style="font-size:16px; font-weight:700; margin-top:4px;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Brightness</div>
              <div id="fdBright" style="font-size:16px; font-weight:700; margin-top:4px;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px; display:none;">
              <div class="subtleTitle" style="font-size:10px;">Mode</div>
              <div id="fdMode" style="font-size:14px; font-weight:600; margin-top:4px;">--</div>
            </div>
          </div>
          
          <div class="card" style="margin-top:12px;">
            <h4 style="margin:0 0 12px 0; color:#64b4ff; font-size:13px; font-weight:700;">DETECTION SETTINGS</h4>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px;">
              <input type="hidden" id="fdRoiX" value="10">
              <input type="hidden" id="fdRoiY" value="10">
              <input type="hidden" id="fdRoiW" value="80">
              <input type="hidden" id="fdRoiH" value="80">
              <div>
                <div class="subtleTitle" style="margin-bottom:6px; font-size:10px;">Thresholds</div>
                <div><label style="color:#9fb0d7; font-size:9px;">Saturation (below=frost)</label><input type="number" id="fdSatTh" min="0" max="255" value="40" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div style="display:none;"><label style="color:#9fb0d7; font-size:9px;">Brightness (above=frost)</label><input type="number" id="fdBrightTh" min="0" max="255" value="150" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px;"></div>
              </div>
              <div>
                <div class="subtleTitle" style="margin-bottom:6px; font-size:10px;">Timing</div>
                <div><label style="color:#9fb0d7; font-size:9px;">Sample Interval (s)</label><input type="number" id="fdSampleInt" min="1" max="30" value="2" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div><label style="color:#9fb0d7; font-size:9px;">Smoothing (frames)</label><input type="number" id="fdSmooth" min="1" max="60" value="10" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div><label style="color:#9fb0d7; font-size:9px;">Change Delay (s)</label><input type="number" id="fdDelay" min="5" max="300" value="30" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px;"></div>
              </div>
              <div>
                <div class="subtleTitle" style="display:none; margin-bottom:6px; font-size:10px;">Options</div>
                <label style="display:none; align-items:center; gap:6px; cursor:pointer; margin-bottom:6px;"><input type="checkbox" id="fdAutoDN" checked style="width:12px; height:12px;"><span style="font-size:10px;">Auto Day/Night</span></label>
                <label style="display:none; align-items:center; gap:6px; cursor:pointer;"><input type="checkbox" id="fdNightBr" checked style="width:12px; height:12px;"><span style="font-size:10px;">Night: Brightness Only</span></label>
              </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="saveFrostDetect()" style="padding:6px 12px; background:#2ee59d; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Save</button>
              <button onclick="loadFrostDetect()" style="padding:6px 12px; background:#3a4a5a; color:#fff; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Reset</button>
              <button onclick="toggleRoiBox()" style="padding:6px 12px; background:#64b4ff; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Edit ROI</button>
              <button onclick="addRoiBox()" style="padding:6px 12px; background:#2ee59d; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">+ Add ROI</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADVISORY SUB-TAB -->
      <div id="heatingSubAdvisory" style="display:none; overflow:hidden; visibility:hidden;">
        <div class="card" style="background:linear-gradient(145deg, rgba(46,229,157,0.08), rgba(122,167,255,0.05)); border:1px solid rgba(46,229,157,0.3);">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
            <div style="font-size:28px;">&#129302;</div>
            <div>
              <h3 style="margin:0; color:#2ee59d;">SmartPitch Advisory</h3>
              <div class="small" style="color:#9fb0d7;">What the system is planning and why</div>
            </div>
          </div>
          
          <!-- Next Session Summary -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#128197;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Next Session</div>
            </div>
            <div id="advNextSession" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Current Plan -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#129504;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Current Plan</div>
            </div>
            <div id="advCurrentPlan" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Weather Assessment -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#127782;&#65039;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Weather Assessment</div>
            </div>
            <div id="advWeather" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Learning Insights -->
          <div class="card" style="padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#128218;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Learning Insights</div>
            </div>
            <div id="advLearning" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
        </div>
      </div>

    </div>

      
    <!-- DATA -->
    <div class="panel" id="panelData" style="display:none;">
      <div class="card">
        <div class="row" style="align-items:flex-end;">
          <div>
            <h3 style="margin-bottom:6px;">Data</h3>
            <div class="small">Browse and export database tables used by SmartPitch learning.</div>
          </div>
          <div class="row" style="gap:8px; justify-content:flex-end;">
            <button class="btnPill" id="btnExportXlsx" onclick="exportXlsxActive()">Export Excel</button>
            <button class="btnPill" id="btnExportCsv" onclick="exportCsvActive()">Export CSV</button>
          </div>
        </div>

        <div class="subtabs" style="margin-top:12px;">
          <button class="subtabbtn active" id="subTrend" onclick="showDataSub('trend')">TrendLogs</button>
          <button class="subtabbtn" id="subDecisions" onclick="showDataSub('decisions')">Control Decisions</button>
          <button class="subtabbtn" id="subLearning" onclick="showDataSub('learning')">SmartPitch</button>
        </div>

        <div id="learningContent" style="display:none; margin-top:12px;">
          <div class="card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 12px 0;">Weather Band Definitions</h4>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px;">
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Temperature Bands</div>
                <div class="mono small">T&lt;=-6: ? -6C (Severe frost)</div>
                <div class="mono small">T-6..-4: -6 to -4C (Hard frost)</div>
                <div class="mono small">T-4..-2: -4 to -2C (Moderate frost)</div>
                <div class="mono small">T-2..0: -2 to 0C (Light frost)</div>
                <div class="mono small">T0..2: 0 to 2C (Frost risk)</div>
                <div class="mono small">T&gt;2: &gt; 2C (Low risk)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Cloud Cover Bands</div>
                <div class="mono small">C0..10: &lt; 10% (Clear - fast defrost)</div>
                <div class="mono small">C10..30: 10-30% (Mostly clear)</div>
                <div class="mono small">C30..60: 30-60% (Partial cloud)</div>
                <div class="mono small">C60..85: 60-85% (Mostly cloudy)</div>
                <div class="mono small">C&gt;85: ? 85% (Overcast - no solar)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Humidity Bands</div>
                <div class="mono small">H&lt;60: &lt; 60% (Dry)</div>
                <div class="mono small">H60..80: 60-80% (Moderate)</div>
                <div class="mono small">H&gt;80: ? 80% (High - frost risk)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Wind Bands</div>
                <div class="mono small">W0..2: &lt; 2 m/s (Calm)</div>
                <div class="mono small">W2..5: 2-5 m/s (Light)</div>
                <div class="mono small">W5..8: 5-8 m/s (Moderate)</div>
                <div class="mono small">W&gt;8: ? 8 m/s (Strong)</div>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 12px 0;">Current Conditions</h4>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
              <div><span class="small" style="color:var(--muted);">Temp:</span> <span id="currentTempBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Cloud:</span> <span id="currentCloudBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Humidity:</span> <span id="currentHumidityBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Wind:</span> <span id="currentWindBand" class="mono"></span></div>
            </div>
          </div>
          
          <div class="card">
            <h4 style="margin:0 0 12px 0;">Historical Performance by Weather Bands</h4>
            <div class="small" style="color:var(--muted); margin-bottom:12px;">Shows pass/fail rate and average heating lead time for each weather combination</div>
            <div class="dbTableWrap" style="overflow-x:auto;">
              <table class="dbTable" id="learningTable">
                <thead id="learningThead"></thead>
                <tbody id="learningTbody"></tbody>
              </table>
            </div>
            <div id="learningMeta" class="small" style="margin-top:8px; color:var(--muted);"></div>
          </div>
        </div>

        <div id="trendSmartContent">
        <div class="dataControls" style="margin-top:12px;">
          <div class="row" style="gap:10px; justify-content:flex-start;">
            <div class="field">
              <div class="label">From</div>
              <input type="datetime-local" id="dataFrom" />
            </div>
            <div class="field">
              <div class="label">To</div>
              <input type="datetime-local" id="dataTo" />
            </div>

            <div class="field" id="smartTablePickerWrap" style="display:none;">
              <div class="label">SmartPitch table</div>
              <select id="smartTableSel" onchange="reloadActiveTable(true)">
                <option value="heating_sessions">Heating sessions</option>
                <option value="heat_periods">Heat periods</option>
                <option value="control_decisions">Control decisions</option>
                <option value="training_schedule">Training schedule</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Rows</div>
              <select id="dataPageSize" onchange="reloadActiveTable(true)">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="250">250</option>
              </select>
            </div>

            <div class="field">
              <div class="label">&nbsp;</div>
              <button onclick="reloadActiveTable(true)">Apply</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="small"><span class="mono" id="dataMeta"></span></div>
            <div class="row" style="gap:8px; justify-content:flex-end;">
              <button onclick="pagePrev()">? Prev</button>
              <button onclick="pageNext()">Next ?</button>
            </div>
          </div>
        </div>

        <div class="errorBox" id="dataErr"></div>

        <div class="tableWrap" style="margin-top:12px;">
          <table class="dbTable" id="dbTable">
            <thead id="dbThead"></thead>
            <tbody id="dbTbody"></tbody>
          </table>
        </div>
      </div>
      </div>
    </div>


    <!-- ADVANCED -->
    <div class="panel" id="panelAdvanced" style="display:none;">
      <div class="subtabs" style="margin-bottom:14px;">
        <button class="subtabbtn active" id="subPLCMonitor" onclick="showAdvancedSub('plc')">PLC Monitor</button>
        <button class="subtabbtn" id="subManualControl" onclick="showAdvancedSub('manual')">Manual Control</button>
        <button class="subtabbtn" id="subModbusDevices" onclick="showAdvancedSub('modbus')">Modbus Devices</button>
        <button class="subtabbtn" id="subAlarms" onclick="showAdvancedSub('alarms')">Alarms</button>
        <button class="subtabbtn" id="subParameters" onclick="showAdvancedSub('parameters')">Temperature Control</button>
      </div>

      <div id="advancedSubPLC" style="display:block;">
        <div class="card">
          <h3>PLC Monitor</h3>
          <div class="small" style="margin-bottom:14px;">Live I/O status from SmartPitch controller</div>
          
          <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            
            <!-- PLC Visual -->
            <div style="background: linear-gradient(180deg, #2a3a4a 0%, #1a2a3a 100%); border-radius:12px; padding:20px; border:2px solid #4a5a6a; min-width:700px;">
              
              <!-- PLC Header -->
              <div style="background:#3a4a5a; border-radius:8px; padding:10px 20px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="color:#2ee59d; font-weight:900; font-size:16px;">SMARTPITCH CONTROLLER</div>
                  <div style="color:#7a8a9a; font-size:11px;">I/O Module Status</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:12px; height:12px; border-radius:50%; background:#2ee59d; box-shadow:0 0 8px #2ee59d;" id="plcStatusLed"></div>
                  <span style="color:#9fb0d7; font-size:12px;" id="plcStatusText">AUTO</span>
                </div>
              </div>
              
              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                
                <!-- Analog Inputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#7aa7ff; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">ANALOG INPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="plc-io-row"><span class="plc-label">AI1</span><span class="plc-desc">Outside Air Temp</span><span class="plc-value" id="plcAI1">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI2</span><span class="plc-desc">Secondary Flow</span><span class="plc-value" id="plcAI2">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI3</span><span class="plc-desc">Secondary Return</span><span class="plc-value" id="plcAI3">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI4</span><span class="plc-desc">Primary Flow</span><span class="plc-value" id="plcAI4">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI5</span><span class="plc-desc">Primary Return</span><span class="plc-value" id="plcAI5">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI6</span><span class="plc-desc">Spare</span><span class="plc-value" id="plcAI6">--</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Analog Outputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#2ee59d; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">ANALOG OUTPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="plc-io-row"><span class="plc-label">AO1</span><span class="plc-desc">3-Port Valve</span><span class="plc-value" id="plcAO1">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO2</span><span class="plc-desc">Pitch 1 Pump</span><span class="plc-value" id="plcAO2">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO3</span><span class="plc-desc">Pitch 2 Pump</span><span class="plc-value" id="plcAO3">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO4</span><span class="plc-desc">Spare</span><span class="plc-value" id="plcAO4">--</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Digital Inputs Section -->
                <div style="flex:1; min-width:180px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#ffd166; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">DIGITAL INPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <div class="plc-io-row"><span class="plc-label">DI1</span><span class="plc-desc">Pitch 1 Enabled</span><span class="plc-led" id="plcDI1"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI2</span><span class="plc-desc">Pitch 2 Enabled</span><span class="plc-led" id="plcDI2"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI3</span><span class="plc-desc">P1 Pump A Fault</span><span class="plc-led fault" id="plcDI3"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI4</span><span class="plc-desc">High Limit Trip</span><span class="plc-led fault" id="plcDI4"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI5</span><span class="plc-desc">P1 Pump B Fault</span><span class="plc-led fault" id="plcDI5"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI6</span><span class="plc-desc">P2 Pump A Fault</span><span class="plc-led fault" id="plcDI6"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI7</span><span class="plc-desc">P2 Pump B Fault</span><span class="plc-led fault" id="plcDI7"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI8</span><span class="plc-desc">Pressure Fault</span><span class="plc-led fault" id="plcDI8"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI9</span><span class="plc-desc">Reset Input</span><span class="plc-led" id="plcDI9"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI10</span><span class="plc-desc">Spare</span><span class="plc-led" id="plcDI10"></span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Digital Outputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#ff6b6b; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">DIGITAL OUTPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <div class="plc-io-row"><span class="plc-label">DO1</span><span class="plc-desc">Common Alarm</span><span class="plc-led fault" id="plcDO1"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO2</span><span class="plc-desc">Primary Heat Demand</span><span class="plc-led" id="plcDO2"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO3</span><span class="plc-desc">AutoFrost Status</span><span class="plc-led" id="plcDO3"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO4</span><span class="plc-desc">Reset Output</span><span class="plc-led" id="plcDO4"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO5</span><span class="plc-desc">Watchdog</span><span class="plc-led" id="plcDO5"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO6</span><span class="plc-desc">Spare</span><span class="plc-led" id="plcDO6"></span></div>
                    </div>
                  </div>
                </div>
                
              </div>
            </div>
            
          </div>
        </div>
      </div>

      <div id="advancedSubManual" style="display:none;">
        <div class="card">
          <h3>Manual Control</h3>
          <div class="small" style="margin-bottom:14px;">Override automatic control and manually set I/O states</div>
          
          <!-- Master Override Switch -->
          <div style="background:linear-gradient(135deg,#ff6b6b22,#ff8e5322); border:2px solid #ff6b6b; border-radius:10px; padding:15px; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="color:#ff6b6b; font-weight:900; font-size:14px;">?? MANUAL OVERRIDE MODE</div>
                <div style="color:#9fb0d7; font-size:11px;">When enabled, automatic control is suspended</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="manualOverrideEnabled" onchange="toggleManualOverride()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div id="manualControlsContainer" style="opacity:0.5; pointer-events:none;">
          
          <div style="display:flex; gap:20px; flex-wrap:wrap;">
            
            <!-- Digital Outputs -->
            <div style="flex:1; min-width:280px;">
              <div style="background:#1a2530; border-radius:10px; padding:15px; border:1px solid #3a4a5a;">
                <div style="color:#2ee59d; font-weight:900; font-size:13px; margin-bottom:12px; border-bottom:1px solid #3a4a5a; padding-bottom:8px;">DIGITAL OUTPUTS</div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO1</span>
                  <span class="manual-desc">Common Alarm</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO1" onchange="setManualDO(1, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO2</span>
                  <span class="manual-desc">Primary Heat Demand</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO2" onchange="setManualDO(2, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO3</span>
                  <span class="manual-desc">AutoFrost Status</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO3" onchange="setManualDO(3, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO4</span>
                  <span class="manual-desc">Reset Output</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO4" onchange="setManualDO(4, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO5</span>
                  <span class="manual-desc">Watchdog</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO5" onchange="setManualDO(5, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO6</span>
                  <span class="manual-desc">Spare</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO6" onchange="setManualDO(6, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Analog Outputs -->
            <div style="flex:1; min-width:320px;">
              <div style="background:#1a2530; border-radius:10px; padding:15px; border:1px solid #3a4a5a;">
                <div style="color:#7aa7ff; font-weight:900; font-size:13px; margin-bottom:12px; border-bottom:1px solid #3a4a5a; padding-bottom:8px;">ANALOG OUTPUTS (0-100%)</div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO1</span>
                    <span class="manual-desc">3-Port Valve</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO1Enabled" onchange="setAOEnabled(1, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO1Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO1" min="0" max="100" value="0" disabled oninput="updateAODisplay(1, this.value)" onchange="setManualAO(1, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO2</span>
                    <span class="manual-desc">Pitch 1 Pump</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO2Enabled" onchange="setAOEnabled(2, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO2Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO2" min="0" max="100" value="0" disabled oninput="updateAODisplay(2, this.value)" onchange="setManualAO(2, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO3</span>
                    <span class="manual-desc">Pitch 2 Pump</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO3Enabled" onchange="setAOEnabled(3, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO3Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO3" min="0" max="100" value="0" disabled oninput="updateAODisplay(3, this.value)" onchange="setManualAO(3, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO4</span>
                    <span class="manual-desc">Spare</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO4Enabled" onchange="setAOEnabled(4, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO4Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO4" min="0" max="100" value="0" disabled oninput="updateAODisplay(4, this.value)" onchange="setManualAO(4, this.value)">
                </div>
              </div>
            </div>
            
          </div>
          
          </div>
        </div>
      </div>

      <!-- MODBUS DEVICES SUB-TAB -->
      <div id="advancedSubModbus" style="display:none;">
        <div class="card">
          <h3>Soil Scout Modbus Sensors</h3>
          <div class="small" style="margin-bottom:14px;">Live temperature readings from underground Soil Scout sensors via Modbus RTU</div>
          
          <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            
            <!-- Modbus Device Visual -->
            <div style="background: linear-gradient(180deg, #2a3a4a 0%, #1a2a3a 100%); border-radius:12px; padding:20px; border:2px solid #4a5a6a; min-width:800px;">
              
              <!-- Modbus Header -->
              <div style="background:#3a4a5a; border-radius:8px; padding:10px 20px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="color:#f5a623; font-weight:900; font-size:16px;">SOIL SCOUT MODBUS GATEWAY</div>
                  <div style="color:#7a8a9a; font-size:11px;">11 Temperature Sensors | Modbus RTU</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:12px; height:12px; border-radius:50%; background:#f5a623; box-shadow:0 0 8px #f5a623;" id="modbusStatusLed"></div>
                  <span style="color:#9fb0d7; font-size:12px;" id="modbusStatusText">ONLINE</span>
                </div>
              </div>
              
              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                
                <!-- Ambient Sensor -->
                <div style="flex:0 0 auto; min-width:180px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #f5a623;">
                    <div style="color:#f5a623; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">AMBIENT</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB1</span><span class="modbus-desc">Air Temperature</span><span class="modbus-value" id="modbusMB1">--C</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Pitch 1 Sensors -->
                <div style="flex:1; min-width:220px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#7aa7ff; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">PITCH 1 SENSORS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB2</span><span class="modbus-desc">Centre Spot</span><span class="modbus-value" id="modbusMB2">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB3</span><span class="modbus-desc">18yd Box - Top Left</span><span class="modbus-value" id="modbusMB3">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB4</span><span class="modbus-desc">18yd Box - Top Right</span><span class="modbus-value" id="modbusMB4">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB5</span><span class="modbus-desc">18yd Box - Bot Left</span><span class="modbus-value" id="modbusMB5">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB6</span><span class="modbus-desc">18yd Box - Bot Right</span><span class="modbus-value" id="modbusMB6">--C</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Pitch 2 Sensors -->
                <div style="flex:1; min-width:220px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#2ee59d; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">PITCH 2 SENSORS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB7</span><span class="modbus-desc">Centre Spot</span><span class="modbus-value" id="modbusMB7">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB8</span><span class="modbus-desc">18yd Box - Top Left</span><span class="modbus-value" id="modbusMB8">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB9</span><span class="modbus-desc">18yd Box - Top Right</span><span class="modbus-value" id="modbusMB9">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB10</span><span class="modbus-desc">18yd Box - Bot Left</span><span class="modbus-value" id="modbusMB10">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB11</span><span class="modbus-desc">18yd Box - Bot Right</span><span class="modbus-value" id="modbusMB11">--C</span></div>
                    </div>
                  </div>
                </div>
                
              </div>
              
              <!-- Modbus Stats -->
              <div style="margin-top:15px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Last Poll:</span>
                  <span style="color:#fff; font-size:12px; margin-left:5px;" id="modbusLastPoll">--</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Comms Errors:</span>
                  <span style="color:#fff; font-size:12px; margin-left:5px;" id="modbusErrors">0</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Avg Pitch 1:</span>
                  <span style="color:#7aa7ff; font-size:12px; font-weight:bold; margin-left:5px;" id="modbusAvgP1">--C</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Avg Pitch 2:</span>
                  <span style="color:#2ee59d; font-size:12px; font-weight:bold; margin-left:5px;" id="modbusAvgP2">--C</span>
                </div>
              </div>
              
            </div>
            
          </div>
        </div>
      </div>

      <!-- TEMPERATURE CONTROL SUB-TAB -->
      <div id="advancedSubParameters" style="display:none;">
        <div class="card">
          <h3>Temperature Control</h3>
          <div class="small" style="margin-bottom:14px;">PID controller settings for valve actuator</div>
          
          <!-- Pitch Selection -->
          <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px; margin-bottom:20px; border:1px solid #3a4a5a;">
            <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
              <div>
                <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:4px;">PITCH SELECTION</div>
                <div class="small">Select which pitch(es) to heat in auto mode</div>
              </div>
              <select id="pitchSelection" onchange="savePitchSelection()" style="padding:8px 12px; border-radius:8px; background:#1a2332; border:1px solid #3a4a5a; color:#fff; font-size:14px; min-width:140px;">
                <option value="both">Both Pitches</option>
                <option value="pitch1">Pitch 1 Only</option>
                <option value="pitch2">Pitch 2 Only</option>
              </select>
            </div>
            <div style="margin-top:14px; display:flex; gap:30px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="pitch1StatusLed" style="width:12px; height:12px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                <span class="small">Pitch 1 Pump</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="pitch2StatusLed" style="width:12px; height:12px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                <span class="small">Pitch 2 Pump</span>
              </div>
            </div>
          </div>
          
          <div style="background:#1a2530; border-radius:10px; padding:20px; border:1px solid #3a4a5a;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #3a4a5a;">
              <div style="color:#f5a623; font-weight:900; font-size:14px;">PID CONTROLLER</div>
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="color:#7a8a9a; font-size:12px;">Status:</span>
                <div style="display:flex; align-items:center; gap:8px; padding:6px 12px; background:rgba(0,0,0,0.3); border-radius:6px;">
                  <div id="pidStatusLed" style="width:10px; height:10px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                  <span id="pidStatusText" style="color:#7a8a9a; font-size:12px; font-weight:600;">OFF</span>
                </div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
              
              <div class="tuning-param">
                <label>Gain Factor (Kp)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidKp" value="0.0050" min="0" max="1" step="0.0001">
                  <span class="tuning-unit">-</span>
                </div>
                <div class="tuning-hint">Proportional gain (default: 0.0050)</div>
              </div>
              
              <div class="tuning-param">
                <label>Integrator (Tn)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidTn" value="5" min="0" max="999" step="1">
                  <span class="tuning-unit">sec</span>
                </div>
                <div class="tuning-hint">Integral time constant (default: 5)</div>
              </div>
              
              <div class="tuning-param">
                <label>Differentiator (Tv)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidTv" value="0" min="0" max="999" step="1">
                  <span class="tuning-unit">sec</span>
                </div>
                <div class="tuning-hint">Derivative time constant (default: 0)</div>
              </div>
              
            </div>
            
            <!-- PID Output Display -->
            <div style="margin-top:25px; padding-top:20px; border-top:1px solid #3a4a5a;">
              <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:12px;">PID OUTPUT SIGNAL</div>
              <div style="display:flex; align-items:center; gap:20px;">
                <div style="flex:1; background:rgba(0,0,0,0.3); border-radius:8px; padding:4px;">
                  <div id="pidOutputBar" style="height:24px; width:0%; background:linear-gradient(90deg, #2ee59d, #7aa7ff); border-radius:6px; transition:width 0.3s;"></div>
                </div>
                <div style="min-width:100px; text-align:right;">
                  <span id="pidOutputVolts" style="color:#fff; font-size:20px; font-weight:700;">0.0</span>
                  <span style="color:#7a8a9a; font-size:14px;">V</span>
                </div>
                <div style="min-width:60px; text-align:right;">
                  <span id="pidOutputPercent" style="color:#7a8a9a; font-size:14px;">(0%)</span>
                </div>
              </div>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn" onclick="loadPIDParams()" style="background:#3a4a5a;">Reload</button>
              <button class="btn" onclick="savePIDParams()">Save Parameters</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ALARMS SUB-TAB -->
      <div id="advancedSubAlarms" style="display:none;">
        <div class="card">
          <h3>Alarm Configuration</h3>
          <div class="small" style="margin-bottom:14px;">Configure alarm thresholds and email notifications</div>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
            <!-- Email Settings -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:12px;">EMAIL NOTIFICATIONS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">SMTP Server</label>
                  <input type="text" id="alarmSmtpServer" placeholder="smtp.gmail.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">SMTP Port</label>
                  <input type="number" id="alarmSmtpPort" value="587" style="width:80px; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">Username</label>
                  <input type="text" id="alarmSmtpUser" placeholder="email@example.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">Password</label>
                  <input type="password" id="alarmSmtpPass" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">From</label>
                  <input type="email" id="alarmFromEmail" placeholder="alerts@smartpitch.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">To</label>
                  <input type="email" id="alarmToEmail" placeholder="operator@example.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <button class="btn" onclick="testAlarmEmail()" style="margin-top:8px; background:#3a4a5a;">Test Email</button>
              </div>
            </div>
            
            <!-- Temperature Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#ffd166; font-weight:700; font-size:12px; margin-bottom:12px;">TEMPERATURE ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPriFlowLowEnabled">
                  <label style="flex:1; font-size:12px;">Primary Flow Low</label>
                  <input type="number" id="alarmPriFlowLowThreshold" value="15" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPriFlowLowDelay" value="60" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPriReturnHighEnabled">
                  <label style="flex:1; font-size:12px;">Primary Return High</label>
                  <input type="number" id="alarmPriReturnHighThreshold" value="45" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPriReturnHighDelay" value="60" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPitchFrozenEnabled">
                  <label style="flex:1; font-size:12px;">Pitch Frozen</label>
                  <input type="number" id="alarmPitchFrozenThreshold" value="1" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPitchFrozenDelay" value="300" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmSecFlowNotReachingEnabled">
                  <label style="flex:1; font-size:12px;">Sec. Flow Not Reaching Setpoint</label>
                  <input type="number" id="alarmSecFlowNotReachingOffset" value="3" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmSecFlowNotReachingDelay" value="900" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
              </div>
            </div>
            
            <!-- Hardware Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#ff6b6b; font-weight:700; font-size:12px; margin-bottom:12px;">HARDWARE ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP1AFaultEnabled" checked> Pump 1A Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP1BFaultEnabled" checked> Pump 1B Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP2AFaultEnabled" checked> Pump 2A Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP2BFaultEnabled" checked> Pump 2B Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmHighLimitEnabled" checked> High Limit Trip</label>
              </div>
            </div>
            
            <!-- Building Protect -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <div style="color:#ff9f43; font-weight:700; font-size:12px;">BUILDING PROTECT</div>
                <div style="display:flex; align-items:center; gap:6px;">
                  <div id="buildingProtectLed" style="width:10px; height:10px; border-radius:50%; background:#555;"></div>
                  <span id="buildingProtectStatus" style="font-size:11px; color:var(--muted);">INACTIVE</span>
                </div>
              </div>
              <div class="small" style="margin-bottom:10px; color:var(--muted);">Closes actuator when primary return is too cold to protect building heating system.</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;">
                  <input type="checkbox" id="buildingProtectEnabled" checked> Enable Building Protect
                </label>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:120px; font-size:12px;">Close Below</label>
                  <input type="number" id="buildingProtectCloseBelowTemp" value="25" style="width:60px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:120px; font-size:12px;">Open Above</label>
                  <input type="number" id="buildingProtectOpenAboveTemp" value="30" style="width:60px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
              </div>
            </div>
            
            <!-- System Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#2ee59d; font-weight:700; font-size:12px; margin-bottom:12px;">SYSTEM ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmCommLossEnabled" checked>
                  <label style="flex:1; font-size:12px;">Communication Loss</label>
                  <input type="number" id="alarmCommLossDelay" value="120" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmSensorFailEnabled" checked> Sensor Failure</label>
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                  <label style="font-size:12px;">Hysteresis</label>
                  <input type="number" id="alarmHysteresis" value="1" step="0.1" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn" onclick="loadAlarmSettings()" style="background:#3a4a5a;">Reload</button>
            <button class="btn" onclick="saveAlarmSettings()">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
  // Hide splash screen after 5 seconds
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    if (splash) {
      splash.classList.add('fade-out');
      setTimeout(() => {
        splash.style.display = 'none';
        // Reload chart data after splash screen is gone to ensure proper rendering
        safeRefresh().then(() => {
          if (trendChart) trendChart.resize();
          if (forecastChart) forecastChart.resize();
        });
      }, 800);
    }
  }, 5000);

  let trendChart = null;
  let forecastChart = null;
  let lastHeatOn = [];

  let showTemp = false;
  let showFeels = true;

  
  
  let schematicInterval = null;
  let plcInterval = null;
  let pidInterval = null;
  
  function startPLCRefresh() {
    if(!plcInterval) {
      plcInterval = setInterval(updatePLCDisplay, 2000);
    }
  }
  
  function stopPLCRefresh() {
    if(plcInterval) {
      clearInterval(plcInterval);
      plcInterval = null;
    }
  }
  // Update PLC Monitor display with current I/O states
  function updatePLCDisplay() {
    Promise.all([
      fetch('/api/status').then(r => r.json()),
      fetch('/api/manual/state').then(r => r.json()),
      fetch('/api/settings/pitch_selection').then(r => r.json()).catch(() => ({ value: 'both' }))
    ]).then(([status, manual, pitchSetting]) => {
      const t = status.latest_trend || {};
      const overrideOn = manual.override_enabled;
      const pitchValue = pitchSetting.value || 'both';
      
      // Helper to set text content safely
      const setVal = (id, val) => { 
        const el = document.getElementById(id); 
        if(el) el.textContent = val; 
      };
      
      // Helper to set LED state
      const setLed = (id, on) => {
        const el = document.getElementById(id);
        if(el) el.style.background = on ? '#4CAF50' : '#555';
      };
      
      // Update wish temperature displays
      const wishTemp = status.wish_temp;
      const forecastAvg = status.forecast_avg;
      const hcFlow = document.getElementById('hcCurrentFlow');
      if (hcFlow && wishTemp !== null && wishTemp !== undefined) {
        hcFlow.textContent = wishTemp + 'C';
      }
      const schWish = document.getElementById('schWishTemp');
      if (schWish && wishTemp !== null && wishTemp !== undefined) {
        schWish.textContent = wishTemp;
      }
      const schForecast = document.getElementById('schForecastAvg');
      if (schForecast && forecastAvg !== null && forecastAvg !== undefined) {
        schForecast.textContent = typeof forecastAvg === 'number' ? forecastAvg.toFixed(1) : forecastAvg;
      }
      
      // Determine values based on override state
      let ao1Val, ao2Val, ao3Val, ao4Val;
      let do1, do2, do3, do4, do5, do6;
      
      if (overrideOn) {
        // Manual override ON - use manual values
        ao1Val = manual.ao1 ?? 0;
        ao2Val = manual.ao2_enabled ? (manual.ao2 ?? 0) : 0;
        ao3Val = manual.ao3_enabled ? (manual.ao3 ?? 0) : 0;
        ao4Val = manual.ao4_enabled ? (manual.ao4 ?? 0) : 0;
        do1 = manual.do1;
        do2 = manual.do2;
        do3 = manual.do3;
        do4 = manual.do4;
        do5 = manual.do5;
        do6 = manual.do6;
      } else {
        // Manual override OFF - use control system values with pitch selection
        const heatOn = t.heat_enabled || false;
        // Calculate proportional valve output (same as schematic)
        if (heatOn) {
          const wishTemp = status.wish_temp ?? 16;
          const secFlow = t.sec_flow_c ?? 18;
          const error = wishTemp - secFlow;
          const kp = 5;
          ao1Val = 50 + (error * kp);
          ao1Val = Math.max(0, Math.min(100, ao1Val));
          ao1Val = Math.round(ao1Val);
        } else {
          ao1Val = 0;
        }
        ao2Val = heatOn && (pitchValue === 'both' || pitchValue === 'pitch1') ? 100 : 0;  // Pump 1
        ao3Val = heatOn && (pitchValue === 'both' || pitchValue === 'pitch2') ? 100 : 0;  // Pump 2
        ao4Val = 0;
        do1 = false;  // Common alarm
        do2 = heatOn; // Primary heat demand
        do3 = false;  // AutoFrost status
        do4 = false;  // Reset
        do5 = true;   // Watchdog (always on when running)
        do6 = false;  // Spare
      }
      
      // Update Analog Outputs
      setVal('plcAO1', ao1Val + '%');
      setVal('plcAO2', ao2Val + '%');
      setVal('plcAO3', ao3Val + '%');
      setVal('plcAO4', ao4Val + '%');
      
      // Update Analog Inputs (from sensor data)
      setVal('plcAI1', (t.sec_flow_c != null) ? t.sec_flow_c.toFixed(1) + '\u00B0C' : '--\u00B0C');
      setVal('plcAI2', (t.sec_return_c != null) ? t.sec_return_c.toFixed(1) + '\u00B0C' : '--\u00B0C');
      setVal('plcAI3', (t.outside_temp_c != null) ? t.outside_temp_c.toFixed(1) + '\u00B0C' : '--\u00B0C');
      setVal('plcAI4', (t.avg_field_8cm_c != null) ? t.avg_field_8cm_c.toFixed(1) + '\u00B0C' : '--\u00B0C');
      
      // Update Digital Outputs (LEDs)
      setLed('plcDO1', do1);
      setLed('plcDO2', do2);
      setLed('plcDO3', do3);
      setLed('plcDO4', do4);
      setLed('plcDO5', do5);
      setLed('plcDO6', do6);
      
      // Update Digital Inputs - Pitch selection status
      const pitch1Enabled = (pitchValue === 'both' || pitchValue === 'pitch1');
      const pitch2Enabled = (pitchValue === 'both' || pitchValue === 'pitch2');
      setLed('plcDI1', pitch1Enabled);  // Pitch 1 Enabled
      setLed('plcDI2', pitch2Enabled);  // Pitch 2 Enabled
      setLed('plcDI3', false);  // P1 Pump A Fault
      setLed('plcDI4', false);  // High Limit
      
    
      // Update slope intervention indicator
      const slopeRow = document.getElementById('slopeInterventionRow');
      const slopeDot = document.getElementById('slopeInterventionDot');
      const slopeText = document.getElementById('slopeInterventionText');
      const sessionActive = status.session_active === true;
      const slopeIntervened = status.slope_intervened === true;
      const slopeAdjustment = status.slope_adjustment_total || 0;
      
      if (slopeRow) {
        if (sessionActive && slopeIntervened) {
          slopeRow.style.display = 'flex';
          slopeRow.className = 'slope-indicator active';
          if (slopeText) slopeText.textContent = 'Intervened (' + slopeAdjustment.toFixed(1) + 'C)';
        } else if (sessionActive) {
          slopeRow.style.display = 'flex';
          slopeRow.className = 'slope-indicator on-track';
          if (slopeText) slopeText.textContent = 'On Track';
        } else {
          slopeRow.style.display = 'none';
        }
      }
      
      // Update Building Protect status indicator
      const bpActive = status.building_protect_active === true;
      const bpLed = document.getElementById('buildingProtectLed');
      const bpStatus = document.getElementById('buildingProtectStatus');
      if (bpLed) {
        bpLed.style.background = bpActive ? '#ff9f43' : '#555';
        bpLed.style.boxShadow = bpActive ? '0 0 8px rgba(255,159,67,0.6)' : 'none';
      }
      if (bpStatus) {
        bpStatus.textContent = bpActive ? 'ACTIVE' : 'INACTIVE';
        bpStatus.style.color = bpActive ? '#ff9f43' : 'var(--muted)';
      }
\n    }).catch(e => console.error('PLC display error:', e));
  }

  
  function updateSchematic() {
    Promise.all([
      fetch('/api/status').then(r=>r.json()),
      fetch('/api/manual/state').then(r=>r.json()),
      fetch('/api/settings/pitch_selection').then(r=>r.json()).catch(()=>({value:'both'}))
    ]).then(([status, manual, pitchSetting]) => {
      const pitchValue = pitchSetting.value || 'both';
      const t = status.latest_trend || {};
      const overrideOn = manual.override_enabled;
      
      const setVal = (id, val) => { 
        const el = document.getElementById(id); 
        if(el) el.textContent = (typeof val === 'number') ? val.toFixed(1) : (val ?? '--'); 
      };
      
      // Ambient temp (1 decimal place)
      setVal('schAmbientTemp', t.outside_temp_c ?? 6.5);
      
      // Primary circuit temps
      setVal('schPriFlow', t.pri_flow_c ?? 72.0);
      setVal('schPriReturn', t.pri_return_c ?? 62.0);
      
      // Secondary circuit - test values: flow 18, return 8
      setVal('schSecFlow', t.sec_flow_c ?? 18.0);
      setVal('schSecReturn', t.sec_return_c ?? 8.0);
      // When override is OFF, use control system values; when ON, use manual values
      if(overrideOn) {
        // Manual override ON - use manual values
        setVal('schValvePos', manual.ao1 ?? 0);
        
        const bmsLed = document.getElementById('schBmsLed');
        if(bmsLed) bmsLed.style.background = manual.do2 ? '#4CAF50' : '#555';
        
        const pump1On = (manual.ao2 ?? 0) > 0 && manual.ao2_enabled;
        const pump2On = (manual.ao3 ?? 0) > 0 && manual.ao3_enabled;
        const p1a = document.getElementById('schPump1A');
        const p1b = document.getElementById('schPump1B');
        const p2a = document.getElementById('schPump2A');
        const p2b = document.getElementById('schPump2B');
        if(p1a) p1a.querySelector('div').style.background = pump1On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p1b) p1b.querySelector('div').style.background = pump1On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p2a) p2a.querySelector('div').style.background = pump2On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p2b) p2b.querySelector('div').style.background = pump2On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
      } else {
        // Manual override OFF - use control system values with pitch selection
        const heatOn = t.heat_enabled || false;
        // Calculate valve position based on wish temp vs actual flow
        const wishTemp = status.wish_temp ?? 16;
        const secFlow = t.sec_flow_c ?? 18;
        
        let valvePos = 0;
        if (heatOn) {
          // Simple proportional control: error = wish - actual
          // If secFlow < wish, need more heat (open valve)
          // If secFlow > wish, need less heat (close valve)
          const error = wishTemp - secFlow;
          // Proportional gain - adjust valve based on error
          // +10 error = +50% valve, -10 error = -50% valve
          const kp = 5; // 5% per degree error
          valvePos = 50 + (error * kp); // Base at 50%, adjust by error
          valvePos = Math.max(0, Math.min(100, valvePos)); // Clamp 0-100
        }
        setVal('schValvePos', Math.round(valvePos));
        
        const bmsLed = document.getElementById('schBmsLed');
        if(bmsLed) bmsLed.style.background = heatOn ? '#4CAF50' : '#555';
        
        // Determine which pumps should run based on pitch selection
        const pump1On = heatOn && (pitchValue === 'both' || pitchValue === 'pitch1');
        const pump2On = heatOn && (pitchValue === 'both' || pitchValue === 'pitch2');
        
        const p1a = document.getElementById('schPump1A');
        const p1b = document.getElementById('schPump1B');
        const p2a = document.getElementById('schPump2A');
        const p2b = document.getElementById('schPump2B');
        if(p1a) p1a.querySelector('div').style.background = pump1On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p1b) p1b.querySelector('div').style.background = pump1On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p2a) p2a.querySelector('div').style.background = pump2On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
        if(p2b) p2b.querySelector('div').style.background = pump2On ? 'radial-gradient(circle at 30% 30%,#90EE90,#228B22)' : 'radial-gradient(circle at 30% 30%,#666,#333)';
      }
      
      // Pitch sensors - using field temps
      const f8 = t.avg_field_8cm_c ?? 6.0;  // Test value: 6C at -8cm
      const f25 = t.avg_field_25cm_c ?? 8.5;  // Test value: 8.5C at -25cm
      // Corners (8 sensors at -8cm)
      setVal('schP1TL', f8);
      setVal('schP1TR', f8);
      setVal('schP1BL', f8);
      setVal('schP1BR', f8);
      setVal('schP2TL', f8);
      setVal('schP2TR', f8);
      setVal('schP2BL', f8);
      setVal('schP2BR', f8);
      // Centre spots (2 sensors at -25cm)
      setVal('schP1C', f25);
      setVal('schP2C', f25);
      
    }).catch(e=>console.error('Schematic error:',e));
  }
  
  function startSchematicRefresh() {
    if(!schematicInterval) {
      schematicInterval = setInterval(updateSchematic, 2000);
    }
  }
  
  function stopSchematicRefresh() {
    if(schematicInterval) {
      clearInterval(schematicInterval);
      schematicInterval = null;
    }
  }


  function updateModeVisuals(mode) {
    const card = document.getElementById('modeCard');
    const bg = document.getElementById('smartpitchBg');
    const title = document.getElementById('modeTitle');
    const subtitle = document.getElementById('modeSubtitle');
    const spBtn = document.getElementById('btnSMARTPITCH');
    const modePanel = document.querySelector('.mode-panel');
    
    if(mode==='SMARTPITCH'){
      if(card)card.classList.add('smartpitch-active');
      if(bg)bg.classList.add('active');
      if(spBtn)spBtn.classList.add('selected');
      if(title)title.textContent='SmartPitch AI Active';
      if(subtitle)subtitle.textContent='Intelligent frost protection enabled';
      
      // Initialize visual effects for SmartPitch mode
      if (typeof startNeuralAnimation === 'function') {
        startNeuralAnimation();
      }
      
      // Add hex grid if not exists
      if (modePanel && !document.querySelector('.hex-grid')) {
        const hexGrid = document.createElement('div');
        hexGrid.className = 'hex-grid active';
        modePanel.insertBefore(hexGrid, modePanel.firstChild);
      }
    }else if(mode==='BUILDING_PROTECT'){
      if(card){
        card.classList.remove('smartpitch-active');
        card.classList.add('building-protect-active');
      }
      if(bg)bg.classList.remove('active');
      if(spBtn)spBtn.classList.remove('selected');
      if(title){
        title.textContent='BUILDING PROTECT';
        title.style.color='#ff9f43';
      }
      if(subtitle){
        subtitle.textContent='Actuator closed - primary return too cold';
        subtitle.style.color='#ff9f43';
      }
      
      if (typeof stopNeuralAnimation === 'function') {
        stopNeuralAnimation();
      }
      const hexGrid = document.querySelector('.hex-grid');
      if (hexGrid) hexGrid.remove();
    }else{
      if(card){
        card.classList.remove('smartpitch-active');
        card.classList.remove('building-protect-active');
      }
      if(bg)bg.classList.remove('active');
      if(spBtn)spBtn.classList.remove('selected');
      if(title){
        title.textContent='Select Operating Mode';
        title.style.color='';
      }
      if(subtitle){
        subtitle.textContent='Choose how the system controls pitch heating';
        subtitle.style.color='';
      }
      
      // Stop neural animation for non-SmartPitch modes
      if (typeof stopNeuralAnimation === 'function') {
        stopNeuralAnimation();
      }
      
      // Remove hex grid
      const hexGrid = document.querySelector('.hex-grid');
      if (hexGrid) hexGrid.remove();
    }
  }

function showHeatingSub(sub) {
    const mode = document.getElementById('heatingSubMode');
    const curve = document.getElementById('heatingSubCurve');
    const schematic = document.getElementById('heatingSubSchematic');
    const settings = document.getElementById('heatingSubSettings');
    const frostcam = document.getElementById('heatingSubFrostcam');
    const advisory = document.getElementById('heatingSubAdvisory');
    const btnMode = document.getElementById('subHeatingMode');
    const btnCurve = document.getElementById('subHeatingCurve');
    const btnSchematic = document.getElementById('subHeatingSchematic');
    const btnSettings = document.getElementById('subHeatingSettings');
    const btnFrostCam = document.getElementById('subHeatingFrostCam');
    const btnAdvisory = document.getElementById('subHeatingAdvisory');
    
    // Hide all sub-tabs with both display and visibility
    [mode, curve, schematic, settings, frostcam, advisory].forEach(el => {
      if(el) { el.style.display = 'none'; el.style.visibility = 'hidden'; }
    });
    if(btnMode) btnMode.classList.remove('active');
    if(btnCurve) btnCurve.classList.remove('active');
    if(btnSchematic) btnSchematic.classList.remove('active');
    if(btnSettings) btnSettings.classList.remove('active');
    if(btnFrostCam) btnFrostCam.classList.remove('active');
    if(btnAdvisory) btnAdvisory.classList.remove('active');
    
    stopSchematicRefresh();
    stopFrostStatusRefresh();
    stopFrostCamRefresh();
    
    if(sub === 'mode') {
      if(mode) { mode.style.display = 'block'; mode.style.visibility = 'visible'; }
      if(btnMode) btnMode.classList.add('active');
    } else if(sub === 'curve') {
      if(curve) { curve.style.display = 'block'; curve.style.visibility = 'visible'; }
      if(btnCurve) btnCurve.classList.add('active');
      loadHeatCurve();
    } else if(sub === 'schematic') {
      if(schematic) { schematic.style.display = 'block'; schematic.style.visibility = 'visible'; }
      if(btnSchematic) btnSchematic.classList.add('active');
      startSchematicRefresh();
    } else if(sub === 'settings') {
      if(settings) { settings.style.display = 'block'; settings.style.visibility = 'visible'; }
      if(btnSettings) btnSettings.classList.add('active');
    } else if(sub === 'frostcam') {
      if(frostcam) { frostcam.style.display = 'block'; frostcam.style.visibility = 'visible'; }
      if(btnFrostCam) btnFrostCam.classList.add('active');
      startFrostCamRefresh();
      startFrostStatusRefresh();
    } else if(sub === 'advisory') {
      if(advisory) { advisory.style.display = 'block'; advisory.style.visibility = 'visible'; }
      if(btnAdvisory) btnAdvisory.classList.add('active');
      loadAdvisory();
    }
  }

  let frostStatusInterval = null;
  
  async function loadFrostDetect() {
    try {
      const res = await fetch('/api/frost/settings');
      const data = await res.json();
      
      // Clear existing ROI boxes
      const container = document.getElementById('frostRoiContainer');
      if (container) container.innerHTML = '';
      roiCounter = 0;
      
      // Load ROIs - use rois array if available, otherwise fall back to single roi
      const rois = data.rois || [data.roi || { x: 10, y: 10, width: 80, height: 80, rotation: 0 }];
      
      // Store first ROI in hidden inputs for backward compatibility
      if (rois.length > 0) {
        document.getElementById('fdRoiX').value = rois[0].x || 10;
        document.getElementById('fdRoiY').value = rois[0].y || 10;
        document.getElementById('fdRoiW').value = rois[0].width || 80;
        document.getElementById('fdRoiH').value = rois[0].height || 80;
      }
      
      // Create ROI boxes (but hidden initially)
      rois.forEach(roi => {
        const box = createRoiBox(roi);
        if (box) box.style.display = 'none';
      });
      
      document.getElementById('fdSatTh').value = data.thresholds?.saturation || 40;
      document.getElementById('fdBrightTh').value = data.thresholds?.brightness || 150;
      document.getElementById('fdSampleInt').value = data.timing?.sampleInterval || 2;
      document.getElementById('fdSmooth').value = data.timing?.smoothingWindow || 10;
      document.getElementById('fdDelay').value = data.timing?.stateChangeDelay || 30;
      document.getElementById('fdAutoDN').checked = data.mode?.autoDayNight !== false;
      document.getElementById('fdNightBr').checked = data.mode?.nightBrightnessOnly !== false;
    } catch(e) { console.error('Load frost settings:', e); }
  }
  
  async function saveFrostDetect() {
    try {
      const roiBoxes = [];
      document.querySelectorAll('.frost-roi-box').forEach((box, i) => {
        const feed = document.getElementById('frostCamFeed');
        roiBoxes.push({
          x: Math.round((box.offsetLeft / feed.offsetWidth) * 100),
          y: Math.round((box.offsetTop / feed.offsetHeight) * 100),
          width: Math.round((box.offsetWidth / feed.offsetWidth) * 100),
          height: Math.round((box.offsetHeight / feed.offsetHeight) * 100),
          rotation: parseInt(box.dataset.rotation) || 0
        });
      });
      // Use first box for main ROI (backward compatible), store all in rois array
      const mainRoi = roiBoxes[0] || { x: 10, y: 10, width: 80, height: 80, rotation: 0 };
      await fetch('/api/frost/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roi: mainRoi,
          rois: roiBoxes,
          thresholds: { saturation: parseInt(document.getElementById('fdSatTh').value)||40, brightness: parseInt(document.getElementById('fdBrightTh').value)||150 },
          timing: { sampleInterval: parseInt(document.getElementById('fdSampleInt').value)||2, smoothingWindow: parseInt(document.getElementById('fdSmooth').value)||10, stateChangeDelay: parseInt(document.getElementById('fdDelay').value)||30 },
          mode: { autoDayNight: document.getElementById('fdAutoDN').checked, nightBrightnessOnly: document.getElementById('fdNightBr').checked }
        })
      });
      // Hide all ROI boxes after saving
      document.querySelectorAll('.frost-roi-box').forEach(b => b.style.display = 'none');
      roiEditMode = false;
    } catch(e) { console.error('Save frost:', e); }
  }
  
  async function updateFrostStatus() {
    try {
      const res = await fetch('/api/frost/status');
      const data = await res.json();
      const s = document.getElementById('fdStatus');
      if(s) { s.textContent = data.frostDetected ? 'FROST' : 'CLEAR'; s.style.color = data.frostDetected ? '#ff6b6b' : '#2ee59d'; }
      const c = document.getElementById('fdConf'); if(c) c.textContent = (data.confidence||0).toFixed(0)+'%';
      const sat = document.getElementById('fdSat'); if(sat) sat.textContent = (data.saturation||0).toFixed(1);
      const br = document.getElementById('fdBright'); if(br) br.textContent = (data.brightness||0).toFixed(1);
      const m = document.getElementById('fdMode'); if(m) m.textContent = data.isNightMode ? 'NIGHT' : 'DAY';
      const b = document.getElementById('frostBadge'); if(b) { b.textContent = data.frostDetected ? 'FROST' : 'CLEAR'; b.style.color = data.frostDetected ? '#ff6b6b' : '#2ee59d'; }
    } catch(e) {}
  }
  
  function startFrostStatusRefresh() { if(frostStatusInterval) return; updateFrostStatus(); loadFrostDetect(); frostStatusInterval = setInterval(updateFrostStatus, 2000); }
  function stopFrostStatusRefresh() { if(frostStatusInterval) { clearInterval(frostStatusInterval); frostStatusInterval = null; } }
  
  let roiDragging=false, roiResizing=false, roiCorner=null, roiStartX, roiStartY, roiStartLeft, roiStartTop, roiStartW, roiStartH;
  
  function initRoiBoxEvents(box) {
    const feed = document.getElementById('frostCamFeed');
    if (!box || !feed) return;
    
    let dragging = false, resizing = false, rotating = false;
    let startX, startY, startLeft, startTop, startW, startH, startAngle, corner;
    
    box.addEventListener('mousedown', e => {
      if (e.target.classList.contains('roi-handle') || e.target.classList.contains('roi-rotate') || e.target.classList.contains('roi-delete')) return;
      e.preventDefault();
      dragging = true;
      startX = e.clientX; startY = e.clientY;
      startLeft = box.offsetLeft; startTop = box.offsetTop;
      activeRoiBox = box;
    });
    
    box.querySelectorAll('.roi-handle').forEach(h => {
      h.addEventListener('mousedown', e => {
        e.preventDefault(); e.stopPropagation();
        resizing = true; corner = h.dataset.corner;
        startX = e.clientX; startY = e.clientY;
        startLeft = box.offsetLeft; startTop = box.offsetTop;
        startW = box.offsetWidth; startH = box.offsetHeight;
        activeRoiBox = box;
      });
    });
    
    const rotHandle = box.querySelector('.roi-rotate');
    if (rotHandle) {
      rotHandle.addEventListener('mousedown', e => {
        e.preventDefault(); e.stopPropagation();
        rotating = true;
        const rect = box.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        startAngle = Math.atan2(e.clientY - cy, e.clientX - cx) * 180 / Math.PI;
        activeRoiBox = box;
      });
    }
    
    const onMove = e => {
      if (!dragging && !resizing && !rotating) return;
      const dx = e.clientX - startX, dy = e.clientY - startY;
      
      if (dragging) {
        box.style.left = Math.max(0, Math.min(startLeft + dx, feed.offsetWidth - box.offsetWidth)) + 'px';
        box.style.top = Math.max(0, Math.min(startTop + dy, feed.offsetHeight - box.offsetHeight)) + 'px';
      }
      
      if (resizing) {
        let l = startLeft, t = startTop, w = startW, h = startH;
        if (corner.includes('e')) w = Math.max(30, startW + dx);
        if (corner.includes('w')) { w = Math.max(30, startW - dx); l = startLeft + dx; }
        if (corner.includes('s')) h = Math.max(30, startH + dy);
        if (corner.includes('n')) { h = Math.max(30, startH - dy); t = startTop + dy; }
        if (l < 0) { w += l; l = 0; }
        if (t < 0) { h += t; t = 0; }
        if (l + w > feed.offsetWidth) w = feed.offsetWidth - l;
        if (t + h > feed.offsetHeight) h = feed.offsetHeight - t;
        box.style.left = l + 'px'; box.style.top = t + 'px';
        box.style.width = w + 'px'; box.style.height = h + 'px';
      }
      
      if (rotating) {
        const rect = box.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const angle = Math.atan2(e.clientY - cy, e.clientX - cx) * 180 / Math.PI;
        const currentRot = parseInt(box.dataset.rotation) || 0;
        const newRot = Math.round((currentRot + (angle - startAngle)) / 5) * 5; // Snap to 5 degrees
        box.dataset.rotation = newRot;
        box.style.transform = 'rotate(' + newRot + 'deg)';
        startAngle = angle;
      }
    };
    
    const onUp = () => {
      dragging = resizing = rotating = false;
      corner = null;
      // Update hidden inputs with first box values
      const firstBox = document.querySelector('.frost-roi-box');
      if (firstBox) {
        document.getElementById('fdRoiX').value = Math.round((firstBox.offsetLeft / feed.offsetWidth) * 100);
        document.getElementById('fdRoiY').value = Math.round((firstBox.offsetTop / feed.offsetHeight) * 100);
        document.getElementById('fdRoiW').value = Math.round((firstBox.offsetWidth / feed.offsetWidth) * 100);
        document.getElementById('fdRoiH').value = Math.round((firstBox.offsetHeight / feed.offsetHeight) * 100);
      }
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  }
  
  
  
  let roiEditMode = false;
  let roiCounter = 0;
  let activeRoiBox = null;
  
  function createRoiBox(roi = null) {
    const container = document.getElementById('frostRoiContainer');
    const feed = document.getElementById('frostCamFeed');
    if (!container || !feed) return null;
    
    const box = document.createElement('div');
    box.className = 'frost-roi-box';
    box.id = 'roiBox_' + (roiCounter++);
    box.dataset.rotation = roi?.rotation || 0;
    box.style.cssText = 'position:absolute; border:2px dashed #2ee59d; cursor:move; display:block; min-width:30px; min-height:30px;';
    box.style.left = (roi?.x || 10) + '%';
    box.style.top = (roi?.y || 10) + '%';
    box.style.width = (roi?.width || 30) + '%';
    box.style.height = (roi?.height || 30) + '%';
    box.style.transform = 'rotate(' + (roi?.rotation || 0) + 'deg)';
    
    // Corner handles
    ['nw','ne','sw','se'].forEach(corner => {
      const h = document.createElement('div');
      h.className = 'roi-handle';
      h.dataset.corner = corner;
      const pos = { nw: 'top:-5px;left:-5px;cursor:nw-resize;', ne: 'top:-5px;right:-5px;cursor:ne-resize;', sw: 'bottom:-5px;left:-5px;cursor:sw-resize;', se: 'bottom:-5px;right:-5px;cursor:se-resize;' };
      h.style.cssText = 'position:absolute;width:10px;height:10px;background:#2ee59d;' + pos[corner];
      box.appendChild(h);
    });
    
    // Rotation handle
    const rotHandle = document.createElement('div');
    rotHandle.className = 'roi-rotate';
    rotHandle.style.cssText = 'position:absolute;top:-25px;left:50%;transform:translateX(-50%);width:16px;height:16px;background:#ff9500;border-radius:50%;cursor:grab;';
    rotHandle.title = 'Drag to rotate';
    box.appendChild(rotHandle);
    
    // Delete button
    const delBtn = document.createElement('div');
    delBtn.className = 'roi-delete';
    delBtn.innerHTML = '&times;';
    delBtn.style.cssText = 'position:absolute;top:-8px;right:-8px;width:18px;height:18px;background:#ff4444;color:#fff;border-radius:50%;font-size:14px;line-height:16px;text-align:center;cursor:pointer;font-weight:bold;';
    delBtn.onclick = (e) => { e.stopPropagation(); box.remove(); };
    box.appendChild(delBtn);
    
    // Box number label
    const label = document.createElement('div');
    label.className = 'roi-label';
    label.style.cssText = 'position:absolute;bottom:2px;left:2px;background:rgba(0,0,0,0.7);color:#2ee59d;font-size:10px;padding:1px 4px;border-radius:2px;';
    label.textContent = 'ROI ' + roiCounter;
    box.appendChild(label);
    
    container.appendChild(box);
    initRoiBoxEvents(box);
    return box;
  }
  
  function toggleRoiBox() {
    roiEditMode = !roiEditMode;
    const boxes = document.querySelectorAll('.frost-roi-box');
    if (roiEditMode) {
      if (boxes.length === 0) {
        // Create initial box from saved settings
        const roi = {
          x: parseInt(document.getElementById('fdRoiX')?.value) || 10,
          y: parseInt(document.getElementById('fdRoiY')?.value) || 10,
          width: parseInt(document.getElementById('fdRoiW')?.value) || 80,
          height: parseInt(document.getElementById('fdRoiH')?.value) || 80,
          rotation: 0
        };
        createRoiBox(roi);
      } else {
        boxes.forEach(b => b.style.display = 'block');
      }
    } else {
      boxes.forEach(b => b.style.display = 'none');
    }
  }
  
  function addRoiBox() {
    if (!roiEditMode) toggleRoiBox();
    createRoiBox({ x: 20, y: 20, width: 25, height: 25, rotation: 0 });
  }

  let frostCamActive = false;
  let frostCamTimer = null;
  
  function isFrostCamTabVisible() {
    const heatingPanel = document.getElementById('panelHeating');
    const frostcamPanel = document.getElementById('heatingSubFrostcam');
    return heatingPanel && heatingPanel.style.display !== 'none' &&
           frostcamPanel && frostcamPanel.style.display !== 'none';
  }
  
  function startFrostCamRefresh() {
    if (frostCamActive) return;
    if (!isFrostCamTabVisible()) return;
    
    const feed = document.getElementById('frostCamFeed');
    if (!feed) return;
    
    // Remove any stale image first
    const oldImg = document.getElementById('frostCamImg');
    if (oldImg) {
      oldImg.src = '';
      oldImg.remove();
    }
    
    // Create fresh image element
    const img = document.createElement('img');
    img.id = 'frostCamImg';
    img.style.cssText = 'max-width:100%; max-height:450px; display:block;';
    feed.insertBefore(img, feed.firstChild);
    
    feed.style.display = 'flex';
    frostCamActive = true;
    doFrostCamRefresh();
  }
  
  function doFrostCamRefresh() {
    if (!frostCamActive || !isFrostCamTabVisible()) {
      stopFrostCamRefresh();
      return;
    }
    
    const img = document.getElementById('frostCamImg');
    const feed = document.getElementById('frostCamFeed');
    
    // Extra safety: ensure img is still inside frostCamFeed
    if (img && feed && img.parentElement === feed) {
      img.src = '/api/camera/snapshot?t=' + Date.now();
    }
    
    if (frostCamActive) {
      frostCamTimer = setTimeout(doFrostCamRefresh, 3000);
    }
  }
  
  function stopFrostCamRefresh() {
    frostCamActive = false;
    if (frostCamTimer) {
      clearTimeout(frostCamTimer);
      frostCamTimer = null;
    }
    // Clear and remove the image element
    const img = document.getElementById('frostCamImg');
    if (img) {
      img.src = '';
      img.remove();
    }
    // Hide the feed container
    const feed = document.getElementById('frostCamFeed');
    if (feed) feed.style.display = 'none';
  }

  function showAdvancedSub(sub) {
    const plc = document.getElementById('advancedSubPLC');
    const manual = document.getElementById('advancedSubManual');
    const modbus = document.getElementById('advancedSubModbus');
    const params = document.getElementById('advancedSubParameters');
    const alarms = document.getElementById('advancedSubAlarms');
    const btnPLC = document.getElementById('subPLCMonitor');
    const btnManual = document.getElementById('subManualControl');
    const btnModbus = document.getElementById('subModbusDevices');
    const btnParams = document.getElementById('subParameters');
    const btnAlarms = document.getElementById('subAlarms');
    
    if(plc) plc.style.display = 'none';
    if(manual) manual.style.display = 'none';
    if(modbus) modbus.style.display = 'none';
    if(params) params.style.display = 'none';
    if(alarms) alarms.style.display = 'none';
    if(btnPLC) btnPLC.classList.remove('active');
    if(btnManual) btnManual.classList.remove('active');
    if(btnModbus) btnModbus.classList.remove('active');
    if(btnParams) btnParams.classList.remove('active');
    if(btnAlarms) btnAlarms.classList.remove('active');
    
    if(sub === 'plc') {
      if(plc) plc.style.display = 'block';
      if(btnPLC) btnPLC.classList.add('active');
    } else if(sub === 'manual') {
      if(manual) manual.style.display = 'block';
      if(btnManual) btnManual.classList.add('active');
    } else if(sub === 'modbus') {
      if(modbus) modbus.style.display = 'block';
      if(btnModbus) btnModbus.classList.add('active');
    } else if(sub === 'parameters') {
      if(params) params.style.display = 'block';
      if(btnParams) btnParams.classList.add('active');
    } else if(sub === 'alarms') {
      if(alarms) alarms.style.display = 'block';
      if(btnAlarms) btnAlarms.classList.add('active');
      loadAlarmSettings();
    }
  }


  function showTab(name){
    const tabs = ["Dashboard","Forecast","Schedule","Heating","Data","Advanced"];
    tabs.forEach(t=>{
      const p = document.getElementById("panel"+t);
      const b = document.getElementById("tab"+t);
      if (p) p.style.display = (t===name) ? "block" : "none";
      if (b) b.classList.toggle("active", t===name);
    });

    // Stop heating sub-tab refreshes and hide sub-tabs when leaving Heating tab
    if(name !== "Heating") {
      stopFrostCamRefresh();
      stopFrostStatusRefresh();
      stopSchematicRefresh();
    }
    
    // Initialize Data tab content when shown
    if(name === "Data") {
      showDataSub(dataSub || 'trend');
    }
  }

  function setText(id,v){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (v===null||v===undefined||v==="") ? "" : v;
  }
  function setLed(id, on){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle("on", !!on);
  }
  function showErr(id, msg){
    const el = document.getElementById(id);
    if(!el) return;
    if(!msg){
      el.style.display = "none";
      el.textContent = "";
    } else {
      el.style.display = "block";
      el.textContent = msg;
    }
  }
  function showWarn(id, msg){
    const el = document.getElementById(id);
    if(!el) return;
    if(!msg){
      el.style.display = "none";
      el.textContent = "";
    } else {
      el.style.display = "block";
      el.textContent = msg;
    }
  }

  function fmtAxisDateTime(iso){
    if(!iso) return "";
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return dd + "/" + mm + " " + hh + ":" + mi;
  }
  function fmtShort(iso){
    if(!iso) return "";
    const d = new Date(iso);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return hh + ":" + mi;
  }
  function fmtDateShort(iso){
    if(!iso) return "";
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    return dd + "/" + mm + "/" + yy;
  }

  const heatShadePlugin = {
    id: 'heatShade',
    beforeDatasetsDraw(chart){
      const heatOn = lastHeatOn || [];
      if(!heatOn.length) return;
      const ctx = chart.ctx;
      const chartArea = chart.chartArea;
      const x = chart.scales.x;
      if(!chartArea || !x) return;

      ctx.save();
      
      // Find continuous heating regions for proper edge fading
      const regions = [];
      let regionStart = -1;
      for(let i=0; i<=heatOn.length; i++){
        if(heatOn[i] && regionStart === -1) {
          regionStart = i;
        } else if(!heatOn[i] && regionStart !== -1) {
          regions.push({start: regionStart, end: i-1});
          regionStart = -1;
        }
      }
      
      const fadeWidth = 15; // pixels to fade on each side
      const height = chartArea.bottom - chartArea.top;
      
      for(const region of regions) {
        const x1 = x.getPixelForValue(region.start);
        const x2 = x.getPixelForValue(Math.min(region.end + 1, heatOn.length - 1));
        const w = Math.max(1, x2 - x1);
        
        // Create a temporary canvas for this region with 4-way fade
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill with vertical gradient first
        const vGrad = tempCtx.createLinearGradient(0, 0, 0, height);
        vGrad.addColorStop(0, 'rgba(255,255,255,0)');
        vGrad.addColorStop(0.25, 'rgba(255,255,255,0.15)');
        vGrad.addColorStop(0.5, 'rgba(255,255,255,0.18)');
        vGrad.addColorStop(0.75, 'rgba(255,255,255,0.15)');
        vGrad.addColorStop(1, 'rgba(255,255,255,0)');
        tempCtx.fillStyle = vGrad;
        tempCtx.fillRect(0, 0, w, height);
        
        // Apply horizontal fade using destination-in compositing
        tempCtx.globalCompositeOperation = 'destination-in';
        const hGrad = tempCtx.createLinearGradient(0, 0, w, 0);
        const edgeFade = Math.min(fadeWidth / w, 0.3);
        hGrad.addColorStop(0, 'rgba(255,255,255,0)');
        hGrad.addColorStop(edgeFade, 'rgba(255,255,255,1)');
        hGrad.addColorStop(1 - edgeFade, 'rgba(255,255,255,1)');
        hGrad.addColorStop(1, 'rgba(255,255,255,0)');
        tempCtx.fillStyle = hGrad;
        tempCtx.fillRect(0, 0, w, height);
        
        // Draw the composited region onto main canvas
        ctx.drawImage(tempCanvas, x1, chartArea.top);
      }
      ctx.restore();
    }
  };

  function ensureTrendChart(labels, outside, field8){
    const ctx = document.getElementById("trendChart");
    if(!trendChart){
      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            { label: "Outside C", data: outside, tension: 0.25, pointRadius: 0, borderWidth: 2, borderColor: '#7aa7ff' },
            { label: "Avg Field 8cm C", data: field8, tension: 0.25, pointRadius: 0, borderWidth: 2, borderColor: '#ff6b6b' },
            { label: "Heating On", data: [], backgroundColor: 'rgba(255,255,255,0.2)', borderColor: 'rgba(255,255,255,0.4)', borderWidth: 2, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { ticks: { maxTicksLimit: 10, autoSkip: true } },
            y: { ticks: { maxTicksLimit: 8 } }
          },
          plugins: { legend: { display: true } }
        },
        plugins: [heatShadePlugin]
      });
    } else {
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = outside;
      trendChart.data.datasets[1].data = field8;
      trendChart.update();
    }
  }

  function ensureForecastChart(labels, temp, feels, cloud, wind){
    const ctx = document.getElementById("forecastChart");
    const GREEN = "#2ee59d";
    const YELLOW = "#ffd166";
    const BLUE = "#7aa7ff";

    if(!forecastChart){
      forecastChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            { label: "Temp C", data: temp, tension: 0.25, pointRadius: 0, borderWidth: 3, borderColor: GREEN, yAxisID: "y", hidden: !showTemp },
            { label: "Feels Like C", data: feels, tension: 0.25, pointRadius: 0, borderWidth: 2, borderDash:[6,4], borderColor: GREEN, yAxisID: "y", hidden: !showFeels },
            { label: "Cloud %", data: cloud, tension: 0.25, pointRadius: 0, borderWidth: 3, borderColor: YELLOW, yAxisID: "y2" },
            { label: "Wind", data: wind, tension: 0.25, pointRadius: 0, borderWidth: 3, borderColor: BLUE, yAxisID: "y2" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
            y: { 
              position: "left", 
              ticks: { maxTicksLimit: 6 },
              title: { display: true, text: "Temperature C", color: "#2ee59d" },
              min: -15,
              max: 35
            },
            y2: { 
              position: "right", 
              grid: { drawOnChartArea: false }, 
              ticks: { maxTicksLimit: 6 },
              title: { display: true, text: "Cloud % / Wind", color: "#ffd166" },
              min: 0,
              max: 100
            }
          },
          plugins: { legend: { display: true } }
        }
      });
    } else {
      forecastChart.data.labels = labels;
      forecastChart.data.datasets[0].data = temp;
      forecastChart.data.datasets[1].data = feels;
      forecastChart.data.datasets[2].data = cloud;
      forecastChart.data.datasets[3].data = wind;

      forecastChart.data.datasets[0].hidden = !showTemp;
      forecastChart.data.datasets[1].hidden = !showFeels;

      forecastChart.update();
    }

    // If chart was created while hidden, forcing resize helps
    setTimeout(()=>{ if(forecastChart) forecastChart.resize(); }, 80);
  }

  function selectTempType(which){
    const btnTemp = document.getElementById("btnShowTemp");
    const btnFeels = document.getElementById("btnShowFeels");
    const labelEl = document.getElementById("coldestLabel");
    
    if(which === "temp"){
      showTemp = true;
      showFeels = false;
      btnTemp.classList.add("active");
      btnFeels.classList.remove("active");
      if(labelEl) labelEl.textContent = "Coldest Temp";
    } else {
      showTemp = false;
      showFeels = true;
      btnTemp.classList.remove("active");
      btnFeels.classList.add("active");
      if(labelEl) labelEl.textContent = "Coldest Feels Like";
    }

    // Update chart to show only selected series
    if(forecastChart){
      forecastChart.data.datasets[0].hidden = !showTemp;
      forecastChart.data.datasets[1].hidden = !showFeels;
      forecastChart.update();
      setTimeout(()=>forecastChart.resize(), 50);
    }
    
    // Update the coldest value display
    updateColdestDisplay();
  }
  
  function updateColdestDisplay() {
    const valueEl = document.getElementById("coldestValue");
    const timeEl = document.getElementById("coldestTime");
    if (!valueEl || !window.forecastData) return;
    
    const data = window.forecastData;
    if (showFeels && data.coldestFeels) {
      valueEl.textContent = data.coldestFeels.temp.toFixed(1) + "C";
      timeEl.textContent = data.coldestFeels.time || "";
    } else if (showTemp && data.coldestTemp) {
      valueEl.textContent = data.coldestTemp.temp.toFixed(1) + "C";
      timeEl.textContent = data.coldestTemp.time || "";
    } else {
      valueEl.textContent = "";
      timeEl.textContent = "";
    }
  }

  function setActiveMode(mode, buildingProtectActive){
    // If building protect is active, override display
    const displayMode = buildingProtectActive ? "BUILDING_PROTECT" : mode;
    
    ["STANDARD","SMARTPITCH"].forEach(m=>{
      const btn = document.getElementById("btn"+m);
      if(btn) btn.classList.toggle("active", m===mode && !buildingProtectActive);
      const led = document.getElementById("led"+m);
      if(led) led.classList.toggle("on", m===mode && !buildingProtectActive);
    });

    setLed("modeLed", !!mode || buildingProtectActive);
    setText("modeNow", displayMode || "");
    setText("modeNow2", displayMode || "");
    updateModeVisuals(displayMode);

    const desc =
      buildingProtectActive ? "Actuator closed - protecting building heating system." :
      mode === "STANDARD" ? "Fixed strategy (no learning). Use for baseline stability." :
      mode === "SMARTPITCH" ? "AI-driven optimisation using learned performance bands." :
      "";
    setText("modeDesc", desc);
  }

  async function loadGui(){
    const r = await fetch("/api/gui", { cache: "no-store" });
    const data = await r.json();
    
    // Also fetch status to check building protect (with error handling)
    let buildingProtectActive = false;
    try {
      const statusR = await fetch("/api/status", { cache: "no-store" });
      const statusData = await statusR.json();
      buildingProtectActive = statusData.building_protect_active === true;
      
      // Check forecast override status
      const forecastOverrideActive = statusData.forecast_override_active === true;
      const forecastOverrideEl = document.getElementById('forecastOverrideIndicator');
      if (forecastOverrideEl) {
        if (forecastOverrideActive) {
          forecastOverrideEl.style.display = 'flex';
        } else {
          forecastOverrideEl.style.display = 'none';
        }
      }
    } catch(e) {
      console.warn('Could not fetch status:', e);
    }

    const mode = data.mode || {};
    setActiveMode(mode.mode, buildingProtectActive);
    
    // Update SmartPitch sub-mode display
    const submode = mode.smartpitch_submode || 'MONITOR';
    const submodeEl = document.getElementById('aiSubmode');
    const submodeDescEl = document.getElementById('aiSubmodeDesc');
    if (submodeEl) {
      submodeEl.textContent = submode;
      submodeEl.className = 'ai-submode-value ' + submode.toLowerCase();
    }
    if (submodeDescEl) {
      const descriptions = {
        'MONITOR': 'Monitoring conditions - no heating required',
        'PREHEAT': 'Pre-heating active - gentle warming',
        'HEATING': 'Full heating active - targeting playable'
      };
      submodeDescEl.textContent = descriptions[submode] || 'Unknown state';
    }

    const latest = (data.status && data.status.latest_trend) ? data.status.latest_trend : {};
    setText("trendTs", latest.ts ? fmtAxisDateTime(latest.ts) : "");

    // Fetch frost detection status
    try {
      const frostRes = await fetch("/api/frost/status");
      const frost = await frostRes.json();
      const leafEl = document.getElementById("leafFrost");
      if (leafEl) {
        if (frost.frostDetected === true) {
          leafEl.textContent = "FROST";
          leafEl.style.color = "#ff6b6b";
        } else if (frost.frostDetected === false) {
          leafEl.textContent = "CLEAR";
          leafEl.style.color = "#2ee59d";
        } else {
          leafEl.textContent = "";
          leafEl.style.color = "";
        }
      }
    } catch(e) {
      setText("leafFrost", "");
    }

    setText("outsideTemp", (latest.outside_temp_c ?? "") + "C");
    setText("field8", (latest.avg_field_8cm_c ?? 6.0) + "C");  // Test: 6C at -8cm
    setText("field25", (latest.avg_field_25cm_c ?? 8.5) + "C");  // Test: 8.5C at -25cm
    setText("wind", (latest.wind_speed ?? ""));
    setText("cloud", (latest.cloud_cover_pct ?? ""));
    setText("humidity", (latest.humidity_pct ?? ""));

    const heatOn = (latest.heat_enabled === true);
    setLed("heatLed", heatOn);
    setText("heatEnabledMini", heatOn ? "ON" : (latest.heat_enabled === false ? "OFF" : ""));
    
    // Update large heat status LED
    const heatIndicator = document.getElementById('heatStatusIndicator');
    const heatIcon = document.getElementById('heatStatusIcon');
    const heatText = document.getElementById('heatStatusText');
    if (heatIndicator && heatIcon && heatText) {
      if (heatOn) {
        heatIndicator.style.background = 'linear-gradient(145deg, #1a2a20, #0d1f15)';
        heatIndicator.style.borderColor = '#2ee59d';
        heatIndicator.style.boxShadow = '0 0 20px rgba(46,229,157,0.3), 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(46,229,157,0.1)';
        heatIcon.style.filter = 'none';
        heatIcon.style.textShadow = '0 0 10px rgba(255,100,50,0.8)';
        heatText.style.color = '#2ee59d';
        heatText.textContent = 'HEATING';
      } else {
        heatIndicator.style.background = 'linear-gradient(145deg, #1a1a1a, #252525)';
        heatIndicator.style.borderColor = '#333';
        heatIndicator.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05)';
        heatIcon.style.filter = 'grayscale(1) opacity(0.4)';
        heatIcon.style.textShadow = 'none';
        heatText.style.color = '#555';
        heatText.textContent = 'OFF';
      }
    }
    // Calculate live power from flow rate and temperatures (only when heating)
    const flowRateVal = parseFloat(document.getElementById('flowRateInput')?.value) || 0;
    const secFlow = latest.sec_flow_c;
    const secReturn = latest.sec_return_c;
    const heatEnabled = latest.heat_enabled === true;
    
    if (!heatEnabled) {
      setText("liveKw", "0.0 kW");
    } else if (flowRateVal > 0 && secFlow != null && secReturn != null) {
      const deltaT = secFlow - secReturn;
      const powerKw = flowRateVal * 4.186 * Math.max(0, deltaT);
      setText("liveKw", powerKw.toFixed(1) + " kW");
    } else if (flowRateVal <= 0) {
      setText("liveKw", "Set flow rate");
    } else {
      setText("liveKw", "");
    }

    const learning = data.learning || {};
    const nt = learning.next_training || {};
    const rec = learning.recommendation || {};
    const matches = learning.matches || {};
    
    // Check if there's actual frost risk from latest decision
    const latestDecision = data.status?.latest_decision || {};
    const hasFrostRisk = latestDecision.frost_risk > 0;

    // Only show heating recommendation if there's actual frost risk
    if (hasFrostRisk) {
      // Reset styles for normal display
      const el1 = document.getElementById("playableBy");
      const el2 = document.getElementById("suggestedStart");
      const el3 = document.getElementById("confidence");
      if (el1) { el1.style.fontSize = ""; el1.style.fontWeight = ""; el1.style.color = ""; }
      if (el2) { el2.style.fontSize = ""; el2.style.fontWeight = ""; el2.style.color = ""; }
      if (el3) { el3.style.fontSize = ""; el3.style.fontWeight = ""; el3.style.color = ""; }
      setText("trainingStart", nt.training_start ? ("Training: " + fmtAxisDateTime(nt.training_start)) : "");
      setText("playableBy", nt.playable_by_ts ? fmtShort(nt.playable_by_ts) : "");
      setText("suggestedStart", rec.suggested_start_ts ? fmtShort(rec.suggested_start_ts) : "");
      setText("startOffset", (rec.start_offset_minutes != null) ? ("Start offset: " + rec.start_offset_minutes + " min") : "");
      setText("confidence", (rec.confidence != null) ? rec.confidence : "");
      setText("passRate", "Pass rate: " + (matches.pass_rate ?? "") + "% (" + (matches.pass ?? "") + "/" + (matches.n ?? "") + ")");
      setText("reason", rec.reason ?? "");
    } else {
      // No frost risk - show simple message in smaller text
      const noHeatMsg = "No upcoming heating required";
      const el1 = document.getElementById("playableBy");
      const el2 = document.getElementById("suggestedStart");
      const el3 = document.getElementById("confidence");
      if (el1) { el1.textContent = noHeatMsg; el1.style.fontSize = "13px"; el1.style.fontWeight = "normal"; el1.style.color = "var(--muted)"; }
      if (el2) { el2.textContent = noHeatMsg; el2.style.fontSize = "13px"; el2.style.fontWeight = "normal"; el2.style.color = "var(--muted)"; }
      if (el3) { el3.textContent = noHeatMsg; el3.style.fontSize = "13px"; el3.style.fontWeight = "normal"; el3.style.color = "var(--muted)"; }
      setText("trainingStart", "");
      setText("startOffset", "");
      setText("passRate", "");
      setText("reason", "");
    }
  }

  // Generate friendly advisory messages

  async function loadAdvisory() {
    try {
      const r = await fetch("/api/gui", { cache: "no-store" });
      const data = await r.json();
      
      const mode = data.mode || {};
      const learning = data.learning || {};
      const nt = learning.next_training || {};
      const rec = learning.recommendation || {};
      const status = data.status || {};
      const trend = status.latest_trend || {};
      const forecast = { min_temp_c: status.forecast_min_temp };
      
      // Next Session - friendly summary
      let nextSessionText = '';
      if (nt.training_start) {
        const trainingDate = new Date(nt.training_start);
        const playableDate = nt.playable_by_ts ? new Date(nt.playable_by_ts) : null;
        const now = new Date();
        const hoursUntil = (trainingDate - now) / (1000 * 60 * 60);
        
        const dayName = trainingDate.toLocaleDateString('en-GB', { weekday: 'long' });
        const timeStr = trainingDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        if (hoursUntil < 0) {
          nextSessionText = 'The scheduled session has already started.';
        } else if (hoursUntil < 1) {
          nextSessionText = 'Your next session starts in less than an hour at ' + timeStr + '.';
        } else if (hoursUntil < 24) {
          nextSessionText = 'Your next session is today at ' + timeStr + '. ';
          if (playableDate) {
            const playableTime = playableDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            nextSessionText += 'The pitch needs to be ready by ' + playableTime + '.';
          }
        } else if (hoursUntil < 48) {
          nextSessionText = 'Your next session is tomorrow (' + dayName + ') at ' + timeStr + '.';
        } else {
          const days = Math.floor(hoursUntil / 24);
          nextSessionText = 'Your next session is on ' + dayName + ' at ' + timeStr + ' (' + days + ' days away).';
        }
        
        if (nt.session_name) {
          nextSessionText += ' Session: ' + nt.session_name.replace(/_/g, ' ') + '.';
        }
        
        // Check for consecutive sessions
        const nt2 = learning.next_training_2;
        if (nt2 && nt2.training_start) {
          const nextDate2 = new Date(nt2.training_start);
          const hoursBetween = (nextDate2 - trainingDate) / (1000 * 60 * 60);
          if (hoursBetween <= 48) {
            const day2 = nextDate2.toLocaleDateString('en-GB', { weekday: 'long' });
            const time2 = nextDate2.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            nextSessionText += ' There is also a session on ' + day2 + ' at ' + time2 + ' (' + Math.round(hoursBetween) + ' hours later).';
            nextSessionText += ' If frost protection is needed, the system will maintain temperature between sessions rather than fully stopping.';
          }
        }
      } else {
        nextSessionText = 'No training sessions are currently scheduled. Add sessions in the Calendar tab to enable SmartPitch planning.';
      }
      setText('advNextSession', nextSessionText);
      
      // Current Plan - what SmartPitch is doing
      let planText = '';
      const submode = mode.smartpitch_submode || 'MONITOR';
      const currentMode = mode.mode || 'OFF';
      
      if (currentMode !== 'SMARTPITCH') {
        planText = 'SmartPitch AI is currently turned off. The system is in ' + currentMode + ' mode. Switch to SmartPitch mode to enable intelligent heating control.';
      } else {
        if (submode === 'MONITOR') {
          // Check if there's a frost risk from forecast data
          const forecastMin = forecast.min_temp_c;
          const hasFrostRisk = forecastMin !== undefined && forecastMin !== null && forecastMin < 2;
          
          if (!hasFrostRisk) {
            planText = 'SmartPitch is monitoring but NO heating is needed. The weather forecast shows temperatures staying above freezing (minimum ' + (forecastMin !== null && forecastMin !== undefined ? forecastMin.toFixed(1) + 'C' : 'unknown') + '). ';
            if (nt.training_start) {
              planText += 'Your pitch will be fine for the upcoming session without heating.';
            }
          } else {
            planText = 'SmartPitch is monitoring conditions. Frost risk detected (forecast minimum ' + forecastMin.toFixed(1) + 'C). ';
            if (nt.training_start && rec.suggested_start_ts) {
              const suggestedTime = new Date(rec.suggested_start_ts);
              const suggestedHours = (suggestedTime - new Date()) / (1000 * 60 * 60);
              if (suggestedHours > 0) {
                planText += 'Heating will begin in approximately ' + Math.round(suggestedHours) + ' hours to protect against frost.';
              } else {
                planText += 'Heating should begin soon.';
              }
            } else if (!nt.training_start) {
              planText += 'The system will activate frost protection if temperatures drop further.';
            }
          }
        } else if (submode === 'PREHEAT') {
          planText = 'SmartPitch is in pre-heat mode, gently warming the pitch to prepare for the upcoming session. The system is using a conservative approach to gradually raise the temperature while monitoring conditions.';
        } else if (submode === 'HEATING') {
          planText = 'SmartPitch is actively heating the pitch. The system is adjusting the heat output based on real-time temperature readings to ensure the pitch reaches the target condition before the session starts.';
        }
      }
      setText('advCurrentPlan', planText);
      
      // Weather Assessment
      let weatherText = '';
      const outsideTemp = trend.outside_temp_c;
      const humidity = trend.humidity_pct;
      const windSpeed = trend.wind_speed;
      const forecastMin = forecast.min_temp_c;
      const forecastAvg = forecast.avg_temp_c;
      
      if (outsideTemp !== undefined && outsideTemp !== null) {
        if (outsideTemp <= 0) {
          weatherText = 'It is currently ' + outsideTemp.toFixed(1) + ' degrees outside, which is below freezing. ';
          weatherText += 'Frost protection may be needed. ';
        } else if (outsideTemp <= 3) {
          weatherText = 'The current temperature is ' + outsideTemp.toFixed(1) + ' degrees, which is cold but above freezing. ';
        } else if (outsideTemp <= 8) {
          weatherText = 'The current temperature is ' + outsideTemp.toFixed(1) + ' degrees - cool conditions. ';
        } else {
          weatherText = 'The current temperature is ' + outsideTemp.toFixed(1) + ' degrees - mild conditions. ';
        }
        
        if (forecastMin !== undefined && forecastMin !== null) {
          if (forecastMin <= 0) {
            weatherText += 'The forecast shows temperatures dropping to ' + forecastMin.toFixed(1) + ' degrees, so frost is expected. ';
          } else if (forecastMin <= 3) {
            weatherText += 'Forecasts show temperatures may drop to ' + forecastMin.toFixed(1) + ' degrees. ';
          }
        }
        
        if (humidity !== undefined && humidity !== null) {
          if (humidity > 85) {
            weatherText += 'Humidity is high (' + Math.round(humidity) + '%), which can increase frost risk. ';
          }
        }
        
        if (windSpeed !== undefined && windSpeed !== null) {
          if (windSpeed > 5) {
            weatherText += 'Wind speed is ' + windSpeed.toFixed(1) + ' m/s, which increases heat loss from the pitch.';
          }
        }
      } else {
        weatherText = 'Weather data is currently being collected. Check back shortly for conditions assessment.';
      }
      setText('advWeather', weatherText);
      
      // Learning Insights
      let learningText = '';
      const confidence = rec.confidence;
      const passRate = rec.pass_rate;
      const matches = learning.matches || {};
      
      if (confidence && confidence !== 'LOW') {
        learningText = 'SmartPitch has good historical data for conditions like these. ';
        if (passRate !== undefined && passRate !== null) {
          learningText += 'In similar weather conditions, ' + Math.round(passRate) + '% of heating sessions have been successful. ';
        }
        if (rec.start_offset_minutes) {
          const offsetHours = Math.abs(rec.start_offset_minutes) / 60;
          if (rec.start_offset_minutes < 0) {
            learningText += 'Based on past experience, heating should start ' + offsetHours.toFixed(1) + ' hours earlier than the default.';
          } else {
            learningText += 'Past experience suggests heating can start ' + offsetHours.toFixed(1) + ' hours later than default, saving energy.';
          }
        }
      } else if (matches.total_sessions && matches.total_sessions > 0) {
        learningText = 'SmartPitch has ' + matches.total_sessions + ' historical sessions to learn from. As more sessions are completed, predictions will become more accurate.';
      } else {
        learningText = 'SmartPitch is still learning about your pitch. After a few heating sessions, the system will start making smarter predictions based on actual results.';
      }
      setText('advLearning', learningText);
      
    } catch(e) {
      console.error('Advisory load error:', e);
      setText('advNextSession', 'Unable to load advisory information.');
      setText('advCurrentPlan', 'Please try refreshing the page.');
      setText('advWeather', '');
      setText('advLearning', '');
    }
  }


  async function loadTimeseries(hours){
    const r = await fetch("/api/timeseries?hours=" + encodeURIComponent(hours), { cache: "no-store" });
    const data = await r.json();
    const series = data.series || [];

    const labels = series.map(p => fmtAxisDateTime(p.ts));
    const outside = series.map(p => p.outside_temp_c ?? null);
    const field8  = series.map(p => p.avg_field_8cm_c ?? null);
    lastHeatOn    = series.map(p => p.heat_enabled === true);

    ensureTrendChart(labels, outside, field8);
  }

  // Simple client-side feel-like estimate if DB doesn't provide it
  function estimateFeels(tempC, windVal, humidityVal){
    if(tempC == null) return null;

    const t = Number(tempC);
    if(!Number.isFinite(t)) return null;

    const wind = Number(windVal);
    const hum = Number(humidityVal);

    // Very light-touch estimate:
    // - windy knocks it down slightly
    // - high humidity adds a tiny upward bump (less cooling perception)
    let feels = t;

    if(Number.isFinite(wind)) feels -= Math.min(4, wind * 0.12);
    if(Number.isFinite(hum)) feels += Math.max(-1.0, Math.min(1.0, (hum - 50) * 0.01));

    return Math.round(feels * 10) / 10;
  }

  async function loadForecast(force){
    showErr("forecastErr", "");
    showWarn("forecastWarn", "");

    try{
      const r = await fetch("/api/forecast?hours=168&_=" + Date.now(), { cache: "no-store" });
      const data = await r.json();
      const series = Array.isArray(data) ? data : (data.series || []);

      setText("fcRows", series.length);
      setText("fcMaxTs", data.max_ts ? fmtAxisDateTime(data.max_ts) : "");
      setText("fcBehind", (data.hours_behind != null) ? (Number(data.hours_behind).toFixed(2) + " h") : "");

      if(data.stale === true){
        showWarn("forecastWarn",
          "? Forecast DB is STALE. Your ingest has stopped or is late. " +
          "DB max_ts is behind NOW, so you cannot see week-ahead until new open-meteo rows are inserted."
        );
      }

      if(!series.length){
        showErr("forecastErr", "Forecast returned 0 rows (DB has no future window). Fix ingest first.");
        ensureForecastChart([], [], [], [], []);
        return;
      }

      const labels = series.map(p => fmtAxisDateTime(p.ts || p.timestamp));
      const temp   = series.map(p => (p.temp_c ?? p.temp ?? null));
      const cloud  = series.map(p => (p.cloud_cover_pct ?? p.clouds ?? null));
      const wind   = series.map(p => (p.wind_speed ?? p.wind ?? null));

      // Use feels_like_c from database (actual apparent temperature from Open-Meteo)
      let feels = series.map(p => (p.feels_like_c ?? null));
      const anyFeels = feels.some(v => v != null);

      if(!anyFeels){
        // Fallback to estimate if DB has no data yet
        feels = series.map(p => estimateFeels(p.temp_c ?? p.temp ?? null, p.wind_speed ?? p.wind ?? null, p.humidity_pct ?? p.humidity ?? null));
        showWarn("forecastWarn",
          (data.stale ? "? Forecast DB is STALE. " : "") +
          "Feels Like is estimated (waiting for forecast data with apparent_temperature)."
        );
      }

      ensureForecastChart(labels, temp, feels, cloud, wind);

      // Find coldest feels like temperature
      // Calculate coldest for both temp and feels like
      let coldestFeels = null;
      let coldestFeelsIdx = -1;
      let coldestTemp = null;
      let coldestTempIdx = -1;
      
      for (let i = 0; i < feels.length; i++) {
        if (feels[i] != null && (coldestFeels === null || feels[i] < coldestFeels)) {
          coldestFeels = feels[i];
          coldestFeelsIdx = i;
        }
      }
      
      for (let i = 0; i < temp.length; i++) {
        if (temp[i] != null && (coldestTemp === null || temp[i] < coldestTemp)) {
          coldestTemp = temp[i];
          coldestTempIdx = i;
        }
      }
      
      // Store in window for updateColdestDisplay
      window.forecastData = {
        coldestFeels: coldestFeels !== null ? { temp: coldestFeels, time: labels[coldestFeelsIdx] } : null,
        coldestTemp: coldestTemp !== null ? { temp: coldestTemp, time: labels[coldestTempIdx] } : null
      };
      
      // Update display based on current selection
      updateColdestDisplay();

    } catch(e){
      showErr("forecastErr", "Forecast load failed: " + (e && e.message ? e.message : String(e)));
      ensureForecastChart([], [], [], [], []);
      setText("fcRows", "");
      setText("fcMaxTs", "");
      setText("fcBehind", "");
    }
  }

  async function loadCost(){
    const r = await fetch("/api/cost", { cache: "no-store" });
    const data = await r.json();

    const s = data.season_to_date || {};
    const cr = data.current_rate || {};
    const season = data.season || {};

    setText("seasonKwh", s.kwh ?? "");
    setText("seasonCost", (s.cost_gbp!=null ? ("" + Number(s.cost_gbp).toFixed(2)) : ""));
    setText("rateNow", (cr.pence_per_kwh!=null ? (Number(cr.pence_per_kwh).toFixed(2) + " p/kWh") : ""));

    const start = season.start ? fmtDateShort(season.start) : "";
    const end = season.end ? fmtDateShort(season.end) : "";
    setText("seasonWindow", start + " ? " + end);

    const inp = document.getElementById("rateInput");
    if (inp && cr.pence_per_kwh!=null && !inp.dataset.touched) {
      inp.value = Number(cr.pence_per_kwh).toFixed(2);
    }
  }

  async function saveRate(){
    const inp = document.getElementById("rateInput");
    const p = Number(inp.value);
    if(!Number.isFinite(p) || p < 0){
      alert("Enter a valid p/kWh (e.g. 3.00)");
      return;
    }
    await fetch("/api/rate", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ pence_per_kwh: p, updated_by: "gui", notes: "rate update from dashboard" })
    });
    inp.dataset.touched = "";
    await loadCost();
  }

  async function setMode(mode){
    await fetch("/api/mode", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ mode: mode, updated_by: "gui" })
    });
    await refreshAll();
  }

  // ===== Scheduler calendar =====
  let calYear = (new Date()).getFullYear();
  let calMonth = (new Date()).getMonth(); // 0-11
  let calItems = [];

  function ymd(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return yyyy + "-" + mm + "-" + dd;
  }
  function monthKey(y,m){
    const mm = String(m+1).padStart(2,'0');
    return y + "-" + mm;
  }
  function setCalTitle(){
    const d = new Date(calYear, calMonth, 1);
    const name = d.toLocaleString(undefined, { month: "long", year:"numeric" });
    setText("calTitle", name);
  }
  function startOfMonthGrid(y,m){
    const first = new Date(y,m,1);
    const dow = first.getDay(); // 0=Sun..6=Sat
    const mondayIndex = (dow === 0) ? 6 : (dow - 1);
    const gridStart = new Date(y,m,1);
    gridStart.setDate(gridStart.getDate() - mondayIndex);
    return gridStart;
  }

  function renderCalendar(){
    setCalTitle();
    const grid = document.getElementById("calGrid");
    if(!grid) return;

    grid.innerHTML = "";

    const gridStart = startOfMonthGrid(calYear, calMonth);
    const thisMonth = calMonth;

    for(let i=0;i<42;i++){
      const d = new Date(gridStart);
      d.setDate(gridStart.getDate() + i);
      const dKey = ymd(d);

      const cell = document.createElement("div");
      cell.className = "dayCell";
      if(d.getMonth() !== thisMonth) cell.classList.add("dayMuted");

      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = d.getDate();
      cell.appendChild(num);

      const itemsWrap = document.createElement("div");
      itemsWrap.className = "dayItems";

      const items = calItems.filter(x => (x.training_start || "").slice(0,10) === dKey);

      items.forEach((it) => {
        const pill = document.createElement("div");
        pill.className = "pill";

        const startT = (it.training_start || "").slice(11,16) || "";
        const finishLabel = it.session_name || "Finish ";
        const buf = (it.buffer_minutes != null) ? it.buffer_minutes : "";

        pill.innerHTML =
          "<div><b>" + startT + "</b> <span class='meta'> " + finishLabel + "</span><br><span class='meta'>Buffer " + buf + " min</span></div>";

        const xbtn = document.createElement("button");
        xbtn.className = "pillX";
        xbtn.textContent = "x";
        xbtn.onclick = (ev) => {
          ev.stopPropagation();
          removeScheduleItem(it.training_start, it.session_name);
        };

        pill.appendChild(xbtn);
        itemsWrap.appendChild(pill);
      });

      cell.appendChild(itemsWrap);
      cell.onclick = () => addDayFromControls(d);
      grid.appendChild(cell);
    }
  }

  function addDayFromControls(dateObj){
    showErr("scheduleErr", "");

    const startHHMM = document.getElementById("schedStart").value || "09:00";
    const stopHHMM  = document.getElementById("schedStop").value  || "11:00";
    const bufMin    = parseInt(document.getElementById("schedBuf").value || "60", 10);

    const sParts = startHHMM.split(":");
    const eParts = stopHHMM.split(":");
    const sMin = Number(sParts[0])*60 + Number(sParts[1]);
    const eMin = Number(eParts[0])*60 + Number(eParts[1]);
    if(!(eMin > sMin)){
      showErr("scheduleErr", "Finish time must be after Start time.");
      return;
    }
    if(!Number.isFinite(bufMin) || bufMin < 0){
      showErr("scheduleErr", "Buffer must be a valid number of minutes.");
      return;
    }

    const yyyy = dateObj.getFullYear();
    const mm = String(dateObj.getMonth()+1).padStart(2,'0');
    const dd = String(dateObj.getDate()).padStart(2,'0');

    const localIso = yyyy + "-" + mm + "-" + dd + "T" + startHHMM + ":00";
    const dt = new Date(localIso);
    const iso = dt.toISOString();

    const sessionName = "Finish " + stopHHMM;

    calItems.push({
      training_start: iso,
      buffer_minutes: bufMin,
      session_name: sessionName
    });

    renderCalendar();
  }

  function removeScheduleItem(training_start, session_name){
    calItems = calItems.filter(x => !(x.training_start === training_start && x.session_name === session_name));
    renderCalendar();
  }

  async function loadScheduleMonth(){
    showErr("scheduleErr", "");
    const mk = monthKey(calYear, calMonth);
    try{
      const r = await fetch("/api/schedule?month=" + encodeURIComponent(mk), { cache:"no-store" });
      const data = await r.json();
      calItems = data.rows || [];
      renderCalendar();
    } catch(e){
      showErr("scheduleErr", "Schedule load failed: " + (e && e.message ? e.message : String(e)));
      calItems = [];
      renderCalendar();
    }
  }

  async function saveSchedule(){
    showErr("scheduleErr", "");
    const mk = monthKey(calYear, calMonth);
    try{
      const payload = { month: mk, rows: calItems };
      const r = await fetch("/api/schedule", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      alert("Saved: " + (data.saved ?? 0) + " sessions for " + mk);
      await loadScheduleMonth();
      await loadGui();
    } catch(e){
      showErr("scheduleErr", "Schedule save failed: " + (e && e.message ? e.message : String(e)));
    }
  }

  function prevMonth(){
    calMonth -= 1;
    if(calMonth < 0){ calMonth = 11; calYear -= 1; }
    loadScheduleMonth();
  }
  function nextMonth(){
    calMonth += 1;
    if(calMonth > 11){ calMonth = 0; calYear += 1; }
    loadScheduleMonth();
  }

  
  // ===== Data tab (DB tables) =====
  let dataSub = "trend"; // "trend" | "smart"
  let dataPage = 1;

  function showDataSub(which){
    dataSub = which;
    dataPage = 1;

    const trendSmartContent = document.getElementById("trendSmartContent");
    const learningContent = document.getElementById("learningContent");
    const smartTablePicker = document.getElementById("smartTablePickerWrap");

    // TrendLogs and Decisions share the same panel (trendSmartContent)
    // Learning has its own panel (learningContent)
    if(trendSmartContent) trendSmartContent.style.display = (which === 'trend' || which === 'decisions') ? 'block' : 'none';
    if(learningContent) learningContent.style.display = (which === 'learning') ? 'block' : 'none';
    
    // Show/hide the smart table picker (only for decisions)
    if(smartTablePicker) smartTablePicker.style.display = (which === 'decisions') ? 'inline-block' : 'none';

    document.getElementById("subTrend")?.classList.toggle('active', which === 'trend');
    document.getElementById("subDecisions")?.classList.toggle('active', which === 'decisions');
    document.getElementById("subLearning")?.classList.toggle('active', which === 'learning');

    if (which === 'learning') {
      loadLearningData();
    } else {
      reloadActiveTable(true);
    }
  }

  function localIsoNoSeconds(dt){
    const pad = (n)=>String(n).padStart(2,"0");
    return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate())+"T"+pad(dt.getHours())+":"+pad(dt.getMinutes());
  }

  function initDataDefaults(){
    const now = new Date();
    const to = new Date(now);
    const from = new Date(now);
    from.setDate(from.getDate() - 7);

    const elFrom = document.getElementById("dataFrom");
    const elTo = document.getElementById("dataTo");
    if(elFrom && !elFrom.value) elFrom.value = localIsoNoSeconds(from);
    if(elTo && !elTo.value) elTo.value = localIsoNoSeconds(to);
  }

  function getDataFilters(){
    const from = (document.getElementById("dataFrom")||{}).value || "";
    const to   = (document.getElementById("dataTo")||{}).value || "";
    const pageSize = Number(((document.getElementById("dataPageSize")||{}).value) || 50);
    const smartTable = ((document.getElementById("smartTableSel")||{}).value) || "heating_sessions";
    return { from:from, to:to, page:dataPage, page_size:pageSize, smart_table:smartTable };
  }

  function inferColumns(rows){
    if(!rows || !rows.length) return [];
    const cols = new Set();
    rows.forEach(r => Object.keys(r || {}).forEach(k => cols.add(k)));
    return Array.from(cols);
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function cellHtml(col, v){
    const key = String(col || "").toLowerCase();
    if(key === "result" || key === "pass_fail"){
      const val = (v==null ? "" : String(v)).toUpperCase();
      const cls = (val === "PASS") ? "ok" : (val === "FAIL") ? "bad" : "";
      return '<span class="pillTiny '+cls+'">'+(val || "")+'</span>';
    }
    if(key.includes("ts") || key.includes("time") || key.includes("date")){
      const s = (v==null ? "" : String(v));
      return escapeHtml(s.replace("T"," ").replace("+00:00","Z"));
    }
    if(v === null || v === undefined) return "";
    if(typeof v === "boolean") return v ? "TRUE" : "FALSE";
    return escapeHtml(v);
  }

  function renderDbTable(rows, columns){
    const thead = document.getElementById("dbThead");
    const tbody = document.getElementById("dbTbody");
    if(!thead || !tbody) return;

    const cols = (columns && columns.length) ? columns : inferColumns(rows);

    thead.innerHTML = "<tr>" + cols.map(c => "<th>"+escapeHtml(c)+"</th>").join("") + "</tr>";

    if(!rows || !rows.length){
      tbody.innerHTML = '<tr><td colspan="'+Math.max(cols.length,1)+'" class="small" style="padding:14px;">No rows for selected range.</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      return "<tr>" + cols.map(c => "<td>"+cellHtml(c, r[c])+"</td>").join("") + "</tr>";
    }).join("");
  }

  async function reloadActiveTable(resetPage){
    initDataDefaults();
    if(resetPage) dataPage = 1;

    showErr("dataErr", "");
    setText("dataMeta", "Loading");

    const f = getDataFilters();
    const qs = new URLSearchParams();
    if(f.from) qs.set("from", new Date(f.from).toISOString());
    if(f.to) qs.set("to", new Date(f.to).toISOString());
    qs.set("page", String(f.page));
    qs.set("page_size", String(f.page_size));

    let endpoint = "/api/data/trendlogs";
    if(dataSub === "decisions"){
      endpoint = "/api/data/smartpitch";
      qs.set("table", "control_decisions");
    }

    try{
      const r = await fetch(endpoint + "?" + qs.toString(), { cache:"no-store" });
      const data = await r.json();

      const rows = data.rows || [];
      const total = (data.total!=null) ? data.total : (rows.length || 0);
      const page = data.page || f.page;
      const pageSize = data.page_size || f.page_size;
      const pageCount = data.page_count || (pageSize ? Math.ceil(total / pageSize) : 1);

      renderDbTable(rows, data.columns || null);
      setText("dataMeta",
        (dataSub==="trend" ? "TrendLogs" : (dataSub==="decisions" ? "Control Decisions" : "SmartPitch")) +
        "  " + total + " rows  page " + page + "/" + pageCount +
        "  showing " + rows.length
      );

      const bx = document.getElementById("btnExportXlsx");
      const bc = document.getElementById("btnExportCsv");
      if(bx) bx.disabled = (total === 0);
      if(bc) bc.disabled = (total === 0);

      window.__lastTableData = { rows: rows, columns: data.columns || inferColumns(rows) };

    } catch(e){
      showErr("dataErr", "Data load failed: " + (e && e.message ? e.message : String(e)));
      renderDbTable([], []);
      setText("dataMeta", "");
      window.__lastTableData = { rows: [], columns: [] };
    }
  }

  function pagePrev(){
    if(dataPage > 1){
      dataPage -= 1;
      reloadActiveTable(false);
    }
  }
  function pageNext(){
    dataPage += 1;
    reloadActiveTable(false);
  }

  function buildExportUrl(fmt){
    const f = getDataFilters();
    const qs = new URLSearchParams();
    if(f.from) qs.set("from", new Date(f.from).toISOString());
    if(f.to) qs.set("to", new Date(f.to).toISOString());
    if(dataSub === "smart") qs.set("table", f.smart_table);
    qs.set("format", fmt);
    return (dataSub === "trend" ? "/api/data/trendlogs/export" : "/api/data/smartpitch/export") + "?" + qs.toString();
  }

  function exportCsvActive(){
    const url = buildExportUrl("csv");
    window.open(url, "_blank");
  }

  function exportXlsxActive(){
    if(typeof XLSX === "undefined"){
      alert("Excel export library not loaded. Check the xlsx script tag.");
      return;
    }
    const data = window.__lastTableData || { rows:[], columns:[] };
    const rows = data.rows || [];
    const cols = data.columns || inferColumns(rows);
    if(!rows.length){ alert("No rows to export."); return; }

    const flat = rows.map(r => {
      const obj = {};
      cols.forEach(c => obj[c] = (r[c]===undefined ? null : r[c]));
      return obj;
    });

    const ws = XLSX.utils.json_to_sheet(flat);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "data");
    XLSX.writeFile(wb, (dataSub === "trend" ? "trendlogs" : "smartpitch") + "_page.xlsx");
  }


  async function refreshAll(){
    const hours = Number(document.getElementById("hoursSel").value || 168);
    await Promise.all([
      loadGui(),
      loadTimeseries(hours),
      loadForecast(false),
      loadCost()
    ]);
  }

  document.getElementById("hoursSel").addEventListener("change", () => refreshAll());
  document.getElementById("rateInput").addEventListener("input", (e)=>{ e.target.dataset.touched = "1"; });

  function tickClock(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    setText("serverTime", dd + "/" + mm + " " + hh + ":" + mi);
  }
  tickClock();
  setInterval(tickClock, 1000);

  let refreshBusy = false;
  async function safeRefresh(){
    if (refreshBusy) return;
    refreshBusy = true;
    try { await refreshAll(); }
    catch (e) { console.log("refresh error:", e); }
    finally { refreshBusy = false; }
  }

  // ===== Heat Curve with Knee =====
  let heatCurveChart = null;

  function ensureHeatCurveChart(x1, y1, xk, yk, x2, y2) {
    const ctx = document.getElementById('heatCurveChart');
    if (!ctx) return;

    // Generate curve points
    const curvePoints = [];
    const linearPoints = [];
    const step = 0.5;
    
    // Linear slope for comparison (straight line from x1,y1 to x2,y2)
    const linearSlope = (y2 - y1) / (x2 - x1);
    
    for (let x = x1; x <= x2; x += step) {
      let y;
      if (x <= xk) {
        // Steep section from x1 to knee
        const slope = (yk - y1) / (xk - x1);
        y = y1 + slope * (x - x1);
      } else {
        // Gentle section from knee to x2
        const slope = (y2 - yk) / (x2 - xk);
        y = yk + slope * (x - xk);
      }
      curvePoints.push({ x: x, y: y });
      
      // Linear comparison
      const yLinear = y1 + linearSlope * (x - x1);
      linearPoints.push({ x: x, y: yLinear });
    }

    const data = {
      datasets: [
        {
          label: 'Heat Curve (with Knee)',
          data: curvePoints,
          borderColor: '#2ee59d',
          backgroundColor: 'rgba(255, 255, 255, 0.15)',
          borderWidth: 3,
          fill: true,
          tension: 0,
          pointRadius: 0,
          showLine: true
        },
        {
          label: 'Linear (no Knee)',
          data: linearPoints,
          borderColor: 'rgba(255, 209, 102, 0.5)',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          tension: 0,
          pointRadius: 0,
          showLine: true
        },
        {
          label: 'Knee Point',
          data: [{ x: xk, y: yk }],
          borderColor: '#ffd166',
          backgroundColor: '#ffd166',
          pointRadius: 8,
          pointStyle: 'circle',
          showLine: false
        }
      ]
    };

    const config = {
      type: 'scatter',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Outside Temp (C)', color: '#9fb0d7' },
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: '#9fb0d7' }
          },
          y: {
            title: { display: true, text: 'Flow Temp (C)', color: '#9fb0d7' },
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: '#9fb0d7' }
          }
        },
        plugins: {
          legend: { 
            display: true,
            labels: { color: '#eaf0ff' }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + 'C at ' + context.parsed.x.toFixed(1) + 'C outside';
              }
            }
          }
        }
      }
    };

    if (heatCurveChart) {
      heatCurveChart.destroy();
    }
    heatCurveChart = new Chart(ctx, config);
  }

  function updateHeatCurvePreview() {
    const x1 = parseFloat(document.getElementById('hcX1').value) || -10;
    const y1 = parseFloat(document.getElementById('hcY1').value) || 35;
    const xk = parseFloat(document.getElementById('hcXK').value) || -2;
    const yk = parseFloat(document.getElementById('hcYK').value) || 20;
    const x2 = parseFloat(document.getElementById('hcX2').value) || 4;
    const y2 = parseFloat(document.getElementById('hcY2').value) || 15;
    
    ensureHeatCurveChart(x1, y1, xk, yk, x2, y2);
  }

  async function loadHeatCurve() {
    try {
      const r = await fetch('/api/heatcurve', { cache: 'no-store' });
      const data = await r.json();
      
      const x1 = data.x1_outside_c ?? -10;
      const y1 = data.y1_flow_c ?? 35;
      const xk = data.xk_outside_c ?? -2;
      const yk = data.yk_flow_c ?? 20;
      const x2 = data.x2_outside_c ?? 4;
      const y2 = data.y2_flow_c ?? 15;
      
      document.getElementById('hcX1').value = x1;
      document.getElementById('hcY1').value = y1;
      document.getElementById('hcXK').value = xk;
      document.getElementById('hcYK').value = yk;
      document.getElementById('hcX2').value = x2;
      document.getElementById('hcY2').value = y2;
      
      ensureHeatCurveChart(x1, y1, xk, yk, x2, y2);
      showErr('heatCurveErr', '');
    } catch (e) {
      showErr('heatCurveErr', 'Failed to load heat curve: ' + e.message);
    }
  }

  async function saveHeatCurve() {
    const x1 = parseFloat(document.getElementById('hcX1').value);
    const y1 = parseFloat(document.getElementById('hcY1').value);
    const xk = parseFloat(document.getElementById('hcXK').value);
    const yk = parseFloat(document.getElementById('hcYK').value);
    const x2 = parseFloat(document.getElementById('hcX2').value);
    const y2 = parseFloat(document.getElementById('hcY2').value);
    
    if (isNaN(x1) || isNaN(y1) || isNaN(xk) || isNaN(yk) || isNaN(x2) || isNaN(y2)) {
      showErr('heatCurveErr', 'All fields must be valid numbers');
      return;
    }
    
    if (x1 >= xk || xk >= x2) {
      showErr('heatCurveErr', 'X values must be in order: X1 < XK < X2');
      return;
    }
    
    try {
      const r = await fetch('/api/heatcurve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          x1_outside_c: x1,
          y1_flow_c: y1,
          xk_outside_c: xk,
          yk_flow_c: yk,
          x2_outside_c: x2,
          y2_flow_c: y2
        })
      });
      
      if (r.ok) {
        showErr('heatCurveErr', '');
        await loadHeatCurve();
      } else {
        const err = await r.json();
        showErr('heatCurveErr', 'Save failed: ' + (err.error || 'Unknown error'));
      }
    } catch (e) {
      showErr('heatCurveErr', 'Save failed: ' + e.message);
    }
  }

  function loadManualState() {
    fetch('/api/manual/state')
      .then(r => r.json())
      .then(state => {
        const overrideEl = document.getElementById('manualOverrideEnabled');
        if (overrideEl) overrideEl.checked = state.override_enabled || false;
        
        for (let i = 1; i <= 6; i++) {
          const el = document.getElementById('manualDO' + i);
          if (el) el.checked = state['do' + i] || false;
        }
        
        for (let i = 1; i <= 4; i++) {
          const slider = document.getElementById('manualAO' + i);
          const enabledEl = document.getElementById('manualAO' + i + 'Enabled');
          const valueEl = document.getElementById('manualAO' + i + 'Value');
          if (slider) {
            slider.value = state['ao' + i] || 0;
            slider.disabled = !state['ao' + i + '_enabled'];
          }
          if (enabledEl) enabledEl.checked = state['ao' + i + '_enabled'] || false;
          if (valueEl) valueEl.textContent = (state['ao' + i] || 0) + '%';
        }
        
        const container = document.getElementById('manualControlsContainer');
        if (container) {
          container.style.opacity = state.override_enabled ? '1' : '0.5';
          container.style.pointerEvents = state.override_enabled ? 'auto' : 'none';
        }
      })
      .catch(e => console.log('Manual state not loaded:', e));
  }


  // ===== Forecast Monitor Control =====
  async function updateForecastAverage() {
    const duration = parseInt(document.getElementById('forecastDuration').value) || 24;
    const tempType = document.querySelector('input[name="forecastTempType"]:checked')?.value || 'real';
    
    // Update labels
    document.getElementById('forecastDurationLabel').textContent = duration;
    document.getElementById('forecastTempLabel').textContent = tempType === 'real' ? 'Real' : 'Feels like';
    
    try {
      const r = await fetch('/api/forecast');
      const data = await r.json();
      
      if (!data.series || data.series.length === 0) {
        document.getElementById('forecastAvgTemp').textContent = '--';
        document.getElementById('forecastMinTemp').textContent = '--';
        document.getElementById('forecastMaxTemp').textContent = '--';
        return;
      }
      
      // Get the required hours of data
      const hoursData = data.series.slice(0, duration);
      
      if (hoursData.length === 0) {
        document.getElementById('forecastAvgTemp').textContent = '--';
        return;
      }
      
      // Extract temperatures based on type
      const temps = hoursData.map(h => tempType === 'real' ? h.temp_c : h.feels_like_c).filter(t => t !== null && t !== undefined);
      
      if (temps.length === 0) {
        document.getElementById('forecastAvgTemp').textContent = '--';
        return;
      }
      
      // Calculate stats
      const avg = temps.reduce((a, b) => a + b, 0) / temps.length;
      const min = Math.min(...temps);
      const max = Math.max(...temps);
      
      // Update display
      document.getElementById('forecastAvgTemp').textContent = avg.toFixed(1) + '\u00B0C';
      document.getElementById('forecastMinTemp').textContent = min.toFixed(1);
      document.getElementById('forecastMaxTemp').textContent = max.toFixed(1);
      
      // Color code based on temperature
      const avgEl = document.getElementById('forecastAvgTemp');
      if (avg <= 0) {
        avgEl.style.color = '#7aa7ff'; // Cold - blue
      } else if (avg <= 5) {
        avgEl.style.color = '#ffd166'; // Cool - yellow
      } else {
        avgEl.style.color = '#2ee59d'; // Mild - green
      }
      
    } catch (e) {
      console.error('Failed to fetch forecast:', e);
      document.getElementById('forecastAvgTemp').textContent = 'Error';
    }
  }

  // Save forecast monitor settings to API (and localStorage as backup)
  function saveForecastSettings() {
    const duration = document.getElementById('forecastDuration').value;
    const tempType = document.querySelector('input[name="forecastTempType"]:checked')?.value || 'real';
    
    // Save to localStorage as backup
    try {
      localStorage.setItem('smartpitch_forecast_duration', duration);
      localStorage.setItem('smartpitch_forecast_temp_type', tempType);
    } catch (e) {}
    
    // Save to backend for control logic
    fetch('/api/settings/forecast', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ duration: parseInt(duration), temp_type: tempType })
    }).catch(e => console.log('Failed to save forecast settings:', e));
  }

  // Load forecast monitor settings from API (with localStorage fallback)
  async function loadForecastSettings() {
    let duration = '24';
    let tempType = 'real';
    
    try {
      const res = await fetch('/api/settings/forecast').then(r => r.ok ? r.json() : null).catch(() => null);
      if (res && res.value) {
        duration = String(res.value.duration || 24);
        tempType = res.value.temp_type || 'real';
      } else {
        // Fallback to localStorage
        duration = localStorage.getItem('smartpitch_forecast_duration') || '24';
        tempType = localStorage.getItem('smartpitch_forecast_temp_type') || 'real';
      }
    } catch (e) {
      duration = localStorage.getItem('smartpitch_forecast_duration') || '24';
      tempType = localStorage.getItem('smartpitch_forecast_temp_type') || 'real';
    }
    
    // Set dropdown
    const durationEl = document.getElementById('forecastDuration');
    if (durationEl) durationEl.value = duration;
    
    // Set radio
    const radioEl = document.querySelector('input[name="forecastTempType"][value="' + tempType + '"]');
    if (radioEl) radioEl.checked = true;
    
    // Update display
    updateForecastAverage();
  }



  // ===== Flow Rate & Energy Calculation =====
  function saveFlowRate(value) {
    const flowRate = parseFloat(value) || 0;
    localStorage.setItem('smartpitch_flow_rate', flowRate);
    
    fetch('/api/settings/flow_rate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ value: flowRate })
    }).catch(e => console.log('Failed to save flow rate:', e));
    
    // Recalculate energy display
    updateEnergyDisplay();
  }
  
  async function loadFlowRate() {
    let flowRate = parseFloat(localStorage.getItem('smartpitch_flow_rate')) || 0;
    
    try {
      const res = await fetch('/api/settings/flow_rate').then(r => r.ok ? r.json() : null).catch(() => null);
      if (res && res.value !== undefined) {
        flowRate = parseFloat(res.value) || 0;
        localStorage.setItem('smartpitch_flow_rate', flowRate);
      }
    } catch (e) {}
    
    const input = document.getElementById('flowRateInput');
    if (input && flowRate > 0) input.value = flowRate;
    
    return flowRate;
  }
  
  function calculatePowerKw(flowRateLps, flowTempC, returnTempC) {
    // Q = m * c * deltaT
    // For water: c = 4.186 kJ/(kgC), and 1 L water = 1 kg
    // Power (kW) = flowRate(L/s) * 4.186 * (flow - return)
    if (!flowRateLps || flowRateLps <= 0) return null;
    const deltaT = flowTempC - returnTempC;
    if (deltaT <= 0) return 0;
    return flowRateLps * 4.186 * deltaT;
  }
  
  async function updateEnergyDisplay() {
    const flowRate = parseFloat(document.getElementById('flowRateInput')?.value) || 0;
    
    try {
      const [status, cost] = await Promise.all([
        fetch('/api/status').then(r => r.json()),
        fetch('/api/cost').then(r => r.json())
      ]);
      const t = status.latest_trend || {};
      const rate = cost.current_rate?.pence_per_kwh || 0;
      const heatEnabled = t.heat_enabled === true;
      
      const el = document.getElementById('liveKw');
      const costEl = document.getElementById('liveCostHr');
      
      // Only show power when heating is actually enabled
      if (!heatEnabled) {
        if (el) el.textContent = '0.0 kW';
        if (costEl) costEl.textContent = '0.00/hr';
      } else if (flowRate <= 0) {
        if (el) el.textContent = 'Set flow rate';
        if (costEl) costEl.textContent = '';
      } else {
        const secFlow = t.sec_flow_c;
        const secReturn = t.sec_return_c;
        const powerKw = calculatePowerKw(flowRate, secFlow, secReturn);
        
        if (el) {
          if (powerKw !== null && powerKw > 0) {
            el.textContent = powerKw.toFixed(1) + ' kW';
            if (costEl && rate > 0) {
              const costPerHour = (powerKw * rate) / 100;
              costEl.textContent = '' + costPerHour.toFixed(2) + '/hr';
            }
          } else {
            el.textContent = '0 kW';
            if (costEl) costEl.textContent = '0.00/hr';
          }
        }
      }
    } catch (e) {
      console.log('Energy calc error:', e);
    }
  }

  function getTempBand(temp) {
    if (temp === null || temp === undefined) return 'UNK';
    if (temp <= -6) return 'T<=-6';
    if (temp <= -4) return 'T-6..-4';
    if (temp <= -2) return 'T-4..-2';
    if (temp <= 0) return 'T-2..0';
    if (temp <= 2) return 'T0..2';
    return 'T>2';
  }
  
  function getWindBand(wind) {
    if (wind === null || wind === undefined) return 'UNK';
    if (wind < 2) return 'W0..2';
    if (wind < 5) return 'W2..5';
    if (wind < 8) return 'W5..8';
    return 'W>8';
  }
  
  function getCloudBand(cloud) {
    if (cloud === null || cloud === undefined) return 'UNK';
    if (cloud < 10) return 'C0..10';
    if (cloud < 30) return 'C10..30';
    if (cloud < 60) return 'C30..60';
    if (cloud < 85) return 'C60..85';
    return 'C>85';
  }
  
  function getHumidityBand(humidity) {
    if (humidity === null || humidity === undefined) return 'UNK';
    if (humidity < 60) return 'H<60';
    if (humidity < 80) return 'H60..80';
    return 'H>80';
  }
  
  async function loadLearningData() {
    try {
      // Get current conditions
      const statusRes = await fetch('/api/status');
      const status = await statusRes.json();
      const t = status.latest_trend || {};
      
      const tempBand = getTempBand(t.outside_temp_c);
      const windBand = getWindBand(t.wind_speed);
      const cloudBand = getCloudBand(t.cloud_cover_pct);
      const humidityBand = getHumidityBand(t.humidity_pct);
      
      setText('currentTempBand', tempBand);
      setText('currentCloudBand', cloudBand);
      setText('currentHumidityBand', humidityBand);
      setText('currentWindBand', windBand);
      
      // Get learning data
      const res = await fetch('/api/learning/bands');
      const data = await res.json();
      const rows = data.rows || [];
      
      const thead = document.getElementById('learningThead');
      const tbody = document.getElementById('learningTbody');
      
      if (!thead || !tbody) return;
      
      const cols = ['temp_band', 'cloud_band', 'humidity_band', 'wind_band', 'sessions', 'pass', 'fail', 'pass_rate', 'avg_lead_hours', 'avg_margin_hours', 'avg_pass_wish', 'avg_fail_wish'];
      const colLabels = ['Temp', 'Cloud', 'Humidity', 'Wind', 'Sessions', 'Pass', 'Fail', 'Pass %', 'Lead (hrs)', 'Margin (hrs)', 'Pass Wish C', 'Fail Wish C'];
      
      thead.innerHTML = '<tr>' + colLabels.map(c => '<th>' + c + '</th>').join('') + '</tr>';
      
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="small" style="padding:14px;">No historical data yet. Sessions will appear after heating cycles complete.</td></tr>';
      } else {
        tbody.innerHTML = rows.map(r => {
          const isCurrentMatch = (r.temp_band === tempBand && r.cloud_band === cloudBand && r.humidity_band === humidityBand && r.wind_band === windBand);
          const rowStyle = isCurrentMatch ? 'background:rgba(46,229,157,0.15);' : '';
          return '<tr style="' + rowStyle + '">' + cols.map(c => {
            let val = r[c];
            if (c === 'pass_rate') val = (val !== null && val !== undefined ? parseFloat(val).toFixed(0) + '%' : '');
            else if (c === 'avg_lead_hours' || c === 'avg_margin_hours') val = (val !== null && val !== undefined ? parseFloat(val).toFixed(1) : '');
            else if (c === 'avg_pass_wish' || c === 'avg_fail_wish') val = (val !== null && val !== undefined ? parseFloat(val).toFixed(1) + 'C' : '');
            else if (val === null || val === undefined) val = '';
            return '<td>' + val + '</td>';
          }).join('') + '</tr>';
        }).join('');
      }
      
      setText('learningMeta', 'Showing ' + rows.length + ' weather band combinations from historical sessions');
      
    } catch (e) {
      console.error('Failed to load learning data:', e);
      setText('learningMeta', 'Error loading learning data: ' + e.message);
    }
  }

  (async function boot(){
    loadManualState();
    loadPIDParams();
    loadFlowRate();
    loadForecastSettings();
    updatePLCDisplay();
    setInterval(updatePLCDisplay, 5000);
    try{
      await safeRefresh();
      await loadScheduleMonth();
    }catch(e){
      console.log("boot error:", e);
    }
    setInterval(safeRefresh, 10000);
  })();

  // Manual Control Functions
  function toggleManualOverride() {
    const enabled = document.getElementById('manualOverrideEnabled').checked;
    const container = document.getElementById('manualControlsContainer');
    if (container) {
      container.style.opacity = enabled ? '1' : '0.5';
      container.style.pointerEvents = enabled ? 'auto' : 'none';
    }
    // Save override state to API
    fetch('/api/manual/override', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled })
    }).then(r => r.json())
      .then(d => {
        console.log('Manual override:', enabled);
        // Update PLC display to show auto or manual values
        updatePLCDisplay();
      })
      .catch(e => console.error('Failed to set override:', e));
  }
  
  function setManualDO(channel, state) {
    fetch('/api/manual/do', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ channel: channel, state: state })
    }).then(r => r.json())
      .then(d => {
        console.log('DO' + channel + ':', state);
        updatePLCDisplay();
      })
      .catch(e => console.error('Failed to set DO:', e));
  }
  
  function updateAODisplay(channel, value) {
    const el = document.getElementById('manualAO' + channel + 'Value');
    if (el) el.textContent = value + '%';
  }
  
  function setManualAO(channel, value) {
    fetch('/api/manual/ao', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ channel: channel, value: parseInt(value) })
    }).then(r => r.json())
      .then(d => {
        console.log('AO' + channel + ':', value + '%');
        updatePLCDisplay();
      })
      .catch(e => console.error('Failed to set AO:', e));
  }
  
  function setAOEnabled(channel, enabled) {
    const slider = document.getElementById('manualAO' + channel);
    if (slider) {
      slider.disabled = !enabled;
      if (!enabled) {
        slider.value = 0;
        updateAODisplay(channel, 0);
        setManualAO(channel, 0);
      }
    }
    fetch('/api/manual/ao/enable', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ channel: channel, enabled: enabled })
    }).then(r => r.json())
      .then(d => {
        console.log('AO' + channel + ' enabled:', enabled);
        updatePLCDisplay();
      })
      .catch(e => console.error('Failed to set AO enabled:', e));
  }
  
  function loadPIDParams() {
    Promise.all([
      fetch('/api/pid/params').then(r => r.json()),
      fetch('/api/status').then(r => r.json()),
      fetch('/api/manual/state').then(r => r.json()),
      fetch('/api/settings/pitch_selection').then(r => r.json()).catch(() => ({ value: 'both' }))
    ]).then(([params, status, manual, pitchSetting]) => {
      // Load saved parameters
      if (params.kp !== undefined) document.getElementById('pidKp').value = params.kp;
      if (params.tn !== undefined) document.getElementById('pidTn').value = params.tn;
      if (params.tv !== undefined) document.getElementById('pidTv').value = params.tv;
      
      // Load pitch selection
      const pitchSel = document.getElementById('pitchSelection');
      const pitchValue = pitchSetting.value || 'both';
      if (pitchSel && pitchSel.value !== pitchValue) pitchSel.value = pitchValue;
      
      // Get actual output state from control system
      const t = status.latest_trend || {};
      const overrideOn = manual.override_enabled;
      
      let active, outputPercent, pump1On, pump2On;
      if (overrideOn) {
        // Manual mode - use manual values
        active = manual.ao1_enabled && (manual.ao1 > 0);
        outputPercent = manual.ao1 || 0;
        pump1On = manual.ao2_enabled && (manual.ao2 > 0);
        pump2On = manual.ao3_enabled && (manual.ao3 > 0);
      } else {
        // Auto mode - calculate proportional output based on temp error (same as schematic)
        active = t.heat_enabled || false;
        if (active) {
          const wishTemp = status.wish_temp ?? 16;
          const secFlow = t.sec_flow_c ?? 18;
          const error = wishTemp - secFlow;
          const kp = 5; // 5% per degree error
          outputPercent = 50 + (error * kp); // Base at 50%, adjust by error
          outputPercent = Math.max(0, Math.min(100, outputPercent)); // Clamp 0-100
        } else {
          outputPercent = 0;
        }
        pump1On = active && (pitchValue === 'both' || pitchValue === 'pitch1');
        pump2On = active && (pitchValue === 'both' || pitchValue === 'pitch2');
      }
      
      updatePIDDisplay(active, outputPercent);
      
      // Update pitch pump status LEDs
      const led1 = document.getElementById('pitch1StatusLed');
      const led2 = document.getElementById('pitch2StatusLed');
      if (led1) {
        led1.style.background = pump1On ? '#2ee59d' : '#3a4a5a';
        led1.style.boxShadow = pump1On ? '0 0 8px #2ee59d' : 'none';
      }
      if (led2) {
        led2.style.background = pump2On ? '#2ee59d' : '#3a4a5a';
        led2.style.boxShadow = pump2On ? '0 0 8px #2ee59d' : 'none';
      }
    }).catch(e => console.log('PID params not available yet:', e));
  }
  
  function savePIDParams() {
    const params = {
      kp: parseFloat(document.getElementById('pidKp').value) || 0.005,
      tn: parseInt(document.getElementById('pidTn').value) || 5,
      tv: parseInt(document.getElementById('pidTv').value) || 0
    };
    
    fetch('/api/pid/params', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params)
    }).then(r => r.json()).then(d => {
      if (d.ok) {
        showToast('PID parameters saved', 'success');
      } else {
        showToast('Failed to save parameters', 'error');
      }
    }).catch(e => {
      showToast('Failed to save parameters', 'error');
    });
  }
  
  function savePitchSelection() {
    const sel = document.getElementById('pitchSelection').value;
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: 'pitch_selection', value: sel })
    }).then(r => r.json()).then(d => {
      console.log('Pitch selection saved:', sel);
      // Trigger immediate update of displays
      loadPIDParams();
    }).catch(e => console.error('Failed to save pitch selection:', e));
  }
  
  function loadPitchSelection() {
    fetch('/api/settings/pitch_selection')
      .then(r => r.json())
      .then(d => {
        const sel = document.getElementById('pitchSelection');
        if (sel && d.value) sel.value = d.value;
      })
      .catch(e => console.log('Pitch selection not set yet'));
  }
  
  function updatePIDDisplay(active, outputPercent) {
    const led = document.getElementById('pidStatusLed');
    const text = document.getElementById('pidStatusText');
    const bar = document.getElementById('pidOutputBar');
    const volts = document.getElementById('pidOutputVolts');
    const percent = document.getElementById('pidOutputPercent');
    
    if (active) {
      if (led) { led.style.background = '#2ee59d'; led.style.boxShadow = '0 0 8px #2ee59d'; }
      if (text) { text.textContent = 'ACTIVE'; text.style.color = '#2ee59d'; }
    } else {
      if (led) { led.style.background = '#3a4a5a'; led.style.boxShadow = 'none'; }
      if (text) { text.textContent = 'OFF'; text.style.color = '#7a8a9a'; }
    }
    
    const pct = outputPercent || 0;
    const v = (pct / 100 * 10).toFixed(1);
    if (bar) bar.style.width = pct + '%';
    if (volts) volts.textContent = v;
    if (percent) percent.textContent = '(' + Math.round(pct) + '%)';
  }

  function showToast(message, type) {
    // Remove existing toast
    const existing = document.getElementById('toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.id = 'toast';
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;font-size:13px;font-weight:600;z-index:10000;animation:toastIn 0.3s ease;';
    toast.style.background = type === 'success' ? 'rgba(46,229,157,0.95)' : 'rgba(255,100,100,0.95)';
    toast.style.color = type === 'success' ? '#000' : '#fff';
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'toastOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function toggleStandardTrigger() {
    const method = document.getElementById('stdTriggerMethod')?.value || 'time';
    const timeSettings = document.getElementById('stdTimeBasedSettings');
    const forecastSettings = document.getElementById('stdForecastSettings');
    
    if (method === 'time') {
      if (timeSettings) timeSettings.style.display = 'block';
      if (forecastSettings) forecastSettings.style.display = 'none';
    } else {
      if (timeSettings) timeSettings.style.display = 'none';
      if (forecastSettings) forecastSettings.style.display = 'block';
      updateStandardForecastDesc();
    }
  }
  
  function updateStandardForecastDesc() {
    const days = document.getElementById('stdForecastDays')?.value || 3;
    const tempType = document.getElementById('stdForecastTempType')?.value || 'real';
    const threshold = document.getElementById('frostThreshold')?.value || 0;
    
    const tempTypeDesc = document.getElementById('stdTempTypeDesc');
    const daysDesc = document.getElementById('stdDaysDesc');
    const thresholdDesc = document.getElementById('stdThresholdDesc');
    
    if (tempTypeDesc) tempTypeDesc.textContent = tempType === 'feels' ? 'feels-like' : 'actual';
    if (daysDesc) daysDesc.textContent = days;
    if (thresholdDesc) thresholdDesc.textContent = threshold;
  }
  
  function saveStandardSettings() {
    const triggerMethod = document.getElementById('stdTriggerMethod')?.value || 'time';
    const preTrainingHours = document.getElementById('stdPreTrainingHours')?.value || 72;
    const forecastDays = document.getElementById('stdForecastDays')?.value || 3;
    const forecastTempType = document.getElementById('stdForecastTempType')?.value || 'real';
    
    fetch('/api/settings/standard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        trigger_method: triggerMethod,
        pre_training_hours: parseFloat(preTrainingHours),
        forecast_days: parseInt(forecastDays),
        forecast_temp_type: forecastTempType
      })
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        showToast('Standard mode settings saved', 'success');
        updateStandardForecastDesc();
      } else {
        showToast('Failed to save settings', 'error');
      }
    }).catch(e => {
      console.error('Save error:', e);
      showToast('Failed to save settings', 'error');
    });
  }
  function loadStandardSettings() {
    fetch('/api/settings/standard').then(r => r.json()).then(data => {
      // Trigger method
      if (data.trigger_method !== undefined) {
        const el = document.getElementById('stdTriggerMethod');
        if (el) el.value = data.trigger_method;
      }
      
      // Pre-training hours (time-based)
      if (data.pre_training_hours !== undefined) {
        const el = document.getElementById('stdPreTrainingHours');
        if (el) el.value = data.pre_training_hours;
      }
      
      // Forecast days
      if (data.forecast_days !== undefined) {
        const el = document.getElementById('stdForecastDays');
        if (el) el.value = data.forecast_days;
      }
      
      // Forecast temp type
      if (data.forecast_temp_type !== undefined) {
        const el = document.getElementById('stdForecastTempType');
        if (el) el.value = data.forecast_temp_type;
      }
      
      // Update toggle display
      toggleStandardTrigger();
    }).catch(e => console.error('Load settings error:', e));
  }

  function saveFrostSettings() {
    const threshold = document.getElementById('frostThreshold')?.value || 0;
    const tempType = document.getElementById('frostTempType')?.value || 'real';
    const deadband = document.getElementById('frostDeadband')?.value || 1.5;
    const minHeatMinutes = document.getElementById('minHeatMinutes')?.value || 30;
    const soilFrozenThreshold = document.getElementById('soilFrozenThreshold')?.value || 0;
    const forecastOverrideEnabled = document.getElementById('forecastOverrideEnabled')?.checked ?? true;
    const forecastOverrideThreshold = document.getElementById('forecastOverrideThreshold')?.value || 5;
    
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        key: 'frost',
        value: {
          threshold: parseFloat(threshold),
          temp_type: tempType,
          deadband: parseFloat(deadband),
          min_heat_minutes: parseFloat(minHeatMinutes),
          soil_frozen_threshold: parseFloat(soilFrozenThreshold),
          forecast_override_enabled: forecastOverrideEnabled,
          forecast_override_threshold: parseFloat(forecastOverrideThreshold)
        }
      })
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        showToast('Frost settings saved', 'success');
      } else {
        showToast('Failed to save frost settings', 'error');
      }
    }).catch(e => {
      console.error('Save frost settings error:', e);
      showToast('Failed to save frost settings', 'error');
    });
  }
  
  function loadFrostSettings() {
    fetch('/api/settings/frost').then(r => r.json()).then(data => {
      if (data.threshold !== undefined) {
        const el = document.getElementById('frostThreshold');
        if (el) el.value = data.threshold;
      }
      if (data.temp_type !== undefined) {
        const el = document.getElementById('frostTempType');
        if (el) el.value = data.temp_type;
      }
      if (data.deadband !== undefined) {
        const el = document.getElementById('frostDeadband');
        if (el) el.value = data.deadband;
      }
      if (data.min_heat_minutes !== undefined) {
        const el = document.getElementById('minHeatMinutes');
        if (el) el.value = data.min_heat_minutes;
      }
      if (data.soil_frozen_threshold !== undefined) {
        const el = document.getElementById('soilFrozenThreshold');
        if (el) el.value = data.soil_frozen_threshold;
      }
      if (data.forecast_override_enabled !== undefined) {
        const el = document.getElementById('forecastOverrideEnabled');
        if (el) el.checked = data.forecast_override_enabled;
      }
      if (data.forecast_override_threshold !== undefined) {
        const el = document.getElementById('forecastOverrideThreshold');
        if (el) el.value = data.forecast_override_threshold;
      }
    }).catch(e => console.error('Load frost settings error:', e));
  }


  
  // SmartPitch sub-tab navigation
  function showSpTab(tab) {
    const tabs = ['safetynet', 'heatcurve', 'timing'];
    tabs.forEach(t => {
      const panel = document.getElementById('spTab' + t.charAt(0).toUpperCase() + t.slice(1).replace('net', 'Net').replace('curve', 'Curve'));
      const btn = document.getElementById('spSub' + t.charAt(0).toUpperCase() + t.slice(1).replace('net', 'Net').replace('curve', 'Curve'));
      if (panel) panel.style.display = (t === tab) ? 'block' : 'none';
      if (btn) btn.classList.toggle('active', t === tab);
    });
  }

function saveSmartPitchSettings() {
    // Safety Net settings
    const safetyNetEnabled = document.getElementById('safetyNetEnabled')?.checked ?? true;
    const emergencyThreshold = document.getElementById('emergencyThreshold')?.value || 1.0;
    const offTrackSlope = document.getElementById('offTrackSlope')?.value || -0.5;
    const slopeWindow = document.getElementById('slopeWindow')?.value || 60;
    
    // Heat Curve settings
    const useHeatCurve = document.getElementById('useHeatCurve')?.checked ?? true;
    const learningConfidence = document.getElementById('learningConfidence')?.value || 70;
    
    // Timing settings
    const forecastLookahead = document.getElementById('forecastLookahead')?.value || 24;
    const successTemp = document.getElementById('successTemp')?.value || 5.0;
    const coolBufferHours = document.getElementById('coolBufferHours')?.value || 2;
    
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        key: 'smartpitch',
        value: {
          safety_net_enabled: safetyNetEnabled,
          emergency_threshold: parseFloat(emergencyThreshold),
          off_track_slope: parseFloat(offTrackSlope),
          slope_window_minutes: parseInt(slopeWindow),
          use_heat_curve: useHeatCurve,
          learning_confidence: parseInt(learningConfidence),
          forecast_lookahead_hours: parseInt(forecastLookahead),
          success_temp: parseFloat(successTemp),
          cool_buffer_hours: parseInt(coolBufferHours)
        }
      })
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        showToast('SmartPitch settings saved', 'success');
      } else {
        showToast('Failed to save settings', 'error');
      }
    }).catch(e => {
      console.error('Save SmartPitch settings error:', e);
      showToast('Failed to save settings', 'error');
    });
  }
  
  function loadSmartPitchSettings() {
    fetch('/api/settings/smartpitch').then(r => r.json()).then(data => {
      // Safety Net settings
      if (data.safety_net_enabled !== undefined) {
        const el = document.getElementById('safetyNetEnabled');
        if (el) el.checked = data.safety_net_enabled;
      }
      if (data.emergency_threshold !== undefined) {
        const el = document.getElementById('emergencyThreshold');
        if (el) el.value = data.emergency_threshold;
      }
      if (data.off_track_slope !== undefined) {
        const el = document.getElementById('offTrackSlope');
        if (el) el.value = data.off_track_slope;
      }
      if (data.slope_window_minutes !== undefined) {
        const el = document.getElementById('slopeWindow');
        if (el) el.value = data.slope_window_minutes;
      }
      
      // Heat Curve settings
      if (data.use_heat_curve !== undefined) {
        const el = document.getElementById('useHeatCurve');
        if (el) el.checked = data.use_heat_curve;
      }
      if (data.learning_confidence !== undefined) {
        const el = document.getElementById('learningConfidence');
        if (el) el.value = data.learning_confidence;
      }
      
      // Timing settings
      if (data.forecast_lookahead_hours !== undefined) {
        const el = document.getElementById('forecastLookahead');
        if (el) el.value = data.forecast_lookahead_hours;
      }
      if (data.success_temp !== undefined) {
        const el = document.getElementById('successTemp');
        if (el) el.value = data.success_temp;
      }
      if (data.cool_buffer_hours !== undefined) {
        const el = document.getElementById('coolBufferHours');
        if (el) el.value = data.cool_buffer_hours;
      }
    }).catch(e => console.error('Load SmartPitch settings error:', e));
  }


  // ========================================
  // SMARTPITCH MODE TRANSITION ANIMATIONS
  // ========================================
  
  let neuralCanvas, neuralCtx;
  let particles = [];
  let nodes = [];
  let animationId = null;
  
  function initNeuralCanvas() {
    const modePanel = document.querySelector('.mode-panel');
    if (!modePanel) return;
    
    // Create canvas if it doesn't exist
    if (!document.getElementById('neuralCanvas')) {
      const canvas = document.createElement('canvas');
      canvas.id = 'neuralCanvas';
      modePanel.style.position = 'relative';
      modePanel.insertBefore(canvas, modePanel.firstChild);
    }
    
    neuralCanvas = document.getElementById('neuralCanvas');
    neuralCtx = neuralCanvas.getContext('2d');
    
    // Set canvas size
    neuralCanvas.width = modePanel.offsetWidth;
    neuralCanvas.height = modePanel.offsetHeight;
    
    // Create neural network nodes
    nodes = [];
    const nodeCount = 15;
    for (let i = 0; i < nodeCount; i++) {
      nodes.push({
        x: Math.random() * neuralCanvas.width,
        y: Math.random() * neuralCanvas.height,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        radius: Math.random() * 3 + 2,
        pulsePhase: Math.random() * Math.PI * 2
      });
    }
  }
  
  function animateNeuralNetwork() {
    if (!neuralCtx || !neuralCanvas) return;
    
    neuralCtx.clearRect(0, 0, neuralCanvas.width, neuralCanvas.height);
    
    const time = Date.now() * 0.001;
    
    // Update and draw nodes
    nodes.forEach((node, i) => {
      // Update position
      node.x += node.vx;
      node.y += node.vy;
      
      // Bounce off edges
      if (node.x < 0 || node.x > neuralCanvas.width) node.vx *= -1;
      if (node.y < 0 || node.y > neuralCanvas.height) node.vy *= -1;
      
      // Pulse effect
      const pulse = Math.sin(time * 2 + node.pulsePhase) * 0.5 + 0.5;
      const radius = node.radius + pulse * 2;
      
      // Draw node
      neuralCtx.beginPath();
      neuralCtx.arc(node.x, node.y, radius, 0, Math.PI * 2);
      neuralCtx.fillStyle = 'rgba(100, 180, 255, ' + (0.5 + pulse * 0.5) + ')';
      neuralCtx.fill();
      
      // Draw glow
      const gradient = neuralCtx.createRadialGradient(node.x, node.y, 0, node.x, node.y, radius * 3);
      gradient.addColorStop(0, 'rgba(100, 180, 255, 0.3)');
      gradient.addColorStop(1, 'rgba(100, 180, 255, 0)');
      neuralCtx.beginPath();
      neuralCtx.arc(node.x, node.y, radius * 3, 0, Math.PI * 2);
      neuralCtx.fillStyle = gradient;
      neuralCtx.fill();
      
      // Draw connections to nearby nodes
      nodes.forEach((other, j) => {
        if (i >= j) return;
        const dx = other.x - node.x;
        const dy = other.y - node.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 150) {
          const opacity = (1 - dist / 150) * 0.5;
          neuralCtx.beginPath();
          neuralCtx.moveTo(node.x, node.y);
          neuralCtx.lineTo(other.x, other.y);
          neuralCtx.strokeStyle = 'rgba(100, 180, 255, ' + opacity + ')';
          neuralCtx.lineWidth = 1;
          neuralCtx.stroke();
          
          // Animated pulse along connection
          const pulsePos = (time * 0.5 + i * 0.1) % 1;
          const pulseX = node.x + dx * pulsePos;
          const pulseY = node.y + dy * pulsePos;
          neuralCtx.beginPath();
          neuralCtx.arc(pulseX, pulseY, 2, 0, Math.PI * 2);
          neuralCtx.fillStyle = 'rgba(0, 255, 255, ' + opacity + ')';
          neuralCtx.fill();
        }
      });
    });
    
    animationId = requestAnimationFrame(animateNeuralNetwork);
  }
  
  function startNeuralAnimation() {
    initNeuralCanvas();
    const canvas = document.getElementById('neuralCanvas');
    if (canvas) {
      canvas.classList.add('active');
      animateNeuralNetwork();
    }
  }
  
  function stopNeuralAnimation() {
    const canvas = document.getElementById('neuralCanvas');
    if (canvas) {
      canvas.classList.remove('active');
    }
    if (animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
  }
  
  function triggerModeTransition(newMode) {
    const modePanel = document.querySelector('.mode-panel');
    const modeCard = document.querySelector('.mode-card');
    
    if (newMode === 'SMARTPITCH') {
      // === ACTIVATING SMARTPITCH - THE WOW MOMENT ===
      
      // 1. Add scanning line effect
      let scanLine = document.querySelector('.scan-line');
      if (!scanLine) {
        scanLine = document.createElement('div');
        scanLine.className = 'scan-line';
        modePanel?.appendChild(scanLine);
      }
      scanLine.classList.remove('active');
      void scanLine.offsetWidth; // Force reflow
      scanLine.classList.add('active');
      
      // 2. Create AI activation pulse
      let overlay = document.querySelector('.ai-activation-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'ai-activation-overlay';
        modePanel?.appendChild(overlay);
      }
      overlay.classList.remove('pulse');
      void overlay.offsetWidth;
      overlay.classList.add('pulse');
      
      // 3. Start neural network animation
      setTimeout(() => startNeuralAnimation(), 300);
      
      // 4. Add hexagon grid background
      let hexGrid = document.querySelector('.hex-grid');
      if (!hexGrid) {
        hexGrid = document.createElement('div');
        hexGrid.className = 'hex-grid';
        modePanel?.insertBefore(hexGrid, modePanel.firstChild);
      }
      setTimeout(() => hexGrid.classList.add('active'), 500);
      
      // 5. Mode card glow effect
      if (modeCard) {
        modeCard.classList.add('smartpitch-active');
      }
      
      // 6. Show AI status badge with animation
      const aiBadge = document.getElementById('aiStatusBadge');
      if (aiBadge) {
        setTimeout(() => aiBadge.classList.add('visible'), 800);
      }
      
      // 7. Animate learning stats
      document.querySelectorAll('.learning-stat').forEach((stat, i) => {
        setTimeout(() => stat.classList.add('animate-in'), 1000 + i * 150);
      });
      
      // 8. Play activation sound (optional - browser may block)
      // playActivationSound();
      
      // 9. Glitch effect on title
      const title = document.querySelector('.smartpitch-title');
      if (title) {
        title.classList.add('glitch', 'active');
        title.setAttribute('data-text', title.textContent);
        setTimeout(() => title.classList.remove('active'), 500);
      }
      
      // 10. Create floating particles
      createFloatingParticles(modePanel);
      
    } else {
      // === DEACTIVATING SMARTPITCH ===
      stopNeuralAnimation();
      
      const hexGrid = document.querySelector('.hex-grid');
      if (hexGrid) hexGrid.classList.remove('active');
      
      const modeCard = document.querySelector('.mode-card');
      if (modeCard) modeCard.classList.remove('smartpitch-active');
      
      const aiBadge = document.getElementById('aiStatusBadge');
      if (aiBadge) aiBadge.classList.remove('visible');
      
      document.querySelectorAll('.learning-stat').forEach(stat => {
        stat.classList.remove('animate-in');
      });
      
      // Remove particles
      document.querySelectorAll('.particle').forEach(p => p.remove());
    }
  }
  
  function createFloatingParticles(container) {
    if (!container) return;
    
    // Remove existing particles
    container.querySelectorAll('.particle').forEach(p => p.remove());
    
    // Create new particles
    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 3 + 's';
      container.appendChild(particle);
      
      setTimeout(() => particle.classList.add('float'), 100 + i * 50);
    }
  }
  
  // Enhanced setMode function wrapper
  const originalSetMode = typeof setMode === 'function' ? setMode : null;
  
  function setModeEnhanced(mode) {
    // Trigger visual transition
    triggerModeTransition(mode);
    
    // Add ripple effect to clicked button
    const btn = document.querySelector('.mode-btn[onclick*="' + mode + '"]') || 
                document.querySelector('.mode-btn.active');
    if (btn) {
      btn.classList.add('ripple');
      setTimeout(() => btn.classList.remove('ripple'), 600);
    }
    
    // Call original setMode if it exists
    if (originalSetMode) {
      originalSetMode(mode);
    } else {
      // Fallback - make API call directly
      fetch('/api/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: mode })
      }).then(r => r.json()).then(data => {
        if (data.ok) {
          showToast('Mode changed to ' + mode, 'success');
          reloadActiveTable(true);
        }
      });
    }
  }
  
  // Check current mode on page load and apply effects if SmartPitch
  function checkInitialMode() {
    fetch('/api/mode').then(r => r.json()).then(data => {
      if (data.mode === 'SMARTPITCH') {
        setTimeout(() => triggerModeTransition('SMARTPITCH'), 500);
      }
    }).catch(() => {});
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkInitialMode, 1000);
  });

  // Load settings on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadStandardSettings();
    loadFrostSettings();
    loadSmartPitchSettings();
  });

  function updateModbusDisplay() {
    // Sensor depths: Centre spots at -25cm, corners at -8cm
    // Pitch 1: MB2 (-25cm), MB3-MB6 (-8cm)
    // Pitch 2: MB7 (-25cm), MB8-MB11 (-8cm)
    fetch('/api/status').then(r => r.json()).then(status => {
      const t = status.latest_trend || {};
      
      // Base temperatures (test values)
      const base8cm = t.avg_field_8cm_c ?? 6.0;    // -8cm sensors
      const base25cm = t.avg_field_25cm_c ?? 8.5;  // -25cm sensors (warmer deeper)
      const ambient = t.outside_temp_c ?? 6.5;
      
      const setVal = (id, val) => { 
        const el = document.getElementById(id); 
        if(el) el.textContent = (val !== null && val !== undefined) ? val.toFixed(1) + 'C' : '--C'; 
      };
      
      // MB1 = Air temperature
      setVal('modbusMB1', ambient);
      
      // Pitch 1 sensors
      const p1Centre25 = base25cm;                  // MB2 Centre at -25cm
      const p1Corners8 = [
        base8cm + 0.3,     // MB3 TL at -8cm
        base8cm - 0.2,     // MB4 TR at -8cm
        base8cm + 0.1,     // MB5 BL at -8cm
        base8cm - 0.4      // MB6 BR at -8cm
      ];
      setVal('modbusMB2', p1Centre25);
      setVal('modbusMB3', p1Corners8[0]);
      setVal('modbusMB4', p1Corners8[1]);
      setVal('modbusMB5', p1Corners8[2]);
      setVal('modbusMB6', p1Corners8[3]);
      const p1Avg8 = p1Corners8.reduce((a,b) => a+b, 0) / p1Corners8.length;
      document.getElementById('modbusAvgP1').textContent = p1Avg8.toFixed(1) + 'C (-8cm)';
      
      // Pitch 2 sensors
      const p2Centre25 = base25cm + 0.3;            // MB7 Centre at -25cm
      const p2Corners8 = [
        base8cm + 0.7,     // MB8 TL at -8cm
        base8cm + 0.2,     // MB9 TR at -8cm
        base8cm + 0.9,     // MB10 BL at -8cm
        base8cm + 0.4      // MB11 BR at -8cm
      ];
      setVal('modbusMB7', p2Centre25);
      setVal('modbusMB8', p2Corners8[0]);
      setVal('modbusMB9', p2Corners8[1]);
      setVal('modbusMB10', p2Corners8[2]);
      setVal('modbusMB11', p2Corners8[3]);
      const p2Avg8 = p2Corners8.reduce((a,b) => a+b, 0) / p2Corners8.length;
      document.getElementById('modbusAvgP2').textContent = p2Avg8.toFixed(1) + 'C (-8cm)';
      
      // Calculate overall average of all 8 sensors at -8cm for field8 display
      const all8cmSensors = [...p1Corners8, ...p2Corners8];
      const avg8cm = all8cmSensors.reduce((a,b) => a+b, 0) / all8cmSensors.length;
      const field8El = document.getElementById('field8');
      if (field8El) field8El.textContent = avg8cm.toFixed(1) + 'C';
      
      // Average of the 2 centre spots at -25cm
      const avg25cm = (p1Centre25 + p2Centre25) / 2;
      const field25El = document.getElementById('field25');
      if (field25El) field25El.textContent = avg25cm.toFixed(1) + 'C';
      
      // Update last poll time
      document.getElementById('modbusLastPoll').textContent = new Date().toLocaleTimeString();
      
      // Status indicator
      const led = document.getElementById('modbusStatusLed');
      const txt = document.getElementById('modbusStatusText');
      if (led) led.style.background = '#2ee59d';
      if (led) led.style.boxShadow = '0 0 8px #2ee59d';
      if (txt) txt.textContent = 'ONLINE';
      
    }).catch(e => {
      console.error('Failed to update Modbus display:', e);
      const led = document.getElementById('modbusStatusLed');
      const txt = document.getElementById('modbusStatusText');
      if (led) led.style.background = '#ff5555';
      if (led) led.style.boxShadow = '0 0 8px #ff5555';
      if (txt) txt.textContent = 'OFFLINE';
    });
  }
  // Alarm Settings Functions
  function saveAlarmSettings() {
    const settings = {
      email: {
        smtp_server: document.getElementById('alarmSmtpServer').value,
        smtp_port: parseInt(document.getElementById('alarmSmtpPort').value) || 587,
        username: document.getElementById('alarmSmtpUser').value,
        password: document.getElementById('alarmSmtpPass').value,
        from_address: document.getElementById('alarmFromEmail').value,
        to_address: document.getElementById('alarmToEmail').value
      },
      temperature: {
        pri_flow_low: {
          enabled: document.getElementById('alarmPriFlowLowEnabled').checked,
          threshold: parseFloat(document.getElementById('alarmPriFlowLowThreshold').value) || 15,
          delay: parseInt(document.getElementById('alarmPriFlowLowDelay').value) || 60
        },
        pri_return_high: {
          enabled: document.getElementById('alarmPriReturnHighEnabled').checked,
          threshold: parseFloat(document.getElementById('alarmPriReturnHighThreshold').value) || 45,
          delay: parseInt(document.getElementById('alarmPriReturnHighDelay').value) || 60
        },
        pitch_frozen: {
          enabled: document.getElementById('alarmPitchFrozenEnabled').checked,
          threshold: parseFloat(document.getElementById('alarmPitchFrozenThreshold').value) || 1,
          delay: parseInt(document.getElementById('alarmPitchFrozenDelay').value) || 300
        },
        sec_flow_not_reaching: {
          enabled: document.getElementById('alarmSecFlowNotReachingEnabled').checked,
          offset: parseFloat(document.getElementById('alarmSecFlowNotReachingOffset').value) || 3,
          delay: parseInt(document.getElementById('alarmSecFlowNotReachingDelay').value) || 900
        }
      },
      hardware: {
        p1a_fault: document.getElementById('alarmP1AFaultEnabled').checked,
        p1b_fault: document.getElementById('alarmP1BFaultEnabled').checked,
        p2a_fault: document.getElementById('alarmP2AFaultEnabled').checked,
        p2b_fault: document.getElementById('alarmP2BFaultEnabled').checked,
        high_limit: document.getElementById('alarmHighLimitEnabled').checked
      },
      system: {
        comm_loss: {
          enabled: document.getElementById('alarmCommLossEnabled').checked,
          delay: parseInt(document.getElementById('alarmCommLossDelay').value) || 120
        },
        sensor_fail: document.getElementById('alarmSensorFailEnabled').checked,
        hysteresis: parseFloat(document.getElementById('alarmHysteresis').value) || 1
      },
      building_protect: {
        enabled: document.getElementById('buildingProtectEnabled').checked,
        close_below: parseFloat(document.getElementById('buildingProtectCloseBelowTemp').value) || 25,
        open_above: parseFloat(document.getElementById('buildingProtectOpenAboveTemp').value) || 30
      }
    };
    
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: 'alarms', value: settings })
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        showToast('Alarm settings saved', 'success');
      } else {
        showToast('Failed to save alarm settings', 'error');
      }
    }).catch(e => {
      console.error('Save alarm settings error:', e);
      showToast('Error saving alarm settings', 'error');
    });
  }
  
  function loadAlarmSettings() {
    fetch('/api/settings/alarms').then(r => r.json()).then(data => {
      const s = data.value || {};
      const email = s.email || {};
      const temp = s.temperature || {};
      const hw = s.hardware || {};
      const sys = s.system || {};
      
      document.getElementById('alarmSmtpServer').value = email.smtp_server || '';
      document.getElementById('alarmSmtpPort').value = email.smtp_port || 587;
      document.getElementById('alarmSmtpUser').value = email.username || '';
      document.getElementById('alarmSmtpPass').value = email.password || '';
      document.getElementById('alarmFromEmail').value = email.from_address || '';
      document.getElementById('alarmToEmail').value = email.to_address || '';
      
      const pfl = temp.pri_flow_low || {};
      document.getElementById('alarmPriFlowLowEnabled').checked = pfl.enabled || false;
      document.getElementById('alarmPriFlowLowThreshold').value = pfl.threshold || 15;
      document.getElementById('alarmPriFlowLowDelay').value = pfl.delay || 60;
      
      const prh = temp.pri_return_high || {};
      document.getElementById('alarmPriReturnHighEnabled').checked = prh.enabled || false;
      document.getElementById('alarmPriReturnHighThreshold').value = prh.threshold || 45;
      document.getElementById('alarmPriReturnHighDelay').value = prh.delay || 60;
      
      const pf = temp.pitch_frozen || {};
      document.getElementById('alarmPitchFrozenEnabled').checked = pf.enabled || false;
      document.getElementById('alarmPitchFrozenThreshold').value = pf.threshold || 1;
      document.getElementById('alarmPitchFrozenDelay').value = pf.delay || 300;
      
      const sfnr = temp.sec_flow_not_reaching || {};
      document.getElementById('alarmSecFlowNotReachingEnabled').checked = sfnr.enabled || false;
      document.getElementById('alarmSecFlowNotReachingOffset').value = sfnr.offset || 3;
      document.getElementById('alarmSecFlowNotReachingDelay').value = sfnr.delay || 900;
      
      document.getElementById('alarmP1AFaultEnabled').checked = hw.p1a_fault !== false;
      document.getElementById('alarmP1BFaultEnabled').checked = hw.p1b_fault !== false;
      document.getElementById('alarmP2AFaultEnabled').checked = hw.p2a_fault !== false;
      document.getElementById('alarmP2BFaultEnabled').checked = hw.p2b_fault !== false;
      document.getElementById('alarmHighLimitEnabled').checked = hw.high_limit !== false;
      
      const cl = sys.comm_loss || {};
      document.getElementById('alarmCommLossEnabled').checked = cl.enabled !== false;
      document.getElementById('alarmCommLossDelay').value = cl.delay || 120;
      document.getElementById('alarmSensorFailEnabled').checked = sys.sensor_fail !== false;
      document.getElementById('alarmHysteresis').value = sys.hysteresis || 1;
      
      const bp = s.building_protect || {};
      document.getElementById('buildingProtectEnabled').checked = bp.enabled !== false;
      document.getElementById('buildingProtectCloseBelowTemp').value = bp.close_below || 25;
      document.getElementById('buildingProtectOpenAboveTemp').value = bp.open_above || 30;
    }).catch(e => {
      console.error('Load alarm settings error:', e);
    });
  }
  
  function testAlarmEmail() {
    const email = {
      smtp_server: document.getElementById('alarmSmtpServer').value,
      smtp_port: parseInt(document.getElementById('alarmSmtpPort').value) || 587,
      username: document.getElementById('alarmSmtpUser').value,
      password: document.getElementById('alarmSmtpPass').value,
      from_address: document.getElementById('alarmFromEmail').value,
      to_address: document.getElementById('alarmToEmail').value
    };
    
    if (!email.smtp_server || !email.to_address) {
      showToast('Please fill in SMTP server and To address', 'error');
      return;
    }
    
    fetch('/api/alarms/test-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(email)
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        showToast('Test email sent successfully', 'success');
      } else {
        showToast('Failed to send test email: ' + (data.error || 'Unknown error'), 'error');
      }
    }).catch(e => {
      console.error('Test email error:', e);
      showToast('Error sending test email', 'error');
    });
  }


\n\n
  // Auto-refresh page every 4 hours to prevent memory buildup
  setTimeout(function() {
    console.log('Auto-refreshing page to clear memory...');
    location.reload();
  }, 4 * 60 * 60 * 1000);

</script>
</body>
</html>