<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartPitch</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(255,255,255,0.05);
      --panel2: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.12);
      --border2: rgba(255,255,255,0.18);
      --text:#eaf0ff;
      --muted:#9fb0d7;
      --shadow: 0 18px 40px rgba(0,0,0,0.38);
      --radius: 18px;

      --accent: #2ee59d;
      --accentSoft: rgba(46,229,157,0.14);

      --warn: #ffd166;
      --blue: #7aa7ff;
      --danger: rgba(255,120,120,0.35);
    }

    *{box-sizing:border-box}
    
    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #070b14;
      background-image:
        radial-gradient(1200px 700px at 50% 40%, rgba(46,229,157,0.15), transparent 60%),
        radial-gradient(800px 500px at 30% 60%, rgba(122,167,255,0.12), transparent 50%),
        radial-gradient(600px 400px at 70% 30%, rgba(255,209,102,0.08), transparent 50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease-out;
    }
    .splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .splash-logo {
      width: 200px;
      height: auto;
      animation: logoEntry 1.5s ease-out forwards, logoPulse 2s ease-in-out 1.5s infinite;
      filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
    }
    @keyframes logoEntry {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(30px);
        filter: drop-shadow(0 0 0 rgba(46,229,157,0)) drop-shadow(0 0 0 rgba(0,0,0,0));
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
      }
    }
    @keyframes logoPulse {
      0%, 100% {
        filter: drop-shadow(0 0 30px rgba(46,229,157,0.4)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
        transform: scale(1);
      }
      50% {
        filter: drop-shadow(0 0 50px rgba(46,229,157,0.6)) drop-shadow(0 20px 40px rgba(0,0,0,0.5));
        transform: scale(1.02);
      }
    }
    .splash-text {
      margin-top: 30px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      opacity: 0;
      animation: textFadeIn 1s ease-out 0.8s forwards;
    }
    @keyframes textFadeIn {
      to { opacity: 0.8; }
    }
    .splash-loader {
      margin-top: 40px;
      display: flex;
      gap: 8px;
      opacity: 0;
      animation: textFadeIn 1s ease-out 1.2s forwards;
    }
    .splash-dot {
      width: 10px;
      height: 10px;
      background: #2ee59d;
      border-radius: 50%;
      animation: dotBounce 1.4s ease-in-out infinite;
    }
    .splash-dot:nth-child(2) { animation-delay: 0.2s; }
    .splash-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes toastIn {
      from { opacity:0; transform:translateX(-50%) translateY(20px); }
      to { opacity:1; transform:translateX(-50%) translateY(0); }
    }
    @keyframes toastOut {
      from { opacity:1; transform:translateX(-50%) translateY(0); }
      to { opacity:0; transform:translateX(-50%) translateY(20px); }
    }
    @keyframes dotBounce {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.4;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .splash-version {
      position: absolute;
      bottom: 30px;
      color: rgba(255,255,255,0.3);
      font-size: 11px;
      letter-spacing: 1px;
      opacity: 0;
      animation: textFadeIn 1s ease-out 1.5s forwards;
    }
    body{
      margin:0;
      color:var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(122,167,255,0.18), transparent 62%),
        radial-gradient(900px 600px at 90% 0%, rgba(46,229,157,0.14), transparent 55%),
        radial-gradient(900px 600px at 70% 110%, rgba(255,209,102,0.07), transparent 55%),
        var(--bg);
    }

    .wrap{max-width:1280px;margin:0 auto;padding:18px}

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border:1px solid var(--border2);
      border-radius: calc(var(--radius) + 8px);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      min-height: 92px;
    }
    .brand{
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .brand img{
      height: 84px;
      width: auto;
      display:block;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,0.55)) drop-shadow(0 0 22px rgba(46,229,157,0.20));
    }

    .chip{
      justify-self:end;
      grid-column:3;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(0,0,0,0.22);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    #serverTime{
      color:#fff;
      font-weight: 950;
      letter-spacing:0.2px;
    }

    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .tabbtn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:11px 14px;
      border-radius: 16px;
      font-weight: 950;
      font-size: 14px;
      position:relative;
    }
    .tabbtn:hover{
      background: rgba(122,167,255,0.10);
      border-color: rgba(122,167,255,0.32);
    }
    .tabbtn.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }

    .panel{
      margin-top:14px;
      border:1px solid var(--border2);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding:14px;
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.20);
      padding:14px;
    text-align:center;}

    .card h3{
      margin:0 0 10px;
      font-size: 16px;
      color: #ffffff;
      font-weight: 980;
      letter-spacing: 0.15px;
    text-align:center;}

    .subtleTitle{
      color: var(--accent);
      font-weight: 980;
      font-size: 13px;
      margin-bottom: 10px;
      letter-spacing: 0.3px;
    }

    .small{ color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .kpi{
      padding:10px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
    text-align:center;}
    .kpi .label{ color:var(--muted); font-size:12px; font-weight:900; }
    .kpi .value{ font-size:18px; font-weight:980; margin-top:4px; }

    .statusBar{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:14px;
    }

    .dashGrid{
      display:grid;
      grid-template-columns: 1.65fr 1fr;
      gap:14px;
      align-items:start;
    }

    .rightCol{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .chartWrap{ height: 360px; }
    .chartWrapSmall{ height: 340px; }
    canvas{ width:100% !important; height:100% !important; }

    select, input{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight:900;
      outline:none;
    }
    button{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight:980;
    }
    button:hover{ background: rgba(122,167,255,0.10); border-color: rgba(122,167,255,0.32); }
    button.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }

    .btnPill{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:980;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .led{
      display:inline-block;
      width:10px; height:10px;
      border-radius:999px;
      margin-right:8px;
      background: rgba(255,255,255,0.20);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    .led.on{
      background: rgba(46,229,157,0.95);
      box-shadow:
        0 0 0 2px rgba(46,229,157,0.16),
        0 0 18px rgba(46,229,157,0.45);
    }

    .ghost{
      border:1px dashed rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.10);
      border-radius: 16px;
      padding:12px;
      color: var(--muted);
    }

    .errorBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,120,120,0.35);
      background: rgba(255,120,120,0.10);
      color: #ffd6d6;
      display:none;
      font-weight: 900;
    }

    .warnBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,209,102,0.35);
      background: rgba(255,209,102,0.10);
      color: #ffe9b3;
      display:none;
      font-weight: 900;
    }

    /* ===== Calendar grid ===== */
    .calTop{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .calHeader{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .monthTitle{
      font-size: 20px;
      font-weight: 990;
      letter-spacing: 0.2px;
    }
    .monthNav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .calControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .dow{
      text-align:center;
      font-weight:980;
      color: var(--muted);
      font-size:12px;
      padding:6px 0;
    }
    .dayCell{
      border:1px solid var(--border);
      border-radius: 18px;
      background: rgba(0,0,0,0.16);
      padding:12px;
      min-height: 120px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform 0.05s ease;
    }
    .dayCell:hover{
      border-color: rgba(122,167,255,0.35);
      background: rgba(122,167,255,0.08);
    }
    .dayCell:active{ transform: scale(0.995); }

    .dayNum{
      font-weight:980;
      font-size:13px;
      color:#fff;
      opacity:0.92;
    }
    .dayMuted{ opacity:0.35; }

    .dayItems{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .pill{
      border:1px solid rgba(46,229,157,0.35);
      background: rgba(46,229,157,0.10);
      border-radius: 16px;
      padding:8px 10px;
      font-weight:950;
      font-size:12px;
      color: var(--text);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .pill .meta{ color: var(--muted); font-weight:900; }
    .pillX{
      border:none;
      background: rgba(255,255,255,0.10);
      color:#fff;
      border-radius: 999px;
      padding:2px 10px;
      font-weight:990;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .pillX:hover{ background: rgba(255,255,255,0.16); }

    @media (max-width: 1080px){
      .dashGrid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
      .statusBar{ grid-template-columns: 1fr; }
      .chartWrap{ height: 300px; }
      .chartWrapSmall{ height: 290px; }
      .topbar{ min-height: 88px; }
      .brand img{ height: 74px; }
      .dayCell{ min-height: 110px; }
    }
  
    /* ===== Data tables (Data tab only) ===== */
    .subtabs{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .subtabbtn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      font-weight: 980;
    }
    .subtabbtn:hover{ background: rgba(122,167,255,0.10); border-color: rgba(122,167,255,0.32); }
    .subtabbtn.active{
      border-color: rgba(46,229,157,0.65);
      background: rgba(46,229,157,0.10);
      box-shadow: 0 0 0 2px rgba(46,229,157,0.10) inset;
    }
    .dataControls .field{ min-width: 160px; }
    .dataControls .label{ color:var(--muted); font-size:12px; font-weight:900; margin:0 0 6px 2px; }
    .tableWrap{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:auto;
      max-height: 560px;
      background: rgba(0,0,0,0.16);
    }
    table.dbTable{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      font-size: 12px;
    }
    table.dbTable thead th{
      position: sticky;
      top: 0;
      background: rgba(7,11,20,0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border2);
      padding:10px 10px;
      text-align:left;
      white-space:nowrap;
      font-weight: 980;
      color:#ffffff;
    }
    table.dbTable tbody td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding:9px 10px;
      white-space:nowrap;
      color: var(--text);
    }
    table.dbTable tbody tr:hover td{
      background: rgba(122,167,255,0.07);
    }
    .pillTiny{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      font-weight: 950;
      font-size: 11px;
    }
    .pillTiny.ok{ border-color: rgba(46,229,157,0.40); background: rgba(46,229,157,0.08); }
    .pillTiny.bad{ border-color: rgba(255,120,120,0.40); background: rgba(255,120,120,0.08); }

    /* PLC Monitor styles */
    .plc-io-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 6px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 11px;
    }
    .plc-label {
      color: #9fb0d7;
      font-weight: 900;
      min-width: 32px;
    }
    .plc-desc {
      color: #7a8a9a;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .plc-value {
      color: #2ee59d;
      font-weight: 900;
      font-family: monospace;
      min-width: 50px;
      text-align: right;
    }
    .plc-led {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #3a4a5a;
      border: 1px solid #5a6a7a;
      flex-shrink: 0;
    }
    .plc-led.on {
      background: #2ee59d;
      box-shadow: 0 0 6px #2ee59d;
    }
    .plc-led.fault.on {
      background: #ff6b6b;
      box-shadow: 0 0 6px #ff6b6b;
    }

  
    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch.small {
      width: 40px;
      height: 22px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #3a4a5a;
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: #7a8a9a;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch.small .toggle-slider:before {
      height: 16px;
      width: 16px;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #2ee59d;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
      background-color: white;
    }
    .toggle-switch.small input:checked + .toggle-slider:before {
      transform: translateX(18px);
    }
    
    /* Manual Control Row Styles */
    .manual-io-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .manual-label {
      color: #7aa7ff;
      font-weight: 900;
      font-size: 11px;
      min-width: 30px;
    }
    .manual-desc {
      color: #9fb0d7;
      font-size: 11px;
      flex: 1;
    }
    
    /* Analog Output Slider Styles */
    .manual-ao-row {
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .manual-ao-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .manual-ao-value {
      color: #2ee59d;
      font-weight: 900;
      font-size: 14px;
      margin-left: auto;
      min-width: 45px;
      text-align: right;
    }
    .manual-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #3a4a5a;
      outline: none;
      -webkit-appearance: none;
    }
    .manual-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #7aa7ff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .manual-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #7aa7ff;
      cursor: pointer;
      border: none;
    }
    
    /* Tuning Parameter Styles */
    .tuning-param {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
    }
    .tuning-param label {
      display: block;
      color: #f5a623;
      font-weight: 700;
      font-size: 11px;
      margin-bottom: 6px;
    }
    .tuning-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tuning-param input[type="number"] {
      flex: 1;
      padding: 8px 10px;
      background: #0d1117;
      border: 1px solid #3a4a5a;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 700;
    }
    .tuning-param input[type="number"]:focus {
      outline: none;
      border-color: #f5a623;
    }
    .tuning-unit {
      color: #7a8a9a;
      font-size: 11px;
      min-width: 35px;
    }
    .tuning-hint {
      color: #5a6a7a;
      font-size: 10px;
      margin-top: 4px;
    }

    /* Mode Card Styles */
    .mode-card{background:linear-gradient(135deg,rgba(255,255,255,0.08) 0%,rgba(255,255,255,0.03) 100%);border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:40px;text-align:center;max-width:600px;width:100%;transition:all 0.5s ease;}
    .mode-card.smartpitch-active{border-color:rgba(46,229,157,0.5);box-shadow:0 0 60px rgba(46,229,157,0.2);}
    .mode-header{margin-bottom:30px;}
    .mode-icon{font-size:48px;margin-bottom:10px;transition:all 0.5s ease;}
    .mode-card.smartpitch-active .mode-icon{font-size:64px;animation:modeFloat 3s ease-in-out infinite;}
    @keyframes modeFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
    .mode-title{color:#eaf0ff;font-size:24px;font-weight:700;margin:0 0 8px 0;transition:all 0.5s ease;}
    .mode-card.smartpitch-active .mode-title{background:linear-gradient(90deg,#2ee59d,#7aa7ff,#2ee59d);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:modeGradient 3s linear infinite;}
    @keyframes modeGradient{0%{background-position:0% center;}100%{background-position:200% center;}}
    .mode-subtitle{color:#9fb0d7;font-size:14px;}
    .mode-buttons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:24px;}
    .mode-btn{background:linear-gradient(135deg,rgba(255,255,255,0.06) 0%,rgba(255,255,255,0.02) 100%);border:2px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px 24px;min-width:140px;cursor:pointer;transition:all 0.3s ease;position:relative;}
    .mode-btn:hover{border-color:rgba(255,255,255,0.3);transform:translateY(-2px);}
    .mode-btn.smartpitch{border-color:rgba(255,255,255,0.15);background:linear-gradient(135deg,rgba(255,255,255,0.06) 0%,rgba(255,255,255,0.02) 100%);}
    .mode-btn.smartpitch.selected{border-color:rgba(46,229,157,0.4);background:linear-gradient(135deg,rgba(46,229,157,0.1) 0%,rgba(122,167,255,0.05) 100%);}
    .mode-btn.smartpitch:hover{border-color:rgba(46,229,157,0.6);box-shadow:0 0 30px rgba(46,229,157,0.2);}
    .mode-btn-icon{font-size:28px;margin-bottom:8px;}
    .mode-btn-label{color:#eaf0ff;font-size:16px;font-weight:700;margin-bottom:4px;}
    .mode-btn-desc{color:#7a8a9a;font-size:11px;}
    .mode-btn .led{position:absolute;top:10px;right:10px;}
    .mode-status{color:#9fb0d7;font-size:14px;}
    .ai-status-panel{display:none;margin-top:24px;padding:20px;background:linear-gradient(135deg,rgba(46,229,157,0.1) 0%,rgba(122,167,255,0.05) 100%);border:1px solid rgba(46,229,157,0.3);border-radius:16px;}
    .mode-card.smartpitch-active .ai-status-panel{display:block;animation:aiFadeIn 0.5s ease;}
    @keyframes aiFadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .ai-status-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;color:#2ee59d;font-weight:900;font-size:12px;letter-spacing:2px;}
    .ai-pulse{width:10px;height:10px;background:#2ee59d;border-radius:50%;animation:aiPulse 2s ease-in-out infinite;}
    @keyframes aiPulse{0%,100%{box-shadow:0 0 0 0 rgba(46,229,157,0.7);}50%{box-shadow:0 0 0 10px rgba(46,229,157,0);}}
    .ai-status-grid{display:flex;gap:20px;justify-content:center;}
    .ai-stat{text-align:center;}
    .ai-stat-label{color:#7a8a9a;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
    .ai-stat-value{color:#2ee59d;font-size:14px;font-weight:700;}
    .smartpitch-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 1s ease;z-index:-1;background:radial-gradient(circle at 20% 80%,rgba(46,229,157,0.08) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(122,167,255,0.08) 0%,transparent 50%);}
    .smartpitch-bg.active{opacity:1;}
    .ai-submode-display{text-align:center;margin-bottom:20px;padding:16px;background:rgba(0,0,0,0.2);border-radius:12px;}
    .ai-submode-label{font-size:10px;color:#7a8a9a;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;}
    .ai-submode-value{font-size:24px;font-weight:900;letter-spacing:3px;margin-bottom:6px;transition:all 0.3s ease;}
    .ai-submode-value.monitor{color:#7aa7ff;}
    .ai-submode-value.preheat{color:#ffd166;}
    .ai-submode-value.heating{color:#2ee59d;}
    .ai-submode-desc{font-size:11px;color:#9fb0d7;}
    

    /* Schematic Styles */
    .sch-wrapper{position:relative;padding:20px;min-height:480px;}
    .sch-mode-legend{position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 14px;font-size:12px;}
    .sch-mode-item{display:flex;align-items:center;gap:8px;color:#9fb0d7;margin-bottom:5px;}
    .sch-mode-item:last-child{margin-bottom:0;}
    .sch-radio{width:14px;height:14px;border:2px solid #5a6a7a;border-radius:50%;background:transparent;}
    .sch-radio.active{background:#2ee59d;border-color:#2ee59d;box-shadow:0 0 6px rgba(46,229,157,0.5);}
    .sch-building{position:absolute;top:10px;right:10px;text-align:center;}
    .sch-building-icon{font-size:32px;margin-bottom:4px;}
    .sch-temp-box{background:rgba(0,0,0,0.4);border:1px solid rgba(122,167,255,0.3);border-radius:4px;padding:3px 8px;font-size:11px;color:#7aa7ff;font-weight:600;display:inline-block;}
    .sch-grid{display:flex;gap:10px;margin-top:70px;}
    .sch-plant-section{width:140px;display:flex;flex-direction:column;align-items:center;position:relative;}
    .sch-pipe-temps-upper{display:flex;flex-direction:column;gap:4px;position:absolute;top:0;right:-10px;}
    .sch-vert-pipe{position:relative;height:60px;display:flex;justify-content:center;}
    .sch-pipe-v{width:6px;height:100%;background:linear-gradient(180deg,#5a6a7a,#4a5a6a);border-radius:3px;}
    .sch-temp-vert{position:absolute;left:15px;top:20px;}
    .sch-plant-unit{background:linear-gradient(135deg,#2a3a4a,#1a2530);border:2px solid #4a5a6a;border-radius:8px;padding:10px;position:relative;width:100px;}
    .sch-temp-left{position:absolute;left:-60px;top:10px;}
    .sch-hex-icon{font-size:24px;text-align:center;color:#6a7a8a;margin-bottom:6px;}
    .sch-valve-row{display:flex;align-items:center;gap:6px;justify-content:center;}
    .sch-valve-box{background:rgba(46,229,157,0.2);border:1px solid rgba(46,229,157,0.4);border-radius:3px;padding:2px 6px;font-size:10px;color:#2ee59d;}
    .sch-valve-icon{color:#7a8a9a;font-size:14px;}
    .sch-return-temp{margin-top:10px;}
    .sch-status-indicators{margin-top:15px;font-size:10px;color:#7a8a9a;}
    .sch-status-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
    .sch-status-led{width:12px;height:8px;background:#3a4a3a;border-radius:2px;}
    .sch-status-led.on{background:#2ee59d;box-shadow:0 0 6px rgba(46,229,157,0.6);}
    .sch-main-section{flex:1;position:relative;}
    .sch-pipes-svg{position:absolute;top:0;left:0;width:100%;height:100%;z-index:0;}
    .sch-pipe{fill:none;stroke:#6a7a8a;stroke-width:5;stroke-linecap:round;}
    .sch-pipe.active{stroke:#2ee59d;filter:drop-shadow(0 0 3px rgba(46,229,157,0.5));}
    .sch-pipe-ret{stroke:#5a6a7a;}
    .sch-pitch-labels{display:flex;justify-content:space-around;padding:0 40px;margin-bottom:5px;position:relative;z-index:1;}
    .sch-pitch-label-box{text-align:center;}
    .sch-selected-label{color:#9fb0d7;font-size:12px;font-weight:600;}
    .sch-pumps-row{display:flex;justify-content:space-around;padding:0 60px;margin-bottom:8px;position:relative;z-index:1;}
    .sch-pump-pair{display:flex;gap:12px;}
    .sch-pump-circle{width:24px;height:24px;border:3px solid #5a6a7a;border-radius:50%;background:rgba(0,0,0,0.3);position:relative;}
    .sch-pump-circle::after{content:'';position:absolute;top:50%;left:50%;width:10px;height:10px;border:2px solid #5a6a7a;border-radius:50%;transform:translate(-50%,-50%);}
    .sch-pump-circle.on{border-color:#2ee59d;box-shadow:0 0 10px rgba(46,229,157,0.5);}
    .sch-pump-circle.on::after{border-color:#2ee59d;}
    .sch-pitches-row{display:flex;gap:30px;justify-content:center;position:relative;z-index:1;}
    .sch-pitch-box{position:relative;}
    .sch-pitch-inner{width:200px;height:160px;background:linear-gradient(180deg,#2d8a3e 0%,#3da652 50%,#2d8a3e 100%);border-radius:6px;position:relative;border:2px solid rgba(255,255,255,0.2);}
    .sch-field-marking{position:absolute;top:8px;left:8px;right:8px;bottom:8px;border:2px solid rgba(255,255,255,0.3);border-radius:2px;}
    .sch-center-circle{position:absolute;top:50%;left:50%;width:36px;height:36px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;transform:translate(-50%,-50%);}
    .sch-center-line{position:absolute;top:8px;bottom:8px;left:50%;width:2px;background:rgba(255,255,255,0.3);transform:translateX(-50%);}
    .sch-sens{position:absolute;background:rgba(255,255,255,0.9);border-radius:3px;padding:2px 5px;font-size:9px;color:#333;font-weight:600;z-index:2;}
    .sch-sens-tl{top:12px;left:12px;}
    .sch-sens-tr{top:12px;right:12px;}
    .sch-sens-center{top:50%;left:50%;transform:translate(-50%,-50%);}
    .sch-sens-bl{bottom:12px;left:12px;}
    .sch-sens-br{bottom:12px;right:12px;}
    .sch-pitch-name{text-align:center;color:#9fb0d7;font-size:13px;font-weight:600;margin-top:6px;}
    .sch-side-sensors{position:absolute;right:-55px;top:30px;display:flex;flex-direction:column;gap:50px;}

    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a4a5a; transition: .3s; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #fff; transition: .3s; }
    .slider.round { border-radius: 24px; }
    .slider.round:before { border-radius: 50%; }
    input:checked + .slider { background-color: #2ee59d; }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Settings Page Styles */
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:24px;margin-top:16px;}
    .settings-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px;transition:border-color 0.3s;}
    .settings-card:hover{border-color:var(--border2);}
    .settings-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border);}
    .settings-card-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .settings-card-title{margin:0;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;}
    .settings-card-desc{color:var(--muted);font-size:12px;margin-bottom:18px;line-height:1.5;}
    .settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
    .settings-row:last-child{border-bottom:none;padding-bottom:0;}
    .settings-row:first-child{padding-top:0;}
    .settings-label{display:flex;flex-direction:column;gap:4px;flex:1;min-width:0;padding-right:20px;}
    .settings-label-text{color:var(--text);font-weight:500;font-size:13px;}
    .settings-label-hint{color:var(--muted);font-size:11px;line-height:1.4;}
    .settings-input{display:flex;align-items:center;gap:8px;flex-shrink:0;}
    .settings-input input[type="number"]{width:70px;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,0.3);color:var(--text);font-size:14px;text-align:center;transition:border-color 0.2s,box-shadow 0.2s;}
    .settings-input input[type="number"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(46,229,157,0.15);}
    .settings-input-unit{color:var(--muted);font-size:12px;min-width:28px;}
    .settings-section-title{color:var(--muted);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;margin:20px 0 12px 0;padding-top:12px;border-top:1px solid var(--border);}
    .settings-section-title:first-child{margin-top:0;padding-top:0;border-top:none;}
    .card-standard{border-color:rgba(122,167,255,0.25);}
    .card-standard .settings-card-dot{background:#7aa7ff;}
    .card-standard .settings-card-title{color:#7aa7ff;}
    .card-frost{border-color:rgba(100,180,255,0.25);}
    .card-frost .settings-card-dot{background:#64b4ff;}
    .card-frost .settings-card-title{color:#64b4ff;}
    .card-smartpitch{border-color:rgba(46,229,157,0.25);}
    .card-smartpitch .settings-card-dot{background:#2ee59d;}
    .card-smartpitch .settings-card-title{color:#2ee59d;}

    
    /* ========================================
       SMARTPITCH MODE TRANSITION ANIMATIONS
       ======================================== */
    
    /* Neural Network Canvas */
    #neuralCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.8s ease;
      z-index: 1;
    }
    
    #neuralCanvas.active {
      opacity: 1;
    }
    
    /* Mode Panel Container */
    .mode-panel {
      position: relative;
      overflow: hidden;
    }
    
    /* AI Activation Overlay */
    .ai-activation-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, rgba(100, 180, 255, 0.3) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 5;
      transition: opacity 0.5s ease;
    }
    
    .ai-activation-overlay.pulse {
      animation: aiPulse 2s ease-out;
    }
    
    @keyframes aiPulse {
      0% { opacity: 0; transform: scale(0.5); }
      30% { opacity: 1; }
      100% { opacity: 0; transform: scale(2); }
    }
    
    /* Scanning Line Effect */
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #64b4ff, #00ffff, #64b4ff, transparent);
      opacity: 0;
      z-index: 10;
      box-shadow: 0 0 20px #64b4ff, 0 0 40px #00ffff;
    }
    
    .scan-line.active {
      animation: scanDown 1.5s ease-in-out;
    }
    
    @keyframes scanDown {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
    
    /* Mode Card Enhancements */
    .mode-card {
      position: relative;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .mode-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(100, 180, 255, 0.1), transparent 30%);
      opacity: 0;
      transition: opacity 0.5s ease;
      animation: rotate 4s linear infinite paused;
    }
    
    .mode-card.smartpitch-active::before {
      opacity: 1;
      animation-play-state: running;
    }
    
    @keyframes rotate {
      100% { transform: rotate(360deg); }
    }
    
    /* SmartPitch Active Glow */
    .mode-card.smartpitch-active {
      border-color: #64b4ff !important;
      box-shadow: 0 0 30px rgba(100, 180, 255, 0.4), 
                  0 0 60px rgba(100, 180, 255, 0.2),
                  inset 0 0 30px rgba(100, 180, 255, 0.1) !important;
    }
    
    /* AI Status Indicator */
    .ai-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(100, 180, 255, 0.2), rgba(0, 255, 255, 0.1));
      border: 1px solid rgba(100, 180, 255, 0.5);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #64b4ff;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.5s ease;
    }
    
    .ai-status-badge.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .ai-status-badge .pulse-dot {
      width: 8px;
      height: 8px;
      background: #00ffff;
      border-radius: 50%;
      animation: pulseDot 2s ease-in-out infinite;
    }
    
    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 10px #00ffff; }
      50% { opacity: 0.5; transform: scale(0.8); box-shadow: 0 0 5px #00ffff; }
    }
    
    /* Data Stream Effect */
    .data-stream {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .data-stream.active {
      opacity: 1;
    }
    
    .data-stream span {
      position: absolute;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      color: rgba(100, 180, 255, 0.3);
      white-space: nowrap;
      animation: dataFall linear infinite;
    }
    
    @keyframes dataFall {
      0% { transform: translateY(-100%); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(calc(100vh)); opacity: 0; }
    }
    
    /* Learning Stats Animation */
    .learning-stat {
      opacity: 0;
      transform: translateX(-20px);
      transition: all 0.4s ease;
    }
    
    .learning-stat.animate-in {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Circular Progress Ring */
    .confidence-ring {
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .confidence-ring svg {
      transform: rotate(-90deg);
    }
    
    .confidence-ring circle {
      fill: none;
      stroke-width: 6;
    }
    
    .confidence-ring .bg {
      stroke: rgba(100, 180, 255, 0.1);
    }
    
    .confidence-ring .progress {
      stroke: url(#confidenceGradient);
      stroke-linecap: round;
      stroke-dasharray: 226;
      stroke-dashoffset: 226;
      transition: stroke-dashoffset 1.5s ease;
    }
    
    .confidence-ring .value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
      color: #64b4ff;
    }
    
    /* Hexagon Grid Background */
    .hex-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2364b4ff' fill-opacity='0.03'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
    }
    
    .hex-grid.active {
      opacity: 1;
    }
    
    /* Typing Text Effect */
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #64b4ff;
      animation: typing 2s steps(40) forwards, blink 0.8s step-end infinite;
    }
    
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    
    @keyframes blink {
      50% { border-color: transparent; }
    }
    
    /* Particle Float */
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #64b4ff;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0;
    }
    
    .particle.float {
      animation: particleFloat 3s ease-in-out infinite;
    }
    
    @keyframes particleFloat {
      0%, 100% { opacity: 0; transform: translateY(0) scale(0); }
      20% { opacity: 1; transform: scale(1); }
      80% { opacity: 1; }
      100% { transform: translateY(-100px) scale(0); }
    }
    
    /* Mode Button Enhanced */
    .mode-btn {
      position: relative;
      overflow: hidden;
    }
    
    .mode-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(100, 180, 255, 0.4), transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    
    .mode-btn.ripple::after {
      width: 300px;
      height: 300px;
    }
    
    /* Glitch Text Effect */
    .glitch {
      position: relative;
    }
    
    .glitch::before,
    .glitch::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
    }
    
    .glitch.active::before {
      animation: glitch1 0.3s linear;
      color: #ff0040;
      z-index: -1;
    }
    
    .glitch.active::after {
      animation: glitch2 0.3s linear;
      color: #00ffff;
      z-index: -2;
    }
    
    @keyframes glitch1 {
      0%, 100% { opacity: 0; transform: translate(0); }
      20% { opacity: 0.8; transform: translate(-3px, 2px); }
      40% { opacity: 0.8; transform: translate(3px, -2px); }
      60% { opacity: 0.8; transform: translate(-2px, 1px); }
      80% { opacity: 0.8; transform: translate(2px, -1px); }
    }
    
    @keyframes glitch2 {
      0%, 100% { opacity: 0; transform: translate(0); }
      20% { opacity: 0.8; transform: translate(3px, -2px); }
      40% { opacity: 0.8; transform: translate(-3px, 2px); }
      60% { opacity: 0.8; transform: translate(2px, -1px); }
      80% { opacity: 0.8; transform: translate(-2px, 1px); }
    }

    
    
  
    /* Slope Intervention Indicator */
    @keyframes slopePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    .slope-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,209,102,0.1);
      border: 1px solid rgba(255,209,102,0.3);
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .slope-indicator.active {
      background: rgba(255,209,102,0.15);
      border-color: rgba(255,209,102,0.5);
    }
    .slope-indicator .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }
    .slope-indicator.active .dot {
      background: #ffd166;
      box-shadow: 0 0 8px rgba(255,209,102,0.6);
      animation: slopePulse 1.5s infinite;
    }
    .slope-indicator.on-track .dot {
      background: #4CAF50;
      box-shadow: 0 0 8px rgba(76,175,80,0.4);
      animation: none;
    }

  
    /* Building Protect Mode */
    .building-protect-active {
      border-color: rgba(255,159,67,0.5) !important;
      background: linear-gradient(180deg, rgba(255,159,67,0.15), rgba(255,159,67,0.05)) !important;
    }
    .building-protect-active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 30px rgba(255,159,67,0.2);
      pointer-events: none;
    }
  
    /* ===== MOBILE RESPONSIVENESS ===== */
    
    /* Tabs: scrollable on mobile */
    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      justify-content: flex-start;
      padding-bottom: 4px;
    }
    .tabs::-webkit-scrollbar { display: none; }
    
    .subtabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      justify-content: flex-start;
      padding-bottom: 4px;
    }
    .subtabs::-webkit-scrollbar { display: none; }
    
    @media (max-width: 1080px) {
      .dashGrid { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: 1fr; }
      .statusBar { grid-template-columns: 1fr 1fr; }
      .chartWrap { height: 300px; }
      .chartWrapSmall { height: 280px; }
      .topbar { min-height: 70px; }
      .brand img { height: 60px; }
      .dayCell { min-height: 90px; }
      .settings-grid { grid-template-columns: 1fr !important; }
    }
    
    @media (max-width: 768px) {
      .wrap { padding: 6px; }
      .topbar { 
        grid-template-columns: 1fr auto; 
        min-height: 55px; 
        padding: 6px 10px; 
        border-radius: 14px;
      }
      .chip { display: none; }
      .brand { grid-column: 1; justify-content: flex-start; }
      .brand img { height: 44px; }
      
      .tabs { gap: 3px; margin-top: 10px; }
      .tabbtn { 
        padding: 8px 12px; 
        font-size: 12px; 
        white-space: nowrap; 
        flex-shrink: 0; 
        border-radius: 12px;
      }
      
      .subtabs { gap: 3px; }
      .subtabbtn { 
        padding: 7px 10px; 
        font-size: 11px; 
        white-space: nowrap; 
        flex-shrink: 0;
        border-radius: 12px;
      }
      
      .panel { margin-top: 10px; padding: 10px; border-radius: 14px; }
      .card { padding: 10px; border-radius: 14px; }
      .card h3 { font-size: 14px; }
      
      .statusBar { grid-template-columns: 1fr !important; gap: 8px; }
      .dashGrid { grid-template-columns: 1fr !important; gap: 10px; }
      .kpis { grid-template-columns: 1fr !important; }
      .kpi .value { font-size: 16px; }
      
      .chartWrap { height: 220px; }
      .chartWrapSmall { height: 200px; }
      
      /* Calendar */
      .calGrid { gap: 3px; }
      .dayCell { min-height: 60px; padding: 4px; border-radius: 10px; }
      .dayNum { font-size: 11px; }
      .pill { padding: 3px 5px; font-size: 9px; gap: 4px; border-radius: 8px; }
      .pillX { padding: 1px 6px; font-size: 10px; }
      .calTop { gap: 8px; }
      .calControls { flex-direction: column; align-items: stretch; gap: 6px; }
      .calHeader { flex-direction: column; gap: 6px; }
      .monthTitle { font-size: 18px; }
      .monthNav { justify-content: center; }
      .btnPill { padding: 7px 10px; font-size: 12px; justify-content: center; }
      
      /* Data tab */
      .row { flex-direction: column; align-items: stretch; gap: 8px; }
      .dataControls .row { flex-direction: column; }
      .field { min-width: 100% !important; }
      table.dbTable { min-width: 500px; font-size: 11px; }
      .tableWrap { max-height: 400px; }
      
      /* Heating tabs */
      .mode-card { padding: 16px; max-width: 100%; border-radius: 16px; }
      .mode-buttons { flex-direction: column; gap: 10px; }
      .mode-btn { min-width: auto; padding: 14px 16px; }
      .mode-btn-icon { font-size: 22px; }
      .ai-status-grid { flex-direction: column; gap: 12px; }
      .mode-title { font-size: 20px; }
      
      /* Advanced PLC/Modbus */
      .plc-io-row { font-size: 10px; padding: 3px 5px; }
      .plc-label { min-width: 24px; font-size: 10px; }
      .plc-desc { font-size: 9px; }
      .plc-value { font-size: 10px; min-width: 40px; }
      
      /* Schematic - scrollable */
      #heatingSubSchematic > div { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      
      /* Manual control */
      .manual-ao-row { padding: 8px; }
      .manual-slider { height: 12px; }
      
      /* Settings */
      .settings-grid { grid-template-columns: 1fr !important; gap: 12px; }
      .settings-card { padding: 14px; }
      .settings-row { flex-direction: column; gap: 8px; align-items: flex-start; }
      .settings-input { width: 100%; }
      .settings-label { padding-right: 0; }
      
      /* Heat curve */
      .dashGrid[style*="grid-template-columns: 1fr 1fr"] { 
        display: grid !important; 
        grid-template-columns: 1fr !important; 
      }
    }
    
    @media (max-width: 480px) {
      .wrap { padding: 4px; }
      .tabbtn { padding: 6px 9px; font-size: 11px; }
      .subtabbtn { padding: 5px 8px; font-size: 10px; }
      .brand img { height: 36px; }
      .topbar { min-height: 46px; padding: 4px 8px; border-radius: 12px; }
      .panel { padding: 6px; }
      .card { padding: 8px; }
      .card h3 { font-size: 13px; margin-bottom: 6px; }
      .kpi .value { font-size: 14px; }
      .kpi .label { font-size: 10px; }
      .small { font-size: 10px; }
      .subtleTitle { font-size: 11px; }
      .chartWrap { height: 180px; }
      .chartWrapSmall { height: 170px; }
      .dayCell { min-height: 50px; padding: 3px; border-radius: 8px; }
      .dayNum { font-size: 10px; }
      .pill { font-size: 8px; padding: 2px 4px; }
      .mode-card { padding: 12px; }
      .mode-title { font-size: 18px; }
      .mode-btn { padding: 12px; border-radius: 12px; }
      .ai-submode-value { font-size: 18px; }
      
      /* Forecast controls */
      .row[style*="gap:10px; align-items:center"] { flex-direction: column; }
      
      /* Fix wide elements */
      select, input, button { max-width: 100%; }
    }
    
    /* Ensure inline flex rows stack on mobile */
    @media (max-width: 768px) {
      div[style*="display:flex"][style*="gap:15px"],
      div[style*="display:flex"][style*="gap:20px"] {
        flex-direction: column !important;
      }
      div[style*="min-width:800px"],
      div[style*="min-width:700px"] {
        min-width: 100% !important;
      }
      div[style*="display:grid"][style*="grid-template-columns:repeat(4"] {
        grid-template-columns: 1fr 1fr !important;
      }
      div[style*="width:1100px"],
      div[style*="max-width:1100px"] {
        width: 100% !important;
        max-width: 100% !important;
      }
    }
</style>
</head>

<body>

<!-- Splash Screen -->
<div class="splash-screen" id="splashScreen">
  <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 80'%3E%3Cdefs%3E%3ClinearGradient id='lg' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%2322c97a'/%3E%3Cstop offset='50%25' stop-color='%232ee59d'/%3E%3Cstop offset='100%25' stop-color='%2388e8c0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='28' cy='40' r='22' fill='none' stroke='url(%23lg)' stroke-width='5' stroke-dasharray='100 40' stroke-linecap='round'/%3E%3Cpath d='M18 50 Q15 40 20 33 Q25 26 35 28' fill='none' stroke='url(%23lg)' stroke-width='5' stroke-linecap='round'/%3E%3Ctext x='58' y='52' fill='url(%23lg)' font-family='system-ui,-apple-system,Segoe UI,Roboto,sans-serif' font-size='38' font-weight='800' letter-spacing='0.5'%3Emart%3C/text%3E%3Ctext x='185' y='52' fill='%23ffffff' font-family='system-ui,-apple-system,Segoe UI,Roboto,sans-serif' font-size='38' font-weight='800' letter-spacing='0.5'%3EPitch%3C/text%3E%3C/svg%3E" alt="SmartPitch" class="splash-logo">
  <div class="splash-text">Pitch Heating Intelligence</div>
  <div class="splash-loader">
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
  </div>
  <div class="splash-version">THFC Training Ground</div>
</div>

  <div class="wrap">
    <div class="topbar">
      <div></div>
      <div class="brand">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 80'%3E%3Cdefs%3E%3ClinearGradient id='lg' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%2322c97a'/%3E%3Cstop offset='50%25' stop-color='%232ee59d'/%3E%3Cstop offset='100%25' stop-color='%2388e8c0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='28' cy='40' r='22' fill='none' stroke='url(%23lg)' stroke-width='5' stroke-dasharray='100 40' stroke-linecap='round'/%3E%3Cpath d='M18 50 Q15 40 20 33 Q25 26 35 28' fill='none' stroke='url(%23lg)' stroke-width='5' stroke-linecap='round'/%3E%3Ctext x='58' y='52' fill='url(%23lg)' font-family='system-ui,-apple-system,Segoe UI,Roboto,sans-serif' font-size='38' font-weight='800' letter-spacing='0.5'%3Emart%3C/text%3E%3Ctext x='185' y='52' fill='%23ffffff' font-family='system-ui,-apple-system,Segoe UI,Roboto,sans-serif' font-size='38' font-weight='800' letter-spacing='0.5'%3EPitch%3C/text%3E%3C/svg%3E" alt="SmartPitch" />
      </div>
      <div class="chip small">
        <span class="mono" id="serverTime"></span>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabDashboard" onclick="showTab('Dashboard')">Dashboard</button>
      <button class="tabbtn" id="tabForecast" onclick="showTab('Forecast')">Forecast</button>
      <button class="tabbtn" id="tabSchedule" onclick="showTab('Schedule')">Schedule</button>
      <button class="tabbtn" id="tabHeating" onclick="showTab('Heating')">Heating Control</button>
      <button class="tabbtn" id="tabData" onclick="showTab('Data')">Data</button>
      <button class="tabbtn" id="tabAdvanced" onclick="showTab('Advanced')">Advanced</button>
    </div>

    <!-- DASHBOARD -->
    <div class="panel" id="panelDashboard">
      <div id="forecastOverrideIndicator" style="display:none; background:rgba(255,159,67,0.15); border:1px solid rgba(255,159,67,0.4); border-radius:8px; padding:8px 12px; margin-bottom:10px; align-items:center; gap:8px;">
        <span style="color:#ff9f43; font-size:18px;">&#9888;&#65039;</span>
        <span style="color:#ff9f43; font-size:12px; font-weight:600;">FORECAST OVERRIDE ACTIVE</span>
        <span style="color:var(--muted); font-size:11px;">Actual temp significantly colder than forecast - using actual readings</span>
      </div>
      <div class="statusBar">
        <div class="card">
          <h3>Live status</h3>
          <div class="kpi">
            <div class="label">Leaf condition</div>
            <div class="value" id="leafFrost"></div>
            <div class="small mono" id="trendTs"></div>
          </div>
        </div>

        <div class="card">
          <h3>Field Temperature</h3>
          <div class="kpi">
            <div class="label">Average field temp -8cm</div>
            <div class="value"><span class="mono" id="field8" style="color:#2ee59d;"></span></div>
          </div>
        </div>

        <div style="display:flex; gap:15px;">
          <div class="card" style="flex:1;">
            <h3>Live energy</h3>
            <div style="display:flex; gap:15px; align-items:stretch;">
              <div class="kpi" style="flex:1; margin:0; text-align:center;">
                <div class="label">Heating</div>
                <div class="value" style="justify-content:center;"><span class="mono" id="liveKw" style="color:#2ee59d;"></span></div>
              </div>
              <div style="display:flex; flex-direction:column; justify-content:center; padding:8px 12px; background:rgba(0,0,0,0.2); border-radius:8px; border:1px solid #3a4a5a;">
                <label style="color:#9fb0d7; font-size:10px; margin-bottom:4px;">Flow Rate</label>
                <div style="display:flex; align-items:center; gap:6px;">
                  <input type="number" id="flowRateInput" step="0.1" min="0" max="50" placeholder="0.0" 
                    style="width:60px; padding:5px 6px; background:#1a2530; border:1px solid #3a4a5a; border-radius:4px; color:#2ee59d; font-size:14px; font-weight:bold; text-align:center;"
                    onchange="saveFlowRate(this.value)">
                  <span style="color:#9fb0d7; font-size:11px;">L/s</span>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="flex:0 0 120px; display:flex; flex-direction:column; align-items:center;">
            <h3 style="text-align:center; width:100%;">Heat Status</h3>
            <div style="flex:1; display:flex; align-items:center; justify-content:center;">
              <div id="heatStatusIndicator" style="display:flex; align-items:center; gap:10px; padding:12px 18px; border-radius:25px; background:linear-gradient(145deg, #1a1a1a, #252525); border:1px solid #333; box-shadow:0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.4s ease;">
                <div id="heatStatusIcon" style="font-size:20px; filter:grayscale(1) opacity(0.4); transition: all 0.4s ease;">&#128293;</div>
                <div id="heatStatusText" style="font-size:13px; font-weight:700; letter-spacing:1px; color:#555; text-transform:uppercase; transition: all 0.4s ease;">OFF</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Mode</h3>
          <div class="kpi">
            <div class="label">Current mode</div>
            <div class="value"><span class="led on" id="modeLed"></span><span class="mono" id="modeNow"></span></div>
            <div class="small" id="modeDesc"></div>
          </div>
        </div>
      </div>

      <div class="dashGrid">
        <div class="card">
          <div class="row">
            <div>
              <div class="subtleTitle">Pitch Temperature</div>
            </div>
            <div class="row" style="gap:8px;">
              <div class="small">Range</div>
              <select id="hoursSel">
                <option value="24">24 hours</option>
                <option value="168">7 days</option>
                <option value="720" selected>1 month</option>
                <option value="8760">1 year</option>
              </select>
            </div>
          </div>

          <div class="chartWrap" style="margin-top:10px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <div class="rightCol">
          <div class="card">
            <div class="subtleTitle">SmartPitch Lookahead</div>
            <div class="kpis">
              <div class="kpi">
                <div class="label">Playable by</div>
                <div class="value" id="playableBy"></div>
                <div class="small mono" id="trainingStart"></div>
              </div>
              <div class="kpi">
                <div class="label">Suggested start</div>
                <div class="value" id="suggestedStart"></div>
                <div class="small mono" id="startOffset"></div>
              </div>
              <div class="kpi">
                <div class="label">Confidence</div>
                <div class="value" id="confidence"></div>
                <div class="small mono" id="passRate"></div>
              </div>
            </div>
            <div class="small" style="margin-top:10px;">
              Reason: <span id="reason"></span>
            </div>
          </div>

          <div class="card">
            <div class="subtleTitle">Heating costs</div>

            <div class="kpi" style="margin-bottom:10px;">
              <div class="label">Season-to-date</div>
              <div class="value" id="seasonCost"></div>
              <div class="small">kWh: <span class="mono" id="seasonKwh"></span></div>
            </div>

            <div class="kpi">
              <div class="label">Energy rate (p/kWh)</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                <input id="rateInput" type="number" step="0.01" min="0" style="width:160px;" />
                <button onclick="saveRate()">Save</button>
                <div class="small">Current: <span class="mono" id="rateNow"></span></div>
              </div>
              <div class="small" style="margin-top:8px;">
                Season window: <span class="mono" id="seasonWindow"></span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- FORECAST -->
    <div class="panel" id="panelForecast" style="display:none;">
      <div class="card">
        <div class="row">
          <div>
            <h3 style="margin:0 0 6px;">Forecast (Fixed 7 days)</h3>
            <div class="small">Temp (green)  Feels Like (green dashed)  Cloud (yellow)  Wind (blue)</div>
          </div>
          <div class="row" style="gap:10px; align-items:center;">
            <div style="background: rgba(46,229,157,0.15); border: 2px solid var(--accent); border-radius: 12px; padding: 8px 16px; text-align:center;">
              <div class="small" style="color: var(--accent); font-weight:900;" id="coldestLabel">Coldest Feels Like</div>
              <div style="font-size: 24px; font-weight: 990; color: #fff;" id="coldestValue"></div>
              <div class="small mono" id="coldestTime"></div>
            </div>
            <button id="btnShowTemp" onclick="selectTempType('temp')">Temp</button>
            <button id="btnShowFeels" class="active" onclick="selectTempType('feels')">Feels Like</button>
            <button onclick="loadForecast(true)">Refresh</button>
          </div>
        </div>

        <div class="chartWrapSmall" style="margin-top:10px;">
          <canvas id="forecastChart"></canvas>
        </div>

        <div class="warnBox" id="forecastWarn"></div>
        <div class="errorBox" id="forecastErr"></div>

        <div class="small" style="margin-top:10px;">
          Rows: <span class="mono" id="fcRows"></span>  DB max_ts: <span class="mono" id="fcMaxTs"></span>
           Behind: <span class="mono" id="fcBehind"></span>
        </div>
      </div>
    </div>

    <!-- SCHEDULE -->
    <div class="panel" id="panelSchedule" style="display:none;">
      <div class="card">
        <div class="calTop">
          <div class="calHeader">
            <div class="monthNav">
              <button onclick="prevMonth()" title="Previous month">&#9664;</button>
              <button onclick="nextMonth()" title="Next month">&#9654;</button>
            </div>
            <div>
              <div class="monthTitle" id="calTitle"></div>
              <div class="small">Click a day to add entry. It shows inside the day cell. X deletes. Save writes to DB.</div>
            </div>
          </div>

          <div class="calControls">
            <span class="btnPill"><span class="small">Start</span>&nbsp;
              <select id="schedStart">
                <option value="06:00">06:00</option><option value="07:00">07:00</option><option value="08:00">08:00</option>
                <option value="09:00" selected>09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option>
                <option value="12:00">12:00</option><option value="13:00">13:00</option><option value="14:00">14:00</option>
                <option value="15:00">15:00</option><option value="16:00">16:00</option><option value="17:00">17:00</option>
                <option value="18:00">18:00</option><option value="19:00">19:00</option><option value="20:00">20:00</option>
              </select>
            </span>

            <span class="btnPill"><span class="small">Finish</span>&nbsp;
              <select id="schedStop">
                <option value="07:00">07:00</option><option value="08:00">08:00</option><option value="09:00">09:00</option>
                <option value="10:00">10:00</option><option value="11:00" selected>11:00</option><option value="12:00">12:00</option>
                <option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option>
                <option value="16:00">16:00</option><option value="17:00">17:00</option><option value="18:00">18:00</option>
                <option value="19:00">19:00</option><option value="20:00">20:00</option><option value="21:00">21:00</option>
              </select>
            </span>

            <span class="btnPill"><span class="small">Buffer</span>&nbsp;
              <select id="schedBuf">
                <option value="0">0</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                <option value="60" selected>60</option><option value="75">75</option><option value="90">90</option>
                <option value="105">105</option><option value="120">120</option><option value="150">150</option><option value="180">180</option>
              </select>&nbsp;<span class="small">min</span>
            </span>

            <button onclick="saveSchedule()">Save</button>
          </div>
        </div>

        <div class="calGrid" id="calDow">
          <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
        </div>

        <div class="calGrid" id="calGrid"></div>

        <div class="errorBox" id="scheduleErr"></div>

        <div class="small" style="margin-top:10px;">
          Stored fields: <span class="mono">training_start</span> (Start), <span class="mono">buffer_minutes</span> (Buffer),
          Finish is stored inside <span class="mono">session_name</span> for display.
        </div>
      </div>
    </div>

    <!-- HEATING CONTROL -->
    <div class="panel" id="panelHeating" style="display:none; position:relative; overflow:hidden;">
      
      <!-- Heating Sub-tabs -->
      <div class="subtabs" style="margin-bottom:14px;">
        <button class="subtabbtn active" id="subHeatingMode" onclick="showHeatingSub('mode')">Mode</button>
        <button class="subtabbtn" id="subHeatingCurve" onclick="showHeatingSub('curve')">Heat Curve</button>
        <button class="subtabbtn" id="subHeatingSchematic" onclick="showHeatingSub('schematic')">Schematic</button>
        <button class="subtabbtn" id="subHeatingSettings" onclick="showHeatingSub('settings')">Settings</button>
        <button class="subtabbtn" id="subHeatingFrostCam" onclick="showHeatingSub('frostcam')">Frost Camera</button>
        <button class="subtabbtn" id="subHeatingAdvisory" onclick="showHeatingSub('advisory')">Advisory</button>
      </div>

      <!-- MODE SUB-TAB -->
      <div id="heatingSubMode" class="mode-panel">
        <div id="smartpitchBg" class="smartpitch-bg"></div>
        <div style="display:flex; justify-content:center; align-items:center; min-height:400px;">
          <div id="modeCard" class="mode-card">
            <div class="mode-header">
              <h2 id="modeTitle" class="mode-title">Select Operating Mode</h2>
              <div id="modeSubtitle" class="mode-subtitle">Choose how the system controls pitch heating</div>
            </div>
            <div class="mode-buttons">
              <button id="btnSTANDARD" class="mode-btn" onclick="setModeEnhanced('STANDARD')">
                <div class="mode-btn-icon">&#9881;&#65039;</div>
                <div class="mode-btn-label">Standard</div>
                <div class="mode-btn-desc">Manual control</div>
                <span class="led" id="ledSTANDARD"></span>
              </button>
              
              <button id="btnSMARTPITCH" class="mode-btn smartpitch" onclick="setModeEnhanced('SMARTPITCH')">
                <div class="mode-btn-icon">&#129302;</div>
                <div class="mode-btn-label">SmartPitch AI</div>
                <div class="mode-btn-desc">Intelligent automation</div>
                <span class="led" id="ledSMARTPITCH"></span>
              </button>
            </div>
            <div class="mode-status">Current mode: <span class="mono" id="modeNow2"></span></div>
            <div id="aiStatusPanel" class="ai-status-panel">
              <div class="ai-status-header"><div class="ai-pulse"></div><span>AI ENGINE ACTIVE</span></div>
              <div class="ai-submode-display">
                <div class="ai-submode-label">Current Phase</div>
                <div class="ai-submode-value" id="aiSubmode">MONITOR</div>
                <div class="ai-submode-desc" id="aiSubmodeDesc">Monitoring conditions</div>
              </div>
              <div class="ai-status-grid">
                <div class="ai-stat"><div class="ai-stat-label">Frost Analysis</div><div class="ai-stat-value" id="aiFrostStatus">Monitoring</div></div>
                <div class="ai-stat"><div class="ai-stat-label">Learning</div><div class="ai-stat-value">Active</div></div>
                <div class="ai-stat"><div class="ai-stat-label">Slope Tracking</div><div class="ai-stat-value" id="aiSlopeStatus">Ready</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HEAT CURVE SUB-TAB -->
      <div id="heatingSubCurve" style="display:none; visibility:hidden;">
      <div class="card">
        <h3>Heat Curve with Knee</h3>
        <div class="small" style="margin-bottom:10px;">
          Defines secondary flow temperature based on outside temperature. The knee point allows aggressive heating in cold conditions, gentler heating for minor frosts.
        </div>

        <div class="dashGrid" class="dashGrid" style="grid-template-columns: 1fr 1fr;">
          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Heat Curve Chart</div>
            <div style="height:300px; position:relative;">
              <canvas id="heatCurveChart"></canvas>
            </div>
          </div>

          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Curve Parameters</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X1 (Coldest Outside C)</div>
                <input type="number" id="hcX1" step="0.5" value="-10" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y1 (Flow at X1 C)</div>
                <input type="number" id="hcY1" step="0.5" value="35" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">XK (Knee Outside C)</div>
                <input type="number" id="hcXK" step="0.5" value="-2" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">YK (Flow at Knee C)</div>
                <input type="number" id="hcYK" step="0.5" value="20" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X2 (Warmest Outside C)</div>
                <input type="number" id="hcX2" step="0.5" value="4" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y2 (Flow at X2 C)</div>
                <input type="number" id="hcY2" step="0.5" value="15" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button onclick="saveHeatCurve()" style="flex:1;">Save Curve</button>
              <button onclick="loadHeatCurve()" style="flex:1;">Reset</button>
            </div>

            <div class="small" style="margin-top:4px;">
              Current wish temp: <span class="mono" id="hcCurrentFlow"></span>
            </div>
          </div>
          </div>
        </div>

        <div class="errorBox" id="heatCurveErr"></div>

      <!-- FORECAST MONITOR CONTROL -->
      <div class="card" style="margin-top:20px;">
        <h3>Forecast Monitor Control</h3>
        <div class="small" style="margin-bottom:14px;">
          View average forecast temperature over selected duration for heating decisions
        </div>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
          
          <!-- Controls -->
          <div style="flex:1; min-width:200px;">
            <div class="kpi" style="margin-bottom:12px;">
              <div class="label">Forecast Duration</div>
              <select id="forecastDuration" onchange="updateForecastAverage(); saveForecastSettings()" style="width:100%; margin-top:6px; padding:8px; background:#1a2530; color:#eaf0ff; border:1px solid #3a4a5a; border-radius:6px;">
                <option value="24">24 Hours</option>
                <option value="36">36 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72">72 Hours</option>
              </select>
            </div>
            
            <div class="kpi">
              <div class="label">Temperature Type</div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="real" checked onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Real</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="feels" onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Feels Like</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Result Display -->
          <div style="flex:1; min-width:250px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%); border:2px solid #3a4a5a; border-radius:12px; padding:20px; text-align:center;">
              <div style="color:#9fb0d7; font-size:11px; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Average Forecast Temperature</div>
              <div id="forecastAvgTemp" style="font-size:42px; font-weight:900; color:#2ee59d; font-family:monospace;">--</div>
              <div style="color:#9fb0d7; font-size:12px; margin-top:4px;">
                <span id="forecastTempLabel">Real</span> temp over next <span id="forecastDurationLabel">24</span>h
              </div>
              <div style="color:#7aa7ff; font-size:11px; margin-top:8px;">
                Min: <span id="forecastMinTemp" style="font-weight:700;">--</span>&deg;C &nbsp;|&nbsp; Max: <span id="forecastMaxTemp" style="font-weight:700;">--</span>&deg;C
              </div>
            </div>
          </div>
          
        </div>
        
        <button onclick="updateForecastAverage()" style="margin-top:14px;">
          Refresh Forecast
        </button>
      </div>

      </div>
      </div>

      <!-- SCHEMATIC SUB-TAB -->
      <div id="heatingSubSchematic" style="display:none; visibility:hidden;">
        <div style="position:relative;max-width:1100px;width:100%;height:550px;overflow-x:auto;margin:0 auto;">

          <!-- Ambient temperature - top right -->
          <div style="position:absolute;top:10px;right:10px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%);border:2px solid #7aa7ff;padding:12px 20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(122,167,255,0.3);">
              <div style="color:#9fb0d7;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Ambient</div>
              <div style="color:#7aa7ff;font-size:28px;font-weight:900;font-family:monospace;"><span id="schAmbientTemp">6.5</span>&deg;C</div>
            </div>
          </div>

          <!-- PRIMARY CIRCUIT -->
          <div style="position:absolute;top:35px;left:5px;color:#bbb;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">Primary</div>

          <!-- Primary IN vertical -->
          <div style="position:absolute;top:60px;left:46px;width:8px;height:180px;background:linear-gradient(to right,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- Bypass horizontal -->
          <div style="position:absolute;top:170px;left:46px;height:8px;width:60px;background:linear-gradient(to bottom,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- 3-port valve -->
          <div style="position:absolute;top:159px;left:93px;width:24px;height:24px;z-index:25;background:radial-gradient(circle at 40% 40%,#777,#444);border:2px solid #555;border-radius:50%;"></div>
          <div style="position:absolute;top:140px;left:85px;z-index:30;background:rgba(76,175,80,0.9);border:1px solid #4CAF50;padding:3px 8px;border-radius:4px;color:#fff;font-size:10px;">S <span id="schValvePos">0</span>%</div>

          <!-- Primary OUT vertical -->
          <div style="position:absolute;top:60px;left:98px;width:8px;height:180px;background:linear-gradient(to right,#bb7766,#884433,#bb7766);border-radius:2px;"></div>

          <!-- Primary sensors -->
          <div style="position:absolute;top:48px;left:5px;color:#aaa;font-size:10px;font-weight:bold;">Pri Flow</div>
          <div style="position:absolute;top:65px;left:5px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schPriFlow">72.0</span>&deg;C</div>
          <div style="position:absolute;top:48px;left:115px;color:#aaa;font-size:10px;font-weight:bold;">Pri Return</div>
          <div style="position:absolute;top:65px;left:115px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schPriReturn">62.0</span>&deg;C</div>

          <!-- HEAT EXCHANGER -->
          <div style="position:absolute;top:240px;left:46px;width:60px;height:80px;background:linear-gradient(145deg,#3a3a4a,#2a2a3a);border:2px solid #555;border-radius:5px;display:flex;align-items:center;justify-content:center;">
            <div style="width:45px;height:60px;background:repeating-linear-gradient(90deg,#555,#555 3px,#3a3a4a 3px,#3a3a4a 6px);border-radius:3px;"></div>
          </div>
          <div style="position:absolute;top:345px;left:25px;color:#bbb;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">Heat Exchanger</div>

          <!-- SECONDARY CIRCUIT -->
          <!-- Secondary flow from HX -->
          <div style="position:absolute;top:275px;left:106px;height:8px;width:82px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:70px;left:180px;width:8px;height:213px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary horizontal header -->
          <div style="position:absolute;top:70px;left:180px;height:8px;width:680px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary sensors on vertical -->
          <div style="position:absolute;top:138px;left:195px;color:#aaa;font-size:10px;font-weight:bold;">Sec Flow</div>
          <div style="position:absolute;top:155px;left:195px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schSecFlow">18.0</span>&deg;C</div>
          <div style="position:absolute;top:180px;left:195px;background:rgba(80,60,100,0.95);border:1px solid #a080cc;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">W <span id="schWishTemp">--</span>&deg;C</div>

          <!-- Vertical drops to pitches -->
          <div style="position:absolute;top:70px;left:465px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:70px;left:855px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>

          <!-- RETURN PIPEWORK -->
          <div style="position:absolute;top:420px;left:465px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:420px;left:855px;width:8px;height:60px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:475px;left:180px;height:8px;width:683px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:295px;left:180px;width:8px;height:185px;background:linear-gradient(to right,#888,#555,#888);border-radius:2px;"></div>
          <div style="position:absolute;top:295px;left:106px;height:8px;width:82px;background:linear-gradient(to bottom,#888,#555,#888);border-radius:2px;"></div>

          <!-- Secondary return sensor -->
          <div style="position:absolute;top:373px;left:195px;color:#aaa;font-size:10px;font-weight:bold;">Sec Return</div>
          <div style="position:absolute;top:390px;left:195px;background:rgba(40,44,52,0.95);border:1px solid #4a9eff;padding:3px 8px;border-radius:4px;color:#fff;font-size:11px;">M <span id="schSecReturn">8.0</span>&deg;C</div>

          <!-- PITCH 1 -->
          <div style="position:absolute;left:300px;top:130px;">
            <!-- Pumps -->
            <div style="position:absolute;left:50%;transform:translateX(-50%);top:-30px;display:flex;gap:6px;">
              <div id="schPump1A" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
              <div id="schPump1B" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
            </div>
            <!-- Pitch -->
            <div style="width:340px;height:240px;background:linear-gradient(90deg,#1e6b1e 0%,#2a8a2a 50%,#1e6b1e 50%,#2a8a2a 100%);border:2px solid rgba(255,255,255,0.7);border-radius:3px;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;">
              <div style="position:absolute;left:50%;top:0;width:2px;height:100%;background:rgba(255,255,255,0.6);transform:translateX(-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid rgba(255,255,255,0.6);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:6px;height:6px;background:rgba(255,255,255,0.7);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <!-- 5 Sensors -->
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:-22px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1C">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1TL">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1BL">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1TR">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP1BR">--</span>&deg;C</div>
            </div>
            <div style="position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);color:#fff;font-size:14px;font-weight:bold;">Pitch 1</div>
          </div>

          <!-- PITCH 2 -->
          <div style="position:absolute;left:690px;top:130px;">
            <!-- Pumps -->
            <div style="position:absolute;left:50%;transform:translateX(-50%);top:-30px;display:flex;gap:6px;">
              <div id="schPump2A" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
              <div id="schPump2B" style="width:26px;height:26px;background:radial-gradient(circle at 30% 30%,#e0e0e0,#888);border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);"><div style="width:8px;height:8px;background:radial-gradient(circle at 30% 30%,#666,#333);border-radius:50%;"></div></div>
            </div>
            <!-- Pitch -->
            <div style="width:340px;height:240px;background:linear-gradient(90deg,#1e6b1e 0%,#2a8a2a 50%,#1e6b1e 50%,#2a8a2a 100%);border:2px solid rgba(255,255,255,0.7);border-radius:3px;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;">
              <div style="position:absolute;left:50%;top:0;width:2px;height:100%;background:rgba(255,255,255,0.6);transform:translateX(-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid rgba(255,255,255,0.6);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:50%;top:50%;width:6px;height:6px;background:rgba(255,255,255,0.7);border-radius:50%;transform:translate(-50%,-50%);"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:50px;height:120px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <div style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-left:none;"></div>
              <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:18px;height:50px;border:2px solid rgba(255,255,255,0.6);border-right:none;"></div>
              <!-- 5 Sensors -->
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:-22px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2C">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2TL">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;left:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2BL">--</span>&deg;C</div>
              <div style="position:absolute;top:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2TR">--</span>&deg;C</div>
              <div style="position:absolute;bottom:35px;right:55px;background:rgba(30,35,45,0.95);border:1px solid #4a9eff;padding:3px 6px;border-radius:3px;color:#fff;font-size:11px;z-index:10;">M <span id="schP2BR">--</span>&deg;C</div>
            </div>
            <div style="position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);color:#fff;font-size:14px;font-weight:bold;">Pitch 2</div>
          </div>

          <!-- Legend -->
          <div style="position:absolute;bottom:10px;left:0;display:flex;gap:20px;font-size:11px;color:#aaa;">
            <div style="display:flex;align-items:center;gap:5px;"><div id="schBmsLed" style="width:15px;height:15px;background:#555;border-radius:3px;"></div><span>Heat demand to BMS</span></div>
          </div>

        </div>
      </div>

      <!-- HEAT CURVE SUB-TAB -->
      <div id="heatingSubCurve" style="display:none; visibility:hidden;">
      <div class="card">
        <h3>Heat Curve with Knee</h3>
        <div class="small" style="margin-bottom:10px;">
          Defines secondary flow temperature based on outside temperature. The knee point allows aggressive heating in cold conditions, gentler heating for minor frosts.
        </div>

        <div class="dashGrid" class="dashGrid" style="grid-template-columns: 1fr 1fr;">
          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Heat Curve Chart</div>
            <div style="height:300px; position:relative;">
              <canvas id="heatCurveChart"></canvas>
            </div>
          </div>

          <div class="card" style="min-height:340px;">
            <div class="subtleTitle">Curve Parameters</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X1 (Coldest Outside C)</div>
                <input type="number" id="hcX1" step="0.5" value="-10" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y1 (Flow at X1 C)</div>
                <input type="number" id="hcY1" step="0.5" value="35" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">XK (Knee Outside C)</div>
                <input type="number" id="hcXK" step="0.5" value="-2" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi" style="border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.08);">
                <div class="label" style="color: var(--warn);">YK (Flow at Knee C)</div>
                <input type="number" id="hcYK" step="0.5" value="20" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="kpi">
                <div class="label">X2 (Warmest Outside C)</div>
                <input type="number" id="hcX2" step="0.5" value="4" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
              <div class="kpi">
                <div class="label">Y2 (Flow at X2 C)</div>
                <input type="number" id="hcY2" step="0.5" value="15" style="width:100%; margin-top:6px;" onchange="updateHeatCurvePreview()" />
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button onclick="saveHeatCurve()" style="flex:1;">Save Curve</button>
              <button onclick="loadHeatCurve()" style="flex:1;">Reset</button>
            </div>

            <div class="small" style="margin-top:4px;">
              Current wish temp: <span class="mono" id="hcCurrentFlow"></span>
            </div>
          </div>
          </div>
        </div>

        <div class="errorBox" id="heatCurveErr"></div>

      <!-- FORECAST MONITOR CONTROL -->
      <div class="card" style="margin-top:20px;">
        <h3>Forecast Monitor Control</h3>
        <div class="small" style="margin-bottom:14px;">
          View average forecast temperature over selected duration for heating decisions
        </div>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
          
          <!-- Controls -->
          <div style="flex:1; min-width:200px;">
            <div class="kpi" style="margin-bottom:12px;">
              <div class="label">Forecast Duration</div>
              <select id="forecastDuration" onchange="updateForecastAverage(); saveForecastSettings()" style="width:100%; margin-top:6px; padding:8px; background:#1a2530; color:#eaf0ff; border:1px solid #3a4a5a; border-radius:6px;">
                <option value="24">24 Hours</option>
                <option value="36">36 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72">72 Hours</option>
              </select>
            </div>
            
            <div class="kpi">
              <div class="label">Temperature Type</div>
              <div style="display:flex; gap:10px; margin-top:8px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="real" checked onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Real</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="radio" name="forecastTempType" value="feels" onchange="updateForecastAverage(); saveForecastSettings()">
                  <span>Feels Like</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Result Display -->
          <div style="flex:1; min-width:250px;">
            <div style="background:linear-gradient(135deg, #1a2530 0%, #0d1520 100%); border:2px solid #3a4a5a; border-radius:12px; padding:20px; text-align:center;">
              <div style="color:#9fb0d7; font-size:11px; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Average Forecast Temperature</div>
              <div id="forecastAvgTemp" style="font-size:42px; font-weight:900; color:#2ee59d; font-family:monospace;">--</div>
              <div style="color:#9fb0d7; font-size:12px; margin-top:4px;">
                <span id="forecastTempLabel">Real</span> temp over next <span id="forecastDurationLabel">24</span>h
              </div>
              <div style="color:#7aa7ff; font-size:11px; margin-top:8px;">
                Min: <span id="forecastMinTemp" style="font-weight:700;">--</span>&deg;C &nbsp;|&nbsp; Max: <span id="forecastMaxTemp" style="font-weight:700;">--</span>&deg;C
              </div>
            </div>
          </div>
          
        </div>
        
        <button onclick="updateForecastAverage()" style="margin-top:14px;">
          Refresh Forecast
        </button>
      </div>

      </div>
      </div>

      <!-- SCHEMATIC SUB-TAB -->
      <div id="heatingSubSchematic" style="display:none; visibility:hidden;">
        <div class="schematic-container">
          
          <!-- Mode Legend (Top Left) -->
          <div class="sch-legend">
            <div class="sch-legend-item"><span class="sch-led" id="schLedAutoFrost"></span>Auto Frost</div>
            <div class="sch-legend-item"><span class="sch-led" id="schLedHeating"></span>Heating</div>
            <div class="sch-legend-item"><span class="sch-led" id="schLedDefrost"></span>Defrost</div>
          </div>
          
          <!-- Weather (Top Right) -->
          <div class="sch-weather">
            <div class="sch-weather-temp" id="schWeatherTemp">--C</div>
            <div class="sch-weather-label">Outside</div>
          </div>
          
          <!-- Main Schematic Area -->
          <div class="sch-main">
            
            <!-- Plant Room (Left) -->
            <div class="sch-plant">
              <div class="sch-plant-box">
                <div class="sch-plant-icon">&#9881;&#65039;</div>
                <div class="sch-plant-label">Heat Source</div>
                <div class="sch-temp-badge sch-plant-temp" id="schPlantTemp">M --C</div>
              </div>
              
              <!-- Valves and Pipes from Plant -->
              <div class="sch-plant-pipes">
                <div class="sch-valve-group">
                  <div class="sch-valve" id="schValve1"><div class="sch-valve-icon"></div></div>
                  <div class="sch-temp-badge" id="schFlowTemp">M --C</div>
                </div>
                <div class="sch-valve-group">
                  <div class="sch-valve" id="schValve2"><div class="sch-valve-icon"></div></div>
                  <div class="sch-temp-badge" id="schReturnTemp">M --C</div>
                </div>
              </div>
              
              <!-- Status Indicators -->
              <div class="sch-status-box">
                <div class="sch-status-item"><span class="sch-led small" id="schHeatDemand"></span>Heat demand to BMS</div>
                <div class="sch-status-item"><span class="sch-led small" id="schTempSwitch"></span>Temperature switch active</div>
              </div>
            </div>
            
            <!-- Pipe Network -->
            <div class="sch-pipes">
              <svg class="sch-pipe-svg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                <!-- Main horizontal pipe from plant -->
                <path class="sch-pipe-line" d="M 0,200 L 100,200 L 100,50 L 700,50 L 700,200" />
                <!-- Return pipe -->
                <path class="sch-pipe-line sch-pipe-return" d="M 0,220 L 80,220 L 80,350 L 700,350 L 700,200" />
                <!-- Branch to Pitch 1 -->
                <path class="sch-pipe-line" d="M 280,50 L 280,80" />
                <path class="sch-pipe-line sch-pipe-return" d="M 300,350 L 300,320" />
                <!-- Branch to Pitch 2 -->
                <path class="sch-pipe-line" d="M 520,50 L 520,80" />
                <path class="sch-pipe-line sch-pipe-return" d="M 540,350 L 540,320" />
                <!-- Flow indicators -->
                <circle class="sch-flow-dot" id="schFlowDot1" cx="200" cy="50" r="4" />
                <circle class="sch-flow-dot" id="schFlowDot2" cx="400" cy="50" r="4" />
              </svg>
              
              <!-- Manifold Temps on pipes -->
              <div class="sch-pipe-temp" style="left:120px;top:30px;" id="schPipeTemp1">M --C</div>
              <div class="sch-pipe-temp" style="right:120px;top:30px;" id="schPipeTemp2">M --C</div>
            </div>
            
            <!-- Pitches -->
            <div class="sch-pitches">
              
              <!-- Pitch 1 -->
              <div class="sch-pitch" id="schPitch1">
                <div class="sch-pitch-status" id="schPitch1Status">Selected</div>
                <div class="sch-pitch-header">
                  <div class="sch-pump" id="schPump1"><div class="sch-pump-icon"></div></div>
                  <div class="sch-temp-badge" id="schP1FlowIn">M --C</div>
                </div>
                <div class="sch-pitch-field">
                  <div class="sch-field-grass">
                    <div class="sch-field-lines"></div>
                    <div class="sch-field-center"></div>
                  </div>
                  <!-- Pitch 1 Sensors -->
                  <div class="sch-sensor sch-sensor-tl" id="schP1SensorTL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-tr" id="schP1SensorTR"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-c" id="schP1SensorC"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-bl" id="schP1SensorBL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-br" id="schP1SensorBR"><span class="sch-sensor-led"></span>--C</div>
                </div>
                <div class="sch-pitch-footer">
                  <div class="sch-temp-badge" id="schP1Return">M --C</div>
                </div>
                <div class="sch-pitch-label">Pitch 1</div>
              </div>
              
              <!-- Pitch 2 -->
              <div class="sch-pitch" id="schPitch2">
                <div class="sch-pitch-status" id="schPitch2Status">Selected</div>
                <div class="sch-pitch-header">
                  <div class="sch-pump" id="schPump2"><div class="sch-pump-icon"></div></div>
                  <div class="sch-temp-badge" id="schP2FlowIn">M --C</div>
                </div>
                <div class="sch-pitch-field">
                  <div class="sch-field-grass">
                    <div class="sch-field-lines"></div>
                    <div class="sch-field-center"></div>
                  </div>
                  <!-- Pitch 2 Sensors -->
                  <div class="sch-sensor sch-sensor-tl" id="schP2SensorTL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-tr" id="schP2SensorTR"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-c" id="schP2SensorC"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-bl" id="schP2SensorBL"><span class="sch-sensor-led"></span>--C</div>
                  <div class="sch-sensor sch-sensor-br" id="schP2SensorBR"><span class="sch-sensor-led"></span>--C</div>
                </div>
                <div class="sch-pitch-footer">
                  <div class="sch-temp-badge" id="schP2Return">M --C</div>
                </div>
                <div class="sch-pitch-label">Pitch 2</div>
              </div>
              
            </div>
          </div>
          
        </div>
      </div>

      <!-- SETTINGS SUB-TAB -->
      <div id="heatingSubSettings" style="display:none; overflow:hidden; visibility:hidden;">
        <div class="card">
          <h3>Heating Control Settings</h3>
          <p class="small" style="margin-bottom:8px;">Configure parameters for each operating mode</p>
          
          <div class="settings-grid">
            
            <!-- STANDARD MODE -->
            <div class="settings-card card-standard">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">Standard Mode</h4>
              </div>
              <p class="settings-card-desc">Basic frost protection - choose trigger method below</p>
              
              <!-- Trigger Type Toggle -->
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Trigger Method</span>
                  <span class="settings-label-hint">How to determine when heating should start</span>
                </div>
                <div class="settings-input">
                  <select id="stdTriggerMethod" onchange="toggleStandardTrigger(); saveStandardSettings();" style="padding:8px 12px; border-radius:6px; border:1px solid #3a3f4b; background:#2a2f3a; color:#e0e0e0; font-size:13px; min-width:180px;">
                    <option value="time">Time-based (fixed hours)</option>
                    <option value="forecast">Forecast Temperature</option>
                  </select>
                </div>
              </div>
              
              <!-- TIME-BASED SETTINGS -->
              <div id="stdTimeBasedSettings">
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Pre-Training Window</span>
                    <span class="settings-label-hint">Hours before training when heating can start if frost risk detected</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="stdPreTrainingHours" value="72" min="1" max="168" step="1" onchange="saveStandardSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
              </div>
              
              <!-- FORECAST TEMPERATURE SETTINGS -->
              <div id="stdForecastSettings" style="display:none;">
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Forecast Duration</span>
                    <span class="settings-label-hint">Number of days to average the temperature over</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="stdForecastDays" value="3" min="1" max="7" step="1" onchange="saveStandardSettings()">
                    <span class="settings-input-unit">days</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Temperature Type</span>
                    <span class="settings-label-hint">Use actual or feels-like temperature for the average</span>
                  </div>
                  <div class="settings-input">
                    <select id="stdForecastTempType" onchange="saveStandardSettings();" style="padding:8px 12px; border-radius:6px; border:1px solid #3a3f4b; background:#2a2f3a; color:#e0e0e0; font-size:13px; min-width:140px;">
                      <option value="real">Actual Temperature</option>
                      <option value="feels">Feels Like</option>
                    </select>
                  </div>
                </div>
                
                <div class="settings-row" style="background:#1a1f2a; border-radius:6px; padding:12px; margin-top:8px;">
                  <div style="font-size:12px; color:#8a9bae;">
                    <strong style="color:#64b4ff;">How it works:</strong> Heating will start when the average <span id="stdTempTypeDesc">actual</span> temperature over the next <span id="stdDaysDesc">3</span> days falls below the Frost Threshold (<span id="stdThresholdDesc">0</span>C).
                  </div>
                </div>
              </div>
            </div>
            
            <!-- FROST PROTECTION -->
            <div class="settings-card card-frost">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">Frost Protection</h4>
              </div>
              <p class="settings-card-desc">Applies to all modes - triggers heating when frost risk is detected in forecast</p>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Frost Threshold</span>
                  <span class="settings-label-hint">Heating activates when forecast minimum falls below this</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="frostThreshold" value="2" min="-10" max="10" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Deadband</span>
                  <span class="settings-label-hint">Hysteresis to prevent rapid cycling (off when min > threshold + deadband)</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="frostDeadband" value="1.5" min="0.5" max="5" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Minimum Run Time</span>
                  <span class="settings-label-hint">Heating stays on for at least this long once activated</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="minHeatMinutes" value="30" min="10" max="120" step="10" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">min</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Soil Frozen Threshold</span>
                  <span class="settings-label-hint">Soil is considered frozen below this temperature (for pass/fail)</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="soilFrozenThreshold" value="0" min="-5" max="5" step="0.5" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Temperature Type</span>
                  <span class="settings-label-hint">Use actual or feels-like temperature for frost detection</span>
                </div>
                <div class="settings-input">
                  <select id="frostTempType" onchange="saveFrostSettings()" style="padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,0.3);color:var(--text);font-size:14px;">
                    <option value="real">Actual</option>
                    <option value="feels">Feels Like</option>
                  </select>
                </div>
              </div>
              
              <div class="settings-section-title" style="margin-top:16px; font-size:12px; color:var(--muted); border-top:1px solid var(--border); padding-top:12px;">Forecast Override (applies to all modes)</div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Enable Forecast Override</span>
                  <span class="settings-label-hint">Use actual temp when significantly colder than forecast</span>
                </div>
                <div class="settings-input">
                  <label class="switch">
                    <input type="checkbox" id="forecastOverrideEnabled" checked onchange="saveFrostSettings()">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Override Threshold</span>
                  <span class="settings-label-hint">Trigger when actual is this much colder than forecast</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="forecastOverrideThreshold" value="5" min="2" max="10" step="1" onchange="saveFrostSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
            </div>
            
            <!-- SMARTPITCH MODE -->
            <div class="settings-card card-smartpitch">
              <div class="settings-card-header">
                <div class="settings-card-dot"></div>
                <h4 class="settings-card-title">SmartPitch Mode</h4>
              </div>
              <p class="settings-card-desc">AI-driven heating with slope-based safety net and learning optimization</p>
              
              <!-- SmartPitch Sub-tabs -->
              <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                <button class="subtabbtn active" id="spSubSafetyNet" onclick="showSpTab('safetynet')">Safety Net</button>
                <button class="subtabbtn" id="spSubHeatCurve" onclick="showSpTab('heatcurve')">Heat Curve</button>
                <button class="subtabbtn" id="spSubTiming" onclick="showSpTab('timing')">Timing</button>
              </div>
              
              <!-- Safety Net Sub-tab -->
              <div id="spTabSafetyNet">
                <div class="settings-section-title">Safety Net</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">The safety net is <strong>dormant by default</strong>. It monitors pitch temperature and only intervenes when the system is off-track or in emergency. Normal control comes from the heat curve and learning system.</p>
                
                <div style="background:rgba(255,159,67,0.1); border:1px solid rgba(255,159,67,0.3); border-radius:8px; padding:12px; margin-bottom:16px;">
                  <div style="color:#ff9f43; font-weight:600; font-size:12px; margin-bottom:8px;">WHEN SAFETY NET INTERVENES:</div>
                  <ul style="margin:0; padding-left:20px; font-size:12px; color:var(--muted); line-height:1.6;">
                    <li><strong>EMERGENCY</strong>  Pitch drops below emergency threshold</li>
                    <li><strong>OFF-TRACK</strong>  Pitch falling too fast with deadline approaching</li>
                    <li><strong>STALLED</strong>  No progress being made near deadline</li>
                    <li><strong>SUCCESS</strong>  Can reduce heat once frost risk cleared (if safe)</li>
                  </ul>
                </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Enable Safety Net</span>
                  <span class="settings-label-hint">Allow safety net to intervene when system is off-track</span>
                </div>
                <div class="settings-input">
                  <label class="switch">
                    <input type="checkbox" id="safetyNetEnabled" checked onchange="saveSmartPitchSettings()">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Emergency Threshold</span>
                  <span class="settings-label-hint">Pitch temp below which emergency intervention triggers</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="emergencyThreshold" value="1.0" min="0" max="3.0" step="0.5" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">C</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Off-Track Slope</span>
                  <span class="settings-label-hint">Falling rate (C/hr) that triggers off-track intervention</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="offTrackSlope" value="-0.5" min="-2.0" max="0" step="0.1" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">C/hr</span>
                </div>
              </div>
              
              <div class="settings-row">
                <div class="settings-label">
                  <span class="settings-label-text">Evaluation Window</span>
                  <span class="settings-label-hint">Time window for calculating pitch temperature slope</span>
                </div>
                <div class="settings-input">
                  <input type="number" id="slopeWindow" value="60" min="30" max="120" step="10" onchange="saveSmartPitchSettings()">
                  <span class="settings-input-unit">min</span>
                </div>
              </div>
              </div><!-- End Safety Net Sub-tab -->
              
              <!-- Heat Curve Sub-tab -->
              <div id="spTabHeatCurve" style="display:none;">
                <div class="settings-section-title">Heat Curve Fallback</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">The heat curve provides baseline flow temperatures when learning data is insufficient. As the system learns, it relies less on this curve.</p>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Use Heat Curve</span>
                    <span class="settings-label-hint">Enable heat curve as fallback when no learning data</span>
                  </div>
                  <div class="settings-input">
                    <label class="switch">
                      <input type="checkbox" id="useHeatCurve" checked onchange="saveSmartPitchSettings()">
                      <span class="slider round"></span>
                    </label>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Learning Confidence Threshold</span>
                    <span class="settings-label-hint">Minimum confidence before using learned data over heat curve</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="learningConfidence" value="70" min="50" max="95" step="5" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">%</span>
                  </div>
                </div>
              </div><!-- End Heat Curve Sub-tab -->
              
              <!-- Timing Sub-tab -->
              <div id="spTabTiming" style="display:none;">
                <div class="settings-section-title">Timing & Deadlines</div>
                <p class="small" style="margin-bottom:12px; color:var(--muted);">Configure how far ahead the system looks and when it considers sessions complete.</p>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Forecast Lookahead</span>
                    <span class="settings-label-hint">Hours of forecast data to consider for decisions</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="forecastLookahead" value="24" min="12" max="72" step="6" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Success Temperature</span>
                    <span class="settings-label-hint">Target pitch temperature to achieve before deadline</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="successTemp" value="5.0" min="3.0" max="10.0" step="0.5" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">C</span>
                  </div>
                </div>
                
                <div class="settings-row">
                  <div class="settings-label">
                    <span class="settings-label-text">Cool Buffer Hours</span>
                    <span class="settings-label-hint">Hours before reducing heat after success (if no cold night ahead)</span>
                  </div>
                  <div class="settings-input">
                    <input type="number" id="coolBufferHours" value="2" min="1" max="6" step="1" onchange="saveSmartPitchSettings()">
                    <span class="settings-input-unit">hrs</span>
                  </div>
                </div>
              </div><!-- End Timing Sub-tab -->
              
            </div>
            
          </div>
        </div>
      </div>

      <!-- FROST CAMERA SUB-TAB -->
      <div id="heatingSubFrostcam" style="display:none; overflow:hidden; visibility:hidden; position:relative;">
        <div class="card">
          <h3>Frost Camera</h3>
          <div class="small" style="margin-bottom:15px;">Live camera feed with frost detection</div>
          
          <div id="frostCamFeed" style="background:#111; border-radius:12px; overflow:hidden; min-height:350px; display:none; align-items:center; justify-content:center; border:2px solid #2ee59d; box-shadow:0 0 15px rgba(46,229,157,0.3); position:relative;">
            <!-- Camera image inserted dynamically -->
            <div id="frostCamError" style="display:none; color:#666; flex-direction:column; align-items:center; text-align:center;">
              <div style="font-size:36px; margin-bottom:8px;">&#128247;</div>
              <div style="font-size:12px;">Camera unavailable</div>
            </div>
            <div id="frostRoiContainer"></div>
            <div style="position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.7); padding:3px 6px; border-radius:4px; font-size:10px; color:#2ee59d;">LIVE</div>
            <div id="frostBadge" style="position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.8); padding:6px 10px; border-radius:5px; font-weight:600; font-size:12px; color:#2ee59d;">--</div>
          </div>
          
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Status</div>
              <div id="fdStatus" style="font-size:16px; font-weight:700; margin-top:4px; color:#2ee59d;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Confidence</div>
              <div id="fdConf" style="font-size:16px; font-weight:700; margin-top:4px;">--%</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Saturation</div>
              <div id="fdSat" style="font-size:16px; font-weight:700; margin-top:4px;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px;">
              <div class="subtleTitle" style="font-size:10px;">Brightness</div>
              <div id="fdBright" style="font-size:16px; font-weight:700; margin-top:4px;">--</div>
            </div>
            <div class="card" style="flex:1; min-width:90px; text-align:center; padding:10px; display:none;">
              <div class="subtleTitle" style="font-size:10px;">Mode</div>
              <div id="fdMode" style="font-size:14px; font-weight:600; margin-top:4px;">--</div>
            </div>
          </div>
          
          <div class="card" style="margin-top:12px;">
            <h4 style="margin:0 0 12px 0; color:#64b4ff; font-size:13px; font-weight:700;">DETECTION SETTINGS</h4>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px;">
              <input type="hidden" id="fdRoiX" value="10">
              <input type="hidden" id="fdRoiY" value="10">
              <input type="hidden" id="fdRoiW" value="80">
              <input type="hidden" id="fdRoiH" value="80">
              <div>
                <div class="subtleTitle" style="margin-bottom:6px; font-size:10px;">Thresholds</div>
                <div><label style="color:#9fb0d7; font-size:9px;">Saturation (below=frost)</label><input type="number" id="fdSatTh" min="0" max="255" value="40" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div style="display:none;"><label style="color:#9fb0d7; font-size:9px;">Brightness (above=frost)</label><input type="number" id="fdBrightTh" min="0" max="255" value="150" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px;"></div>
              </div>
              <div>
                <div class="subtleTitle" style="margin-bottom:6px; font-size:10px;">Timing</div>
                <div><label style="color:#9fb0d7; font-size:9px;">Sample Interval (s)</label><input type="number" id="fdSampleInt" min="1" max="30" value="2" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div><label style="color:#9fb0d7; font-size:9px;">Smoothing (frames)</label><input type="number" id="fdSmooth" min="1" max="60" value="10" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px; margin-bottom:4px;"></div>
                <div><label style="color:#9fb0d7; font-size:9px;">Change Delay (s)</label><input type="number" id="fdDelay" min="5" max="300" value="30" style="width:100%; padding:4px; border-radius:3px; border:1px solid #3a4a5a; background:#1a2530; color:#fff; font-size:11px;"></div>
              </div>
              <div>
                <div class="subtleTitle" style="display:none; margin-bottom:6px; font-size:10px;">Options</div>
                <label style="display:none; align-items:center; gap:6px; cursor:pointer; margin-bottom:6px;"><input type="checkbox" id="fdAutoDN" checked style="width:12px; height:12px;"><span style="font-size:10px;">Auto Day/Night</span></label>
                <label style="display:none; align-items:center; gap:6px; cursor:pointer;"><input type="checkbox" id="fdNightBr" checked style="width:12px; height:12px;"><span style="font-size:10px;">Night: Brightness Only</span></label>
              </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="saveFrostDetect()" style="padding:6px 12px; background:#2ee59d; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Save</button>
              <button onclick="loadFrostDetect()" style="padding:6px 12px; background:#3a4a5a; color:#fff; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Reset</button>
              <button onclick="toggleRoiBox()" style="padding:6px 12px; background:#64b4ff; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">Edit ROI</button>
              <button onclick="addRoiBox()" style="padding:6px 12px; background:#2ee59d; color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:11px;">+ Add ROI</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADVISORY SUB-TAB -->
      <div id="heatingSubAdvisory" style="display:none; overflow:hidden; visibility:hidden;">
        <div class="card" style="background:linear-gradient(145deg, rgba(46,229,157,0.08), rgba(122,167,255,0.05)); border:1px solid rgba(46,229,157,0.3);">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
            <div style="font-size:28px;">&#129302;</div>
            <div>
              <h3 style="margin:0; color:#2ee59d;">SmartPitch Advisory</h3>
              <div class="small" style="color:#9fb0d7;">What the system is planning and why</div>
            </div>
          </div>
          
          <!-- Next Session Summary -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#128197;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Next Session</div>
            </div>
            <div id="advNextSession" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Current Plan -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#129504;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Current Plan</div>
            </div>
            <div id="advCurrentPlan" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Weather Assessment -->
          <div class="card" style="margin-bottom:16px; padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#127782;&#65039;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Weather Assessment</div>
            </div>
            <div id="advWeather" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
          
          <!-- Learning Insights -->
          <div class="card" style="padding:16px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
              <div style="font-size:20px;">&#128218;</div>
              <div class="subtleTitle" style="margin:0; font-size:14px;">Learning Insights</div>
            </div>
            <div id="advLearning" style="font-size:15px; line-height:1.6; color:#eaf0ff;">
              Loading...
            </div>
          </div>
        </div>
      </div>

    </div>

      
    <!-- DATA -->
    <div class="panel" id="panelData" style="display:none;">
      <div class="card">
        <div class="row" style="align-items:flex-end;">
          <div>
            <h3 style="margin-bottom:6px;">Data</h3>
            <div class="small">Browse and export database tables used by SmartPitch learning.</div>
          </div>
          <div class="row" style="gap:8px; justify-content:flex-end;">
            <button class="btnPill" id="btnExportXlsx" onclick="exportXlsxActive()">Export Excel</button>
            <button class="btnPill" id="btnExportCsv" onclick="exportCsvActive()">Export CSV</button>
          </div>
        </div>

        <div class="subtabs" style="margin-top:12px;">
          <button class="subtabbtn active" id="subTrend" onclick="showDataSub('trend')">TrendLogs</button>
          <button class="subtabbtn" id="subDecisions" onclick="showDataSub('decisions')">Control Decisions</button>
          <button class="subtabbtn" id="subLearning" onclick="showDataSub('learning')">SmartPitch</button>
        </div>

        <div id="learningContent" style="display:none; margin-top:12px;">
          <div class="card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 12px 0;">Weather Band Definitions</h4>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px;">
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Temperature Bands</div>
                <div class="mono small">T&lt;=-6:  -6C (Severe frost)</div>
                <div class="mono small">T-6..-4: -6 to -4C (Hard frost)</div>
                <div class="mono small">T-4..-2: -4 to -2C (Moderate frost)</div>
                <div class="mono small">T-2..0: -2 to 0C (Light frost)</div>
                <div class="mono small">T0..2: 0 to 2C (Frost risk)</div>
                <div class="mono small">T&gt;2: &gt; 2C (Low risk)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Cloud Cover Bands</div>
                <div class="mono small">C0..10: &lt; 10% (Clear - fast defrost)</div>
                <div class="mono small">C10..30: 10-30% (Mostly clear)</div>
                <div class="mono small">C30..60: 30-60% (Partial cloud)</div>
                <div class="mono small">C60..85: 60-85% (Mostly cloudy)</div>
                <div class="mono small">C&gt;85:  85% (Overcast - no solar)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Humidity Bands</div>
                <div class="mono small">H&lt;60: &lt; 60% (Dry)</div>
                <div class="mono small">H60..80: 60-80% (Moderate)</div>
                <div class="mono small">H&gt;80:  80% (High - frost risk)</div>
              </div>
              <div>
                <div class="small" style="color:var(--muted); margin-bottom:6px;">Wind Bands</div>
                <div class="mono small">W0..2: &lt; 2 m/s (Calm)</div>
                <div class="mono small">W2..5: 2-5 m/s (Light)</div>
                <div class="mono small">W5..8: 5-8 m/s (Moderate)</div>
                <div class="mono small">W&gt;8:  8 m/s (Strong)</div>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 12px 0;">Current Conditions</h4>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
              <div><span class="small" style="color:var(--muted);">Temp:</span> <span id="currentTempBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Cloud:</span> <span id="currentCloudBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Humidity:</span> <span id="currentHumidityBand" class="mono"></span></div>
              <div><span class="small" style="color:var(--muted);">Wind:</span> <span id="currentWindBand" class="mono"></span></div>
            </div>
          </div>
          
          <div class="card">
            <h4 style="margin:0 0 12px 0;">Historical Performance by Weather Bands</h4>
            <div class="small" style="color:var(--muted); margin-bottom:12px;">Shows pass/fail rate and average heating lead time for each weather combination</div>
            <div class="dbTableWrap" style="overflow-x:auto;">
              <table class="dbTable" id="learningTable">
                <thead id="learningThead"></thead>
                <tbody id="learningTbody"></tbody>
              </table>
            </div>
            <div id="learningMeta" class="small" style="margin-top:8px; color:var(--muted);"></div>
          </div>
        </div>

        <div id="trendSmartContent">
        <div class="dataControls" style="margin-top:12px;">
          <div class="row" style="gap:10px; justify-content:flex-start;">
            <div class="field">
              <div class="label">From</div>
              <input type="datetime-local" id="dataFrom" />
            </div>
            <div class="field">
              <div class="label">To</div>
              <input type="datetime-local" id="dataTo" />
            </div>

            <div class="field" id="smartTablePickerWrap" style="display:none;">
              <div class="label">SmartPitch table</div>
              <select id="smartTableSel" onchange="reloadActiveTable(true)">
                <option value="heating_sessions">Heating sessions</option>
                <option value="heat_periods">Heat periods</option>
                <option value="control_decisions">Control decisions</option>
                <option value="training_schedule">Training schedule</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Rows</div>
              <select id="dataPageSize" onchange="reloadActiveTable(true)">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="250">250</option>
              </select>
            </div>

            <div class="field">
              <div class="label">&nbsp;</div>
              <button onclick="reloadActiveTable(true)">Apply</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="small"><span class="mono" id="dataMeta"></span></div>
            <div class="row" style="gap:8px; justify-content:flex-end;">
              <button onclick="pagePrev()">&#9664; Prev</button>
              <button onclick="pageNext()">Next &#9654;</button>
            </div>
          </div>
        </div>

        <div class="errorBox" id="dataErr"></div>

        <div class="tableWrap" style="margin-top:12px;">
          <table class="dbTable" id="dbTable">
            <thead id="dbThead"></thead>
            <tbody id="dbTbody"></tbody>
          </table>
        </div>
      </div>
      </div>
    </div>


    <!-- ADVANCED -->
    <div class="panel" id="panelAdvanced" style="display:none;">
      <div class="subtabs" style="margin-bottom:14px;">
        <button class="subtabbtn active" id="subPLCMonitor" onclick="showAdvancedSub('plc')">PLC Monitor</button>
        <button class="subtabbtn" id="subManualControl" onclick="showAdvancedSub('manual')">Manual Control</button>
        <button class="subtabbtn" id="subModbusDevices" onclick="showAdvancedSub('modbus')">Modbus Devices</button>
        <button class="subtabbtn" id="subAlarms" onclick="showAdvancedSub('alarms')">Alarms</button>
        <button class="subtabbtn" id="subParameters" onclick="showAdvancedSub('parameters')">Temperature Control</button>
      </div>

      <div id="advancedSubPLC" style="display:block;">
        <div class="card">
          <h3>PLC Monitor</h3>
          <div class="small" style="margin-bottom:14px;">Live I/O status from SmartPitch controller</div>
          
          <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            
            <!-- PLC Visual -->
            <div style="background: linear-gradient(180deg, #2a3a4a 0%, #1a2a3a 100%); border-radius:12px; padding:20px; border:2px solid #4a5a6a; min-width:0; width:100%;">
              
              <!-- PLC Header -->
              <div style="background:#3a4a5a; border-radius:8px; padding:10px 20px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="color:#2ee59d; font-weight:900; font-size:16px;">SMARTPITCH CONTROLLER</div>
                  <div style="color:#7a8a9a; font-size:11px;">I/O Module Status</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:12px; height:12px; border-radius:50%; background:#2ee59d; box-shadow:0 0 8px #2ee59d;" id="plcStatusLed"></div>
                  <span style="color:#9fb0d7; font-size:12px;" id="plcStatusText">AUTO</span>
                </div>
              </div>
              
              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                
                <!-- Analog Inputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#7aa7ff; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">ANALOG INPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="plc-io-row"><span class="plc-label">AI1</span><span class="plc-desc">Outside Air Temp</span><span class="plc-value" id="plcAI1">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI2</span><span class="plc-desc">Secondary Flow</span><span class="plc-value" id="plcAI2">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI3</span><span class="plc-desc">Secondary Return</span><span class="plc-value" id="plcAI3">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI4</span><span class="plc-desc">Primary Flow</span><span class="plc-value" id="plcAI4">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI5</span><span class="plc-desc">Primary Return</span><span class="plc-value" id="plcAI5">--C</span></div>
                      <div class="plc-io-row"><span class="plc-label">AI6</span><span class="plc-desc">Spare</span><span class="plc-value" id="plcAI6">--</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Analog Outputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#2ee59d; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">ANALOG OUTPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="plc-io-row"><span class="plc-label">AO1</span><span class="plc-desc">3-Port Valve</span><span class="plc-value" id="plcAO1">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO2</span><span class="plc-desc">Pitch 1 Pump</span><span class="plc-value" id="plcAO2">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO3</span><span class="plc-desc">Pitch 2 Pump</span><span class="plc-value" id="plcAO3">--%</span></div>
                      <div class="plc-io-row"><span class="plc-label">AO4</span><span class="plc-desc">Spare</span><span class="plc-value" id="plcAO4">--</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Digital Inputs Section -->
                <div style="flex:1; min-width:180px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#ffd166; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">DIGITAL INPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <div class="plc-io-row"><span class="plc-label">DI1</span><span class="plc-desc">Pitch 1 Enabled</span><span class="plc-led" id="plcDI1"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI2</span><span class="plc-desc">Pitch 2 Enabled</span><span class="plc-led" id="plcDI2"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI3</span><span class="plc-desc">P1 Pump A Fault</span><span class="plc-led fault" id="plcDI3"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI4</span><span class="plc-desc">High Limit Trip</span><span class="plc-led fault" id="plcDI4"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI5</span><span class="plc-desc">P1 Pump B Fault</span><span class="plc-led fault" id="plcDI5"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI6</span><span class="plc-desc">P2 Pump A Fault</span><span class="plc-led fault" id="plcDI6"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI7</span><span class="plc-desc">P2 Pump B Fault</span><span class="plc-led fault" id="plcDI7"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI8</span><span class="plc-desc">Pressure Fault</span><span class="plc-led fault" id="plcDI8"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI9</span><span class="plc-desc">Reset Input</span><span class="plc-led" id="plcDI9"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DI10</span><span class="plc-desc">Spare</span><span class="plc-led" id="plcDI10"></span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Digital Outputs Section -->
                <div style="flex:1; min-width:160px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#ff6b6b; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">DIGITAL OUTPUTS</div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <div class="plc-io-row"><span class="plc-label">DO1</span><span class="plc-desc">Common Alarm</span><span class="plc-led fault" id="plcDO1"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO2</span><span class="plc-desc">Primary Heat Demand</span><span class="plc-led" id="plcDO2"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO3</span><span class="plc-desc">AutoFrost Status</span><span class="plc-led" id="plcDO3"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO4</span><span class="plc-desc">Reset Output</span><span class="plc-led" id="plcDO4"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO5</span><span class="plc-desc">Watchdog</span><span class="plc-led" id="plcDO5"></span></div>
                      <div class="plc-io-row"><span class="plc-label">DO6</span><span class="plc-desc">Spare</span><span class="plc-led" id="plcDO6"></span></div>
                    </div>
                  </div>
                </div>
                
              </div>
            </div>
            
          </div>
        </div>
      </div>

      <div id="advancedSubManual" style="display:none;">
        <div class="card">
          <h3>Manual Control</h3>
          <div class="small" style="margin-bottom:14px;">Override automatic control and manually set I/O states</div>
          
          <!-- Master Override Switch -->
          <div style="background:linear-gradient(135deg,#ff6b6b22,#ff8e5322); border:2px solid #ff6b6b; border-radius:10px; padding:15px; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="color:#ff6b6b; font-weight:900; font-size:14px;">&#9888;&#65039; MANUAL OVERRIDE MODE</div>
                <div style="color:#9fb0d7; font-size:11px;">When enabled, automatic control is suspended</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="manualOverrideEnabled" onchange="toggleManualOverride()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div id="manualControlsContainer" style="opacity:0.5; pointer-events:none;">
          
          <div style="display:flex; gap:20px; flex-wrap:wrap;">
            
            <!-- Digital Outputs -->
            <div style="flex:1; min-width:280px;">
              <div style="background:#1a2530; border-radius:10px; padding:15px; border:1px solid #3a4a5a;">
                <div style="color:#2ee59d; font-weight:900; font-size:13px; margin-bottom:12px; border-bottom:1px solid #3a4a5a; padding-bottom:8px;">DIGITAL OUTPUTS</div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO1</span>
                  <span class="manual-desc">Common Alarm</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO1" onchange="setManualDO(1, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO2</span>
                  <span class="manual-desc">Primary Heat Demand</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO2" onchange="setManualDO(2, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO3</span>
                  <span class="manual-desc">AutoFrost Status</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO3" onchange="setManualDO(3, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO4</span>
                  <span class="manual-desc">Reset Output</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO4" onchange="setManualDO(4, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO5</span>
                  <span class="manual-desc">Watchdog</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO5" onchange="setManualDO(5, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="manual-io-row">
                  <span class="manual-label">DO6</span>
                  <span class="manual-desc">Spare</span>
                  <label class="toggle-switch small">
                    <input type="checkbox" id="manualDO6" onchange="setManualDO(6, this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Analog Outputs -->
            <div style="flex:1; min-width:320px;">
              <div style="background:#1a2530; border-radius:10px; padding:15px; border:1px solid #3a4a5a;">
                <div style="color:#7aa7ff; font-weight:900; font-size:13px; margin-bottom:12px; border-bottom:1px solid #3a4a5a; padding-bottom:8px;">ANALOG OUTPUTS (0-100%)</div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO1</span>
                    <span class="manual-desc">3-Port Valve</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO1Enabled" onchange="setAOEnabled(1, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO1Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO1" min="0" max="100" value="0" disabled oninput="updateAODisplay(1, this.value)" onchange="setManualAO(1, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO2</span>
                    <span class="manual-desc">Pitch 1 Pump</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO2Enabled" onchange="setAOEnabled(2, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO2Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO2" min="0" max="100" value="0" disabled oninput="updateAODisplay(2, this.value)" onchange="setManualAO(2, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO3</span>
                    <span class="manual-desc">Pitch 2 Pump</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO3Enabled" onchange="setAOEnabled(3, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO3Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO3" min="0" max="100" value="0" disabled oninput="updateAODisplay(3, this.value)" onchange="setManualAO(3, this.value)">
                </div>
                
                <div class="manual-ao-row">
                  <div class="manual-ao-header">
                    <span class="manual-label">AO4</span>
                    <span class="manual-desc">Spare</span>
                    <label class="toggle-switch small">
                      <input type="checkbox" id="manualAO4Enabled" onchange="setAOEnabled(4, this.checked)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="manual-ao-value" id="manualAO4Value">0%</span>
                  </div>
                  <input type="range" class="manual-slider" id="manualAO4" min="0" max="100" value="0" disabled oninput="updateAODisplay(4, this.value)" onchange="setManualAO(4, this.value)">
                </div>
              </div>
            </div>
            
          </div>
          
          </div>
        </div>
      </div>

      <!-- MODBUS DEVICES SUB-TAB -->
      <div id="advancedSubModbus" style="display:none;">
        <div class="card">
          <h3>Soil Scout Modbus Sensors</h3>
          <div class="small" style="margin-bottom:14px;">Live temperature readings from underground Soil Scout sensors via Modbus RTU</div>
          
          <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            
            <!-- Modbus Device Visual -->
            <div style="background: linear-gradient(180deg, #2a3a4a 0%, #1a2a3a 100%); border-radius:12px; padding:20px; border:2px solid #4a5a6a; min-width:0; width:100%;">
              
              <!-- Modbus Header -->
              <div style="background:#3a4a5a; border-radius:8px; padding:10px 20px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="color:#f5a623; font-weight:900; font-size:16px;">SOIL SCOUT MODBUS GATEWAY</div>
                  <div style="color:#7a8a9a; font-size:11px;">11 Temperature Sensors | Modbus RTU</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:12px; height:12px; border-radius:50%; background:#f5a623; box-shadow:0 0 8px #f5a623;" id="modbusStatusLed"></div>
                  <span style="color:#9fb0d7; font-size:12px;" id="modbusStatusText">ONLINE</span>
                </div>
              </div>
              
              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                
                <!-- Ambient Sensor -->
                <div style="flex:0 0 auto; min-width:180px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #f5a623;">
                    <div style="color:#f5a623; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">AMBIENT</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB1</span><span class="modbus-desc">Air Temperature</span><span class="modbus-value" id="modbusMB1">--C</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Pitch 1 Sensors -->
                <div style="flex:1; min-width:220px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#7aa7ff; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">PITCH 1 SENSORS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB2</span><span class="modbus-desc">Centre Spot</span><span class="modbus-value" id="modbusMB2">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB3</span><span class="modbus-desc">18yd Box - Top Left</span><span class="modbus-value" id="modbusMB3">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB4</span><span class="modbus-desc">18yd Box - Top Right</span><span class="modbus-value" id="modbusMB4">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB5</span><span class="modbus-desc">18yd Box - Bot Left</span><span class="modbus-value" id="modbusMB5">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB6</span><span class="modbus-desc">18yd Box - Bot Right</span><span class="modbus-value" id="modbusMB6">--C</span></div>
                    </div>
                  </div>
                </div>
                
                <!-- Pitch 2 Sensors -->
                <div style="flex:1; min-width:220px;">
                  <div style="background:#1a2530; border-radius:8px; padding:12px; border:1px solid #3a4a5a;">
                    <div style="color:#2ee59d; font-weight:900; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #3a4a5a; padding-bottom:6px;">PITCH 2 SENSORS</div>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                      <div class="modbus-io-row"><span class="modbus-label">MB7</span><span class="modbus-desc">Centre Spot</span><span class="modbus-value" id="modbusMB7">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB8</span><span class="modbus-desc">18yd Box - Top Left</span><span class="modbus-value" id="modbusMB8">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB9</span><span class="modbus-desc">18yd Box - Top Right</span><span class="modbus-value" id="modbusMB9">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB10</span><span class="modbus-desc">18yd Box - Bot Left</span><span class="modbus-value" id="modbusMB10">--C</span></div>
                      <div class="modbus-io-row"><span class="modbus-label">MB11</span><span class="modbus-desc">18yd Box - Bot Right</span><span class="modbus-value" id="modbusMB11">--C</span></div>
                    </div>
                  </div>
                </div>
                
              </div>
              
              <!-- Modbus Stats -->
              <div style="margin-top:15px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Last Poll:</span>
                  <span style="color:#fff; font-size:12px; margin-left:5px;" id="modbusLastPoll">--</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Comms Errors:</span>
                  <span style="color:#fff; font-size:12px; margin-left:5px;" id="modbusErrors">0</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Avg Pitch 1:</span>
                  <span style="color:#7aa7ff; font-size:12px; font-weight:bold; margin-left:5px;" id="modbusAvgP1">--C</span>
                </div>
                <div style="background:#1a2530; border-radius:6px; padding:8px 15px; border:1px solid #3a4a5a;">
                  <span style="color:#7a8a9a; font-size:11px;">Avg Pitch 2:</span>
                  <span style="color:#2ee59d; font-size:12px; font-weight:bold; margin-left:5px;" id="modbusAvgP2">--C</span>
                </div>
              </div>
              
            </div>
            
          </div>
        </div>
      </div>

      <!-- TEMPERATURE CONTROL SUB-TAB -->
      <div id="advancedSubParameters" style="display:none;">
        <div class="card">
          <h3>Temperature Control</h3>
          <div class="small" style="margin-bottom:14px;">PID controller settings for valve actuator</div>
          
          <!-- Pitch Selection -->
          <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px; margin-bottom:20px; border:1px solid #3a4a5a;">
            <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
              <div>
                <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:4px;">PITCH SELECTION</div>
                <div class="small">Select which pitch(es) to heat in auto mode</div>
              </div>
              <select id="pitchSelection" onchange="savePitchSelection()" style="padding:8px 12px; border-radius:8px; background:#1a2332; border:1px solid #3a4a5a; color:#fff; font-size:14px; min-width:140px;">
                <option value="both">Both Pitches</option>
                <option value="pitch1">Pitch 1 Only</option>
                <option value="pitch2">Pitch 2 Only</option>
              </select>
            </div>
            <div style="margin-top:14px; display:flex; gap:30px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="pitch1StatusLed" style="width:12px; height:12px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                <span class="small">Pitch 1 Pump</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="pitch2StatusLed" style="width:12px; height:12px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                <span class="small">Pitch 2 Pump</span>
              </div>
            </div>
          </div>
          
          <div style="background:#1a2530; border-radius:10px; padding:20px; border:1px solid #3a4a5a;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #3a4a5a;">
              <div style="color:#f5a623; font-weight:900; font-size:14px;">PID CONTROLLER</div>
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="color:#7a8a9a; font-size:12px;">Status:</span>
                <div style="display:flex; align-items:center; gap:8px; padding:6px 12px; background:rgba(0,0,0,0.3); border-radius:6px;">
                  <div id="pidStatusLed" style="width:10px; height:10px; border-radius:50%; background:#3a4a5a; transition:all 0.3s;"></div>
                  <span id="pidStatusText" style="color:#7a8a9a; font-size:12px; font-weight:600;">OFF</span>
                </div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
              
              <div class="tuning-param">
                <label>Gain Factor (Kp)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidKp" value="0.0050" min="0" max="1" step="0.0001">
                  <span class="tuning-unit">-</span>
                </div>
                <div class="tuning-hint">Proportional gain (default: 0.0050)</div>
              </div>
              
              <div class="tuning-param">
                <label>Integrator (Tn)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidTn" value="5" min="0" max="999" step="1">
                  <span class="tuning-unit">sec</span>
                </div>
                <div class="tuning-hint">Integral time constant (default: 5)</div>
              </div>
              
              <div class="tuning-param">
                <label>Differentiator (Tv)</label>
                <div class="tuning-input-row">
                  <input type="number" id="pidTv" value="0" min="0" max="999" step="1">
                  <span class="tuning-unit">sec</span>
                </div>
                <div class="tuning-hint">Derivative time constant (default: 0)</div>
              </div>
              
            </div>
            
            <!-- PID Output Display -->
            <div style="margin-top:25px; padding-top:20px; border-top:1px solid #3a4a5a;">
              <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:12px;">PID OUTPUT SIGNAL</div>
              <div style="display:flex; align-items:center; gap:20px;">
                <div style="flex:1; background:rgba(0,0,0,0.3); border-radius:8px; padding:4px;">
                  <div id="pidOutputBar" style="height:24px; width:0%; background:linear-gradient(90deg, #2ee59d, #7aa7ff); border-radius:6px; transition:width 0.3s;"></div>
                </div>
                <div style="min-width:100px; text-align:right;">
                  <span id="pidOutputVolts" style="color:#fff; font-size:20px; font-weight:700;">0.0</span>
                  <span style="color:#7a8a9a; font-size:14px;">V</span>
                </div>
                <div style="min-width:60px; text-align:right;">
                  <span id="pidOutputPercent" style="color:#7a8a9a; font-size:14px;">(0%)</span>
                </div>
              </div>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn" onclick="loadPIDParams()" style="background:#3a4a5a;">Reload</button>
              <button class="btn" onclick="savePIDParams()">Save Parameters</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ALARMS SUB-TAB -->
      <div id="advancedSubAlarms" style="display:none;">
        <div class="card">
          <h3>Alarm Configuration</h3>
          <div class="small" style="margin-bottom:14px;">Configure alarm thresholds and email notifications</div>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
            <!-- Email Settings -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#7aa7ff; font-weight:700; font-size:12px; margin-bottom:12px;">EMAIL NOTIFICATIONS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">SMTP Server</label>
                  <input type="text" id="alarmSmtpServer" placeholder="smtp.gmail.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">SMTP Port</label>
                  <input type="number" id="alarmSmtpPort" value="587" style="width:80px; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">Username</label>
                  <input type="text" id="alarmSmtpUser" placeholder="email@example.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">Password</label>
                  <input type="password" id="alarmSmtpPass" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">From</label>
                  <input type="email" id="alarmFromEmail" placeholder="alerts@smartpitch.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:100px; font-size:12px;">To</label>
                  <input type="email" id="alarmToEmail" placeholder="operator@example.com" style="flex:1; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:#fff;">
                </div>
                <button class="btn" onclick="testAlarmEmail()" style="margin-top:8px; background:#3a4a5a;">Test Email</button>
              </div>
            </div>
            
            <!-- Temperature Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#ffd166; font-weight:700; font-size:12px; margin-bottom:12px;">TEMPERATURE ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPriFlowLowEnabled">
                  <label style="flex:1; font-size:12px;">Primary Flow Low</label>
                  <input type="number" id="alarmPriFlowLowThreshold" value="15" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPriFlowLowDelay" value="60" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPriReturnHighEnabled">
                  <label style="flex:1; font-size:12px;">Primary Return High</label>
                  <input type="number" id="alarmPriReturnHighThreshold" value="45" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPriReturnHighDelay" value="60" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmPitchFrozenEnabled">
                  <label style="flex:1; font-size:12px;">Pitch Frozen</label>
                  <input type="number" id="alarmPitchFrozenThreshold" value="1" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmPitchFrozenDelay" value="300" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmSecFlowNotReachingEnabled">
                  <label style="flex:1; font-size:12px;">Sec. Flow Not Reaching Setpoint</label>
                  <input type="number" id="alarmSecFlowNotReachingOffset" value="3" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                  <input type="number" id="alarmSecFlowNotReachingDelay" value="900" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
              </div>
            </div>
            
            <!-- Hardware Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#ff6b6b; font-weight:700; font-size:12px; margin-bottom:12px;">HARDWARE ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP1AFaultEnabled" checked> Pump 1A Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP1BFaultEnabled" checked> Pump 1B Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP2AFaultEnabled" checked> Pump 2A Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmP2BFaultEnabled" checked> Pump 2B Fault</label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmHighLimitEnabled" checked> High Limit Trip</label>
              </div>
            </div>
            
            <!-- Building Protect -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <div style="color:#ff9f43; font-weight:700; font-size:12px;">BUILDING PROTECT</div>
                <div style="display:flex; align-items:center; gap:6px;">
                  <div id="buildingProtectLed" style="width:10px; height:10px; border-radius:50%; background:#555;"></div>
                  <span id="buildingProtectStatus" style="font-size:11px; color:var(--muted);">INACTIVE</span>
                </div>
              </div>
              <div class="small" style="margin-bottom:10px; color:var(--muted);">Closes actuator when primary return is too cold to protect building heating system.</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;">
                  <input type="checkbox" id="buildingProtectEnabled" checked> Enable Building Protect
                </label>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:120px; font-size:12px;">Close Below</label>
                  <input type="number" id="buildingProtectCloseBelowTemp" value="25" style="width:60px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <label style="width:120px; font-size:12px;">Open Above</label>
                  <input type="number" id="buildingProtectOpenAboveTemp" value="30" style="width:60px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
              </div>
            </div>
            
            <!-- System Alarms -->
            <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:16px;">
              <div style="color:#2ee59d; font-weight:700; font-size:12px; margin-bottom:12px;">SYSTEM ALARMS</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="alarmCommLossEnabled" checked>
                  <label style="flex:1; font-size:12px;">Communication Loss</label>
                  <input type="number" id="alarmCommLossDelay" value="120" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">sec</span>
                </div>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px;"><input type="checkbox" id="alarmSensorFailEnabled" checked> Sensor Failure</label>
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                  <label style="font-size:12px;">Hysteresis</label>
                  <input type="number" id="alarmHysteresis" value="1" step="0.1" style="width:50px; padding:4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-align:center;">
                  <span style="font-size:11px;">C</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn" onclick="loadAlarmSettings()" style="background:#3a4a5a;">Reload</button>
            <button class="btn" onclick="saveAlarmSettings()">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>

  // ===== SPLASH SCREEN =====
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    if (splash) {
      splash.classList.add('fade-out');
      setTimeout(() => { splash.style.display = 'none'; initDemo(); }, 800);
    }
  }, 2500);

  // ===== FAKE DATA GENERATORS =====
  function generateTrendData(hours) {
    const now = Date.now();
    const rows = [];
    const interval = hours <= 24 ? 15 : hours <= 168 ? 60 : hours <= 720 ? 240 : 1440;
    const count = Math.floor((hours * 60) / interval);
    for (let i = count; i >= 0; i--) {
      const ts = new Date(now - i * interval * 60000);
      const dayProgress = (ts.getHours() * 60 + ts.getMinutes()) / 1440;
      const baseTemp = 4 + 3 * Math.sin(dayProgress * Math.PI * 2 - Math.PI / 2);
      const noise = (Math.random() - 0.5) * 1.5;
      const outsideTemp = baseTemp + noise;
      const secFlow = outsideTemp < 2 ? 18 + Math.random() * 4 : 12 + Math.random() * 2;
      const secReturn = secFlow - 4 - Math.random() * 3;
      const field8 = 5.5 + Math.sin(dayProgress * Math.PI * 2 - Math.PI / 3) * 2 + (Math.random() - 0.5);
      const heatOn = outsideTemp < 2;
      rows.push({
        ts: ts.toISOString(),
        outside_temp_c: +outsideTemp.toFixed(1),
        feels_like_c: +(outsideTemp - 1.5 - Math.random()).toFixed(1),
        sec_flow_c: +secFlow.toFixed(1),
        sec_return_c: +secReturn.toFixed(1),
        pri_flow_c: +(70 + Math.random() * 5).toFixed(1),
        pri_return_c: +(58 + Math.random() * 5).toFixed(1),
        avg_field_8cm_c: +field8.toFixed(1),
        avg_field_25cm_c: +(field8 + 2.5 + Math.random()).toFixed(1),
        humidity_pct: +(70 + Math.random() * 20).toFixed(0),
        wind_speed: +(2 + Math.random() * 6).toFixed(1),
        cloud_cover_pct: +(30 + Math.random() * 50).toFixed(0),
        heat_enabled: heatOn,
        valve_pct: heatOn ? +(40 + Math.random() * 30).toFixed(0) : 0,
        kw: heatOn ? +(15 + Math.random() * 20).toFixed(1) : 0
      });
    }
    return rows;
  }

  function generateForecastData() {
    const now = Date.now();
    const rows = [];
    for (let i = 0; i < 168; i++) {
      const ts = new Date(now + i * 3600000);
      const dayProgress = (ts.getHours()) / 24;
      const dayOfWeek = ts.getDay();
      const baseTemp = 3 + 4 * Math.sin(dayProgress * Math.PI * 2 - Math.PI / 2) + (dayOfWeek % 3 - 1) * 1.5;
      const temp = baseTemp + (Math.random() - 0.5) * 2;
      const feels = temp - 1.5 - Math.random() * 2;
      rows.push({
        ts: ts.toISOString(),
        temp_c: +temp.toFixed(1),
        feels_like_c: +feels.toFixed(1),
        cloud_cover_pct: +(20 + Math.random() * 60).toFixed(0),
        wind_speed_ms: +(1 + Math.random() * 8).toFixed(1),
        humidity_pct: +(60 + Math.random() * 30).toFixed(0)
      });
    }
    return rows;
  }

  function generateTrendLogTable() {
    const rows = [];
    const now = Date.now();
    for (let i = 0; i < 50; i++) {
      const ts = new Date(now - i * 900000);
      rows.push({
        ts: ts.toISOString().replace('T', ' ').slice(0, 19),
        outside_temp_c: (3 + Math.random() * 5).toFixed(1),
        feels_like_c: (1 + Math.random() * 4).toFixed(1),
        sec_flow_c: (16 + Math.random() * 6).toFixed(1),
        sec_return_c: (10 + Math.random() * 4).toFixed(1),
        pri_flow_c: (68 + Math.random() * 8).toFixed(1),
        pri_return_c: (55 + Math.random() * 8).toFixed(1),
        avg_field_8cm_c: (5 + Math.random() * 3).toFixed(1),
        humidity_pct: Math.round(65 + Math.random() * 25),
        wind_speed: (2 + Math.random() * 6).toFixed(1),
        cloud_cover_pct: Math.round(20 + Math.random() * 60),
        heat_enabled: Math.random() > 0.6,
        valve_pct: Math.round(Math.random() * 80),
        kw: (Math.random() * 30).toFixed(1)
      });
    }
    return rows;
  }

  function generateDecisionTable() {
    const rows = [];
    const now = Date.now();
    for (let i = 0; i < 50; i++) {
      const ts = new Date(now - i * 3600000 * 4);
      rows.push({
        ts: ts.toISOString().replace('T', ' ').slice(0, 19),
        mode: Math.random() > 0.3 ? 'SMARTPITCH' : 'STANDARD',
        submode: ['MONITOR', 'PREHEAT', 'HEATING'][Math.floor(Math.random() * 3)],
        frost_risk: +(Math.random() * 100).toFixed(0),
        outside_temp_c: (1 + Math.random() * 6).toFixed(1),
        forecast_min_c: (-2 + Math.random() * 5).toFixed(1),
        action: ['HEAT_ON', 'HEAT_OFF', 'MONITOR', 'PREHEAT'][Math.floor(Math.random() * 4)],
        valve_pct: Math.round(Math.random() * 80),
        wish_temp_c: (15 + Math.random() * 10).toFixed(1),
        result: Math.random() > 0.15 ? 'PASS' : 'FAIL'
      });
    }
    return rows;
  }

  // ===== STATE =====
  let trendChart = null;
  let forecastChart = null;
  let heatCurveChart = null;
  let lastHeatOn = [];
  let showTemp = false;
  let showFeels = true;
  let dataSub = 'trend';
  let dataPage = 1;
  let calYear = new Date().getFullYear();
  let calMonth = new Date().getMonth();
  let calItems = [];
  let schematicInterval = null;
  let plcInterval = null;
  let pidInterval = null;
  let frostStatusInterval = null;
  let frostCamActive = false;
  let frostCamTimer = null;
  let roiEditMode = false;
  let roiCounter = 0;
  let activeRoiBox = null;
  let currentMode = 'SMARTPITCH';

  // ===== TOAST =====
  function showToast(msg, type) {
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:12px;font-weight:700;font-size:13px;z-index:9999;animation:toastIn 0.3s ease;';
    t.style.background = type === 'error' ? 'rgba(255,100,100,0.9)' : 'rgba(46,229,157,0.9)';
    t.style.color = type === 'error' ? '#fff' : '#000';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.animation = 'toastOut 0.3s ease'; setTimeout(() => t.remove(), 300); }, 3000);
  }

  // ===== TAB NAVIGATION =====
  function showTab(name) {
    const tabs = ['Dashboard', 'Forecast', 'Schedule', 'Heating', 'Data', 'Advanced'];
    tabs.forEach(t => {
      const p = document.getElementById('panel' + t);
      const b = document.getElementById('tab' + t);
      if (p) p.style.display = (t === name) ? 'block' : 'none';
      if (b) b.classList.toggle('active', t === name);
    });
    if (name === 'Forecast') loadForecast();
    if (name === 'Schedule') renderCalendar();
    if (name === 'Data') showDataSub(dataSub || 'trend');
    if (name === 'Heating') showHeatingSub('mode');
    if (name === 'Advanced') { showAdvancedSub('plc'); populatePLC(); }
  }

  // ===== HELPERS =====
  function setText(id, v) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (v === null || v === undefined || v === '') ? '\u2014' : v;
  }
  function setLed(id, on) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('on', !!on);
  }
  function showErr(id, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    if (!msg) { el.style.display = 'none'; el.textContent = ''; }
    else { el.style.display = 'block'; el.textContent = msg; }
  }
  function showWarn(id, msg) { showErr(id, msg); }

  function fmtAxisDateTime(iso) {
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mi = String(d.getMinutes()).padStart(2, '0');
    return dd + '/' + mm + ' ' + hh + ':' + mi;
  }
  function fmtShort(iso) {
    const d = new Date(iso);
    return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  }

  // ===== CLOCK =====
  function tickClock() {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mi = String(d.getMinutes()).padStart(2, '0');
    setText('serverTime', dd + '/' + mm + ' ' + hh + ':' + mi);
  }
  tickClock();
  setInterval(tickClock, 1000);

  // ===== TREND CHART =====
  function loadTimeseries(hours) {
    const data = generateTrendData(hours);
    const labels = data.map(r => fmtAxisDateTime(r.ts));
    const outside = data.map(r => r.outside_temp_c);
    const feels = data.map(r => r.feels_like_c);
    const field8 = data.map(r => r.avg_field_8cm_c);
    const heatOnArr = data.map(r => r.heat_enabled ? r.outside_temp_c : null);

    const ctx = document.getElementById('trendChart');
    if (!ctx) return;

    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Outside \u00b0C', data: outside, borderColor: '#2ee59d', borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false },
          { label: 'Feels Like \u00b0C', data: feels, borderColor: '#2ee59d', borderWidth: 1.5, borderDash: [4, 4], pointRadius: 0, tension: 0.3, fill: false },
          { label: 'Field -8cm \u00b0C', data: field8, borderColor: '#7aa7ff', borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false },
          { label: 'Heat ON', data: heatOnArr, borderColor: 'transparent', backgroundColor: 'rgba(255,120,120,0.15)', pointRadius: 0, fill: 'origin', showLine: false }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#9fb0d7', maxTicksLimit: 8, maxRotation: 0 }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { ticks: { color: '#9fb0d7' }, grid: { color: 'rgba(255,255,255,0.06)' } }
        },
        plugins: { legend: { labels: { color: '#eaf0ff' } } }
      }
    });
  }

  // ===== FORECAST CHART =====
  function loadForecast() {
    const data = generateForecastData();
    const labels = data.map(r => fmtAxisDateTime(r.ts));
    const temp = data.map(r => r.temp_c);
    const feels = data.map(r => r.feels_like_c);
    const cloud = data.map(r => r.cloud_cover_pct);
    const wind = data.map(r => r.wind_speed_ms);

    const minFeels = Math.min(...feels);
    const minFeelsIdx = feels.indexOf(minFeels);
    const minTemp = Math.min(...temp);
    const minTempIdx = temp.indexOf(minTemp);

    window.forecastData = {
      coldestFeels: { temp: minFeels, time: labels[minFeelsIdx] },
      coldestTemp: { temp: minTemp, time: labels[minTempIdx] }
    };
    updateColdestDisplay();

    setText('fcRows', data.length);
    setText('fcMaxTs', labels[labels.length - 1]);
    setText('fcBehind', '0 min');

    const ctx = document.getElementById('forecastChart');
    if (!ctx) return;
    if (forecastChart) forecastChart.destroy();
    forecastChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Temp \u00b0C', data: temp, borderColor: '#2ee59d', borderWidth: 2, pointRadius: 0, tension: 0.3, yAxisID: 'y', hidden: !showTemp },
          { label: 'Feels Like \u00b0C', data: feels, borderColor: '#2ee59d', borderWidth: 1.5, borderDash: [4, 4], pointRadius: 0, tension: 0.3, yAxisID: 'y', hidden: !showFeels },
          { label: 'Cloud %', data: cloud, borderColor: '#ffd166', borderWidth: 1.5, pointRadius: 0, tension: 0.3, yAxisID: 'y1' },
          { label: 'Wind m/s', data: wind, borderColor: '#7aa7ff', borderWidth: 1.5, pointRadius: 0, tension: 0.3, yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#9fb0d7', maxTicksLimit: 8, maxRotation: 0 }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { position: 'left', ticks: { color: '#9fb0d7' }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y1: { position: 'right', min: 0, max: 100, ticks: { color: '#9fb0d7' }, grid: { drawOnChartArea: false } }
        },
        plugins: { legend: { labels: { color: '#eaf0ff' } } }
      }
    });
  }

  function selectTempType(which) {
    showTemp = which === 'temp';
    showFeels = which === 'feels';
    document.getElementById('btnShowTemp')?.classList.toggle('active', showTemp);
    document.getElementById('btnShowFeels')?.classList.toggle('active', showFeels);
    const lbl = document.getElementById('coldestLabel');
    if (lbl) lbl.textContent = showTemp ? 'Coldest Temp' : 'Coldest Feels Like';
    if (forecastChart) {
      forecastChart.data.datasets[0].hidden = !showTemp;
      forecastChart.data.datasets[1].hidden = !showFeels;
      forecastChart.update();
    }
    updateColdestDisplay();
  }

  function updateColdestDisplay() {
    const v = document.getElementById('coldestValue');
    const t = document.getElementById('coldestTime');
    if (!v || !window.forecastData) return;
    const d = window.forecastData;
    if (showFeels && d.coldestFeels) { v.textContent = d.coldestFeels.temp.toFixed(1) + '\u00b0C'; t.textContent = d.coldestFeels.time; }
    else if (showTemp && d.coldestTemp) { v.textContent = d.coldestTemp.temp.toFixed(1) + '\u00b0C'; t.textContent = d.coldestTemp.time; }
  }

  // ===== HEAT CURVE =====
  function ensureHeatCurveChart(x1, y1, xk, yk, x2, y2) {
    const ctx = document.getElementById('heatCurveChart');
    if (!ctx) return;
    const curvePoints = [], linearPoints = [];
    const linearSlope = (y2 - y1) / (x2 - x1);
    for (let x = x1; x <= x2; x += 0.5) {
      let y = x <= xk ? y1 + ((yk - y1) / (xk - x1)) * (x - x1) : yk + ((y2 - yk) / (x2 - xk)) * (x - xk);
      curvePoints.push({ x, y });
      linearPoints.push({ x, y: y1 + linearSlope * (x - x1) });
    }
    if (heatCurveChart) heatCurveChart.destroy();
    heatCurveChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          { label: 'Heat Curve (with Knee)', data: curvePoints, borderColor: '#2ee59d', backgroundColor: 'rgba(255,255,255,0.15)', borderWidth: 3, fill: true, tension: 0, pointRadius: 0, showLine: true },
          { label: 'Linear (no Knee)', data: linearPoints, borderColor: 'rgba(255,209,102,0.5)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0, pointRadius: 0, showLine: true },
          { label: 'Knee Point', data: [{ x: xk, y: yk }], borderColor: '#ffd166', backgroundColor: '#ffd166', pointRadius: 8, showLine: false }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Outside Temp (\u00b0C)', color: '#9fb0d7' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9fb0d7' } },
          y: { title: { display: true, text: 'Flow Temp (\u00b0C)', color: '#9fb0d7' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9fb0d7' } }
        },
        plugins: { legend: { labels: { color: '#eaf0ff' } } }
      }
    });
  }
  function updateHeatCurvePreview() {
    const g = id => parseFloat(document.getElementById(id)?.value) || 0;
    ensureHeatCurveChart(g('hcX1'), g('hcY1'), g('hcXK'), g('hcYK'), g('hcX2'), g('hcY2'));
  }
  function loadHeatCurve() { updateHeatCurvePreview(); }
  function saveHeatCurve() { updateHeatCurvePreview(); showToast('Heat curve saved', 'success'); }

  // ===== DASHBOARD DATA =====
  function loadGui() {
    setText('leafFrost', 'CLEAR');
    const lf = document.getElementById('leafFrost');
    if (lf) lf.style.color = '#2ee59d';
    setText('field8', '6.2\u00b0C');
    setText('field25', '8.7\u00b0C');
    setText('liveKw', '0.0 kW');
    setText('trendTs', fmtAxisDateTime(new Date().toISOString()));

    // Mode
    setActiveMode(currentMode, false);

    // Heat status
    const hi = document.getElementById('heatStatusIndicator');
    const hIcon = document.getElementById('heatStatusIcon');
    const hText = document.getElementById('heatStatusText');
    if (hi) { hi.style.background = 'linear-gradient(145deg, #1a1a1a, #252525)'; hi.style.borderColor = '#333'; }
    if (hIcon) { hIcon.style.filter = 'grayscale(1) opacity(0.4)'; }
    if (hText) { hText.style.color = '#555'; hText.textContent = 'OFF'; }

    // Lookahead
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(9, 0);
    setText('playableBy', fmtShort(tomorrow.toISOString()));
    setText('trainingStart', 'Training: ' + fmtAxisDateTime(tomorrow.toISOString()));
    const sugStart = new Date(tomorrow); sugStart.setHours(sugStart.getHours() - 4);
    setText('suggestedStart', fmtShort(sugStart.toISOString()));
    setText('startOffset', 'Start offset: 240 min');
    setText('confidence', 'HIGH');
    setText('passRate', 'Pass rate: 87% (26/30)');
    setText('reason', 'Forecast shows min -1.2\u00b0C overnight; historical band match indicates 4hr preheat needed');

    // Costs
    setText('seasonKwh', '14,250');
    setText('seasonCost', '\u00a3427.50');
    setText('rateNow', '3.00 p/kWh');
    setText('seasonWindow', '01/10/2025 \u2014 31/03/2026');
    const inp = document.getElementById('rateInput');
    if (inp && !inp.dataset.touched) inp.value = '3.00';

    // Flow rate
    const fr = document.getElementById('flowRateInput');
    if (fr && !fr.value) fr.value = '1.8';

    // Advisory
    setText('advNextSession', 'Your next session is tomorrow (Friday) at 09:00. The pitch needs to be ready by 08:30. Session: Finish 11:00.');
    setText('advCurrentPlan', 'SmartPitch is monitoring conditions. The forecast shows a minimum of -1.2\u00b0C overnight. Heating will begin at approximately 05:00 to ensure the pitch is ready by 08:30.');
    setText('advWeather', 'The current temperature is 4.8\u00b0C \u2014 cool conditions. Forecasts show temperatures may drop to -1.2\u00b0C overnight. Humidity is moderate (72%). Wind is light at 3.2 m/s.');
    setText('advLearning', 'SmartPitch has analysed 42 similar weather events. In conditions matching the current forecast (light frost, moderate cloud, low wind), the system has a 87% success rate. Average heating lead time for these conditions is 4.2 hours.');

    // Forecast monitor
    const favg = document.getElementById('forecastAvgTemp');
    if (favg) favg.textContent = '2.8\u00b0C';
    setText('forecastTempLabel', 'Real');
    setText('forecastDurationLabel', '24');
    const fmin = document.getElementById('forecastMinTemp');
    if (fmin) fmin.textContent = '-1.2';
    const fmax = document.getElementById('forecastMaxTemp');
    if (fmax) fmax.textContent = '7.4';
  }

  function setActiveMode(mode, bp) {
    ['STANDARD', 'SMARTPITCH'].forEach(m => {
      const btn = document.getElementById('btn' + m);
      if (btn) btn.classList.toggle('active', m === mode);
      const led = document.getElementById('led' + m);
      if (led) led.classList.toggle('on', m === mode);
    });
    setLed('modeLed', true);
    setText('modeNow', mode);
    setText('modeNow2', mode);
    updateModeVisuals(mode);
    const desc = mode === 'STANDARD' ? 'Fixed strategy (no learning). Use for baseline stability.' :
                 mode === 'SMARTPITCH' ? 'AI-driven optimisation using learned performance bands.' : '\u2014';
    setText('modeDesc', desc);
  }

  function updateModeVisuals(mode) {
    const card = document.getElementById('modeCard');
    const bg = document.getElementById('smartpitchBg');
    const spBtn = document.getElementById('btnSMARTPITCH');
    if (mode === 'SMARTPITCH') {
      if (card) card.classList.add('smartpitch-active');
      if (bg) bg.classList.add('active');
      if (spBtn) spBtn.classList.add('selected');
    } else {
      if (card) card.classList.remove('smartpitch-active');
      if (bg) bg.classList.remove('active');
      if (spBtn) spBtn.classList.remove('selected');
    }
  }

  function setModeEnhanced(mode) {
    currentMode = mode;
    setActiveMode(mode, false);
    showToast('Mode set to ' + mode, 'success');
  }

  // ===== HEATING SUB-TABS =====
  function showHeatingSub(sub) {
    ['mode', 'curve', 'schematic', 'settings', 'frostcam', 'advisory'].forEach(s => {
      const el = document.getElementById('heatingSubMode') || document.getElementById('heatingSub' + s.charAt(0).toUpperCase() + s.slice(1));
      const panelId = s === 'mode' ? 'heatingSubMode' : 'heatingSub' + s.charAt(0).toUpperCase() + s.slice(1);
      const panel = document.getElementById(panelId);
      const btn = document.getElementById('subHeating' + s.charAt(0).toUpperCase() + s.slice(1));
      if (panel) { panel.style.display = s === sub ? 'block' : 'none'; panel.style.visibility = s === sub ? 'visible' : 'hidden'; }
      if (btn) btn.classList.toggle('active', s === sub);
    });
    if (sub === 'curve') setTimeout(updateHeatCurvePreview, 100);
  }

  // ===== ADVANCED SUB-TABS =====
  function showAdvancedSub(sub) {
    ['PLC', 'Manual', 'Modbus', 'Alarms', 'Parameters'].forEach(s => {
      const key = s.toLowerCase() === 'plc' ? 'PLC' : s;
      const panel = document.getElementById('advancedSub' + key);
      const btn = document.getElementById('sub' + key + (key === 'PLC' ? 'Monitor' : key === 'Manual' ? 'Control' : key === 'Modbus' ? 'Devices' : ''));
      if (panel) panel.style.display = sub === s.toLowerCase() ? 'block' : 'none';
      if (btn) btn.classList.toggle('active', sub === s.toLowerCase());
    });
    if (sub === 'plc') populatePLC();
    if (sub === 'modbus') populateModbus();
  }

  function populatePLC() {
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    const setLedPLC = (id, on) => { const el = document.getElementById(id); if (el) el.style.background = on ? '#4CAF50' : '#555'; };
    setVal('plcAI1', '4.8\u00b0C'); setVal('plcAI2', '18.2\u00b0C'); setVal('plcAI3', '12.4\u00b0C');
    setVal('plcAI4', '72.1\u00b0C'); setVal('plcAI5', '60.3\u00b0C'); setVal('plcAI6', '--');
    setVal('plcAO1', '0%'); setVal('plcAO2', '0%'); setVal('plcAO3', '0%'); setVal('plcAO4', '0%');
    setLedPLC('plcDI1', true); setLedPLC('plcDI2', true);
    setLedPLC('plcDO5', true); // Watchdog
  }

  function populateModbus() {
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    setVal('modbusMB1', '4.8\u00b0C');
    setVal('modbusMB2', '6.1\u00b0C'); setVal('modbusMB3', '5.8\u00b0C'); setVal('modbusMB4', '6.3\u00b0C');
    setVal('modbusMB5', '5.5\u00b0C'); setVal('modbusMB6', '6.0\u00b0C');
    setVal('modbusMB7', '6.4\u00b0C'); setVal('modbusMB8', '6.0\u00b0C'); setVal('modbusMB9', '6.2\u00b0C');
    setVal('modbusMB10', '5.9\u00b0C'); setVal('modbusMB11', '6.5\u00b0C');
    setVal('modbusAvgP1', '5.9\u00b0C (-8cm)'); setVal('modbusAvgP2', '6.2\u00b0C (-8cm)');
    setVal('modbusLastPoll', new Date().toLocaleTimeString()); setVal('modbusErrors', '0');
    const led = document.getElementById('modbusStatusLed');
    if (led) { led.style.background = '#2ee59d'; led.style.boxShadow = '0 0 8px #2ee59d'; }
    const txt = document.getElementById('modbusStatusText');
    if (txt) txt.textContent = 'ONLINE';
  }

  // ===== CALENDAR =====
  function ymd(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
  function setCalTitle() {
    const d = new Date(calYear, calMonth, 1);
    setText('calTitle', d.toLocaleString(undefined, { month: 'long', year: 'numeric' }));
  }

  function renderCalendar() {
    setCalTitle();
    const grid = document.getElementById('calGrid');
    if (!grid) return;
    grid.innerHTML = '';
    const first = new Date(calYear, calMonth, 1);
    const dow = first.getDay();
    const mondayIdx = dow === 0 ? 6 : dow - 1;
    const gridStart = new Date(calYear, calMonth, 1 - mondayIdx);

    for (let i = 0; i < 42; i++) {
      const d = new Date(gridStart);
      d.setDate(gridStart.getDate() + i);
      const dKey = ymd(d);
      const cell = document.createElement('div');
      cell.className = 'dayCell';
      if (d.getMonth() !== calMonth) cell.classList.add('dayMuted');
      const num = document.createElement('div');
      num.className = 'dayNum';
      num.textContent = d.getDate();
      cell.appendChild(num);

      const itemsWrap = document.createElement('div');
      itemsWrap.className = 'dayItems';
      const items = calItems.filter(x => (x.training_start || '').slice(0, 10) === dKey);
      items.forEach(it => {
        const pill = document.createElement('div');
        pill.className = 'pill';
        const startT = (it.training_start || '').slice(11, 16) || '\u2014';
        pill.innerHTML = '<div><b>' + startT + '</b> <span class="meta">\u2022 ' + (it.session_name || '') + '</span><br><span class="meta">Buffer ' + (it.buffer_minutes ?? 60) + ' min</span></div>';
        const xbtn = document.createElement('button');
        xbtn.className = 'pillX'; xbtn.textContent = 'x';
        xbtn.onclick = (ev) => { ev.stopPropagation(); calItems = calItems.filter(x => x !== it); renderCalendar(); };
        pill.appendChild(xbtn);
        itemsWrap.appendChild(pill);
      });
      cell.appendChild(itemsWrap);
      cell.onclick = () => addDayFromControls(d);
      grid.appendChild(cell);
    }
  }

  function addDayFromControls(dateObj) {
    const startHHMM = document.getElementById('schedStart')?.value || '09:00';
    const stopHHMM = document.getElementById('schedStop')?.value || '11:00';
    const bufMin = parseInt(document.getElementById('schedBuf')?.value || '60', 10);
    const yyyy = dateObj.getFullYear();
    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
    const dd = String(dateObj.getDate()).padStart(2, '0');
    const iso = new Date(yyyy + '-' + mm + '-' + dd + 'T' + startHHMM + ':00').toISOString();
    calItems.push({ training_start: iso, buffer_minutes: bufMin, session_name: 'Finish ' + stopHHMM });
    renderCalendar();
  }

  function prevMonth() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
  function nextMonth() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); }
  function saveSchedule() { showToast('Schedule saved (' + calItems.length + ' sessions)', 'success'); }

  // ===== DATA TAB =====
  function showDataSub(which) {
    dataSub = which;
    const tsc = document.getElementById('trendSmartContent');
    const lc = document.getElementById('learningContent');
    const sp = document.getElementById('smartTablePickerWrap');
    if (tsc) tsc.style.display = (which === 'trend' || which === 'decisions') ? 'block' : 'none';
    if (lc) lc.style.display = (which === 'learning') ? 'block' : 'none';
    if (sp) sp.style.display = (which === 'decisions') ? 'inline-block' : 'none';
    document.getElementById('subTrend')?.classList.toggle('active', which === 'trend');
    document.getElementById('subDecisions')?.classList.toggle('active', which === 'decisions');
    document.getElementById('subLearning')?.classList.toggle('active', which === 'learning');
    reloadActiveTable(true);
  }

  function initDataDefaults() {
    const now = new Date();
    const from = new Date(now); from.setDate(from.getDate() - 7);
    const pad = n => String(n).padStart(2, '0');
    const fmt = d => d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    const ef = document.getElementById('dataFrom');
    const et = document.getElementById('dataTo');
    if (ef && !ef.value) ef.value = fmt(from);
    if (et && !et.value) et.value = fmt(now);
  }

  function reloadActiveTable(resetPage) {
    initDataDefaults();
    if (resetPage) dataPage = 1;
    const rows = dataSub === 'decisions' ? generateDecisionTable() : generateTrendLogTable();
    const cols = rows.length > 0 ? Object.keys(rows[0]) : [];
    renderDbTable(rows, cols);
    setText('dataMeta', (dataSub === 'trend' ? 'TrendLogs' : 'Control Decisions') + ' \u2022 ' + rows.length + ' rows \u2022 page 1/1');
  }

  function renderDbTable(rows, columns) {
    const thead = document.getElementById('dbThead');
    const tbody = document.getElementById('dbTbody');
    if (!thead || !tbody) return;
    const cols = columns && columns.length ? columns : (rows.length ? Object.keys(rows[0]) : []);
    thead.innerHTML = '<tr>' + cols.map(c => '<th>' + c + '</th>').join('') + '</tr>';
    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="' + Math.max(cols.length, 1) + '">No rows.</td></tr>'; return; }
    tbody.innerHTML = rows.map(r => '<tr>' + cols.map(c => {
      const v = r[c];
      const key = c.toLowerCase();
      if (key === 'result') {
        const val = String(v || '').toUpperCase();
        return '<td><span class="pillTiny ' + (val === 'PASS' ? 'ok' : val === 'FAIL' ? 'bad' : '') + '">' + val + '</span></td>';
      }
      if (v === true) return '<td>TRUE</td>';
      if (v === false) return '<td>FALSE</td>';
      return '<td>' + (v ?? '\u2014') + '</td>';
    }).join('') + '</tr>').join('');
  }

  function pagePrev() { showToast('Already on first page', 'success'); }
  function pageNext() { showToast('No more pages', 'success'); }

  // ===== EXPORTS =====
  function exportXlsxActive() { showToast('Export to Excel (demo)', 'success'); }
  function exportCsvActive() { showToast('Export to CSV (demo)', 'success'); }

  // ===== STUB FUNCTIONS =====
  function saveRate() { showToast('Rate saved', 'success'); }
  function saveFlowRate(v) { showToast('Flow rate saved: ' + v + ' L/s', 'success'); }
  function saveStandardSettings() {}
  function toggleStandardTrigger() {}
  function savePitchSelection() { showToast('Pitch selection saved', 'success'); }
  function savePIDParams() { showToast('PID parameters saved', 'success'); }
  function loadPIDParams() { showToast('PID parameters loaded', 'success'); }
  function saveAlarmSettings() { showToast('Alarm settings saved', 'success'); }
  function loadAlarmSettings() {}
  function testAlarmEmail() { showToast('Test email sent (demo)', 'success'); }
  function saveForecastSettings() {}
  function updateForecastAverage() {
    const favg = document.getElementById('forecastAvgTemp');
    if (favg) favg.textContent = (2 + Math.random() * 3).toFixed(1) + '\u00b0C';
  }
  function loadFrostDetect() {}
  function saveFrostDetect() { showToast('Frost detection saved', 'success'); }
  function toggleRoiBox() { showToast('ROI edit (demo)', 'success'); }
  function addRoiBox() { showToast('ROI added (demo)', 'success'); }
  function toggleManualOverride() {
    const c = document.getElementById('manualControlsContainer');
    const en = document.getElementById('manualOverrideEnabled')?.checked;
    if (c) { c.style.opacity = en ? '1' : '0.5'; c.style.pointerEvents = en ? 'all' : 'none'; }
  }
  function setManualDO(n, v) {}
  function setManualAO(n, v) {}
  function setAOEnabled(n, v) {
    const slider = document.getElementById('manualAO' + n);
    if (slider) slider.disabled = !v;
  }
  function updateAODisplay(n, v) {
    const el = document.getElementById('manualAO' + n + 'Value');
    if (el) el.textContent = v + '%';
  }
  function loadLearningData() {}
  function startPLCRefresh() {}
  function stopPLCRefresh() {}
  function startSchematicRefresh() {}
  function stopSchematicRefresh() {}
  function startFrostCamRefresh() {}
  function stopFrostCamRefresh() {}
  function startFrostStatusRefresh() {}
  function stopFrostStatusRefresh() {}
  function updatePLCDisplay() { populatePLC(); }
  function updateSchematic() {}
  function loadAdvisory() {}
  function saveBuildingProtectSettings() { showToast('Building protect saved', 'success'); }

  // SmartPitch AI submode display
  function updateSubmodeDisplay() {
    const el = document.getElementById('aiSubmode');
    const desc = document.getElementById('aiSubmodeDesc');
    if (el) { el.textContent = 'MONITOR'; el.className = 'ai-submode-value monitor'; }
    if (desc) desc.textContent = 'Monitoring conditions \u2014 no heating required';
  }

  // ===== INIT =====
  function initDemo() {
    loadGui();
    loadTimeseries(720);
    renderCalendar();
    updateSubmodeDisplay();

    // Add some demo calendar items
    const today = new Date();
    for (let i = 1; i <= 5; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i * 2);
      d.setHours(9, 0, 0, 0);
      calItems.push({ training_start: d.toISOString(), buffer_minutes: 60, session_name: 'Finish 11:00' });
    }

    // Populate schematic with fake data
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    setVal('schAmbientTemp', '4.8'); setVal('schPriFlow', '72.1'); setVal('schPriReturn', '60.3');
    setVal('schSecFlow', '18.2'); setVal('schSecReturn', '12.4'); setVal('schValvePos', '0');
    setVal('schWishTemp', '16.0');

    // Frost camera status
    const fds = document.getElementById('fdStatus');
    if (fds) { fds.textContent = 'CLEAR'; fds.style.color = '#2ee59d'; }
    const fdc = document.getElementById('fdConf');
    if (fdc) fdc.textContent = '94%';
    const fdsat = document.getElementById('fdSat');
    if (fdsat) fdsat.textContent = '62.4';
    const fdbr = document.getElementById('fdBright');
    if (fdbr) fdbr.textContent = '128.6';
  }

  // Periodic refresh of clock
  document.getElementById('hoursSel')?.addEventListener('change', () => {
    const hours = Number(document.getElementById('hoursSel').value || 720);
    loadTimeseries(hours);
  });
  document.getElementById('rateInput')?.addEventListener('input', (e) => { e.target.dataset.touched = '1'; });


</script>
</body>
</html>